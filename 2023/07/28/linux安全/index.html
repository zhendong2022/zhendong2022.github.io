

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、安全机制1 加密算法和协议  对称加密 非对称（公钥）加密 单向加密 认证协议   1.1 对称加密算法  对称加密：加密和解密使用同一个密钥 特性：  加密、解密使用同一个密钥，效率高 将原始数据分割成固定大小的块，逐个进行加密  缺陷：  密钥过多 密钥分发 数据来源无法确认  常见对称加密算法: DES：Data Encryption Standard，56bits 3DES： AES：">
<meta property="og:type" content="article">
<meta property="og:title" content="linux安全">
<meta property="og:url" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/index.html">
<meta property="og:site_name" content="Mgedu-N80054">
<meta property="og:description" content="一、安全机制1 加密算法和协议  对称加密 非对称（公钥）加密 单向加密 认证协议   1.1 对称加密算法  对称加密：加密和解密使用同一个密钥 特性：  加密、解密使用同一个密钥，效率高 将原始数据分割成固定大小的块，逐个进行加密  缺陷：  密钥过多 密钥分发 数据来源无法确认  常见对称加密算法: DES：Data Encryption Standard，56bits 3DES： AES：">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018001857347-619543177.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018002330391-1043978088.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018002554668-1302441161.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018003713522-730791525.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018003808415-1632798470.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018004054155-1863710445.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018004224400-1964755815.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018004408437-2040069815.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018004656559-1179429802.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018005530571-1513021450.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018010926895-2020571642.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018011120539-682459929.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018142750302-1970532597.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018143055616-1558234375.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018150700752-1300345871.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018150738804-1476474728.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018161801212-865140516.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018162950225-98900703.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018164555746-1131565948.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018165556743-1856795570.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018235908851-2085796555.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221019001745795-2072836263.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221019002027372-1349063876.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221021002436602-1665333347.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221021150311248-725218953.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221021150501836-1587744129.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221021145014684-1868779511.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221021155826630-240959642.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221021162824622-342021938.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221022151736334-206807770.png">
<meta property="og:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221022162202913-1703421813.png">
<meta property="article:published_time" content="2023-07-28T20:11:17.000Z">
<meta property="article:modified_time" content="2023-07-30T21:21:41.128Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/07/28/linux%E5%AE%89%E5%85%A8/2927659-20221018001857347-619543177.png">
  
  
  <title>linux安全 - Mgedu-N80054</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>JohnBackus</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="linux安全">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-07-28 20:11" pubdate>
        July 28, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      66k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      548 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">linux安全</h1>
            
            <div class="markdown-body">
              <h1 id="一、安全机制"><a href="#一、安全机制" class="headerlink" title="一、安全机制"></a>一、安全机制</h1><h2 id="1-加密算法和协议"><a href="#1-加密算法和协议" class="headerlink" title="1 加密算法和协议"></a>1 加密算法和协议</h2><blockquote>
<ul>
<li>对称加密</li>
<li>非对称（公钥）加密</li>
<li>单向加密</li>
<li>认证协议</li>
</ul>
</blockquote>
<h3 id="1-1-对称加密算法"><a href="#1-1-对称加密算法" class="headerlink" title="1.1 对称加密算法"></a>1.1 对称加密算法</h3><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018001857347-619543177.png"><img src="2927659-20221018001857347-619543177.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<p><strong>对称加密：加密和解密使用同一个密钥</strong></p>
<p>特性：</p>
<ul>
<li>加密、解密使用同一个密钥，效率高</li>
<li>将原始数据分割成固定大小的块，逐个进行加密</li>
</ul>
<p>缺陷：</p>
<ul>
<li>密钥过多</li>
<li>密钥分发</li>
<li>数据来源无法确认</li>
</ul>
<p>常见对称加密算法:</p>
<p>DES：Data Encryption Standard，56bits</p>
<p>3DES：</p>
<p><strong>AES</strong>：Advanced (128, 192, 256bits)</p>
<p>Blowfish，Twofish</p>
<p>IDEA，RC6，CAST5</p>
</blockquote>
<hr>
<h3 id="1-2-非对称加密算法"><a href="#1-2-非对称加密算法" class="headerlink" title="1.2 非对称加密算法"></a>1.2 非对称加密算法</h3><h4 id="1-2-1-介绍"><a href="#1-2-1-介绍" class="headerlink" title="1.2.1 介绍"></a>1.2.1 介绍</h4><blockquote>
<p><strong>非对称加密：密钥是成对出现</strong></p>
<ul>
<li>公钥：public key，公开给所有人，主要给别人加密使用</li>
<li>私钥：secret key，private key 自己留存，必须保证其私密性，用于自已加密签名</li>
<li>特点：用公钥加密数据，只能使用与之配对的私钥解密；反之亦然</li>
</ul>
<p>功能：</p>
<ul>
<li>数据加密：适合加密较小数据,比如: 加密对称密钥</li>
<li>数字签名：主要在于让接收方确认发送方身份</li>
</ul>
<p>缺点：</p>
<ul>
<li>密钥长,算法复杂</li>
<li>加密解密效率低下</li>
</ul>
<p>常见算法：</p>
<ul>
<li><strong>RSA</strong>：由 RSA 公司发明，是一个支持变长密钥的公共密钥算法，需要加密的文件块的长度也是可变的,可实现加密和数字签名</li>
<li>DSA（Digital Signature Algorithm）：数字签名算法，是一种标准的 DSS（数字签名标准）</li>
<li>ECC（Elliptic Curves Cryptography）：椭圆曲线密码编码学，比RSA加密算法使用更小的密钥，提供相当的或更高等级的安全</li>
</ul>
</blockquote>
<h4 id="1-2-2-实现加密"><a href="#1-2-2-实现加密" class="headerlink" title="1.2.2 实现加密"></a>1.2.2 实现加密</h4><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018002330391-1043978088.png"><img src="2927659-20221018002330391-1043978088.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<p><strong>接收者</strong></p>
<ul>
<li><strong>生成公钥/密钥对：P和S</strong></li>
<li><strong>公开公钥P，保密密钥S</strong></li>
</ul>
<p><strong>发送者</strong></p>
<ul>
<li><strong>使用接收者的公钥来加密消息M</strong></li>
<li><strong>将P(M)发送给接收者</strong></li>
</ul>
<p><strong>接收者</strong></p>
<ul>
<li><strong>使用密钥S来解密：M=S(P(M))</strong></li>
</ul>
</blockquote>
<h4 id="1-2-3-实现数字签名"><a href="#1-2-3-实现数字签名" class="headerlink" title="1.2.3 实现数字签名"></a>1.2.3 实现数字签名</h4><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018002554668-1302441161.png"><img src="2927659-20221018002554668-1302441161.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<p>发送者</p>
<ul>
<li>生成公钥/密钥对：P和S</li>
<li>公开公钥P，保密密钥S</li>
<li>使用密钥S来加密消息M</li>
<li>发送给接收者S(M)</li>
</ul>
<p>接收者</p>
<ul>
<li>使用发送者的公钥来解密M=P(S(M))</li>
</ul>
</blockquote>
<h4 id="1-2-4-RSA和DSA"><a href="#1-2-4-RSA和DSA" class="headerlink" title="1.2.4 RSA和DSA"></a>1.2.4 RSA和DSA</h4><blockquote>
<p>RSA</p>
<ul>
<li>公钥加密算法是1977年由Ron Rivest、Adi Shamirh和LenAdleman在（美国麻省理工学院）开发的，RSA取名来自开发他们三者的名字，后成立RSA数据安全有限公司。RSA是目前最有影响力的公钥加密算法，它能够抵抗到目前为止已知的所有密码攻击，已被ISO推荐为公钥数据加密标准。RSA算法基于一个十分简单的数论事实：将两个大素数相乘十分容易，但那时想要对其乘积进行因式分解却极其困难，因此可以将乘积公开作为加密密钥</li>
</ul>
<p>DSA</p>
<ul>
<li>1991年7月26日提交，并归属于David W. Kravitz前NSA员工，DSA是Schnorr和ElGamal签名算法的变种，被美国NIST作为SS(DigitalSignature Standard)， DSA是基于整数有限域离散对数难题的，其安全性与RSA相比差不多。<strong>DSA只是一种算法，和RSA不同之处在于它不能用作加密和解密，也不能进行密钥交换，只用于签名,它比RSA要快很多</strong></li>
</ul>
</blockquote>
<hr>
<h3 id="1-3-单向哈希算法"><a href="#1-3-单向哈希算法" class="headerlink" title="1.3 单向哈希算法"></a>1.3 单向哈希算法</h3><blockquote>
<p>哈希算法：</p>
<ul>
<li>也称为散列算法，将任意数据缩小成固定大小的“指纹”，称为digest，即摘要</li>
</ul>
<p>特性：</p>
<ul>
<li>任意长度输入，固定长度输出</li>
<li>若修改数据，指纹也会改变，且有雪崩效应，数据的一点微小改变，生成的指纹值变化非常大。</li>
<li>无法从指纹中重新生成数据，即不要逆，具有单向性</li>
</ul>
<p>功能：</p>
<ul>
<li>数据完整性</li>
</ul>
<p>常见算法</p>
<ul>
<li>md5: 128bits、sha1: 160bits、sha224 、sha256、sha384、sha512</li>
</ul>
<p>常用工具</p>
<ul>
<li><strong>md5sum</strong> | sha1sum [ –check ] file</li>
<li><strong>openssl</strong>、gpg</li>
<li>rpm -V</li>
</ul>
</blockquote>
<hr>
<h3 id="1-4-综合应用多种加密算法"><a href="#1-4-综合应用多种加密算法" class="headerlink" title="1.4 综合应用多种加密算法"></a>1.4 综合应用多种加密算法</h3><h4 id="1-4-1-实现数据加密"><a href="#1-4-1-实现数据加密" class="headerlink" title="1.4.1 实现数据加密"></a>1.4.1 实现数据加密</h4><p><strong>实现数据加密，无法验证数据完整性和来源</strong></p>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018003713522-730791525.png"><img src="2927659-20221018003713522-730791525.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h4 id="1-4-2-实现数字签名"><a href="#1-4-2-实现数字签名" class="headerlink" title="1.4.2 实现数字签名"></a>1.4.2 实现数字签名</h4><p><strong>不加密数据，可以保证数据来源的可靠性、数据的完整性和一致性</strong></p>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018003808415-1632798470.png"><img src="2927659-20221018003808415-1632798470.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h4 id="1-4-3-综合加密和签名"><a href="#1-4-3-综合加密和签名" class="headerlink" title="1.4.3 综合加密和签名"></a>1.4.3 综合加密和签名</h4><p><strong>即实现数据加密，又可以保证数据来源的可靠性、数据的完整性和一致性</strong></p>
<h5 id="方法1：Pb-Sa-hash-data-data"><a href="#方法1：Pb-Sa-hash-data-data" class="headerlink" title="方法1：Pb{Sa[hash(data)]+data}"></a>方法1：Pb{Sa[hash(data)]+data}</h5><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018004054155-1863710445.png"><img src="2927659-20221018004054155-1863710445.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h5 id="方法2：对称key-Sa-hash-data-data-Pb-对称key"><a href="#方法2：对称key-Sa-hash-data-data-Pb-对称key" class="headerlink" title="方法2：对称key{Sa[hash(data)]+data}+Pb(对称key)"></a>方法2：对称key{Sa[hash(data)]+data}+Pb(对称key)</h5><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018004224400-1964755815.png"><img src="2927659-20221018004224400-1964755815.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<hr>
<h3 id="1-5-CA和证书"><a href="#1-5-CA和证书" class="headerlink" title="1.5 CA和证书"></a><strong>1.5 CA和证书</strong></h3><h4 id="1-5-1-中间人攻击"><a href="#1-5-1-中间人攻击" class="headerlink" title="1.5.1 中间人攻击"></a>1.5.1 中间人攻击</h4><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018004408437-2040069815.png"><img src="2927659-20221018004408437-2040069815.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h4 id="1-5-2-CA和证书"><a href="#1-5-2-CA和证书" class="headerlink" title="1.5.2 CA和证书"></a>1.5.2 CA和证书</h4><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018004656559-1179429802.png"><img src="2927659-20221018004656559-1179429802.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<p><strong>PKI：Public Key Infrastructure 公共密钥加密体系</strong></p>
<p><strong>签证机构：CA</strong>（Certificate Authority）</p>
<p>注册机构：RA</p>
<p>证书吊销列表：CRL</p>
<p>证书存取库：</p>
<p><strong>X.509</strong>：定义了证书的结构以及认证协议标准</p>
<ul>
<li>版本号</li>
<li>序列号</li>
<li>签名算法</li>
<li>颁发者</li>
<li>有效期限</li>
<li>主体名称</li>
</ul>
<p>证书类型：</p>
<ul>
<li>证书授权机构的证书</li>
<li>服务器证书</li>
<li>用户证书</li>
</ul>
<p><strong>获取证书两种方法：</strong></p>
<ul>
<li><p><strong>自签名的证书： 自已签发自己的公钥</strong></p>
</li>
<li><p><strong>使用证书授权机构：</strong></p>
</li>
<li><ul>
<li><strong>生成证书请求（csr）</strong></li>
<li><strong>将证书请求csr发送给CA</strong></li>
<li><strong>CA签名颁发证书</strong></li>
</ul>
</li>
</ul>
</blockquote>
<h4 id="1-5-3-安全协议-SSL-TLS"><a href="#1-5-3-安全协议-SSL-TLS" class="headerlink" title="1.5.3 安全协议 SSL/TLS"></a>1.5.3 安全协议 SSL/TLS</h4><h5 id="1-5-3-1-TLS-介绍"><a href="#1-5-3-1-TLS-介绍" class="headerlink" title="1.5.3.1 TLS 介绍"></a>1.5.3.1 TLS 介绍</h5><blockquote>
<p>SSL：Secure Socket Layer，TLS: Transport Layer Security</p>
<p>1994年，NetScape公司设计了SSL协议（Secure Sockets Layer）的1.0版，但是未发布</p>
<p>1995：SSL 2.0 Netscape 开发</p>
<p>1996：SSL 3.0</p>
<p>1999：TLS 1.0</p>
<p>2006：TLS 1.1 IETF(Internet工程任务组) RFC 4346，从2020年3月起，停止支持TLS 1.1及TLS 1.0版本安全协议，谷歌（Chrome）、Mozilla（Firefox）、微软（IE和Edge） 、苹果（Safari） 都会发布新版浏览器执行这个策略</p>
<p>2008：TLS 1.2 当前主要使用</p>
<p>2018：TLS 1.3</p>
<p>功能：</p>
<ul>
<li>机密性</li>
<li>认证</li>
<li>完整性</li>
<li>重放保护</li>
</ul>
</blockquote>
<h5 id="1-5-3-2-HTTPS"><a href="#1-5-3-2-HTTPS" class="headerlink" title="1.5.3.2 HTTPS"></a>1.5.3.2 HTTPS</h5><blockquote>
<p><strong>HTTPS 协议：就是“HTTP 协议”和“SSL/TLS 协议”的组合。</strong></p>
<p>HTTP over SSL 或 HTTP over TLS ，对http协议的文本数据进行加密处理后，成为二进制形式传输</p>
</blockquote>
<h6 id="HTTPS-工作的简化过程"><a href="#HTTPS-工作的简化过程" class="headerlink" title="HTTPS 工作的简化过程"></a>HTTPS 工作的简化过程</h6><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018005530571-1513021450.png"><img src="2927659-20221018005530571-1513021450.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<ol>
<li>客户端发起HTTPS请求</li>
</ol>
<p>用户在浏览器里输入一个https网址，然后连接到服务器的443端口</p>
<ol start="2">
<li>服务端的配置</li>
</ol>
<p>采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面。这套证书其实就是一对公钥和私钥</p>
<ol start="3">
<li>传送服务器的证书给客户端</li>
</ol>
<p>证书里其实就是公钥，并且还包含了很多信息，如证书的颁发机构，过期时间等等</p>
<ol start="4">
<li>客户端解析验证服务器证书</li>
</ol>
<p>这部分工作是由客户端的TLS来完成的，首先会验证公钥是否有效，比如：颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。如果证书没有问题，那么就生成一个随机值。然后用证书中公钥对该随机值进行非对称加密</p>
<ol start="5">
<li>客户端将加密信息传送服务器</li>
</ol>
<p>这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了</p>
<ol start="6">
<li>服务端解密信息</li>
</ol>
<p>服务端将客户端发送过来的加密信息用服务器私钥解密后，得到了客户端传过来的随机值</p>
<ol start="7">
<li>服务器加密信息并发送信息</li>
</ol>
<p>服务器将数据利用随机值进行对称加密,再发送给客户端</p>
<ol start="8">
<li>客户端接收并解密信息</li>
</ol>
<p>客户端用之前生成的随机值解密服务段传过来的数据，于是获取了解密后的内容</p>
</blockquote>
<blockquote>
<p><strong>1 、 首先 HTTP 请求服务端生成证书，客户端对证书的有效期、合法性、域名是否与请求的域名一致、证书的公钥（ RSA 加密）等进行校验；</strong><br><strong>2 、 客户端如果校验通过后，就根据证书的公钥的有效， 生成随机数，随机数使用公钥进行加密（ RSA加密）；</strong><br><strong>3 、 消息体产生的后，对它的摘要进行 MD5 （或者 SHA1 ）算法加密，此时就得到了 RSA 签名；</strong><br><strong>4 、 发送给服务端，此时只有服务端（ RSA 私钥）能解密。</strong><br><strong>5 、 解密得到的随机数，再用 AES 加密，作为密钥（此时的密钥只有客户端和服务端知道）。</strong></p>
</blockquote>
<hr>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="二、OpenSSL"><a href="#二、OpenSSL" class="headerlink" title="二、OpenSSL"></a>二、OpenSSL</h1><h2 id="1-Base64-编码"><a href="#1-Base64-编码" class="headerlink" title="1 Base64 编码"></a>1 Base64 编码</h2><p>Base64是网络上最常见的用于传输 8Bit 字节码的编码方式之一，Base64就是一种基于64个可打印字符来表示二进制数据的方法</p>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018010926895-2020571642.png"><img src="2927659-20221018010926895-2020571642.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h3 id="base64的编码过程"><a href="#base64的编码过程" class="headerlink" title="base64的编码过程"></a>base64的编码过程</h3><blockquote>
<p>将每3个字节放入一个24位的缓冲区中，最后不足3个字节的，缓冲区的剩余部分用0来填补。然后每次取出6位（2的6次方为64，使用64个字符即可表示所有），将高2位用0来填充，组成一个新的字节，计算出这个新字节的十进制值，对应上面的编码表，输出相应的字符。这样不断地进行下去，就可完成对所有数据的编码工作。</p>
</blockquote>
<p>按照以上规则对文本Man编码如下：</p>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018011120539-682459929.png"><img src="2927659-20221018011120539-682459929.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h3 id="范例：用法"><a href="#范例：用法" class="headerlink" title="范例：用法"></a>范例：用法</h3><figure class="highlight bash"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># echo -n Dream |base64</span><br>RHJlYW0=<br>[root@rocky01 ~]<span class="hljs-comment"># echo -n RHJlYW0= |base64 -d</span><br>Dream<br></code></pre></td></tr></table></figure>

<h3 id="范例：破解下面密文"><a href="#范例：破解下面密文" class="headerlink" title="范例：破解下面密文"></a>范例：破解下面密文</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">JXU0ZjYwJXU1OTdkJXVmZjAxJXU2MjExJXU2NjJmd2lsbG9uZWRheSV1ZmYwYyV1NTNlZiV1NGVlNSV1N2VkOSV1NjIxMSV1NGUyYSV1NTE3MyV1NmNlOCV1NTQxNyV1ZmYxZgo=<br><br><span class="hljs-comment">#步骤1</span><br>[root@rocky01 ~]<span class="hljs-comment"># echo JXU0ZjYwJXU1OTdkJXVmZjAxJXU2MjExJXU2NjJmd2lsbG9uZWRheSV1ZmYwYyV1NTNlZiV1NGVlNSV1N2VkOSV1NjIxMSV1NGUyYSV1NTE3MyV1NmNlOCV1NTQxNyV1ZmYxZgo= |base64 -d</span><br>%u4f60%u597d%uff01%u6211%u662fwilloneday%uff0c%u53ef%u4ee5%u7ed9%u6211%u4e2a%u5173%u6ce8%u5417%uff1f<br><br><span class="hljs-comment">#步骤2</span><br><span class="hljs-comment">#使用unicode编码转换所得上述代码</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="2-openssl-命令"><a href="#2-openssl-命令" class="headerlink" title="2 openssl 命令"></a>2 openssl 命令</h2><blockquote>
<p> 两种运行模式：</p>
<ul>
<li>交互模式</li>
<li>批处理模式</li>
</ul>
<p>三种子命令：</p>
<ul>
<li>标准命令</li>
<li>消息摘要命令</li>
<li>加密命令</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># openssl version</span><br>OpenSSL 1.1.1k  FIPS 25 Mar 2021<br><br>[root@rocky01 ~]<span class="hljs-comment"># openssl help</span><br>Standard commands<br>asn1parse         ca                ciphers           cms<br>crl               crl2pkcs7         dgst              dhparam<br>dsa               dsaparam          ec                ecparam<br>...省略...<br></code></pre></td></tr></table></figure>

<h3 id="2-1-openssl命令单向哈希加密"><a href="#2-1-openssl命令单向哈希加密" class="headerlink" title="2.1 openssl命令单向哈希加密"></a>2.1 openssl命令单向哈希加密</h3><p>工具：openssl dgst</p>
<p>算法：md5sum, sha1sum, sha224sum,sha256sum…</p>
<p>dgst 命令：帮助：man dgst</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># cat test.txt</span><br>abc<br>[root@rocky01 ~]<span class="hljs-comment"># openssl md5 test.txt</span><br>MD5(test.txt)= 0bee89b07a248e27c83fc3d5951213c1<br>[root@rocky01 ~]<span class="hljs-comment"># cat &gt; test.txt</span><br>abcd<br>^C<br>[root@rocky01 ~]<span class="hljs-comment"># openssl md5 test.txt</span><br>MD5(test.txt)= f5ac8127b3b6b85cdc13f237c6005d80<br>[root@rocky01 ~]<span class="hljs-comment"># cat &gt; test.txt</span><br>abc<br>^C<br>[root@rocky01 ~]<span class="hljs-comment"># openssl md5 test.txt</span><br>MD5(test.txt)= 0bee89b07a248e27c83fc3d5951213c1<br><br><span class="hljs-comment">#hash总结</span><br>1 单向<br>2 data 相同，digest必相同<br>3 data不相同，digest必不相同<br>4 <span class="hljs-built_in">hash</span>算法固定，则digest的长度固定<br>5 data发生轻微变化，而digest会发生巨大的变化<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="2-2-openssl-命令生成用户密码"><a href="#2-2-openssl-命令生成用户密码" class="headerlink" title="2.2 openssl 命令生成用户密码"></a>2.2 openssl 命令生成用户密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># openssl passwd --help</span><br>Usage: passwd [options]<br>Valid options are:<br> -<span class="hljs-built_in">help</span>               Display this summary<br> -<span class="hljs-keyword">in</span> infile          Read passwords from file<br> -noverify           Never verify when reading password from terminal<br> -quiet              No warnings<br> -table              Format output as table<br> -reverse            Switch table columns<br> -salt val           Use provided salt<br> -stdin              Read passwords from stdin<br> -6                  SHA512-based password algorithm<br> -5                  SHA256-based password algorithm<br> -apr1               MD5-based password algorithm, Apache variant<br> -1                  MD5-based password algorithm<br> -aixmd5             AIX MD5-based password algorithm<br> -crypt              Standard Unix password algorithm (default)<br> -rand val           Load the file(s) into the random number generator<br> -writerand outfile  Write random data to the specified file<br></code></pre></td></tr></table></figure>

<h4 id="范例：使用方法"><a href="#范例：使用方法" class="headerlink" title="范例：使用方法"></a>范例：使用方法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># openssl passwd -6 123456</span><br>$6<span class="hljs-variable">$T3SqZyPPgbzy5He</span>/<span class="hljs-variable">$Zv7rn1</span>.I/93LDe0EulS1npLzOX4fObgj/g5S4WLGfnVn7nfvZUMRJdZFHt8F0FRrVK1y1Hzz9nY2XpW52AN0D/<br>[root@rocky01 ~]<span class="hljs-comment"># openssl passwd -6 -salt &quot;T3SqZyPPgbzy5He/&quot; 123456</span><br>$6<span class="hljs-variable">$T3SqZyPPgbzy5He</span>/<span class="hljs-variable">$Zv7rn1</span>.I/93LDe0EulS1npLzOX4fObgj/g5S4WLGfnVn7nfvZUMRJdZFHt8F0FRrVK1y1Hzz9nY2XpW52AN0D/<br>[root@rocky01 ~]<span class="hljs-comment"># openssl passwd -6 123456</span><br>$6$1pNhebfUlcTAtz1k<span class="hljs-variable">$cTDbrNHNcF5IFOfv31FILNTKnwbf</span>/BFkmFbB1trGXHa3trgENepAodueNJULiT1RAPWbABeG7Iwisk/rj4uiD1<br><br><span class="hljs-comment">#结论</span><br>第二个$和第三个$的值（salt）一样，则生成的密码一样<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="2-3-openssl命令生成随机数"><a href="#2-3-openssl命令生成随机数" class="headerlink" title="2.3 openssl命令生成随机数"></a>2.3 openssl命令生成随机数</h3><p>随机数生成器：伪随机数字，利用键盘和鼠标，块设备中断生成随机数</p>
<h4 id="范例：生成随机10位长度密码"><a href="#范例：生成随机10位长度密码" class="headerlink" title="范例：生成随机10位长度密码"></a><strong>范例：生成随机10位长度密码</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># openssl rand -base64 9 |head -c10</span><br>JbxYH0ISvr<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="2-4-openssl命令实现-PKI"><a href="#2-4-openssl命令实现-PKI" class="headerlink" title="2.4 openssl命令实现 PKI"></a>2.4 openssl命令实现 PKI</h3><blockquote>
<p>公钥加密：</p>
<ul>
<li>算法：RSA, ELGamal</li>
<li>工具：gpg, openssl rsautl（man rsautl）</li>
</ul>
<p>数字签名：</p>
<ul>
<li>算法：RSA, DSA, ELGamal</li>
</ul>
<p>密钥交换：</p>
<ul>
<li>算法：dh</li>
</ul>
<p>DSA：Digital Signature Algorithm</p>
<p>DSS：Digital Signature Standard</p>
<p>RSA：openssl命令生成密钥对儿：man genrsa</p>
</blockquote>
<h4 id="生成公钥和私钥"><a href="#生成公钥和私钥" class="headerlink" title="生成公钥和私钥"></a>生成公钥和私钥</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">openssl genrsa -out /PATH/<span class="hljs-selector-tag">TO</span>/PRIVATEKEY<span class="hljs-selector-class">.FILE</span> <span class="hljs-selector-attr">[-aes128]</span> <span class="hljs-selector-attr">[-aes192]</span> <span class="hljs-selector-attr">[-aes256]</span> <span class="hljs-selector-attr">[- des3]</span> <span class="hljs-selector-attr">[NUM_BITS,默认2048]</span><br></code></pre></td></tr></table></figure>

<p><strong>注：centos8以下版本创建后的文件权限为644，centos8为600</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#可选加密[-aes128]等</span><br>[root@rocky01 ~]<span class="hljs-comment"># openssl genrsa -out /test/app1.key</span><br>Generating RSA private key, 2048 bit long modulus (2 primes)<br>........................+++++<br>..........................................................+++++<br>e is 65537 (0x010001)<br><br>[root@rocky01 ~]<span class="hljs-comment"># cat /test/app1.key</span><br>-----BEGIN RSA PRIVATE KEY-----<br>MIIEowIBAAKCAQEAt/E7JRD0OULSCF5sDGygefUdig4mK6w5A+jxsjFSGeAfNXWX<br>mpPSCq5ig0JJY/6MlK+dL6hVobOdDzOC+EmNMw9DdfkM3hLkBxJ+HG/52byo4V/H<br>...省略...<br><br>[root@rocky01 ~]<span class="hljs-comment"># openssl rsa -in /test/app1.key -out /test/app1.pubkey</span><br>writing RSA key<br>[root@rocky01 ~]<span class="hljs-comment"># ll /test/</span><br>total 8<br>-rw------- 1 root root 1675 Oct 18 01:59 app1.key<br>-rw------- 1 root root 1675 Oct 18 02:17 app1.pubkey<br>[root@rocky01 ~]<span class="hljs-comment"># cat /test/app1.pubkey</span><br>-----BEGIN RSA PRIVATE KEY-----<br>MIIEowIBAAKCAQEAt/E7JRD0OULSCF5sDGygefUdig4mK6w5A+jxsjFSGeAfNXWX<br>mpPSCq5ig0JJY/6MlK+dL6hVobOdDzOC+EmNMw9DdfkM3hLkBxJ+HG/52byo4V/H<br>...省略...<br></code></pre></td></tr></table></figure>

<h4 id="范例-从私钥中提取出公钥"><a href="#范例-从私钥中提取出公钥" class="headerlink" title="范例: 从私钥中提取出公钥"></a>范例: 从私钥中提取出公钥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">openssl rsa -<span class="hljs-keyword">in</span> PRIVATEKEYFILE -pubout -out PUBLICKEYFILE<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="3-建立私有CA实现证书申请颁发"><a href="#3-建立私有CA实现证书申请颁发" class="headerlink" title="3 建立私有CA实现证书申请颁发"></a>3 建立私有CA实现证书申请颁发</h2><blockquote>
<p>建立私有CA：</p>
<ul>
<li>OpenCA：OpenCA开源组织使用Perl对OpenSSL进行二次开发而成的一套完善的PKI免费软件</li>
<li>openssl：相关包 openssl和openssl-libs</li>
</ul>
<p><strong>证书申请及签署步骤：</strong></p>
<p><strong>1、生成证书申请请求</strong></p>
<p><strong>2、RA核验</strong></p>
<p><strong>3、CA签署</strong></p>
<p><strong>4、获取证书</strong></p>
</blockquote>
<h3 id="openssl-libs-包"><a href="#openssl-libs-包" class="headerlink" title="openssl-libs 包"></a>openssl-libs 包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># rpm -ql openssl-libs</span><br>/etc/pki/tls<br>/etc/pki/tls/certs<br>/etc/pki/tls/ct_log_list.cnf<br>/etc/pki/tls/misc<br>/etc/pki/tls/openssl.cnf<br>/etc/pki/tls/private<br>...省略...<br></code></pre></td></tr></table></figure>

<h3 id="openssl的配置文件"><a href="#openssl的配置文件" class="headerlink" title="openssl的配置文件"></a>openssl的配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/etc/pki/tls/openssl.cnf<br></code></pre></td></tr></table></figure>

<h3 id="三种策略"><a href="#三种策略" class="headerlink" title="三种策略"></a>三种策略</h3><p>match匹配、optional可选、supplied提供</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">match：要求申请填写的信息跟CA设置信息必须一致<br>optional：可有可无，跟CA设置信息可不一致<br>supplied：必须填写这项申请信息<br></code></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 CA]<span class="hljs-comment"># cat /etc/pki/tls/openssl.cnf</span><br>...省略...<br>[ policy_match ]<br>countryName		= match<br>stateOrProvinceName	= match<br>organizationName	= match<br>organizationalUnitName	= optional<br>commonName		= supplied<br>emailAddress		= optional<br>...省略...<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-1-创建创建私有CA"><a href="#3-1-创建创建私有CA" class="headerlink" title="3.1 创建创建私有CA"></a>3.1 创建创建私有CA</h3><h4 id="（1）创建CA所需要的文件"><a href="#（1）创建CA所需要的文件" class="headerlink" title="（1）创建CA所需要的文件"></a>（1）创建CA所需要的文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#1、创建CA所需要的文件</span><br>[root@rocky01 ~]<span class="hljs-comment"># mkdir -p /etc/pki/CA/&#123;certs,crl,newcerts,private&#125;</span><br><span class="hljs-comment">#生成证书索引数据库文件</span><br>[root@rocky01 ~]<span class="hljs-comment"># touch /etc/pki/CA/index.txt</span><br><span class="hljs-comment">#指定第一个颁发证书的序列号</span><br>[root@rocky01 ~]<span class="hljs-comment"># echo 01 &gt; /etc/pki/CA/serial</span><br></code></pre></td></tr></table></figure>

<h4 id="（2）生成CA私钥"><a href="#（2）生成CA私钥" class="headerlink" title="（2）生成CA私钥"></a>（2）生成CA私钥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 CA]<span class="hljs-comment"># openssl genrsa -out private/cakey.pem</span><br>Generating RSA private key, 2048 bit long modulus (2 primes)<br>................................................................................................................................................+++++<br>.........................................................................................................+++++<br>e is 65537 (0x010001)<br><br><span class="hljs-comment">#注：centos8以下版本建议umask修改权限后创建</span><br><span class="hljs-comment">#[root@centos7 CA]# (umask 066; openssl genrsa -out private/cakey.pem)</span><br></code></pre></td></tr></table></figure>

<h4 id="（3）生成CA自签名证书"><a href="#（3）生成CA自签名证书" class="headerlink" title="（3）生成CA自签名证书"></a>（3）生成CA自签名证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 CA]<span class="hljs-comment"># openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 3650 -out /etc/pki/CA/cacert.pem</span><br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Country Name (2 letter code) [XX]:CN<br>State or Province Name (full name) []:GuangDong<br>Locality Name (eg, city) [Default City]:Guangzhou<br>Organization Name (eg, company) [Default Company Ltd]:Willoneday <span class="hljs-comment">###公司名###</span><br>Organizational Unit Name (eg, section) []:Dream <span class="hljs-comment">###部门###</span><br>Common Name (eg, your name or your server<span class="hljs-string">&#x27;s hostname) []:ca.willoneday.org</span><br><span class="hljs-string">Email Address []:willoneday@qq.com</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p> 选项说明</p>
<ul>
<li>-new：生成新证书签署请求</li>
<li>-x509：专用于CA生成自签证书</li>
<li>-key：生成请求时用到的私钥文件</li>
<li>-days n：证书的有效期限</li>
<li>-out /PATH/TO/SOMECERTFILE: 证书的保存路径</li>
</ul>
<p>国家代码：<a target="_blank" rel="noopener" href="https://country-code.cl/">https://country-code.cl/</a></p>
</blockquote>
<h4 id="（4）查看证书中的信息"><a href="#（4）查看证书中的信息" class="headerlink" title="（4）查看证书中的信息"></a>（4）查看证书中的信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 CA]<span class="hljs-comment"># openssl x509 -in /etc/pki/CA/cacert.pem -noout -text</span><br>Certificate:<br>    Data:<br>        Version: 3 (0x2)<br>        Serial Number:<br>            44:11:88:69:b1:8f:2c:15:23:3a:56:2a:d7:50:ee:b2:91:71:bd:2a<br>        Signature Algorithm: sha256WithRSAEncryption<br>        Issuer: C = CN, ST = GuangDong, L = Guangzhou, O = Willoneday, OU = Dream, CN = ca.willoneday.org, emailAddress = willoneday@qq.com<br>        Validity<br>            Not Before: Oct 18 05:12:52 2022 GMT<br>            Not After : Oct 15 05:12:52 2032 GMT<br>        Subject: C = CN, ST = GuangDong, L = Guangzhou, O = Willoneday, OU = Dream, CN = ca.willoneday.org, emailAddress = willoneday@qq.com<br>        Subject Public Key Info:<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-2-申请证书并颁发证书"><a href="#3-2-申请证书并颁发证书" class="headerlink" title="3.2 申请证书并颁发证书"></a>3.2 申请证书并颁发证书</h3><h4 id="（1）为需要使用证书的主机生成生成私钥"><a href="#（1）为需要使用证书的主机生成生成私钥" class="headerlink" title="（1）为需要使用证书的主机生成生成私钥"></a>（1）为需要使用证书的主机生成生成私钥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># openssl genrsa -out /test/www.key</span><br>Generating RSA private key, 2048 bit long modulus (2 primes)<br>.................+++++<br>......................................................+++++<br>e is 65537 (0x010001)<br></code></pre></td></tr></table></figure>

<h4 id="（2）为需要使用证书的主机生成证书申请文件"><a href="#（2）为需要使用证书的主机生成证书申请文件" class="headerlink" title="（2）为需要使用证书的主机生成证书申请文件"></a>（2）为需要使用证书的主机生成证书申请文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># openssl req -new -key /test/www.key -out /test/www.csr</span><br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter <span class="hljs-string">&#x27;.&#x27;</span>, the field will be left blank.<br>-----<br>Country Name (2 letter code) [XX]:CN<br>State or Province Name (full name) []:GuangDong<br>Locality Name (eg, city) [Default City]:Guangzhou<br>Organization Name (eg, company) [Default Company Ltd]:Willoneday<br>Organizational Unit Name (eg, section) []:Dream<br>Common Name (eg, your name or your server<span class="hljs-string">&#x27;s hostname) []:www.willoneday.org</span><br><span class="hljs-string">Email Address []:</span><br><span class="hljs-string"></span><br><span class="hljs-string">Please enter the following &#x27;</span>extra<span class="hljs-string">&#x27; attributes</span><br><span class="hljs-string">to be sent with your certificate request</span><br><span class="hljs-string">A challenge password []:</span><br><span class="hljs-string">An optional company name []:</span><br></code></pre></td></tr></table></figure>

<h4 id="（3）在CA签署证书并将证书颁发给请求者"><a href="#（3）在CA签署证书并将证书颁发给请求者" class="headerlink" title="（3）在CA签署证书并将证书颁发给请求者"></a>（3）在CA签署证书并将证书颁发给请求者</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 CA]<span class="hljs-comment"># openssl ca -in /test/www.csr -out /etc/pki/CA/certs/www.crt -days 100</span><br>Using configuration from /etc/pki/tls/openssl.cnf<br>Check that the request matches the signature<br>Signature ok<br>Certificate Details:<br>        Serial Number: 1 (0x1)<br>        Validity<br>            Not Before: Oct 18 05:40:54 2022 GMT<br>            Not After : Jan 26 05:40:54 2023 GMT<br>        Subject:<br>            countryName               = CN<br>            stateOrProvinceName       = GuangDong<br>            organizationName          = Willoneday<br>            organizationalUnitName    = Dream<br>            commonName                = www.willoneday.org<br>        X509v3 extensions:<br>            X509v3 Basic Constraints:<br>                CA:FALSE<br>            Netscape Comment:<br>                OpenSSL Generated Certificate<br>            X509v3 Subject Key Identifier:<br>                AF:DE:3F:02:73:72:29:B4:2D:0F:7E:8D:DA:15:CB:07:CB:EE:9A:2D<br>            X509v3 Authority Key Identifier:<br>                keyid:28:75:5C:54:19:73:FE:84:6E:D9:DC:83:46:72:6F:0A:2B:6B:B8:85<br><br>Certificate is to be certified until Jan 26 05:40:54 2023 GMT (100 days)<br>Sign the certificate? [y/n]:y<br><br><br>1 out of 1 certificate requests certified, commit? [y/n]y<br>Write out database with 1 new entries<br>Data Base Updated<br><br><span class="hljs-comment">#注：这里如果没有创建以下两个文件会报错</span><br><span class="hljs-comment">#生成证书索引数据库文件</span><br>[root@rocky01 ~]<span class="hljs-comment"># touch /etc/pki/CA/index.txt</span><br><span class="hljs-comment">#指定第一个颁发证书的序列号</span><br>[root@rocky01 ~]<span class="hljs-comment"># echo 01 &gt; /etc/pki/CA/serial</span><br></code></pre></td></tr></table></figure>

<h4 id="（4）查看证书中的信息-状态"><a href="#（4）查看证书中的信息-状态" class="headerlink" title="（4）查看证书中的信息/状态"></a>（4）查看证书中的信息/状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看证书信息</span><br>openssl x509 -<span class="hljs-keyword">in</span> /PATH/FROM/CERT_FILE -noout   -text|issuer|subject|serial|dates<br>或<br><span class="hljs-built_in">cat</span> /etc/pki/CA/certs/*.crt<br><br><span class="hljs-comment">#查看指定编号的证书状态</span><br>openssl ca -status SERIAL<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-3-吊销证书"><a href="#3-3-吊销证书" class="headerlink" title="3.3 吊销证书"></a>3.3 吊销证书</h3><h4 id="（1）吊销证书"><a href="#（1）吊销证书" class="headerlink" title="（1）吊销证书"></a>（1）吊销证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 CA]<span class="hljs-comment"># openssl ca -status 01</span><br>Using configuration from /etc/pki/tls/openssl.cnf<br>01=Valid (V)<br>[root@rocky01 CA]<span class="hljs-comment"># openssl ca -revoke /etc/pki/CA/newcerts/01.pem</span><br>Using configuration from /etc/pki/tls/openssl.cnf<br>Revoking Certificate 01.<br>Data Base Updated<br>[root@rocky01 CA]<span class="hljs-comment"># openssl ca -status 01</span><br>Using configuration from /etc/pki/tls/openssl.cnf<br>01=Revoked (R)<br></code></pre></td></tr></table></figure>

<h4 id="（2）生成吊销列表"><a href="#（2）生成吊销列表" class="headerlink" title="（2）生成吊销列表"></a>（2）生成吊销列表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 CA]<span class="hljs-comment"># echo 01 &gt; /etc/pki/CA/crlnumber</span><br></code></pre></td></tr></table></figure>

<h4 id="（3）更新证书吊销列表"><a href="#（3）更新证书吊销列表" class="headerlink" title="（3）更新证书吊销列表"></a>（3）更新证书吊销列表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 CA]<span class="hljs-comment"># openssl ca -gencrl -out /etc/pki/CA/crl.pem</span><br>Using configuration from /etc/pki/tls/openssl.cnf<br></code></pre></td></tr></table></figure>

<h4 id="（4）查看crl吊销文件"><a href="#（4）查看crl吊销文件" class="headerlink" title="（4）查看crl吊销文件"></a>（4）查看crl吊销文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 CA]<span class="hljs-comment"># openssl crl -in /etc/pki/CA/crl.pem -noout -text</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-4-CentOS7-创建自签名证书"><a href="#3-4-CentOS7-创建自签名证书" class="headerlink" title="3.4 CentOS7 创建自签名证书"></a>3.4 CentOS7 创建自签名证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#进到/etc/pki/tls/certs目录下，mkae</span><br>[root@centos7 ~]<span class="hljs-comment">#cd /etc/pki/tls/certs</span><br>[root@centos7 certs]<span class="hljs-comment">#make</span><br>This makefile allows you to create:<br> o public/private key pairs<br> o SSL certificate signing requests (CSRs)<br> o self-signed SSL <span class="hljs-built_in">test</span> certificates<br> ...省略...<br></code></pre></td></tr></table></figure>

<hr>
<h1 id="-1"><a href="#-1" class="headerlink" title=""></a></h1><h1 id="三、ssh服务"><a href="#三、ssh服务" class="headerlink" title="三、ssh服务"></a>三、ssh服务</h1><h2 id="1-ssh服务介绍"><a href="#1-ssh服务介绍" class="headerlink" title="1 ssh服务介绍"></a>1 ssh服务介绍</h2><p>ssh: secure shell protocol, 22/tcp, <strong>安全的远程登录，实现加密通信，代替传统的 telnet 协议</strong></p>
<h3 id="1-1-公钥交换原理"><a href="#1-1-公钥交换原理" class="headerlink" title="1.1 公钥交换原理"></a>1.1 公钥交换原理</h3><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018142750302-1970532597.png"><img src="2927659-20221018142750302-1970532597.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<ul>
<li>客户端发起链接请求</li>
<li>服务端返回自己的公钥，以及一个会话ID（这一步客户端得到服务端公钥）</li>
<li>客户端生成密钥对</li>
<li>客户端用自己的公钥异或会话ID，计算出一个值Res，并用服务端的公钥加密</li>
<li>客户端发送加密后的值到服务端，服务端用私钥解密，得到Res</li>
<li>服务端用解密后的值Res异或会话ID，计算出客户端的公钥（这一步服务端得到客户端公钥）</li>
<li>最终：双方各自持有三个秘钥，分别为自己的一对公、私钥，以及对方的公钥，之后的所有通讯都会被加密</li>
</ul>
</blockquote>
<h3 id="1-2-ssh加密通讯原理"><a href="#1-2-ssh加密通讯原理" class="headerlink" title="1.2 ssh加密通讯原理"></a>1.2 ssh加密通讯原理</h3><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018143055616-1558234375.png"><img src="2927659-20221018143055616-1558234375.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<hr>
<h2 id="2-openssh-服务"><a href="#2-openssh-服务" class="headerlink" title="2 openssh 服务"></a>2 openssh 服务</h2><blockquote>
<p>OpenSSH是SSH （Secure SHell） 协议的免费开源实现，一般在各种Linux版本中会默认安装，基于C/S结构</p>
<p>Openssh软件相关包：</p>
<ul>
<li>openssh</li>
<li>openssh-clients</li>
<li>openssh-server</li>
</ul>
<p>服务器端程序：/usr/sbin/sshd</p>
<p>Unit 文件：/usr/lib/systemd/system/sshd.service</p>
<p>客户端：</p>
<ul>
<li>Linux Client: ssh, scp, sftp，slogin</li>
<li>Windows Client：xshell, MobaXterm,putty, securecrt, sshsecureshellclient</li>
</ul>
</blockquote>
<h3 id="2-1-客户端-ssh命令"><a href="#2-1-客户端-ssh命令" class="headerlink" title="2.1 客户端 ssh命令"></a>2.1 客户端 ssh命令</h3><blockquote>
<p>ssh命令是ssh客户端，允许实现对远程系统经验证地加密安全访问</p>
<p>当用户远程连接ssh服务器时，会复制ssh服务器/etc/ssh/ssh_host<em>key.pub文件中的公钥到客户机的</em>*~/.ssh/know_hosts**中。下次连接时，会自动匹配相对应的私钥，不能匹配，将拒绝连接</p>
</blockquote>
<p>ssh客户端配置文件：<code> /etc/ssh/ssh_config</code></p>
<h4 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh [user@]host [COMMAND]<br>ssh [-l user] host [COMMAND]<br></code></pre></td></tr></table></figure>

<h4 id="范例：禁止首次连接的询问过程"><a href="#范例：禁止首次连接的询问过程" class="headerlink" title="范例：禁止首次连接的询问过程"></a>范例：禁止首次连接的询问过程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#/etc/ssh/ssh_config 文件修改</span><br><span class="hljs-comment">#首次登录不显示检查提示</span><br>StrictHostKeyChecking no<br></code></pre></td></tr></table></figure>

<blockquote>
<p> 常见选项</p>
<ul>
<li>-p port #远程服务器监听的端口</li>
<li>-b #指定连接的源IP</li>
<li>-v #调试模式</li>
<li>-C #压缩方式</li>
<li>-X #支持x11转发</li>
<li>-t #强制伪tty分配，如：ssh -t remoteserver1 ssh -t remoteserver2  ssh  remoteserver3</li>
<li>-o option  如：-o StrictHostKeyChecking=no</li>
<li>-i <file>  #指定私钥文件路径，实现基于key验证，默认使用文件： <del>/.ssh/id_dsa,</del>/.ssh/id_ecdsa, <del>/.ssh/id_ed25519，</del>/.ssh/id_rsa等</li>
</ul>
</blockquote>
<h4 id="范例：远程执行命令"><a href="#范例：远程执行命令" class="headerlink" title="范例：远程执行命令"></a>范例：远程执行命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># ssh 10.0.0.128 cat /etc/hosts</span><br>root@10.0.0.128<span class="hljs-string">&#x27;s password:</span><br><span class="hljs-string">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="hljs-string">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br></code></pre></td></tr></table></figure>

<h4 id="范例：在远程主机运行本地shell脚本"><a href="#范例：在远程主机运行本地shell脚本" class="headerlink" title="范例：在远程主机运行本地shell脚本"></a>范例：在远程主机运行本地shell脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># hostname -I</span><br>10.0.0.8<br>[root@centos8 ~]<span class="hljs-comment"># cat test.sh </span><br><span class="hljs-comment">#!/bin/bash</span><br>hostname -I<br><br>[root@centos8 ~]<span class="hljs-comment"># ssh 10.0.0.18 /bin/bash &lt; test.sh </span><br>root@10.0.0.18<span class="hljs-string">&#x27;s password: </span><br><span class="hljs-string">10.0.0.18</span><br></code></pre></td></tr></table></figure>

<p><strong>范例：统计ssh登录失败次数最多的前十个远程IP</strong></p>
<p><strong>注：此命令可用于检测是否有黑客尝试破解你的服务器密码</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># lastb | awk &#x27;&#123;print $3&#125;&#x27;|sort |uniq -c|sort -nr|head</span><br>      3 10.0.0.128<br>      1 Sat<br>      1<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="2-2-其它ssh客户端工具"><a href="#2-2-其它ssh客户端工具" class="headerlink" title="2.2 其它ssh客户端工具"></a>2.2 其它ssh客户端工具</h3><h4 id="2-2-1-scp-命令"><a href="#2-2-1-scp-命令" class="headerlink" title="2.2.1 scp 命令"></a>2.2.1 scp 命令</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">scp <span class="hljs-selector-attr">[options]</span> <span class="hljs-attribute">SRC</span>... DEST/<br></code></pre></td></tr></table></figure>

<blockquote>
<p>常用选项</p>
<ul>
<li>-C 压缩数据流</li>
<li><strong>-r 递归复制</strong></li>
<li><strong>-p 保持原文件的属性信息</strong></li>
<li>-q 静默模式</li>
<li>-P PORT 指明remote host的监听的端口</li>
</ul>
</blockquote>
<h4 id="2-2-2-rsync-命令"><a href="#2-2-2-rsync-命令" class="headerlink" title="2.2.2 rsync 命令"></a>2.2.2 rsync 命令</h4><p>rsync工具可以基于ssh和rsync协议实现高效率的远程系统之间复制文件，使用安全的shell连接做为传输方式，<strong>比scp更快，基于增量数据同步，即只复制两方不同的文件</strong>，此工具来自于rsync包</p>
<p>注意：通信两端主机都需要安装 rsync 软件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">rsync -av /etc  server1:/tmp/ <span class="hljs-comment">#复制目录和目录下文件</span><br>rsync -av /etc/ server1:/tmp/ <span class="hljs-comment">#只复制目录下文件</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>常用选项</p>
<ul>
<li>-n 模拟复制过程</li>
<li><strong>-v 显示详细过程</strong></li>
<li>-r 递归复制目录树</li>
<li><strong>-p 保留权限</strong></li>
<li>-t 保留修改时间戳</li>
<li>-g 保留组信息</li>
<li>-o 保留所有者信息</li>
<li>-l 将软链接文件本身进行复制（默认）</li>
<li>-L 将软链接文件指向的文件复制</li>
<li>-u 如果接收者的文件比发送者的文件较新，将忽略同步</li>
<li>-z 压缩，节约网络带宽</li>
<li>-a 存档，相当于-rlptgoD，但不保留ACL（-A）和SELinux属性（-X）</li>
<li>–delete 源数据删除，目标数据也自动同步删除</li>
<li>–progress 显示进度</li>
<li>–bwlimit=5120 #限速以KB为单位,5120表示5MB</li>
</ul>
</blockquote>
<hr>
<h4 id="2-2-3-sshpass自动登录-ssh工具"><a href="#2-2-3-sshpass自动登录-ssh工具" class="headerlink" title="2.2.3 sshpass自动登录 ssh工具"></a>2.2.3 sshpass自动登录 ssh工具</h4><blockquote>
<p>由EPEL源提供，ssh登陆不能在命令行中指定密码。sshpass的出现，解决了这一问题。sshpass用于非交互SSH的密码验证，一般用在sh脚本中，无须再次输入密码（本机known_hosts文件中有的主机才能生效）。它允许你<strong>用 -p 参数指定明文密码</strong>，然后直接登录远程服务器，它支持密码从命令行、文件、环境变量中读取。</p>
<p>常见选项</p>
<ul>
<li>-p password #后跟密码它允许你用 -p 参数指定明文密码，然后直接登录远程服务器</li>
<li>-f filename #后跟保存密码的文件名，密码是文件内容的第一行</li>
<li>-e #将环境变量SSHPASS作为密码</li>
</ul>
</blockquote>
<h5 id="格式-1"><a href="#格式-1" class="headerlink" title="格式"></a>格式</h5><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">sshpass [<span class="hljs-keyword">option</span>] <span class="hljs-keyword">command</span> parameters<br></code></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># sshpass -p 000000 ssh -o StrictHostKeyChecking=no 10.0.0.128</span><br>Activate the web console with: systemctl <span class="hljs-built_in">enable</span> --now cockpit.socket<br><br>Last login: Tue Oct 18 12:55:16 2022 from 10.0.0.1<br></code></pre></td></tr></table></figure>

<h5 id="范例：批量修改多台主机的root密码为随机密码"><a href="#范例：批量修改多台主机的root密码为随机密码" class="headerlink" title="范例：批量修改多台主机的root密码为随机密码"></a>范例：批量修改多台主机的root密码为随机密码</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># cat change_root_password.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><br><span class="hljs-comment">#******************************************************</span><br><span class="hljs-comment"># Author:          会不会有那么一天</span><br><span class="hljs-comment"># E-mail:          willoneday@qq.com</span><br><span class="hljs-comment"># Date:            2022-10-18</span><br><span class="hljs-comment"># FileName:        change_root_password.sh</span><br><span class="hljs-comment"># Version:         1.0.0</span><br><span class="hljs-comment"># Description:     The test script</span><br><span class="hljs-comment"># BLOG:            https://www.cnblogs.com/Willoneday</span><br><span class="hljs-comment">#******************************************************</span><br><br>rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass<br><span class="hljs-built_in">export</span> SSHPASS=123456<br>NET=10.0.0<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &#123;1..254&#125;;<span class="hljs-keyword">do</span><br>    &#123;<br>        PASS=`openssl rand -<span class="hljs-built_in">base64</span> 9`<br>        sshpass -e ssh  -o  StrictHostKeyChecking=no <span class="hljs-variable">$NET</span>.<span class="hljs-variable">$i</span> <span class="hljs-string">&quot;echo <span class="hljs-variable">$PASS</span>|passwd --stdin root &amp;&gt; /dev/null&quot;</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-variable">$NET</span>.<span class="hljs-variable">$i</span>:<span class="hljs-variable">$PASS</span> &gt;&gt; host.txt<br>    &#125;&amp;<br><span class="hljs-keyword">done</span><br><span class="hljs-built_in">wait</span><br></code></pre></td></tr></table></figure>

<h5 id="范例：批量部署多台主机基于key验证脚本"><a href="#范例：批量部署多台主机基于key验证脚本" class="headerlink" title="范例：批量部署多台主机基于key验证脚本"></a>范例：批量部署多台主机基于key验证脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># cat sshpass.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><br><span class="hljs-comment">#******************************************************</span><br><span class="hljs-comment"># Author:          会不会有那么一天</span><br><span class="hljs-comment"># E-mail:          willoneday@qq.com</span><br><span class="hljs-comment"># Date:            2022-10-18</span><br><span class="hljs-comment"># FileName:        sshpass.sh</span><br><span class="hljs-comment"># Version:         1.0.0</span><br><span class="hljs-comment"># Description:     The test script</span><br><span class="hljs-comment"># BLOG:            https://www.cnblogs.com/Willoneday</span><br><span class="hljs-comment">#******************************************************</span><br><br><span class="hljs-comment">#!/bin/bash</span><br>NET=10.0.0<br>PASS=123456<br><br>ssh-keygen  -P <span class="hljs-string">&quot;&quot;</span>  -f /root/.ssh/id_rsa &amp;&gt; /dev/null<br>rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass &amp;&gt; /dev/null<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &#123;1..100&#125;;<span class="hljs-keyword">do</span><br>&#123;<br>    sshpass  -p <span class="hljs-variable">$PASS</span> ssh-copy-id -o  StrictHostKeyChecking=no -i /root/.ssh/id_rsa.pub <span class="hljs-variable">$NET</span>.<span class="hljs-variable">$i</span> &amp;&gt; /dev/null<br>&#125;&amp;<br><span class="hljs-keyword">done</span><br><span class="hljs-built_in">wait</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="2-3-ssh登录验证方式介绍"><a href="#2-3-ssh登录验证方式介绍" class="headerlink" title="2.3 ssh登录验证方式介绍"></a>2.3 ssh登录验证方式介绍</h3><blockquote>
<p>ssh服务登录的常用验证方式</p>
<ul>
<li>用户/口令</li>
<li>基于密钥</li>
</ul>
</blockquote>
<h4 id="基于用户和口令登录验证"><a href="#基于用户和口令登录验证" class="headerlink" title="基于用户和口令登录验证"></a>基于用户和口令登录验证</h4><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018150700752-1300345871.png"><img src="2927659-20221018150700752-1300345871.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<ol>
<li>客户端发起ssh请求，服务器会把自己的公钥发送给用户</li>
<li>用户会根据服务器发来的公钥对密码进行加密</li>
<li>加密后的信息回传给服务器，服务器用自己的私钥解密，如果密码正确，则用户登录成功</li>
</ol>
</blockquote>
<h4 id="基于密钥的登录方式"><a href="#基于密钥的登录方式" class="headerlink" title="基于密钥的登录方式"></a>基于密钥的登录方式</h4><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018150738804-1476474728.png"><img src="2927659-20221018150738804-1476474728.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<ol>
<li>首先在客户端生成一对密钥（ssh-keygen）</li>
<li>并将客户端的公钥ssh-copy-id 拷贝到服务端</li>
<li>当客户端再次发送一个连接请求，包括ip、用户名</li>
<li>服务端得到客户端的请求后，会到authorized_keys中查找，如果有响应的IP和用户，就会随机生成一个字符串</li>
<li>服务端将使用客户端拷贝过来的公钥进行加密，然后发送给客户端</li>
<li>得到服务端发来的消息后，客户端会使用私钥进行解密，然后将解密后的字符串发送给服务端</li>
<li>服务端接受到客户端发来的字符串后，跟之前的字符串进行对比，如果一致，就允许免密码登录</li>
</ol>
</blockquote>
<hr>
<h3 id="2-4-实现基于密钥的登录方式"><a href="#2-4-实现基于密钥的登录方式" class="headerlink" title="2.4 实现基于密钥的登录方式"></a>2.4 实现基于密钥的登录方式</h3><h4 id="在客户端生成密钥对"><a href="#在客户端生成密钥对" class="headerlink" title="在客户端生成密钥对"></a><strong>在客户端生成密钥对</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-keygen -t rsa [-P <span class="hljs-string">&#x27;password&#x27;</span>] [-f “~/.ssh/id_rsa<span class="hljs-string">&quot;]</span><br></code></pre></td></tr></table></figure>

<h4 id="把公钥文件传输至远程服务器对应用户的家目录"><a href="#把公钥文件传输至远程服务器对应用户的家目录" class="headerlink" title="把公钥文件传输至远程服务器对应用户的家目录"></a>把公钥文件传输至远程服务器对应用户的家目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-copy-id [-i [identity_file]] [user@]host<br></code></pre></td></tr></table></figure>

<h4 id="重设私钥口令"><a href="#重设私钥口令" class="headerlink" title="重设私钥口令"></a>重设私钥口令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-keygen -p<br></code></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#对私钥加密</span><br>[root@centos8 ~]<span class="hljs-comment"># ssh-keygen -p</span><br>Enter file <span class="hljs-keyword">in</span> <span class="hljs-built_in">which</span> the key is (/root/.ssh/id_rsa): <br>Key has comment <span class="hljs-string">&#x27;root@centos8&#x27;</span><br>Enter new passphrase (empty <span class="hljs-keyword">for</span> no passphrase): <br>Enter same passphrase again: <br>Your identification has been saved with the new passphrase.<br>[root@centos8 ~]<span class="hljs-comment"># ssh 10.0.0.7</span><br>Enter passphrase <span class="hljs-keyword">for</span> key <span class="hljs-string">&#x27;/root/.ssh/id_rsa&#x27;</span>: <span class="hljs-comment">#输入私钥的密码</span><br>Last login: Fri May 22 08:47:50 2020 from 10.0.0.8<br>[root@centos7 ~]<span class="hljs-comment"># exit</span><br><span class="hljs-built_in">logout</span><br>Connection to 10.0.0.7 closed.<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="2-5-ssh服务器配置"><a href="#2-5-ssh服务器配置" class="headerlink" title="2.5 ssh服务器配置"></a>2.5 ssh服务器配置</h3><blockquote>
<p>服务器端：sshd</p>
<p>服务器端的配置文件: /etc/ssh/sshd_config</p>
<p>服务器端的配置文件帮助：man 5 sshd_config</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#常用参数：</span><br>Port  22     <span class="hljs-comment">#生产建议修改</span><br>ListenAddress ip<br>LoginGraceTime 2m<br>PermitRootLogin <span class="hljs-built_in">yes</span> <span class="hljs-comment">#默认ubuntu不允许root远程ssh登录</span><br>StrictModes <span class="hljs-built_in">yes</span>   <span class="hljs-comment">#检查.ssh/文件的所有者，权限等</span><br>MaxAuthTries   6     <span class="hljs-comment">#pecifies the maximum number of authentication </span><br>attempts permitted per connection. Once the number of failures reaches half this <br>value, additional failures are logged. The default is 6.<br>MaxSessions  10         <span class="hljs-comment">#同一个连接最大会话</span><br>PubkeyAuthentication <span class="hljs-built_in">yes</span>     <span class="hljs-comment">#基于key验证</span><br>PermitEmptyPasswords no      <span class="hljs-comment">#空密码连接</span><br>PasswordAuthentication <span class="hljs-built_in">yes</span>   <span class="hljs-comment">#基于用户名和密码连接</span><br>GatewayPorts no<br>ClientAliveInterval 10 <span class="hljs-comment">#单位:秒</span><br>ClientAliveCountMax 3 <span class="hljs-comment">#默认3</span><br>UseDNS <span class="hljs-built_in">yes</span> <span class="hljs-comment">#提高速度可改为no</span><br>GSSAPIAuthentication <span class="hljs-built_in">yes</span> <span class="hljs-comment">#提高速度可改为no</span><br>MaxStartups    <span class="hljs-comment">#未认证连接最大值，默认值10</span><br>Banner /path/file<br><br><span class="hljs-comment">#以下可以限制可登录用户的办法：</span><br>AllowUsers user1 user2 user3<br>DenyUsers user1 user2 user3<br>AllowGroups g1 g2<br>DenyGroups g1 g2<br></code></pre></td></tr></table></figure>

<h4 id="范例：解决ssh登录缓慢的问题"><a href="#范例：解决ssh登录缓慢的问题" class="headerlink" title="范例：解决ssh登录缓慢的问题"></a>范例：解决ssh登录缓慢的问题</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/ssh/sshd_config<br>UseDNS no<br>GSSAPIAuthentication no<br>systemctl restart sshd<br></code></pre></td></tr></table></figure>

<hr>
<h1 id="-2"><a href="#-2" class="headerlink" title=""></a></h1><h1 id="四、利用-sudo-实现授权"><a href="#四、利用-sudo-实现授权" class="headerlink" title="四、利用 sudo 实现授权"></a>四、利用 sudo 实现授权</h1><h2 id="1-sudo-介绍"><a href="#1-sudo-介绍" class="headerlink" title="1 sudo 介绍"></a>1 sudo 介绍</h2><blockquote>
<p>sudo 即superuser do，允许系统管理员让普通用户执行一些或者全部的root命令的一个工具，如halt，reboot，su等等。这样不仅减少了root用户的登录 和管理时间，同样也提高了安全性</p>
</blockquote>
<h2 id="2-sudo-组成"><a href="#2-sudo-组成" class="headerlink" title="2 sudo 组成"></a>2 sudo 组成</h2><p>包：sudo</p>
<p>配置文件：/etc/sudo.conf</p>
<p><strong>授权规则配置文件：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">/etc/sudoers<br>/etc/sudoers.d<br></code></pre></td></tr></table></figure>

<p>安全编辑授权规则文件和语法检查工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/sbin/visudo<br><br><span class="hljs-comment">#范例</span><br><span class="hljs-comment">#检查语法</span><br>visudo -c<br><br><span class="hljs-comment">#检查指定配置文件语法</span><br>visudo -f /etc/sudoers.d/test<br></code></pre></td></tr></table></figure>

<p>授权编辑规则文件的工具：/usr/bin/sudoedit</p>
<p>执行授权命令：/usr/bin/sudo</p>
<p>时间戳文件：/var/db/sudo</p>
<p>日志文件：/var/log/secure</p>
<h2 id="3-sudo-命令"><a href="#3-sudo-命令" class="headerlink" title="3 sudo 命令"></a>3 sudo 命令</h2><blockquote>
<p>sudo -i -u willoneday 切换身份功能和 su 相似,但不一样,sudo必须提前授权,而且要输入自已的密码</p>
<p>sudo [-u user] COMMAND</p>
<ul>
<li>-V 显示版本信息等配置信息</li>
<li><strong>-u user 默认为root</strong></li>
<li>-l,ll 列出用户在主机上可用的和被禁止的命令</li>
<li>-v 再延长密码有效期限5分钟,更新时间戳</li>
<li>-k 清除时间戳（1970-01-01），下次需要重新输密码</li>
<li>-K 与-k类似，还要删除时间戳文件</li>
<li>-b 在后台执行指令</li>
<li>-p 改变询问密码的提示符号 示例：-p “password on %h for user %p: “</li>
</ul>
</blockquote>
<h2 id="4-sudo-授权规则配置"><a href="#4-sudo-授权规则配置" class="headerlink" title="4 sudo 授权规则配置"></a>4 sudo 授权规则配置</h2><p>配置文件格式说明：/etc/sudoers, /etc/sudoers.d/</p>
<p>配置文件中支持使用通配符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">? 任意单一字符<br>* 匹配任意长度字符<br>[wxc] 匹配其中一个字符<br>[!wxc] 除了这三个字符的其它字符<br>\x 转义 <br>[[alpha]] 字母<br></code></pre></td></tr></table></figure>

<blockquote>
<p>配置文件规则有两类</p>
<p>1、别名定义：不是必须的</p>
<p>2、授权规则：必须的</p>
</blockquote>
<h3 id="sudoers-授权规则格式"><a href="#sudoers-授权规则格式" class="headerlink" title="sudoers 授权规则格式"></a>sudoers 授权规则格式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">用户 登入主机=(代表用户) 命令（绝对路径）<br>user host=(runas) <span class="hljs-built_in">command</span><br><br>user: 运行命令者的身份<br>host: 通过哪些主机<br>(runas)：以哪个用户的身份<br><span class="hljs-built_in">command</span>: 运行哪些命令<br><br><span class="hljs-comment">#范例</span><br>root ALL=(ALL) ALL<br></code></pre></td></tr></table></figure>

<blockquote>
<p> sudoers的别名</p>
<p>User和runas:</p>
<p>username</p>
<ul>
<li>#uid</li>
<li>%group_name</li>
<li>%#gid</li>
<li>user_alias|runas_alias</li>
</ul>
<p>host:</p>
<ul>
<li>ip或hostname</li>
<li>network(/netmask)</li>
<li>host_alias</li>
</ul>
<p>command:</p>
<ul>
<li>command name</li>
<li>directory</li>
<li>sudoedit</li>
<li>Cmnd_Alias</li>
</ul>
</blockquote>
<p>sudo别名有四种类型：</p>
<ul>
<li>User_Alias</li>
<li>Runas_Alias</li>
<li>Host_Alias</li>
<li>Cmnd_Alias</li>
</ul>
<p> 别名定义</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Alias_Type NAME1 = item1,item2,item3 : NAME2 = item4, item5<br></code></pre></td></tr></table></figure>

<h3 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">Student ALL=(ALL)   ALL<br>%wheel  ALL=(ALL)   ALL<br></code></pre></td></tr></table></figure>

<h3 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#bash -c 将后面所有信字符串作为整体进行sudo</span><br><span class="hljs-comment">#注意&quot;&quot;必须加,否则只授权 &gt;&gt; 前面的命令sudo </span><br>[rye@centos7 ~]$ sudo bash  -c <span class="hljs-string">&quot;echo 1.2.3.4 www.test.com &gt;&gt; /etc/hosts&quot;</span><br>[rye@centos7 ~]$ <span class="hljs-built_in">cat</span> /etc/hosts<br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 <br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>1.2.3.4 www.test.com<br></code></pre></td></tr></table></figure>

<h3 id="案例三"><a href="#案例三" class="headerlink" title="案例三"></a>案例三</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># su - rye</span><br>Last login: Sat Oct 15 23:16:52 CST 2022 on pts/2<br>[rye@rocky01 ~]$ mount /dev/sr0 /mnt<br>mount: only root can <span class="hljs-keyword">do</span> that<br>[rye@rocky01 ~]$ <span class="hljs-built_in">exit</span><br><span class="hljs-built_in">logout</span><br>[root@rocky01 ~]<span class="hljs-comment"># vim /etc/sudoers</span><br>[root@rocky01 ~]<span class="hljs-comment"># cat /etc/sudoers |grep rye</span><br>rye     ALL=(root) /usr/bin/mount<br>[root@rocky01 ~]<span class="hljs-comment"># su - rye</span><br>Last login: Tue Oct 18 16:11:09 CST 2022 on pts/2<br>[rye@rocky01 ~]$ sudo mount /dev/sr0 /mnt<br>[sudo] password <span class="hljs-keyword">for</span> rye:<br>mount: /mnt: WARNING: device write-protected, mounted read-only.<br></code></pre></td></tr></table></figure>

<hr>
<h1 id="-3"><a href="#-3" class="headerlink" title=""></a></h1><h1 id="五、PAM认证机制"><a href="#五、PAM认证机制" class="headerlink" title="五、PAM认证机制"></a>五、PAM认证机制</h1><h2 id="1-PAM-介绍"><a href="#1-PAM-介绍" class="headerlink" title="1 PAM 介绍"></a>1 PAM 介绍</h2><blockquote>
<p> PAM：Pluggable Authentication Modules，插件式的验证模块，Sun公司于1995 年开发的一种与认证相关的通用框架机制。PAM 只关注如何为服务验证用户的 API，通过提供一些动态链接库和一套统一的API，将系统提供的服务和该服务的认证方式分开，使得系统管理员可以灵活地根据需要给不同的服务配置不同的认证方式而无需更改服务程序一种认证框架，自身不做认证</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018161801212-865140516.png"><img src="2927659-20221018161801212-865140516.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h2 id="2-PAM相关文件"><a href="#2-PAM相关文件" class="headerlink" title="2 PAM相关文件"></a>2 PAM相关文件</h2><blockquote>
<ul>
<li>包名: pam</li>
<li>模块文件目录：**/lib64/security/*.so**</li>
<li>特定模块相关的设置文件：**/etc/security/**</li>
<li>应用程序调用PAM模块的配置文件<ul>
<li>主配置文件：**/etc/pam.conf**，默认不存在，一般不使用主配置</li>
<li>为每种应用模块提供一个专用的配置文件：/etc/pam.d/APP_NAME</li>
<li>注意：如/etc/pam.d存在，/etc/pam.conf将失效</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="3-PAM工作原理"><a href="#3-PAM工作原理" class="headerlink" title="3 PAM工作原理"></a>3 PAM工作原理</h2><blockquote>
<p>PAM认证一般遵循这样的顺序：Service(服务)→PAM(配置文件)→pam_*.so</p>
<p>PAM认证首先要确定那一项服务，然后加载相应的PAM的配置文件(位于/etc/pam.d下)，最后调用认证文件(位于/lib64/security下)进行安全认证</p>
</blockquote>
<h4 id="PAM认证过程示例"><a href="#PAM认证过程示例" class="headerlink" title="PAM认证过程示例"></a>PAM认证过程示例</h4><blockquote>
<ol>
<li>使用者执行/usr/bin/passwd 程序，并输入密码</li>
<li>passwd开始调用PAM模块，PAM模块会搜寻passwd程序的PAM相关设置文件，这个设置文件一般是在/etc/pam.d/里边的与程序同名的文件，即PAM会搜寻/etc/pam.d/passwd此设置文件</li>
<li>经由/etc/pam.d/passwd设定文件的数据，取用PAM所提供的相关模块来进行验证</li>
<li>将验证结果回传给passwd这个程序，而passwd这个程序会根据PAM回传的结果决定下一个动作（重新输入密码或者通过验证）</li>
</ol>
</blockquote>
<h2 id="4-PAM-配置文件格式说明"><a href="#4-PAM-配置文件格式说明" class="headerlink" title="4 PAM 配置文件格式说明"></a>4 PAM 配置文件格式说明</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#通用配置文件/etc/pam.conf格式,此格式不使用</span><br>application <span class="hljs-built_in">type</span> control module-path arguments<br><br><span class="hljs-comment">#专用配置文件/etc/pam.d/ 格式</span><br><span class="hljs-built_in">type</span> control module-path arguments<br><br>application：指服务名，如：telnet、login、ftp等，服务名字“OTHER”代表所有没有在该文件中明确配置的其它服务<br><span class="hljs-built_in">type</span>：指模块类型，即功能<br>control ：PAM库该如何处理与该服务相关的PAM模块的成功或失败情况，一个关健词实现<br>module-path： 用来指明本模块对应的程序文件的路径名<br>Arguments： 用来传递给该模块的参数<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>模块类型（<strong><strong>module-type</strong></strong>）</strong></p>
<ul>
<li>Auth 账号的认证和授权</li>
<li>Account 帐户的有效性，与账号管理相关的非认证类的功能，如：用来限制/允许用户对某个服务的访问时间，限制用户的位置(例如：root用户只能从控制台登录)</li>
<li>Password 用户修改密码时密码复杂度检查机制等功能</li>
<li>Session 用户会话期间的控制，如：最多打开的文件数，最多的进程数等</li>
<li>-type 表示因为缺失而不能加载的模块将不记录到系统日志,对于那些不总是安装在系统上的模块有用</li>
</ul>
<p><strong>Control</strong></p>
<ul>
<li>required ：一票否决，表示本模块必须返回成功才能通过认证，但是如果该模块返回失败，失败结果也不会立即通知用户，而是要等到同一type中的所有模块全部执行完毕，再将失败结果返回给应用程序，即为必要条件</li>
<li>requisite ：一票否决，该模块必须返回成功才能通过认证，但是一旦该模块返回失败，将不再执行同一type内的任何模块，而是直接将控制权返回给应用程序。是一个必要条件</li>
<li>sufficient ：一票通过，表明本模块返回成功则通过身份认证的要求，不必再执行同一type内的其它模块，但如果本模块返回失败可忽略，即为充分条件，优先于前面的required和requisite</li>
<li>optional ：表明本模块是可选的，它的成功与否不会对身份认证起关键作用，其返回值一般被忽略</li>
<li>include： 调用其他的配置文件中定义的配置信息</li>
</ul>
<p><strong>module-path</strong></p>
<ul>
<li>模块文件所在绝对路径：</li>
<li>模块文件所在相对路径：/lib64/security目录下的模块可使用相对路径，如：pam_shells.so、pam_limits.so</li>
<li>有些模块有自已的专有配置文件，在/etc/security/*.conf目 录下</li>
</ul>
<p><strong>Arguments</strong></p>
<ul>
<li> debug ：该模块应当用syslog( )将调试信息写入到系统日志文件中</li>
<li>no_warn ：表明该模块不应把警告信息发送给应用程序</li>
<li>use_first_pass ：该模块不能提示用户输入密码，只能从前一个模块得到输入密码</li>
<li>try_first_pass ：该模块首先用前一个模块从用户得到密码，如果该密码验证不通过，再提示用户输入新密码</li>
<li>use_mapped_pass 该模块不能提示用户输入密码，而是使用映射过的密码</li>
<li>expose_account 允许该模块显示用户的帐号名等信息，一般只能在安全的环境下使用，因为泄漏用户名会对安全造成一定程度的威胁</li>
</ul>
<p>注意：修改PAM配置文件将马上生效</p>
<p>建议：编辑pam规则时，保持至少打开一个root会话，以防止root身份验证错误</p>
</blockquote>
<h2 id="5-PAM模块帮助"><a href="#5-PAM模块帮助" class="headerlink" title="5 PAM模块帮助"></a>5 PAM模块帮助</h2><p><a target="_blank" rel="noopener" href="http://www.linux-pam.org/Linux-PAM-html/">官方在线文档</a></p>
<p><a target="_blank" rel="noopener" href="http://www.linux-pam.org/documentation/">官方离线文档</a></p>
<h2 id="6-常用PAM模块"><a href="#6-常用PAM模块" class="headerlink" title="6 常用PAM模块"></a>6 常用PAM模块</h2><h3 id="6-1-pam-nologin-so-模块"><a href="#6-1-pam-nologin-so-模块" class="headerlink" title="6.1 pam_nologin.so 模块"></a>6.1 pam_nologin.so 模块</h3><p>功能：如果/etc/nologin文件存在,将导致非root用户不能登陆,当该用户登陆时，会显示/etc/nologin文件内容，并拒绝登陆</p>
<p>范例: 默认此模块可以对ssh等登录有效,但不影响su登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 pam.d]<span class="hljs-comment"># grep pam_nologin *</span><br>cockpit:account    required     pam_nologin.so<br>login:account    required     pam_nologin.so<br>remote:account    required     pam_nologin.so<br>sshd:account    required     pam_nologin.so<br>vmtoolsd:account    required     pam_nologin.so<br></code></pre></td></tr></table></figure>

<h3 id="6-2-pam-limits-so-模块"><a href="#6-2-pam-limits-so-模块" class="headerlink" title="6.2 pam_limits.so 模块"></a>6.2 pam_limits.so 模块</h3><p>功能：在用户级别实现对其可使用的资源的限制，例如：可打开的文件数量，可运行的进程数量，可用内存空间</p>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018162950225-98900703.png"><img src="2927659-20221018162950225-98900703.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>修改限制的实现方式：</p>
<h4 id="1-ulimit命令"><a href="#1-ulimit命令" class="headerlink" title="(1) ulimit命令"></a>(1) ulimit命令</h4><p>ulimit是linux shell的内置命令，它具有一套参数集，用于对shell进程及其子进程进行资源限制。</p>
<p>ulimit的设定值是 per-process 的，也就是说，每个进程有自己的limits值。</p>
<p>使用ulimit进行修改，立即生效。</p>
<p>ulimit只影响shell进程及其子进程，用户登出后失效。</p>
<p>可以在profile中加入ulimit的设置，变相的做到永久生效。</p>
<blockquote>
<ul>
<li>-H 设置硬件资源限制.</li>
<li>-S 设置软件资源限制.</li>
<li>-a 显示当前所有的资源限制.</li>
<li>-c size:设置core文件的最大值.单位:blocks</li>
<li>-d size:设置数据段的最大值.单位:kbytes</li>
<li>-f size:设置创建文件的最大值.单位:blocks</li>
<li>-l size:设置在内存中锁定进程的最大值.单位:kbytes</li>
<li>-m size:设置可以使用的常驻内存的最大值.单位:kbytes</li>
<li>-n size:设置内核可以同时打开的文件描述符的最大值.单位:n</li>
<li>-p size:设置管道缓冲区的最大值.单位:kbytes</li>
<li>-s size:设置堆栈的最大值.单位:kbytes</li>
<li>-t size:设置CPU使用时间的最大上限.单位:seconds</li>
<li>-u size:最大用户进程数</li>
<li>-v size:设置虚拟内存的最大值.单位:kbytes</li>
<li>unlimited 是一个特殊值，用于表示不限制</li>
</ul>
<p>#说明</p>
<p>查询时，若不加H或S参数，默认显示的是软限制</p>
<p>修改时，若不加H或S参数，两个参数一起改变</p>
</blockquote>
<h4 id="2-配置文件"><a href="#2-配置文件" class="headerlink" title="(2) 配置文件"></a>(2) 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">/etc/security/limits.conf<br>/etc/security/limits.d/*.conf<br></code></pre></td></tr></table></figure>

<h5 id="格式-2"><a href="#格式-2" class="headerlink" title="格式"></a>格式</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#每行一个定义</span><br>&lt;domain&gt;       &lt;<span class="hljs-built_in">type</span>&gt; &lt;item&gt; &lt;value&gt;<br></code></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#应用于哪些对象</span><br>Username 单个用户<br>@group 组内所有用户<br>* 所有用户<br>% 仅用于限制 maxlogins <span class="hljs-built_in">limit</span> , 可以使用 %group 语法. 只用 % 相当于 * 对所有用户<br>maxsyslogins <span class="hljs-built_in">limit</span>限制. %group 表示限制此组中的所有用户总的最大登录数<br><br><span class="hljs-comment">#限制的类型</span><br>Soft 软限制,普通用户自己可以修改<br>Hard 硬限制,由root用户设定，且通过kernel强制生效<br>- 二者同时限定<br><br><span class="hljs-comment">#限制的资源</span><br>nofile 所能够同时打开的最大文件数量,默认为1024<br><span class="hljs-built_in">nproc</span> 所能够同时运行的进程的最大数量,默认为1024<br></code></pre></td></tr></table></figure>

<p>注意：systemd 的service 资源设置需要单独配置 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># /etc/security/limits.conf</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#This file sets the resource limits for the users logged in via PAM.</span><br><span class="hljs-comment">#It does not affect resource limits of the system services.</span><br>在Centos7以上版本中，使用Systemd替代了之前的SysV。/etc/security/limits.conf文件的配置作<br>用域缩小了。/etc/security/limits.conf的配置，只适用于通过PAM认证登录用户的资源限制，它对<br>systemd的service的资源限制不生效。因此登录用户的限制，通过/etc/security/limits.conf<br>与/etc/security/limits.d下的文件设置即可。<br>对于systemd service的资源设置，则需修改全局配置，全局配置文件放在/etc/systemd/system.conf<br>和/etc/systemd/user.conf，同时也会加载两个对应目录中的所有.conf文<br>件/etc/systemd/system.conf.d/*.conf和/etc/systemd/user.conf.d/*.conf。system.conf<br>是系统实例使用的，user.conf是用户实例使用的。<br>vim /etc/systemd/system.conf<br>DefaultLimitNOFILE=100000<br>DefaultLimitNPROC=65535<br>或者针对指定的service添加下面行<br>[Service]<br>LimitNOFILE=100000<br>LimitNPROC=65535<br></code></pre></td></tr></table></figure>

<h5 id="案例：系统的各种资源的默认值"><a href="#案例：系统的各种资源的默认值" class="headerlink" title="案例：系统的各种资源的默认值"></a>案例：系统的各种资源的默认值</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 pam.d]<span class="hljs-comment"># ulimit -a</span><br>core file size          (blocks, -c) 0<br>data seg size           (kbytes, -d) unlimited<br>scheduling priority             (-e) 0<br>file size               (blocks, -f) unlimited<br>pending signals                 (-i) 14661<br>max locked memory       (kbytes, -l) 64<br>max memory size         (kbytes, -m) unlimited<br>open files                      (-n) 1024<br>pipe size            (512 bytes, -p) 8<br>POSIX message queues     (bytes, -q) 819200<br>real-time priority              (-r) 0<br>stack size              (kbytes, -s) 8192<br>cpu time               (seconds, -t) unlimited<br>max user processes              (-u) 14661<br>virtual memory          (kbytes, -v) unlimited<br>file locks                      (-x) unlimited<br></code></pre></td></tr></table></figure>

<h5 id="案例：ulimit-命令修改用户打开的文件个数"><a href="#案例：ulimit-命令修改用户打开的文件个数" class="headerlink" title="案例：ulimit 命令修改用户打开的文件个数"></a>案例：ulimit 命令修改用户打开的文件个数</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 pam.d]<span class="hljs-comment"># ulimit -n</span><br>1024<br>[root@rocky01 pam.d]<span class="hljs-comment"># ulimit -n 1048577</span><br>-bash: <span class="hljs-built_in">ulimit</span>: open files: cannot modify <span class="hljs-built_in">limit</span>: Operation not permitted<br>[root@rocky01 pam.d]<span class="hljs-comment"># ulimit -n 1048576</span><br>[root@rocky01 pam.d]<span class="hljs-comment"># ulimit -n</span><br>1048576<br><br>[root@rocky01 pam.d]<span class="hljs-comment"># echo 2^20|bc</span><br>1048576<br></code></pre></td></tr></table></figure>

<h5 id="案例：限制用户最多打开的文件数和运行进程数，并持久保存"><a href="#案例：限制用户最多打开的文件数和运行进程数，并持久保存" class="headerlink" title="案例：限制用户最多打开的文件数和运行进程数，并持久保存"></a>案例：限制用户最多打开的文件数和运行进程数，并持久保存</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># cat /etc/pam.d/system-auth |grep pam_limits.so</span><br>session     required      pam_limits.so<br><br>vim /etc/security/limits.conf  <br><span class="hljs-comment">#用户apache可打开10240个文件</span><br>apache  - nofile 10240<br><span class="hljs-comment">#用户student不能运行超过20个进程</span><br>student hard <span class="hljs-built_in">nproc</span> 10<br><span class="hljs-comment">#用student登录多次运行bash，观察结果</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/security/limits.conf </span><br>rye          -     <span class="hljs-built_in">nproc</span>  5<br>rye          -     nofile 666666<br>[rye@rocky01 ~]$ <span class="hljs-built_in">ulimit</span>  -n<br>66666<br></code></pre></td></tr></table></figure>

<h5 id="生产案例"><a href="#生产案例" class="headerlink" title="生产案例"></a>生产案例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/security/limits.conf  <br>*    -   core       unlimited<br>*    -   <span class="hljs-built_in">nproc</span>       1000000<br>*    -   nofile      1000000<br>*    -   memlock     32000<br>*    -   msgqueue    8192000<br></code></pre></td></tr></table></figure>

<h3 id="6-3-pam-google-authenticator-模块"><a href="#6-3-pam-google-authenticator-模块" class="headerlink" title="6.3 pam_google_authenticator 模块"></a>6.3 pam_google_authenticator 模块</h3><p>功能：实现SSH登录的两次身份验证，先验证APP的数字码，再验证root用户的密码，都通过才可以登录。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/google/google-authenticator-android">官方网站</a></p>
<hr>
<h1 id="-4"><a href="#-4" class="headerlink" title=""></a></h1><h1 id="六、时间同步服务"><a href="#六、时间同步服务" class="headerlink" title="六、时间同步服务"></a>六、时间同步服务</h1><p>加密和安全当前都离不开时间的同步，否则各种网络服务可能不能正常运行</p>
<p>范例: 时间错误导致证书应用出错</p>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018164555746-1131565948.png"><img src="2927659-20221018164555746-1131565948.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h2 id="1-时间同步服务"><a href="#1-时间同步服务" class="headerlink" title="1 时间同步服务"></a>1 时间同步服务</h2><blockquote>
<p>多主机协作工作时，各个主机的时间同步很重要，时间不一致会造成很多重要应用的故障，如：加密协议，日志，集群等， 利用<strong>NTP（Network Time Protocol）</strong> 协议使网络中的各个计算机时间达到同步。</p>
<p><strong>目前NTP协议属于运维基础架构中必备的基本服务之一</strong></p>
</blockquote>
<p>时间同步软件实现：</p>
<ul>
<li>ntp</li>
<li>chrony</li>
</ul>
<p><strong>ntp：</strong></p>
<p>将系统时钟和世界协调时UTC同步，精度在局域网内可达0.1ms，在互联网上绝大多数的地方精度可以达到1-50ms</p>
<p><strong>chrony****：</strong></p>
<p>实现NTP协议的的自由软件。可使系统时钟与NTP服务器，参考时钟（例如GPS接收器）以及使用手表和键盘的手动输入进行同步。还可以作为NTPv4（RFC 5905）服务器和对等体运行，为网络中的计算机提供时间服务。设计用于在各种条件下良好运行，包括间歇性和高度拥挤的网络连接，温度变化（计算机时钟对温度敏感），以及不能连续运行或在虚拟机上运行的系统。</p>
<p>通过Internet同步的两台机器之间的典型精度在几毫秒之内，在LAN上，精度通常为几十微秒。利用硬件时间戳或硬件参考时钟，可实现亚微秒的精度</p>
<h2 id="2-chrony"><a href="#2-chrony" class="headerlink" title="2 chrony"></a>2 chrony</h2><h3 id="2-1-chrony-文件组成"><a href="#2-1-chrony-文件组成" class="headerlink" title="2.1 chrony 文件组成"></a>2.1 chrony 文件组成</h3><blockquote>
<p>包：chrony</p>
<p>两个主要程序：chronyd和chronyc</p>
<ul>
<li>chronyd：后台运行的守护进程，用于调整内核中运行的系统时钟和时钟服务器同步。它确定计算机增减时间的比率，并对此进行补偿</li>
<li>chronyc：命令行用户工具，用于监控性能并进行多样化的配置。它可以在chronyd实例控制的计算机上工作，也可在一台不同的远程计算机上工作</li>
</ul>
<p>服务unit 文件： /usr/lib/systemd/system/chronyd.service</p>
<p>监听端口： 服务端: 123/udp,客户端: 323/udp</p>
<p>配置文件： /etc/chrony.conf</p>
</blockquote>
<h3 id="2-2-配置文件chrony-conf"><a href="#2-2-配置文件chrony-conf" class="headerlink" title="2.2 配置文件chrony.conf"></a>2.2 配置文件chrony.conf</h3><blockquote>
<p><strong>server  #可用于时钟服务器，iburst 选项当服务器可达时</strong>，发送一个八个数据包而不是通常的一个数据包。 包间隔通常为2秒,<strong>可加快初始同步速度</strong></p>
<p>pool   #该指令的语法与server 指令的语法相似，不同之处在于它用于指定NTP服务器池而不是单个NTP服务器。池名称应解析为随时间可能会变化的多个地址</p>
<p>driftfile #根据实际时间计算出计算机增减时间的比率，将它记录到一个文件中，会在重启后为系统时钟作出补偿</p>
<p>rtcsync  #启用内核模式，系统时间每11分钟会拷贝到实时时钟（RTC）</p>
<p><strong>allow / deny #指定一台主机、子网，或者网络以允许或拒绝访问本服务器</strong></p>
<p>cmdallow / cmddeny #可以指定哪台主机可以通过chronyd使用控制命令</p>
<p>bindcmdaddress #允许chronyd监听哪个接口来接收由chronyc执行的命令</p>
<p>makestep # 通常chronyd将根据需求通过减慢或加速时钟，使得系统逐步纠正所有时间偏差。在某些特定情况下，系统时钟可能会漂移过快，导致该调整过程消耗很长的时间来纠正系统时钟。该指令强制chronyd在调整期大于某个阀值时调整系统时钟</p>
<p><strong>local stratum 10  #即使server指令中时间服务器不可用，也允许将本地时间作为标准时间授时给其它客户端</strong></p>
</blockquote>
<h3 id="2-3-NTP-客户端工具"><a href="#2-3-NTP-客户端工具" class="headerlink" title="2.3 NTP 客户端工具"></a>2.3 NTP 客户端工具</h3><p>chronyc 可以运行在交互式和非交互式两种方式，支持以下子命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">help</span> 命令可以查看更多chronyc的交互命令<br>accheck 检查是否对特定主机可访问当前服务器<br>activity 显示有多少NTP源在线/离线<br>sources [-v]   显示当前时间源的同步信息<br>sourcestats [-v]显示当前时间源的同步统计信息<br>add server 手动添加一台新的NTP服务器<br>clients 报告已访问本服务器的客户端列表<br>delete 手动移除NTP服务器或对等服务器<br>settime 手动设置守护进程时间<br>tracking 显示系统时间信息<br></code></pre></td></tr></table></figure>

<h3 id="2-4-时间工具"><a href="#2-4-时间工具" class="headerlink" title="2.4 时间工具"></a>2.4 时间工具</h3><p><strong>timedatectl 时间和时区管理</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看日期时间、时区及NTP状态：</span><br>timedatectl<br><br><span class="hljs-comment">#查看时区列表：</span><br>timedatectl list-timezones<br><br><span class="hljs-comment">#修改时区：</span><br>timedatectl set-timezone Asia/Shanghai<br><br><span class="hljs-comment">#修改时区</span><br>root@ubuntu2004:~<span class="hljs-comment"># rm -f /etc/localtime</span><br>root@ubuntu2004:~<span class="hljs-comment"># ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><br><span class="hljs-comment">#修改日期时间：</span><br>timedatectl set-time <span class="hljs-string">&quot;2017-01-23 10:30:00&quot;</span><br><br><span class="hljs-comment">#开启NTP：</span><br>timedatectl set-ntp <span class="hljs-literal">true</span>/false<br></code></pre></td></tr></table></figure>

<p><strong>ntpdate 时间同步命令,CentOS8版本此命令已淘汰</strong></p>
<p><strong>system-config-date：图形化配置chrony服务的工具</strong></p>
<hr>
<h3 id="实战案例-实现私有的时间服务器"><a href="#实战案例-实现私有的时间服务器" class="headerlink" title="实战案例: 实现私有的时间服务器"></a>实战案例: 实现私有的时间服务器</h3><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018165556743-1856795570.png"><img src="2927659-20221018165556743-1856795570.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#服务器端配置</span><br>[root@centos8 ~]<span class="hljs-comment">#hostname -I</span><br>10.0.0.8 <br>[root@centos8 ~]<span class="hljs-comment">#yum -y install chrony</span><br><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/chrony.conf</span><br>server ntp.aliyun.com iburst<br>server ntp1.aliyun.com iburst<br>server ntp2.aliyun.com iburst<br><br><span class="hljs-comment">#allow 192.168.0.0/16</span><br>allow 0.0.0.0/0  <span class="hljs-comment">#加此行,指定允许同步的网段</span><br><br><span class="hljs-built_in">local</span> stratum 10 <span class="hljs-comment">#删除此行注释,当互联网无法连接,仍然可以为客户端提供时间同步服务</span><br><br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart chronyd</span><br><span class="hljs-comment">#服务启动后会打开端口123/udp</span><br>[root@centos8 ~]<span class="hljs-comment">#ss -ntlu</span><br><br><span class="hljs-comment">#客户端配置</span><br>[root@centos7 ~]<span class="hljs-comment">#vim /etc/chrony.conf</span><br>server 10.0.0.8 iburst<br>[root@centos7 ~]<span class="hljs-comment">#systemctl restart chronyd.service </span><br><span class="hljs-comment">#确认同步成功</span><br>[root@centos7 ~]<span class="hljs-comment">#chronyc sources -vn</span><br></code></pre></td></tr></table></figure>

<h1 id="一、域名系统-DNS"><a href="#一、域名系统-DNS" class="headerlink" title="一、域名系统 DNS"></a>一、域名系统 DNS</h1><h2 id="1-名字解析介绍和DNS"><a href="#1-名字解析介绍和DNS" class="headerlink" title="1 名字解析介绍和DNS"></a>1 名字解析介绍和DNS</h2><blockquote>
<p>当前TCP/IP网络中的设备之间进行通信，是利用和依赖于IP地址实现的。但数字形式的IP地址是很难记忆的。当网络设备众多，想要记住每个设备的IP地址，可以说是”不可能完成的任务”。那么如何解决这一难题呢？我们可以给每个网络设备起一个友好的名称，如：<a href="http://www.willoneday.org，这种由文字组成的名称，显而易见要更容易记忆。但是计算机不会理解这种名称的，我们可以**利用一种名字解析服务将名称转化成（解析）成IP地址**。从而我们就可以利用名称来直接访问网络中设备了。除此之外还有一个重要功能，利用名称解析服务可以实现主机和IP的解耦，即：当主机IP变化时，只需要修改名称服务即可，用户仍可以通过原有的名称进行访问而不受影响。">www.willoneday.org，这种由文字组成的名称，显而易见要更容易记忆。但是计算机不会理解这种名称的，我们可以**利用一种名字解析服务将名称转化成（解析）成IP地址**。从而我们就可以利用名称来直接访问网络中设备了。除此之外还有一个重要功能，利用名称解析服务可以实现主机和IP的解耦，即：当主机IP变化时，只需要修改名称服务即可，用户仍可以通过原有的名称进行访问而不受影响。</a></p>
</blockquote>
<p>实现此服务的方法是多样的。如下面所述：</p>
<p>本地名称解析配置文件：hosts</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">Linux: /etc/hosts<br>windows: %WINDIR%/system32/drivers/etc/hosts<br><span class="hljs-comment">#格式</span><br>122.10.117.2 www.willoneday.org. www<br>93.46.8.89   www.google.com. google<br></code></pre></td></tr></table></figure>

<p>DNS：Domain Name System 域名系统,应用层协议,是互联网的一项服务。它作为将域名和IP地址相互映射的一个分布式数据库，能够使人更方便地访问互联网,基于C/S架构，服务器端：53/udp, 53/tcp</p>
<p><strong>TCP53端口可以用于数据库的主从同步</strong><br><strong>UDP53端口用于客户端向服务端的查询和数据库的主从同步</strong></p>
<p>BIND：Bekerley Internet Name Domain,由 ISC （<a target="_blank" rel="noopener" href="http://www.isc.org)提供的dns软件实现dns域名结构/">www.isc.org）提供的DNS软件实现DNS域名结构</a></p>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221018235908851-2085796555.png"><img src="2927659-20221018235908851-2085796555.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<ul>
<li>根域: 全球根服务器节点只有13个,10个在美国，1个荷兰，1个瑞典，1个日本</li>
<li>一级域名：顶级域（Top Level Domain: tld）</li>
</ul>
<p>   三类：组织域、国家域(.cn, .ca, .hk, .tw)、反向域</p>
<p>   com, edu, mil, gov, net, org, int,arpa</p>
<ul>
<li>二级域名：willoneday.com</li>
<li>三级域名：study.willoneday.com</li>
<li>最多可达到127级域名</li>
</ul>
</blockquote>
<p>ICANN（The Internet Corporation for Assigned Names and Numbers）互联网名称与数字地址分配机构，负责在全球范围内对互联网通用顶级域名（gTLD）以及国家和地区顶级域名（ccTLD）系统的管理、以及根服务器系统的管理</p>
<hr>
<h3 id="1-1-DNS服务工作原理"><a href="#1-1-DNS服务工作原理" class="headerlink" title="1.1 DNS服务工作原理"></a>1.1 DNS服务工作原理</h3><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221019001745795-2072836263.png"><img src="2927659-20221019001745795-2072836263.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<hr>
<h3 id="1-2-DNS查询类型"><a href="#1-2-DNS查询类型" class="headerlink" title="1.2 DNS查询类型"></a>1.2 DNS查询类型</h3><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221019002027372-1349063876.png"><img src="2927659-20221019002027372-1349063876.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<ul>
<li>递归查询</li>
</ul>
<p><strong>是指DNS服务器在收到用户发起的请求时，必须向用户返回一个准确的查询结果。如果DNS服务器本地没有存储与之对应的信息，则该服务器需要询问其他服务器，并将返回的查询结构提交给用户。</strong></p>
<p>一般客户机和本地DNS服务器之间属于递归查询，即当客户机向DNS服务器发出请求后,若DNS服务器本身不能解析，则会向另外的DNS服务器发出查询请求，得到最终的肯定或否定的结果后转交给客户机。此查询的源和目标保持不变,为了查询结果只需要发起一次查询</p>
<p>递归算法：客户端向LocalDNS发起域名查询–&gt;localDNS不知道域名对应的IP–&gt;但它知道谁知道-&gt;他代为帮客户端去查找–&gt;最后再返回最终结果</p>
<ul>
<li>迭代查询</li>
</ul>
<p><strong>是指DNS服务器在收到用户发起的请求时，并不直接回复查询结果，而是告诉另一台DNS服务器的地址，用户再向这台DNS服务器提交请求，这样依次反复，直到返回查询结果。</strong></p>
<p>一般情况下(有例外)本地的DNS服务器向其它DNS服务器的查询属于迭代查询,如：若对方不能返回权威的结果，则它会向下一个DNS服务器(参考前一个DNS服务器返回的结果)再次发起进行查询，直到返回查询的结果为止。此查询的源不变,但查询的目标不断变化,为查询结果一般需要发起多次查询</p>
<p>迭代算法︰客户端向LocalDNS发起域名查询–&gt;localDNS不知道域名对应的IP–&gt;但它知道谁知道并推荐客户端应该找谁–&gt;客户端自己去找它</p>
<ul>
<li>DNS缓存:</li>
</ul>
<p>DNS缓存是将解析数据存储在靠近发起请求的客户端的位置，也可以说DNS数据是可以缓存在任意位置，最终目的是以此减少递归查询过程，可以更快的让用户获得请求结果。</p>
</blockquote>
<hr>
<h3 id="1-3-解析类型"><a href="#1-3-解析类型" class="headerlink" title="1.3 解析类型"></a>1.3 解析类型</h3><blockquote>
<ul>
<li>FQDN –&gt; IP 正向解析</li>
<li>IP –&gt; FQDN 反向解析</li>
</ul>
<p>FQDN（全称域名）</p>
<p>注意：正反向解析是两个不同的名称空间，是两棵不同的解析树</p>
</blockquote>
<hr>
<h3 id="1-4-完整的查询请求经过的流程"><a href="#1-4-完整的查询请求经过的流程" class="headerlink" title="1.4 完整的查询请求经过的流程"></a>1.4 完整的查询请求经过的流程</h3><blockquote>
<p>Client –&gt;hosts文件 –&gt; Client DNS Service Local Cache –&gt; DNS Server (recursion递归) –&gt; DNS Server Cache –&gt;DNS iteration(迭代) –&gt; 根–&gt; 顶级域名DNS–&gt;二级域名DNS…</p>
</blockquote>
<hr>
<h3 id="范例-Windows-客户端DNS缓存"><a href="#范例-Windows-客户端DNS缓存" class="headerlink" title="范例: Windows 客户端DNS缓存"></a>范例: Windows 客户端DNS缓存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">C:\Users\Administrator&gt;ipconfig/displaydns | findstr  redhat<br>C:\Users\Administrator&gt;ping www.redhat.com<br>正在 Ping e3396.ca2.s.tl88.net [117.177.243.181] 具有 32 字节的数据:<br>来自 117.177.243.181 的回复: 字节=32 时间=29ms TTL=53<br>来自 117.177.243.181 的回复: 字节=32 时间=30ms TTL=53<br>来自 117.177.243.181 的回复: 字节=32 时间=29ms TTL=53<br>来自 117.177.243.181 的回复: 字节=32 时间=31ms TTL=53<br>117.177.243.181 的 Ping 统计信息:<br>    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，<br>往返行程的估计时间(以毫秒为单位):<br>    最短 = 29ms，最长 = 31ms，平均 = 29ms<br>C:\Users\Administrator&gt;ipconfig/displaydns | findstr  redhat<br>    www.redhat.com<br>    记录名称. . . . . . . : www.redhat.com<br>    CNAME 记录  . . . . . : ds-www.redhat.com.edgekey.net<br>    记录名称. . . . . . . : ds-www.redhat.com.edgekey.net<br>    CNAME 记录  . . . . . : ds-www.redhat.com.edgekey.net.globalredir.akadns.net<br>    记录名称. . . . . . . : ds-www.redhat.com.edgekey.net.globalredir.akadns.net<br>C:\Users\Administrator&gt;ipconfig/flushdns<br>Windows IP 配置<br>已成功刷新 DNS 解析缓存。<br>C:\Users\Administrator&gt;ipconfig/displaydns | findstr  redhat<br>C:\Users\Administrator&gt;<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="2-DNS-服务相关概念和技术"><a href="#2-DNS-服务相关概念和技术" class="headerlink" title="2 DNS 服务相关概念和技术"></a>2 DNS 服务相关概念和技术</h2><h3 id="2-1-DNS服务器的类型"><a href="#2-1-DNS服务器的类型" class="headerlink" title="2.1 DNS服务器的类型"></a>2.1 DNS服务器的类型</h3><blockquote>
<ul>
<li>主DNS服务器</li>
<li>从DNS服务器</li>
<li>缓存DNS服务器（转发器）</li>
</ul>
</blockquote>
<h4 id="2-1-1-主DNS服务器"><a href="#2-1-1-主DNS服务器" class="headerlink" title="2.1.1 主DNS服务器"></a>2.1.1 主DNS服务器</h4><blockquote>
<p>管理和维护所负责解析的域内解析库的服务器</p>
</blockquote>
<h4 id="2-1-2-从DNS服务器"><a href="#2-1-2-从DNS服务器" class="headerlink" title="2.1.2 从DNS服务器"></a>2.1.2 从DNS服务器</h4><blockquote>
<p>从主服务器或从服务器”复制”（区域传输）解析库副本</p>
<ul>
<li><strong>序列号</strong>：解析库版本号，主服务器解析库变化时，其序列递增</li>
<li><strong>刷新时间间隔</strong>：从服务器从主服务器请求同步解析的时间间隔</li>
<li><strong>重试时间间隔</strong>：从服务器请求同步失败时，再次尝试时间间隔</li>
<li><strong>过期时长</strong>：从服务器联系不到主服务器时，多久后停止服务</li>
<li><strong>通知机制</strong>：主服务器解析库发生变化时，会主动通知从服务器</li>
</ul>
</blockquote>
<hr>
<h3 id="2-2-各种资源记录"><a href="#2-2-各种资源记录" class="headerlink" title="2.2 各种资源记录"></a>2.2 各种资源记录</h3><blockquote>
<p>区域解析库：由众多<strong>资源记录RR</strong>(Resource Record)组成</p>
<p><strong>记录类型：A, AAAA, PTR, SOA, NS, CNAME, MX</strong></p>
<ul>
<li><strong>SOA</strong>：Start Of Authority，起始授权记录；一个区域解析库有且仅能有一个SOA记录，必须位于解析库的第一条记录</li>
<li><strong>A</strong>：internet Address，作用，FQDN –&gt; IP</li>
<li><strong>AAAA</strong>：FQDN（全程域名） –&gt; IPv6</li>
<li><strong>PTR</strong>：PoinTeR，IP –&gt; FQDN</li>
<li><strong>NS</strong>：Name Server，专用于标明当前区域的DNS服务器</li>
<li><strong>CNAME</strong> ： Canonical Name，别名记录</li>
<li><strong>MX</strong>：Mail eXchanger，邮件交换器</li>
<li>TXT：对域名进行标识和说明的一种方式，一般做验证记录时会使用此项，如：SPF（反垃圾邮件）记录，https验证等，如下示例：</li>
</ul>
</blockquote>
<h4 id="2-2-1-资源记录定义"><a href="#2-2-1-资源记录定义" class="headerlink" title="2.2.1 资源记录定义"></a>2.2.1 资源记录定义</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">name [TTL] IN rr_type value<br></code></pre></td></tr></table></figure>

<blockquote>
<p>注意：</p>
<ol>
<li><strong>TTL可从全局继承</strong></li>
<li><strong>使用 “@” 符号可用于引用当前区域的域名</strong></li>
<li><strong>同一个名字可以通过多条记录定义多个不同的值；此时DNS服务器会以轮询方式响应</strong></li>
<li>同一个值也可能有多个不同的定义名字；通过多个不同的名字指向同一个值进行定义；此仅表示通过多个不同的名字可以找到同一个主机</li>
</ol>
</blockquote>
<h4 id="2-2-2-SOA记录"><a href="#2-2-2-SOA记录" class="headerlink" title="2.2.2 SOA记录"></a>2.2.2 SOA记录</h4><blockquote>
<p>name: 当前区域的名字，例如”willoneday.org.”</p>
<p>value: 有多部分组成</p>
<p>注意：</p>
<ol>
<li>当前区域的主DNS服务器的FQDN，也可以使用当前区域的名字，只是注释功能，可以不需要配置对应的NS记录和A记录</li>
<li>当前区域管理员的邮箱地址；<strong>但地址中不能使用@符号，一般用.替换</strong>，例如：willoneday.qq.com</li>
<li>主从服务区域传输相关定义以及否定的答案的统一的TTL</li>
</ol>
</blockquote>
<h5 id="范例：写法"><a href="#范例：写法" class="headerlink" title="范例：写法"></a>范例：写法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">willoneday.org. 86400 IN SOA ns.willoneday.org. nsadmin.willoneday.org. (<br> 2022       ;序列号<br> 2H         ;刷新时间<br> 10M        ;重试时间<br> 1W         ;过期时间<br> 1D         ;否定答案的TTL值<br>)<br></code></pre></td></tr></table></figure>

<h4 id="2-2-3-NS记录"><a href="#2-2-3-NS记录" class="headerlink" title="2.2.3 NS记录"></a>2.2.3 NS记录</h4><blockquote>
<p>name: 当前区域的名字</p>
<p>value: 当前区域的某DNS服务器的名字，例如: ns.willoneday.org.</p>
<p>注意：</p>
<ol>
<li>相邻的两个资源记录的name相同时，后续的可省略</li>
<li><strong>对NS记录而言，任何一个ns记录后面的服务器名字，都应该在后续有一个A记录</strong></li>
<li>一个区域可以有多个NS记录</li>
</ol>
</blockquote>
<h5 id="范例：写法-1"><a href="#范例：写法-1" class="headerlink" title="范例：写法"></a>范例：写法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">willoneday.org. IN NS ns1.willoneday.org.<br>willoneday.org. IN NS ns2.willoneday.org.<br></code></pre></td></tr></table></figure>

<h4 id="2-2-4-MX记录"><a href="#2-2-4-MX记录" class="headerlink" title="2.2.4 MX记录"></a>2.2.4 MX记录</h4><blockquote>
<p>name: 当前区域的名字</p>
<p>value: 当前区域的某邮件服务器(smtp服务器)的主机名</p>
<p>注意：</p>
<ol>
<li><p>一个区域内，MX记录可有多个；但<strong>每个记录的value之前应该有一个数字(0-99)，表示此服务器的优先级；数字越小优先级越高</strong></p>
</li>
<li><p><strong>对MX记录而言，任何一个MX记录后面的服务器名字，都应该在后续有一个A记录</strong></p>
</li>
</ol>
</blockquote>
<p>范例：写法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">willoneday.org. IN MX 10 mx1.willoneday.org.<br>                IN MX 20 mx2.willoneday.org.<br>mx1 A   10.0.0.100<br>mx2 A   10.0.0.200<br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-A记录"><a href="#2-2-5-A记录" class="headerlink" title="2.2.5 A记录"></a>2.2.5 A记录</h4><blockquote>
<p>name: 某主机的FQDN，例如：<a target="_blank" rel="noopener" href="http://www.willoneday.org/">www.willoneday.org</a>.</p>
<p>value: 主机名对应主机的IP地址</p>
<p>避免用户写错名称时给错误答案，可通过泛域名解析进行解析至某特定地址</p>
</blockquote>
<h5 id="范例：写法-2"><a href="#范例：写法-2" class="headerlink" title="范例：写法"></a>范例：写法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">www.willoneday.org. IN    A 1.1.1.1<br>www.willoneday.org. IN    A 2.2.2.2<br>mx1.willoneday.org. IN    A 3.3.3.3<br>mx2.willoneday.org. IN    A 4.4.4.4<br><span class="hljs-variable">$GENERATE</span> 1-254 HOST$  IN A 1.2.3.$<br>*.willoneday.org.   IN    A 5.5.5.5<br>willoneday.org.     IN    A 6.6.6.6<br><span class="hljs-comment">#注意：如果有和DNS的IP相同的多个同名的A记录，优先返回DNS的本机IP</span><br></code></pre></td></tr></table></figure>

<h5 id="范例：阿里云"><a href="#范例：阿里云" class="headerlink" title="范例：阿里云"></a>范例：阿里云</h5><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221021002436602-1665333347.png"><img src="2927659-20221021002436602-1665333347.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h4 id="2-2-6-AAAA记录"><a href="#2-2-6-AAAA记录" class="headerlink" title="2.2 6 AAAA记录"></a>2.2 6 AAAA记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">name: FQDN<br>value: IPv6<br></code></pre></td></tr></table></figure>

<h4 id="2-2-7-PTR记录"><a href="#2-2-7-PTR记录" class="headerlink" title="2.2.7 PTR记录"></a>2.2.7 PTR记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">name: IP，有特定格式，把IP地址反过来写，1.2.3.4，要写作4.3.2.1；而有特定后缀：inaddr.arpa.，所以完整写法为：4.3.2.1.in-addr.arpa.<br>value: FQDN<br><br><span class="hljs-comment">#注意：网络地址及后缀可省略；主机地址依然需要反着写</span><br><span class="hljs-comment">#例如：</span><br>4.3.2.1.in-addr.arpa. IN PTR www.willoneday.org.<br><span class="hljs-comment">#如1.2.3为网络地址，可简写成：</span><br>4 IN PTR www.willoneday.org.<br></code></pre></td></tr></table></figure>

<h4 id="2-2-8-CNAME别名记录"><a href="#2-2-8-CNAME别名记录" class="headerlink" title="2.2.8 CNAME别名记录"></a>2.2.8 CNAME别名记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">name: 别名的FQDN<br>value: 真正名字的FQDN<br><br><span class="hljs-comment">#例如</span><br>www.willoneday.org. IN CNAME   websrv.willoneday.org.<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="2-3-子域授权"><a href="#2-3-子域授权" class="headerlink" title="2.3 子域授权"></a>2.3 子域授权</h3><p>每个域的名称服务器，都是通过其上级名称服务器在解析库进行授权,类似根域授权tld</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">.com. IN NS ns1.com.<br>.com. IN NS ns2.com.<br>ns1.com. IN A 2.2.2.1<br>ns2.com. IN A 2.2.2.2<br><span class="hljs-comment">#willoneday.org. 在.com的名称服务器上，解析库中添加资源记录</span><br>willoneday.org. IN NS ns1.willoneday.org.<br>willoneday.org. IN NS ns2.willoneday.org.<br>willoneday.org. IN NS ns3.willoneday.org.<br>ns1.willoneday.org. IN A 3.3.3.1<br>ns2.willoneday.org. IN A 3.3.3.2<br>ns3.willoneday.org. IN A 3.3.3.3<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="2-4-whois"><a href="#2-4-whois" class="headerlink" title="2.4 whois"></a>2.4 whois</h3><h4 id="范例-whois-查询域名信息"><a href="#范例-whois-查询域名信息" class="headerlink" title="范例: whois 查询域名信息"></a>范例: whois 查询域名信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># yum install -y whois</span><br>[root@rocky01 ~]<span class="hljs-comment"># whois aliyun.com</span><br>   Domain Name: ALIYUN.COM<br>   Registry Domain ID: 1244776076_DOMAIN_COM-VRSN<br>   Registrar WHOIS Server: grs-whois.hichina.com<br>   Registrar URL: http://www.net.cn<br>   Updated Date: 2022-05-18T16:36:00Z<br>   Creation Date: 2007-09-28T11:09:56Z<br>   Registry Expiry Date: 2023-09-28T11:09:56Z<br>   Registrar: Alibaba Cloud Computing (Beijing) Co., Ltd.<br>   Registrar IANA ID: 420<br>   Registrar Abuse Contact Email: DomainAbuse@service.aliyun.com<br>   Registrar Abuse Contact Phone: +86.95187<br>   Domain Status: clientTransferProhibited https://icann.org/epp<span class="hljs-comment">#clientTransferProhibited</span><br>   Domain Status: serverDeleteProhibited https://icann.org/epp<span class="hljs-comment">#serverDeleteProhibited</span><br>   Domain Status: serverTransferProhibited https://icann.org/epp<span class="hljs-comment">#serverTransferProhibited</span><br>   Domain Status: serverUpdateProhibited https://icann.org/epp<span class="hljs-comment">#serverUpdateProhibited</span><br>   Name Server: NS3.ALIYUN.COM<br>   Name Server: NS4.ALIYUN.COM<br>   Name Server: NS5.ALIYUN.COM<br>   DNSSEC: unsigned<br>   URL of the ICANN Whois Inaccuracy Complaint Form: https://www.icann.org/wicf/<br>&gt;&gt;&gt; Last update of whois database: 2022-10-20T16:50:33Z &lt;&lt;&lt;<br>...省略...<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="3-DNS软件-bind"><a href="#3-DNS软件-bind" class="headerlink" title="3 DNS软件 bind"></a>3 DNS软件 bind</h2><p>DNS服务器软件：bind，powerdns，dnsmasq，unbound，coredns</p>
<h3 id="3-1-bind-相关程序包"><a href="#3-1-bind-相关程序包" class="headerlink" title="3.1 bind 相关程序包"></a>3.1 bind 相关程序包</h3><blockquote>
<ul>
<li><strong>bind：服务器</strong></li>
<li><strong>bind-utils: 客户端</strong></li>
<li>bind-libs：相关库,依赖关系自动安装</li>
<li>bind-chroot: 安全包，将dns相关文件放至 /var/named/chroot/</li>
</ul>
</blockquote>
<h4 id="范例：安装bind软件"><a href="#范例：安装bind软件" class="headerlink" title="范例：安装bind软件"></a>范例：安装bind软件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># dnf -y install bind bind-utils</span><br>[root@ubuntu2004 ~]<span class="hljs-comment"># apt -y install bind9 bind9-utils</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-2-BIND包相关文件"><a href="#3-2-BIND包相关文件" class="headerlink" title="3.2 BIND包相关文件"></a>3.2 BIND包相关文件</h3><blockquote>
<ul>
<li>BIND主程序：/usr/sbin/named</li>
<li>服务脚本和Unit名称：/etc/rc.d/init.d/named，/usr/lib/systemd/system/named.service</li>
<li><strong>主配置文件：</strong><strong>/etc/named.conf, /etc/named.rfc1912.zones</strong>, /etc/rndc.key</li>
<li>管理工具：/usr/sbin/rndc：remote name domain controller，默认与bind安装在同一主机，且只能通过127.0.0.1连接named进程，提供辅助性的管理功能；953/tcp</li>
<li><strong>解析库文件：/var/named/ZONE_NAME.ZONE</strong></li>
</ul>
<p>注意：</p>
<p>(1) 一台物理服务器可同时为多个区域提供解析</p>
<p>(2) 必须要有根区域文件；named.ca</p>
<p>(3) 应该有两个（如果包括ipv6的，应该更多）实现localhost和本地回环地址的解析库</p>
</blockquote>
<hr>
<h3 id="3-3-主配置文件"><a href="#3-3-主配置文件" class="headerlink" title="3.3 主配置文件"></a>3.3 主配置文件</h3><blockquote>
<ul>
<li>全局配置：options { };</li>
<li>日志子系统配置：logging { };</li>
<li>区域定义：本机能够为哪些zone进行解析，就要定义哪些zone</li>
</ul>
<p><strong>zone “ZONE_NAME” IN { };</strong></p>
<p>注意：</p>
<ul>
<li>任何服务程序如果期望其能够通过网络被其它主机访问，至少应该监听在一个能与外部主机通信的IP地址上</li>
<li>缓存名称服务器的配置：监听外部地址即可</li>
<li>dnssec: 建议关闭dnssec，设为no</li>
</ul>
</blockquote>
<hr>
<h2 id="4-实现主DNS服务器"><a href="#4-实现主DNS服务器" class="headerlink" title="4 实现主DNS服务器"></a>4 实现主DNS服务器</h2><h3 id="4-1-主DNS服务器配置"><a href="#4-1-主DNS服务器配置" class="headerlink" title="4.1 主DNS服务器配置"></a>4.1 主DNS服务器配置</h3><h4 id="（1）在主配置文件中定义区域"><a href="#（1）在主配置文件中定义区域" class="headerlink" title="（1）在主配置文件中定义区域"></a>（1）在主配置文件中定义区域</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/named.conf             <br><span class="hljs-comment">#注释掉下面两行</span><br>// listen-on port 53 &#123; 127.0.0.1; &#125;;<br>// allow-query     &#123; localhost; &#125;;<br>zone <span class="hljs-string">&quot;ZONE_NAME&quot;</span> IN &#123;<br>   <span class="hljs-built_in">type</span> &#123;master|slave|hint|forward&#125;;<br>   file <span class="hljs-string">&quot;ZONE_NAME.zone&quot;</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="（2）定义区域解析库文件"><a href="#（2）定义区域解析库文件" class="headerlink" title="（2）定义区域解析库文件"></a>（2）定义区域解析库文件</h4><h5 id="范例：区域数据库文件"><a href="#范例：区域数据库文件" class="headerlink" title="范例：区域数据库文件"></a>范例：区域数据库文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky8 named]<span class="hljs-comment"># cat willoneday.org.zone</span><br><span class="hljs-variable">$TTL</span> 1D<br>@           IN  SOA master.willoneday.org. admin.willoneday.org ( 20220117 3H 10M 1D 6H  )<br>                NS  master.willoneday.org.<br>master.willoneday.org.   A   10.0.0.8<br>www                      A   10.0.0.18<br>db                       A   10.0.0.200<br>node1                    A   1.1.1.1<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="4-2-主配置文件语法检查"><a href="#4-2-主配置文件语法检查" class="headerlink" title="4.2 主配置文件语法检查"></a>4.2 主配置文件语法检查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># named-checkconf</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="4-3-解析库文件语法检查"><a href="#4-3-解析库文件语法检查" class="headerlink" title="4.3 解析库文件语法检查"></a>4.3 解析库文件语法检查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># named-checkzone willoneday.org /var/named/willoneday.org.zone</span><br>zone willoneday.org/IN: loaded serial 0<br>OK<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="4-4-配置生效"><a href="#4-4-配置生效" class="headerlink" title="4.4 配置生效"></a>4.4 配置生效</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#三种方式</span><br>[root@rocky01 ~]<span class="hljs-comment"># rndc reload </span><br>[root@rocky01 ~]<span class="hljs-comment"># #systemctl reload named</span><br>[root@rocky01 ~]<span class="hljs-comment"># service named reload</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="4-5-DNS-测试和管理工具"><a href="#4-5-DNS-测试和管理工具" class="headerlink" title="4.5 DNS 测试和管理工具"></a>4.5 DNS 测试和管理工具</h3><h4 id="4-5-1-dig-命令"><a href="#4-5-1-dig-命令" class="headerlink" title="4.5.1 dig 命令"></a>4.5.1 dig 命令</h4><p>dig只用于测试dns系统，不会查询hosts文件进行解析</p>
<p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">dig [-t <span class="hljs-built_in">type</span>] name [@SERVER] [query options]<br>query options：<br> +[no]trace：跟踪解析过程 : dig +trace willoneday.org<br> +[no]recurse：进行递归解析<br></code></pre></td></tr></table></figure>

<h5 id="范例：使用方法-1"><a href="#范例：使用方法-1" class="headerlink" title="范例：使用方法"></a>范例：使用方法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#测试反向解析</span><br>dig -x IP = dig –t ptr reverseip.in-addr.arpa<br><span class="hljs-comment">#模拟区域传送</span><br>dig -t axfr ZONE_NAME @SERVER<br>dig -t axfr willoneday.org @10.10.10.11<br>dig –t axfr 100.1.10.in-addr.arpa @172.16.1.1<br>dig -t NS . @114.114.114.114<br>dig -t NS . @a.root-servers.net<br></code></pre></td></tr></table></figure>

<h4 id="4-5-2-host命令"><a href="#4-5-2-host命令" class="headerlink" title="4.5.2 host命令"></a>4.5.2 host命令</h4><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">host [-t <span class="hljs-built_in">type</span>] name [SERVER]<br></code></pre></td></tr></table></figure>

<h5 id="范例：使用方法-2"><a href="#范例：使用方法-2" class="headerlink" title="范例：使用方法"></a>范例：使用方法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">host -t NS willoneday.org 172.16.0.1<br>host -t soa willoneday.org<br>host -t mx willoneday.org<br>host -t axfr willoneday.org<br>host 1.2.3.4<br></code></pre></td></tr></table></figure>

<h4 id="4-5-3-nslookup命令"><a href="#4-5-3-nslookup命令" class="headerlink" title="4.5.3 nslookup命令"></a>4.5.3 nslookup命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nslookup [-option] [name | -] [server]<br></code></pre></td></tr></table></figure>

<h4 id="4-5-4-rndc-命令"><a href="#4-5-4-rndc-命令" class="headerlink" title="4.5.4 rndc 命令"></a>4.5.4 rndc 命令</h4><p>利用rndc工具可以实现管理DNS功能</p>
<p>rndc 监听端口: 953/tcp</p>
<blockquote>
<p>命令格式:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">rndc <span class="hljs-keyword">COMMAND</span><br></code></pre></td></tr></table></figure>

<p>COMMAND:</p>
<ul>
<li>status: 查看状态</li>
<li><strong>reload: 重载主配置文件和区域解析库文件</strong></li>
<li>reload zonename: 重载区域解析库文件</li>
<li>retransfer zonename: 手动启动区域传送，而不管序列号是否增加</li>
<li>notify zonename: 重新对区域传送发通知</li>
<li>reconfig: 重载主配置文件</li>
<li>querylog: 开启或关闭查询日志文件/var/log/message</li>
<li>trace: 递增debug一个级别</li>
<li>trace LEVEL: 指定使用的级别</li>
<li>notrace：将调试级别设置为 0</li>
<li><strong>flush：清空DNS服务器的所有缓存记录</strong></li>
</ul>
</blockquote>
<hr>
<h3 id="4-6-实战案例：实现DNS正向主服务器"><a href="#4-6-实战案例：实现DNS正向主服务器" class="headerlink" title="4.6 实战案例：实现DNS正向主服务器"></a>4.6 实战案例：实现DNS正向主服务器</h3><blockquote>
<p><strong>实验目的</strong></p>
<ul>
<li>搭建DNS正向主服务器，实现web服务器基于FQDN的访问</li>
</ul>
<p><strong>环境要求</strong></p>
<ul>
<li>需要三台主机</li>
<li>DNS服务端：10.0.0.101</li>
<li>web服务器：10.0.0.102</li>
<li>DNS客户端：10.0.0.103</li>
</ul>
<p><strong>前提准备</strong></p>
<ul>
<li>关闭SELinux</li>
<li>关闭防火墙</li>
<li>时间同步</li>
</ul>
</blockquote>
<h4 id="（1）在DNS服务端安装bind"><a href="#（1）在DNS服务端安装bind" class="headerlink" title="（1）在DNS服务端安装bind"></a>（1）在DNS服务端安装bind</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install <span class="hljs-built_in">bind</span> bind-utils -y<br></code></pre></td></tr></table></figure>

<h4 id="（2）修改bind-配置文件"><a href="#（2）修改bind-配置文件" class="headerlink" title="（2）修改bind 配置文件"></a>（2）修改bind 配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@101 ~]<span class="hljs-comment"># vim /etc/named.conf             </span><br><span class="hljs-comment">#注释掉下面两行</span><br>// listen-on port 53 &#123; 127.0.0.1; &#125;;<br>// allow-query     &#123; localhost; &#125;;<br><br>[root@101 ~]<span class="hljs-comment"># vim /etc/named.rfc1912.zones    </span><br><span class="hljs-comment">#加上下面内容</span><br>zone <span class="hljs-string">&quot;willoneday.org&quot;</span> IN &#123;<br>        <span class="hljs-built_in">type</span> master;<br>        file <span class="hljs-string">&quot;willoneday.org.zone&quot;</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="（3）DNS区域数据库文件"><a href="#（3）DNS区域数据库文件" class="headerlink" title="（3）DNS区域数据库文件"></a>（3）DNS区域数据库文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@101 ~]<span class="hljs-comment"># cp -p /var/named/named.localhost /var/named/willoneday.org.zone</span><br><span class="hljs-comment">#如果没有加-p选项，需要修改所有者或权限。chgrp named willoneday.org.zone</span><br><br>[root@101 ~]<span class="hljs-comment"># vim /var/named/willoneday.org.zone </span><br><span class="hljs-variable">$TTL</span> 1D<br>@       IN SOA  master admin.willoneday.org. (<br>                                        0       ; serial<br>                                        1D      ; refresh<br>                                        1H      ; retry<br>                                        1W      ; expire<br>                                        3H )    ; minimum<br>        NS      master<br>master  A       10.0.0.101<br>www     A       10.0.0.102<br></code></pre></td></tr></table></figure>

<h4 id="（4）检查配置文件和数据库文件格式，并启动服务"><a href="#（4）检查配置文件和数据库文件格式，并启动服务" class="headerlink" title="（4）检查配置文件和数据库文件格式，并启动服务"></a>（4）检查配置文件和数据库文件格式，并启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@101 ~]<span class="hljs-comment"># named-checkconf </span><br>[root@101 ~]<span class="hljs-comment"># named-checkzone willoneday.org /var/named/willoneday.org.zone</span><br><br>[root@101 ~]<span class="hljs-comment"># systemctl start named          #第一次启动服务</span><br>[root@101 ~]<span class="hljs-comment"># rndc reload                    #不是第一次启动服务</span><br></code></pre></td></tr></table></figure>

<h4 id="（5）实现WEB服务"><a href="#（5）实现WEB服务" class="headerlink" title="（5）实现WEB服务"></a>（5）实现WEB服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装http服务</span><br>[root@102 ~]<span class="hljs-comment"># yum install httpd -y                     </span><br><span class="hljs-comment">#配置主页面</span><br>[root@102 ~]<span class="hljs-comment"># echo &quot;https://www.cnblogs.com/Willoneday&quot; &gt; /var/www/html/index.html</span><br><span class="hljs-comment">#启动服务</span><br>[root@102 ~]<span class="hljs-comment"># systemctl enable --now httpd</span><br></code></pre></td></tr></table></figure>

<h4 id="（6）在客户端实现测试"><a href="#（6）在客户端实现测试" class="headerlink" title="（6）在客户端实现测试"></a>（6）在客户端实现测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@103 ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>DNS1=10.0.0.101<br><br><span class="hljs-comment">#重启网络</span><br><span class="hljs-comment">#centos7 以上版执行现下面命令生效</span><br>[root@103 ~]<span class="hljs-comment"># nmcli con reload</span><br>[root@103 ~]<span class="hljs-comment"># nmcli con up eth0</span><br><span class="hljs-comment">#centos 6 执行下面命令生效</span><br>service network restart<br><span class="hljs-comment">#有以下记录，算是重启成功</span><br>[root@103 ~]<span class="hljs-comment"># cat /etc/resolv.conf                    </span><br><span class="hljs-comment"># Generated by NetworkManager</span><br>nameserver 10.0.0.101<br><br><span class="hljs-comment">#测试网页,能显示就是成功</span><br>[root@103 ~]<span class="hljs-comment"># curl www.willoneday.org          </span><br>https://www.cnblogs.com/Willoneday<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="4-7-启用DNS客户端缓存功能"><a href="#4-7-启用DNS客户端缓存功能" class="headerlink" title="4.7 启用DNS客户端缓存功能"></a>4.7 启用DNS客户端缓存功能</h3><blockquote>
<p> 在高并发的服务器场景中,对DNS的服务器查询性能有较高的要求,如果在客户端启用DNS缓存功能,可以大幅减轻DNS服务器的压力,同时也能提高DNS客户端名称解析速度</p>
</blockquote>
<h4 id="4-7-1-nscd命令-CentOS-启用DNS客户端缓存"><a href="#4-7-1-nscd命令-CentOS-启用DNS客户端缓存" class="headerlink" title="4.7.1 nscd命令 CentOS 启用DNS客户端缓存"></a>4.7.1 nscd命令 CentOS 启用DNS客户端缓存</h4><blockquote>
<p>CentOS 默认没有启用DNS客户端缓存,安装nscd（Name Service Cache Daemon,名称服务缓存守护进程）包可以支持DNS缓存功能</p>
<p>减少DNS服务器压力,提高DNS查询速度</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># yum -y install nscd</span><br>[root@centos7 ~]<span class="hljs-comment"># systemctl enable --now nscd</span><br><span class="hljs-comment">#查看缓存统计信息</span><br>[root@centos7 ~]<span class="hljs-comment"># nscd -g</span><br></code></pre></td></tr></table></figure>

<h4 id="4-7-2-Ubuntu-启用DNS客户端缓存"><a href="#4-7-2-Ubuntu-启用DNS客户端缓存" class="headerlink" title="4.7.2 Ubuntu 启用DNS客户端缓存"></a>4.7.2 Ubuntu 启用DNS客户端缓存</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#ubuntu 默认会启用DNS客户端缓存</span><br>[root@ubuntu01 ~]<span class="hljs-comment"># systemctl status systemd-resolved.service</span><br>● systemd-resolved.service - Network Name Resolution<br>     Loaded: loaded (/lib/systemd/system/systemd-resolved.service; enabled; vendor preset: enabled)<br>     Active: active (running) since Tue 2022-10-18 17:14:08 CST; 2 days ago<br>       Docs: man:systemd-resolved.service(8)<br>             https://www.freedesktop.org/wiki/Software/systemd/resolved<br>             https://www.freedesktop.org/wiki/Software/systemd/writing-network-configuration-managers<br>             https://www.freedesktop.org/wiki/Software/systemd/writing-resolver-clients<br>   Main PID: 70372 (systemd-resolve)<br>     Status: <span class="hljs-string">&quot;Processing requests...&quot;</span><br>      Tasks: 1 (<span class="hljs-built_in">limit</span>: 2236)<br>     Memory: 4.2M<br>     CGroup: /system.slice/systemd-resolved.service<br>             └─70372 /lib/systemd/systemd-resolved<br><br>Oct 18 20:10:12 ubuntu01 systemd-resolved[70372]: Using degraded feature <span class="hljs-built_in">set</span> (UDP) <span class="hljs-keyword">for</span> DNS server 10.0.0.2.<br>Oct 18 20:44:51 ubuntu01 systemd-resolved[70372]: Grace period over, resuming full feature <span class="hljs-built_in">set</span> (UDP+EDNS0) <span class="hljs-keyword">for</span> DNS server 10.0.0.2.<br>Oct 18 20:44:51 ubuntu01 systemd-resolved[70372]: Using degraded feature <span class="hljs-built_in">set</span> (UDP) <span class="hljs-keyword">for</span> DNS server 10.0.0.2.<br>Oct 20 19:34:57 ubuntu01 systemd-resolved[70372]: Using degraded feature <span class="hljs-built_in">set</span> (UDP) <span class="hljs-keyword">for</span> DNS server 10.0.0.2.<br>Oct 20 19:45:27 ubuntu01 systemd-resolved[70372]: Grace period over, resuming full feature <span class="hljs-built_in">set</span> (UDP+EDNS0) <span class="hljs-keyword">for</span> DNS server 10.0.0.2.<br>Oct 20 19:45:27 ubuntu01 systemd-resolved[70372]: Using degraded feature <span class="hljs-built_in">set</span> (UDP) <span class="hljs-keyword">for</span> DNS server 10.0.0.2.<br>Oct 20 20:09:24 ubuntu01 systemd-resolved[70372]: Grace period over, resuming full feature <span class="hljs-built_in">set</span> (UDP+EDNS0) <span class="hljs-keyword">for</span> DNS server 10.0.0.2.<br>Oct 20 20:09:24 ubuntu01 systemd-resolved[70372]: Using degraded feature <span class="hljs-built_in">set</span> (UDP) <span class="hljs-keyword">for</span> DNS server 10.0.0.2.<br>Oct 20 20:52:26 ubuntu01 systemd-resolved[70372]: Grace period over, resuming full feature <span class="hljs-built_in">set</span> (UDP+EDNS0) <span class="hljs-keyword">for</span> DNS server 10.0.0.2.<br>Oct 20 20:52:26 ubuntu01 systemd-resolved[70372]: Using degraded feature <span class="hljs-built_in">set</span> (UDP) <span class="hljs-keyword">for</span> DNS server 10.0.0.2.<br></code></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#清空缓存</span><br>[root@ubuntu1804 ~]<span class="hljs-comment"># systemd-resolve --flush-caches</span><br><br><span class="hljs-comment">#查看</span><br>[root@ubuntu1804 ~]<span class="hljs-comment"># systemd-resolve --statistics</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="5-实现反向解析区域"><a href="#5-实现反向解析区域" class="headerlink" title="5 实现反向解析区域"></a>5 实现反向解析区域</h3><h4 id="5-1-反向解析配置"><a href="#5-1-反向解析配置" class="headerlink" title="5.1 反向解析配置"></a>5.1 反向解析配置</h4><blockquote>
<p>反向区域：即将IP反向解析为FQDN</p>
<p>区域名称：网络地址反写**.in-addr.arpa.**</p>
</blockquote>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">172.16.100. --&gt; 100.16.172.in-addr.arpa.<br></code></pre></td></tr></table></figure>

<h5 id="（1）定义区域"><a href="#（1）定义区域" class="headerlink" title="（1）定义区域"></a>（1）定义区域</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">zone <span class="hljs-string">&quot;ZONE_NAME&quot;</span> IN &#123;<br>     <span class="hljs-built_in">type</span> &#123;master|slave|forward&#125;；<br>     file <span class="hljs-string">&quot;网络地址.zone&quot;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h5 id="（2）定义区域解析库文件-1"><a href="#（2）定义区域解析库文件-1" class="headerlink" title="（2）定义区域解析库文件"></a>（2）定义区域解析库文件</h5><p>注意：不需要A记录,以PTR记录为主</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$TTL</span> 1D<br>@       IN SOA  master admin.willoneday.org. (<br>                                        0       ; serial<br>                                        1D      ; refresh<br>                                        1H      ; retry<br>                                        1W      ; expire<br>                                        3H )    ; minimum<br>        NS      master.<br>111     PTR     www.willoneday.org.<br>222     PTR     db.willoneday.org.<br></code></pre></td></tr></table></figure>

<h4 id="5-2-实战案例-反向解析"><a href="#5-2-实战案例-反向解析" class="headerlink" title="5.2 实战案例: 反向解析"></a>5.2 实战案例: 反向解析</h4><h5 id="（1）操作"><a href="#（1）操作" class="headerlink" title="（1）操作"></a>（1）操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@101 ~]<span class="hljs-comment">#  cat /etc/named.conf </span><br>options &#123;<br> ......<br> listen-on port 53 &#123; localhost; &#125;;<br> ......<br> allow-query     &#123; any; &#125;;<br> ......<br>&#125;<br><br>[root@101 ~]<span class="hljs-comment"># vim /etc/named.rfc1912.zones</span><br>zone <span class="hljs-string">&quot;0.0.10.in-addr.arpa&quot;</span> &#123;<br>   <span class="hljs-built_in">type</span> master;<br>   file <span class="hljs-string">&quot;10.0.0.zone&quot;</span>;<br>&#125;;<br><br>[root@101 ~]<span class="hljs-comment"># cd /var/named</span><br>[root@101 named]<span class="hljs-comment"># cp -p named.loopback 10.0.0.zone</span><br>[root@101 named]<span class="hljs-comment"># cat 10.0.0.zone </span><br><span class="hljs-variable">$TTL</span> 1D<br>@       IN SOA  master admin.willoneday.org. (<br>                                        0       ; serial<br>                                        1D      ; refresh<br>                                        1H      ; retry<br>                                        1W      ; expire<br>                                        3H )    ; minimum<br>        NS      master. <span class="hljs-comment">#NS记录必须以点结束，否则需要配置A记录才可以启动</span><br>111     PTR     www.willoneday.org.<br>222     PTR     db.willoneday.org.<br><br>[root@101 named]<span class="hljs-comment"># named-checkzone 0.0.10.in-addr.arpa 10.0.0.zone </span><br>zone 0.0.10.in-addr.arpa/IN: loaded serial 0<br>OK<br></code></pre></td></tr></table></figure>

<h5 id="（2）测试"><a href="#（2）测试" class="headerlink" title="（2）测试"></a>（2）测试</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@103 ~]<span class="hljs-comment"># cat /etc/resolv.conf </span><br><span class="hljs-comment"># Generated by NetworkManager</span><br>nameserver 10.0.0.101<br>[root@103 ~]<span class="hljs-comment">#  </span><br>[root@103 ~]<span class="hljs-comment"># dig -t ptr 111.0.0.10.in-addr.arpa.    </span><br><br>; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.10 &lt;&lt;&gt;&gt; -t ptr 111.0.0.10.in-addr.arpa.<br>;; global options: +cmd<br>;; Got answer:<br>;; -&gt;&gt;HEADER&lt;&lt;- <span class="hljs-string">opcode: QUERY, status: NOERROR, id: 17985</span><br><span class="hljs-string">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1</span><br><span class="hljs-string"></span><br><span class="hljs-string">;; OPT PSEUDOSECTION:</span><br><span class="hljs-string">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="hljs-string">;; QUESTION SECTION:</span><br><span class="hljs-string">;111.0.0.10.in-addr.arpa.       IN      PTR</span><br><span class="hljs-string"></span><br><span class="hljs-string">;; ANSWER SECTION:</span><br><span class="hljs-string">111.0.0.10.in-addr.arpa. 86400  IN      PTR     www.willoneday.org.</span><br><span class="hljs-string"></span><br><span class="hljs-string">;; AUTHORITY SECTION:</span><br><span class="hljs-string">0.0.10.in-addr.arpa.    86400   IN      NS      master.</span><br><span class="hljs-string"></span><br><span class="hljs-string">;; Query time: 1 msec</span><br><span class="hljs-string">;; SERVER: 10.0.0.101#53(10.0.0.101)</span><br><span class="hljs-string">;; WHEN: Fri Oct 21 10:29:03 CST 2022</span><br><span class="hljs-string">;; MSG SIZE  rcvd: 104</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="6-实现从服务器"><a href="#6-实现从服务器" class="headerlink" title="6 实现从服务器"></a>6 实现从服务器</h2><blockquote>
<p>只有一台主DNS服务器，存在单点失败的问题，可以建立主DNS服务器的备份服务器，即从服务器来实现DNS服务的容错机制。从服务器可以自动和主服务器进行单向的数据同步，从而和主DNS服务器一样，也可以对外提供查询服务，但从服务器不提供数据更新服务。</p>
</blockquote>
<h3 id="6-1-DNS从服务器"><a href="#6-1-DNS从服务器" class="headerlink" title="6.1 DNS从服务器"></a>6.1 DNS从服务器</h3><blockquote>
<ol>
<li>应该为一台独立的名称服务器</li>
<li><strong>主服务器的区域解析库文件中必须有一条NS记录指向从服务器</strong></li>
<li>从服务器只需要定义区域，而无须提供解析库文件；解析库文件应该放置于/var/named/slaves/目录中</li>
<li>主服务器得允许从服务器作区域传送</li>
<li>主从服务器时间应该同步，可通过ntp进行</li>
<li><strong>bind程序的版本应该保持一致；否则，应该从高，主低</strong></li>
</ol>
</blockquote>
<h3 id="6-2-定义从区域"><a href="#6-2-定义从区域" class="headerlink" title="6.2 定义从区域"></a>6.2 定义从区域</h3><p>格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">zone <span class="hljs-string">&quot;ZONE_NAME&quot;</span> IN &#123;<br>     <span class="hljs-built_in">type</span> slave;<br>     masters &#123; MASTER_IP; &#125;;<br>     file <span class="hljs-string">&quot;slaves/ZONE_NAME.zone&quot;</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="6-3-实战案例：实现DNS从服务器"><a href="#6-3-实战案例：实现DNS从服务器" class="headerlink" title="6.3 实战案例：实现DNS从服务器"></a>6.3 实战案例：实现DNS从服务器</h3><blockquote>
<p><strong>实验目的</strong></p>
<ul>
<li>搭建DNS主从服务器架构，实现DNS服务冗余</li>
</ul>
<p><strong>环境要求</strong></p>
<ul>
<li>需要四台主机</li>
<li>DNS主服务器：10.0.0.101</li>
<li>DNS从服务器:10.0.0.104</li>
<li>web服务器：10.0.0.102</li>
<li>DNS客户端：10.0.0.103</li>
</ul>
<p><strong>前提准备</strong></p>
<ul>
<li>关闭SElinux</li>
<li>关闭防火墙</li>
<li>时间同步</li>
</ul>
</blockquote>
<h4 id="（1）主DNS服务端配置"><a href="#（1）主DNS服务端配置" class="headerlink" title="（1）主DNS服务端配置"></a>（1）主DNS服务端配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@101 ~]<span class="hljs-comment"># yum install bind -y</span><br><br>[root@101 ~]<span class="hljs-comment"># vim /etc/named.conf</span><br><span class="hljs-comment">#注释掉下面两行</span><br>// listen-on port 53 &#123; 127.0.0.1; &#125;;<br>// allow-query     &#123; localhost; &#125;;<br><span class="hljs-comment">#只允许从服务器进行区域传输</span><br>allow-transfer &#123; 从服务器IP;&#125;; <br><br>[root@101 ~]<span class="hljs-comment"># vim /etc/named.rfc1912.zones    </span><br><span class="hljs-comment">#加上这段</span><br>zone <span class="hljs-string">&quot;willoneday.org&quot;</span> IN &#123;<br>        <span class="hljs-built_in">type</span> master;<br>        file <span class="hljs-string">&quot;willoneday.org.zone&quot;</span>;<br>&#125;;<br><br>[root@101 ~]<span class="hljs-comment"># cp -p /var/named/named.localhost /var/named/willoneday.org.zone</span><br><span class="hljs-comment">#如果没有-p，需要改权限。chgrp named willoneday.org.zone</span><br><br>[root@101 ~]<span class="hljs-comment"># vim /var/named/willoneday.org.zone </span><br><span class="hljs-variable">$TTL</span> 1D<br>@       IN SOA  master admin.willoneday.org. (<br>                                        4       ; serial<br>                                        1D      ; refresh<br>                                        1H      ; retry<br>                                        1W      ; expire<br>                                        3H )    ; minimum<br>        NS      master<br>        NS      slave<br>master  A       10.0.0.101<br>slave   A       10.0.0.104<br>www     A       1.1.1.1<br>db      A       2.2.2.2<br><br>[root@101 ~]<span class="hljs-comment"># systemctl start named      #第一次启动服务</span><br>[root@101 ~]<span class="hljs-comment"># rndc reload                #不是第一次启动服务</span><br></code></pre></td></tr></table></figure>

<h4 id="（2）从DNS服务器配置"><a href="#（2）从DNS服务器配置" class="headerlink" title="（2）从DNS服务器配置"></a>（2）从DNS服务器配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@104 ~]<span class="hljs-comment"># yum install -y bind</span><br><br>[root@104 ~]<span class="hljs-comment"># vim /etc/named.conf</span><br>// listen-on port 53 &#123; 127.0.0.1; &#125;;<br>// allow-query     &#123; localhost; &#125;;<br><span class="hljs-comment">#不允许其它主机进行区域传输</span><br>allow-transfer &#123; none;&#125;;<br><br>[root@104 ~]<span class="hljs-comment"># vim /etc/named.rfc1912.zones</span><br>zone <span class="hljs-string">&quot;willoneday.org&quot;</span> &#123;<br>       <span class="hljs-built_in">type</span> slave;<br>       masters &#123; 主服务器IP;&#125;;                                                               <br>       file <span class="hljs-string">&quot;slaves/willoneday.org.slave&quot;</span>;<br>&#125;;<br><br>[root@104 ~]<span class="hljs-comment"># systemctl start named #第一次启动服务</span><br>[root@104 ~]<span class="hljs-comment"># rndc reload        #不是第一次启动服务</span><br><br>[root@104 ~]<span class="hljs-comment"># ll /var/named/slaves/willoneday.org.slave #查看区域数据库文件是否生成</span><br></code></pre></td></tr></table></figure>

<h4 id="（3）客户端测试主从DNS服务架构"><a href="#（3）客户端测试主从DNS服务架构" class="headerlink" title="（3）客户端测试主从DNS服务架构"></a>（3）客户端测试主从DNS服务架构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@103 ~]<span class="hljs-comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>DNS1=主服务器<br>DNS2=从服务器<br>[root@103 ~]<span class="hljs-comment"># systemctl restart network</span><br><br><span class="hljs-comment">#验证从DNS服务器是否可以查询</span><br>[root@103 ~]<span class="hljs-comment"># dig www.willoneday.org</span><br>[root@103 ~]<span class="hljs-comment"># curl www.willoneday.org</span><br><br><span class="hljs-comment">#在主服务器上停止DNS服务</span><br>[root@101 ~]<span class="hljs-comment"># systemctl stop named</span><br><br><span class="hljs-comment">#验证从DNS服务器仍然可以查询</span><br>[root@103 ~]<span class="hljs-comment"># dig www.willoneday.org </span><br>[root@103 ~]<span class="hljs-comment"># curl www.willoneday.org</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="7-实现子域"><a href="#7-实现子域" class="headerlink" title="7 实现子域"></a>7 实现子域</h2><h3 id="7-1-子域委派授权"><a href="#7-1-子域委派授权" class="headerlink" title="7.1 子域委派授权"></a>7.1 子域委派授权</h3><p> 将子域委派给其它主机管理，实现分布式DNS数据库</p>
<p>正向解析区域子域方法</p>
<h4 id="范例：定义两个子域区域"><a href="#范例：定义两个子域区域" class="headerlink" title="范例：定义两个子域区域"></a>范例：定义两个子域区域</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">shanghai.willoneday.org. IN NS ns1.ops.willoneday.org.<br>shanghai.willoneday.org. IN NS ns2.ops.willoneday.org.<br>shenzhen.willoneday.org. IN NS ns1.shenzhen.willoneday.org.<br>shenzhen.willoneday.org. IN NS ns2.shenzhen.willoneday.org.<br>ns1.shanghai.willoneday.org. IN A 1.1.1.1<br>ns2.shanghai.willoneday.org. IN A 1.1.1.2<br>ns1.shenzhen.willoneday.org. IN A 1.1.1.3<br>ns2.shenzhen.willoneday.org. IN A 1.1.1.4<br></code></pre></td></tr></table></figure>

<h3 id="7-2-实战范例：实现DNS父域和子域服务"><a href="#7-2-实战范例：实现DNS父域和子域服务" class="headerlink" title="7.2 实战范例：实现DNS父域和子域服务"></a>7.2 实战范例：实现DNS父域和子域服务</h3><blockquote>
<p><strong>实验目的</strong></p>
<ul>
<li>搭建DNS父域和子域服务器</li>
</ul>
<p><strong>环境要求</strong></p>
<ul>
<li>需要五台主机</li>
<li>DNS父域服务器：10.0.0.101</li>
<li>DNS子域服务器：10.0.0.104</li>
<li>父域的web服务器：10.0.0.102，<a target="_blank" rel="noopener" href="http://www.willoneday.org/">www.willoneday.org</a></li>
<li>子域的web服务器：10.0.0.105,<a target="_blank" rel="noopener" href="http://www.shanghai.willoneday.org/">www.shanghai.willoneday.org</a></li>
<li>DNS客户端：10.0.0.103</li>
</ul>
<p><strong>前提准备</strong></p>
<ul>
<li>关闭SElinux</li>
<li>关闭防火墙</li>
<li>时间同步</li>
</ul>
</blockquote>
<h4 id="（1）在父域DNS服务器上实现主willoneday-org域的主DNS服务"><a href="#（1）在父域DNS服务器上实现主willoneday-org域的主DNS服务" class="headerlink" title="（1）在父域DNS服务器上实现主willoneday.org域的主DNS服务"></a>（1）在父域DNS服务器上实现主willoneday.org域的主DNS服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@101 ~]<span class="hljs-comment"># yum install bind -y</span><br><br>[root@101 ~]<span class="hljs-comment"># vim /etc/named.conf</span><br><span class="hljs-comment">#注释掉下面两行</span><br>// listen-on port 53 &#123; 127.0.0.1; &#125;;<br>// allow-query     &#123; localhost; &#125;;<br><span class="hljs-comment">#只允许从服务器进行区域传输</span><br>allow-transfer &#123; 从服务器IP;&#125;; <br><span class="hljs-comment">#建议关闭加密验证</span><br>dnssec-enable no; <br>dnssec-validation no;<br><br>[root@101 ~]<span class="hljs-comment"># vim /etc/named.rfc1912.zones</span><br><span class="hljs-comment">#加上这段</span><br>zone <span class="hljs-string">&quot;willoneday.org&quot;</span> IN &#123;<br>        <span class="hljs-built_in">type</span> master;<br>        file <span class="hljs-string">&quot;willoneday.org.zone&quot;</span>;<br>&#125;;<br><br>[root@101 ~]<span class="hljs-comment"># cp -p /var/named/named.localhost /var/named/willoneday.org.zone</span><br><span class="hljs-comment">#如果没有-p，需要改权限。chgrp named willoneday.org.zone</span><br><br>[root@101 ~]<span class="hljs-comment"># vim /var/named/willoneday.org.zone </span><br><span class="hljs-variable">$TTL</span> 1D<br>@       IN SOA  master admin.willoneday.org. (<br>                                        4       ; serial<br>                                        1D      ; refresh<br>                                        1H      ; retry<br>                                        1W      ; expire<br>                                        3H )    ; minimum<br>                NS      master<br>shanghai        NS      shanghains<br>master          A       10.0.0.101<br>shanghains      A       10.0.0.104<br>www             A       10.0.0.102                <br><br>[root@101 ~]<span class="hljs-comment"># systemctl start named          #第一次启动服务</span><br>[root@101 ~]<span class="hljs-comment"># rndc reload                    #不是第一次启动服务</span><br></code></pre></td></tr></table></figure>

<h4 id="（2）实现子域的DNS服务器"><a href="#（2）实现子域的DNS服务器" class="headerlink" title="（2）实现子域的DNS服务器"></a>（2）实现子域的DNS服务器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@104 ~]<span class="hljs-comment"># yum install bind -y</span><br><br>[root@104 ~]<span class="hljs-comment"># vim /etc/named.conf             </span><br><span class="hljs-comment">#注释掉下面两行</span><br>// listen-on port 53 &#123; 127.0.0.1; &#125;;<br>// allow-query     &#123; localhost; &#125;;<br>allow-transfer &#123; none;&#125;; <br><br>[root@104 ~]<span class="hljs-comment"># vim /etc/named.rfc1912.zones</span><br>zone <span class="hljs-string">&quot;shanghai.willoneday.org&quot;</span> &#123;<br>       <span class="hljs-built_in">type</span> master;<br>       file <span class="hljs-string">&quot;shanghai.willoneday.org.zone&quot;</span>;<br>&#125;;<br><br>[root@104 ~]<span class="hljs-comment"># cp -p /var/named/named.localhost /var/named/shanghai.willoneday.org.zone</span><br><span class="hljs-comment">#如果没有-p，需要改权限。chgrp named willoneday.org.zone</span><br>[root@104 ~]<span class="hljs-comment"># vim /var/named/shanghai.willoneday.org.zone </span><br><span class="hljs-variable">$TTL</span> 1D<br>@       IN SOA  master admin.willoneday.org. (<br>                                        4       ; serial<br>                                        1D      ; refresh<br>                                        1H      ; retry<br>                                        1W      ; expire<br>                                        3H )    ; minimum<br>                NS      master<br>master          A       10.0.0.101<br>www             A       10.0.0.102                <br><br>[root@104 ~]<span class="hljs-comment"># systemctl start named   #第一次启动服务</span><br>[root@104 ~]<span class="hljs-comment"># rndc reload             #不是第一次启动服务</span><br></code></pre></td></tr></table></figure>

<h4 id="（3）在父域和子域的web服务器上安装httpd服务"><a href="#（3）在父域和子域的web服务器上安装httpd服务" class="headerlink" title="（3）在父域和子域的web服务器上安装httpd服务"></a>（3）在父域和子域的web服务器上安装httpd服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#父域的web服务器利用上面案例（略）</span><br><span class="hljs-comment">#在子域的web服务器上安装http服务</span><br>yum install httpd                        <br><span class="hljs-comment">#配置主页面</span><br><span class="hljs-built_in">echo</span> www.shanghai.willoneday.org &gt; /var/www/html/index.html<br><span class="hljs-comment">#启动服务</span><br>systemctl start httpd<br></code></pre></td></tr></table></figure>

<h4 id="（4）客户端测试"><a href="#（4）客户端测试" class="headerlink" title="（4）客户端测试"></a>（4）客户端测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">dig www.shanghai.willoneday.org<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="8-实现-DNS-转发（缓存）服务器"><a href="#8-实现-DNS-转发（缓存）服务器" class="headerlink" title="8 实现 DNS 转发（缓存）服务器"></a>8 实现 DNS 转发（缓存）服务器</h2><h3 id="8-1-DNS转发"><a href="#8-1-DNS转发" class="headerlink" title="8.1 DNS转发"></a>8.1 DNS转发</h3><blockquote>
<p>利用DNS转发，可以将用户的DNS请求，转发至指定的DNS服务，而非默认的根DNS服务器，并将指定服务器查询的返回结果进行缓存，提高效率</p>
<p>注意：</p>
<ol>
<li>被转发的服务器需要能够为请求者做递归，否则转发请求不予进行</li>
<li>在/etc/named.conf的全局配置块中，关闭dnssec功能</li>
</ol>
</blockquote>
<h3 id="8-2-转发方式"><a href="#8-2-转发方式" class="headerlink" title="8.2 转发方式"></a>8.2 转发方式</h3><h4 id="8-2-1-全局转发"><a href="#8-2-1-全局转发" class="headerlink" title="8.2.1 全局转发"></a>8.2.1 全局转发</h4><p>对非本机所负责解析区域的请求，全转发给指定的服务器</p>
<p>在全局配置块中实现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">Options &#123;<br>       forward first|only;<br>       forwarders &#123; ip;&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="8-2-2-特定区域转发"><a href="#8-2-2-特定区域转发" class="headerlink" title="8.2.2 特定区域转发"></a>8.2.2 特定区域转发</h4><p>仅转发对特定的区域的请求，比全局转发优先级高</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">zone <span class="hljs-string">&quot;ZONE_NAME&quot;</span> IN &#123;<br>     <span class="hljs-built_in">type</span> forward;<br>     forward first|only;<br>     forwarders &#123; ip;&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>first：先转发至指定DNS服务器，如果无法解析查询请求，则本服务器再去根服务器查询</strong></p>
<p><strong>only: 先转发至指定DNS服务器，如果无法解析查询请求，则本服务器将不再去根服务器查询</strong></p>
</blockquote>
<h3 id="8-3-实战案例：实现DNS-forward（缓存）服务器"><a href="#8-3-实战案例：实现DNS-forward（缓存）服务器" class="headerlink" title="8.3 实战案例：实现DNS forward（缓存）服务器"></a>8.3 实战案例：实现DNS forward（缓存）服务器</h3><hr>
<h2 id="9-实现智能-DNS"><a href="#9-实现智能-DNS" class="headerlink" title="9 实现智能 DNS"></a>9 实现智能 DNS</h2><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221021150311248-725218953.png"><img src="2927659-20221021150311248-725218953.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h3 id="9-1-GSLB"><a href="#9-1-GSLB" class="headerlink" title="9.1 GSLB"></a>9.1 GSLB</h3><blockquote>
<p>GSLB：Global Server Load Balance全局负载均衡</p>
<p>GSLB 是对服务器和链路进行综合判断来决定由哪个地点的服务器来提供服务，实现异地服务器群服务质量的保证</p>
<p>GSLB主要的目的是在整个网络范围内将用户的请求定向到最近的节点（或者区域）</p>
<p>GSLB分为基于DNS实现、基于重定向实现、基于路由协议实现，其中最通用的是基于DNS解析方式</p>
</blockquote>
<h3 id="9-2-CDN-内容分发网络"><a href="#9-2-CDN-内容分发网络" class="headerlink" title="9.2 CDN 内容分发网络"></a>9.2 CDN 内容分发网络</h3><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221021150501836-1587744129.png"><img src="2927659-20221021150501836-1587744129.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h4 id="9-2-1-CDN工作原理"><a href="#9-2-1-CDN工作原理" class="headerlink" title="9.2.1 CDN工作原理"></a>9.2.1 CDN工作原理</h4><blockquote>
<ol>
<li>用户向浏览器输入<a target="_blank" rel="noopener" href="http://www.a.com这个域名,浏览器第一次发现本地没有dns缓存,则向网站的dns服务器请求/">www.a.com这个域名，浏览器第一次发现本地没有dns缓存，则向网站的DNS服务器请求</a></li>
<li>网站的DNS域名解析器设置了CNAME，指向了<a target="_blank" rel="noopener" href="http://www.a.tbcdn.com,请求指向了cdn网络中的智能dns负载均衡系统/">www.a.tbcdn.com,请求指向了CDN网络中的智能DNS负载均衡系统</a></li>
<li>智能DNS负载均衡系统解析域名，把对用户响应速度最快的IP节点返回给用户；</li>
<li>用户向该IP节点（CDN服务器）发出请求</li>
<li>由于是第一次访问，CDN服务器会通过Cache内部专用DNS解析得到此域名的原web站点IP，向原站点服务器发起请求，并在CDN服务器上缓存内容</li>
<li>请求结果发给用户</li>
</ol>
</blockquote>
<h3 id="9-3-智能DNS相关技术"><a href="#9-3-智能DNS相关技术" class="headerlink" title="9.3 智能DNS相关技术"></a>9.3 智能DNS相关技术</h3><hr>
<h2 id="10-综合实战案例：实现-Internet-的-DNS-服务架构"><a href="#10-综合实战案例：实现-Internet-的-DNS-服务架构" class="headerlink" title="10 综合实战案例：实现 Internet 的 DNS 服务架构"></a>10 综合实战案例：实现 Internet 的 DNS 服务架构</h2><h1 id="-5"><a href="#-5" class="headerlink" title=""></a></h1><hr>
<h1 id="二、Linux-防火墙"><a href="#二、Linux-防火墙" class="headerlink" title="二、Linux 防火墙"></a>二、Linux 防火墙</h1><h2 id="1-安全技术和防火墙"><a href="#1-安全技术和防火墙" class="headerlink" title="1 安全技术和防火墙"></a>1 安全技术和防火墙</h2><h3 id="1-1-安全技术"><a href="#1-1-安全技术" class="headerlink" title="1.1 安全技术"></a>1.1 安全技术</h3><blockquote>
<ul>
<li>入侵检测系统（Intrusion Detection Systems）</li>
</ul>
<p>特点是不阻断任何网络访问，量化、定位来自内外网络的威胁情况，主要以提供报警和事后监督为主，提供有针对性的指导措施和安全决策依据,类似于监控系统一般采用旁路部署方式</p>
<ul>
<li>入侵防御系统（Intrusion Prevention System）</li>
</ul>
<p>以透明模式工作，分析数据包的内容如：溢出攻击、拒绝服务攻击、木马、蠕虫、系统漏洞等进行准确的分析判断，在判定为攻击行为后立即予以阻断，主动而有效的保护网络的安全，一般采用在线部署方式</p>
<ul>
<li>防火墙（ FireWall ）</li>
</ul>
<p>隔离功能，工作在网络或主机边缘，对进出网络或主机的数据包基于一定的规则检查，并在匹配某规则时由规则定义的行为进行处理的一组功能的组件，基本上的实现都是默认情况下关闭所有的通过型访问，只开放允许访问的策略,会将希望外网访问的主机放在DMZ(demilitarized zone)网络中.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221021145014684-1868779511.png"><img src="2927659-20221021145014684-1868779511.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h3 id="1-2-防火墙的分类"><a href="#1-2-防火墙的分类" class="headerlink" title="1.2 防火墙的分类"></a>1.2 防火墙的分类</h3><blockquote>
<p>按保护范围划分：</p>
<ul>
<li>主机防火墙：服务范围为当前一台主机</li>
<li>网络防火墙：服务范围为防火墙一侧的局域网</li>
</ul>
<p>按实现方式划分:</p>
<ul>
<li>硬件防火墙：在专用硬件级别实现部分功能的防火墙；另一个部分功能基于软件实现，如：华为，山石hillstone,天融信，启明星辰，绿盟，深信服, PaloAlto , fortinet飞塔, Cisco, Checkpoint，NetScreen(2004年被 Juniper 用40亿美元收购)等</li>
<li>软件防火墙：运行于通用硬件平台之上的防火墙的应用软件，Windows 防火墙 ISA –&gt; ForefrontTMG</li>
</ul>
<p>按网络协议划分：</p>
<ul>
<li>网络层防火墙：OSI模型下四层，又称为包过滤防火墙</li>
<li>应用层防火墙/代理服务器：proxy 代理网关，OSI模型七层</li>
</ul>
</blockquote>
<hr>
<h2 id="2-Linux-防火墙的基本认识"><a href="#2-Linux-防火墙的基本认识" class="headerlink" title="2 Linux 防火墙的基本认识"></a>2 Linux 防火墙的基本认识</h2><h3 id="2-1-Netfilter"><a href="#2-1-Netfilter" class="headerlink" title="2.1 Netfilter"></a>2.1 Netfilter</h3><blockquote>
<p>Linux防火墙是由Netfilter组件提供的，Netfilter工作在内核空间，集成在linux内核中</p>
<p>Netfilter 是Linux 2.4.x之后新一代的Linux防火墙机制，是linux内核的一个子系统。Netfilter采用模块化设计，具有良好的可扩充性，提供扩展各种网络服务的结构化底层框架。Netfilter与IP协议栈是无缝契合，并允许对数据报进行过滤、地址转换、处理等操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># grep -m 10 NETFILTER /boot/config-4.18.0-372.9.1.el8.x86_64</span><br>CONFIG_NETFILTER=y<br>CONFIG_NETFILTER_ADVANCED=y<br>CONFIG_BRIDGE_NETFILTER=m<br>CONFIG_NETFILTER_INGRESS=y<br>CONFIG_NETFILTER_NETLINK=m<br>CONFIG_NETFILTER_FAMILY_BRIDGE=y<br>CONFIG_NETFILTER_FAMILY_ARP=y<br><span class="hljs-comment"># CONFIG_NETFILTER_NETLINK_ACCT is not set</span><br>CONFIG_NETFILTER_NETLINK_QUEUE=m<br>CONFIG_NETFILTER_NETLINK_LOG=m<br><br><span class="hljs-comment">#y表示集成在内核中</span><br>[root@rocky01 ~]<span class="hljs-comment"># ll /boot/vmlinuz-4.18.0-372.9.1.el8.x86_64</span><br><br><span class="hljs-comment">#m表示在模块中</span><br>[root@rocky01 ~]<span class="hljs-comment"># ll /lib/modules/4.18.0-372.9.1.el8.x86_64/</span><br>[root@rocky01 ~]<span class="hljs-comment"># modinfo bridge</span><br></code></pre></td></tr></table></figure>

<h3 id="2-2-防火墙工具介绍"><a href="#2-2-防火墙工具介绍" class="headerlink" title="2.2 防火墙工具介绍"></a>2.2 防火墙工具介绍</h3><h4 id="2-2-1-iptables"><a href="#2-2-1-iptables" class="headerlink" title="2.2.1 iptables"></a>2.2.1 iptables</h4><blockquote>
<p>由软件包iptables提供的命令行工具，工作在用户空间，用来编写规则，写好的规则被送往netfilter，告诉内核如何去处理信息包</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># ll `which iptables`</span><br>lrwxrwxrwx. 1 root root 17 Apr 20  2022 /usr/sbin/iptables -&gt; xtables-nft-multi<br></code></pre></td></tr></table></figure>

<h5 id="范例：安装iptables的service包"><a href="#范例：安装iptables的service包" class="headerlink" title="范例：安装iptables的service包"></a>范例：安装iptables的service包</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># dnf -y install iptables-services</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-firewalld"><a href="#2-2-2-firewalld" class="headerlink" title="2.2.2 firewalld"></a>2.2.2 firewalld</h4><blockquote>
<p>从CentOS 7 版开始引入了新的前端管理工具，到Centos8取消</p>
<p>软件包：</p>
<ul>
<li>firewalld</li>
<li>firewalld-config</li>
</ul>
<p>管理工具：</p>
<ul>
<li>firewall-cmd 命令行工具</li>
<li>firewall-config 图形工作</li>
</ul>
</blockquote>
<h4 id="2-2-3-nftables"><a href="#2-2-3-nftables" class="headerlink" title="2.2.3 nftables"></a>2.2.3 nftables</h4><blockquote>
<p>此软件是CentOS 8 新特性,Nftables最初在法国巴黎的Netfilter Workshop 2008上发表，然后由长期的netfilter核心团队成员和项目负责人Patrick McHardy于2009年3月发布。</p>
</blockquote>
<h4 id="范例：CentOS-8-支持三种防火墙服务"><a href="#范例：CentOS-8-支持三种防火墙服务" class="headerlink" title="范例：CentOS 8 支持三种防火墙服务"></a>范例：CentOS 8 支持三种防火墙服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># systemctl status iptables</span><br>● iptables.service - IPv4 firewall with iptables<br>   Loaded: loaded (/usr/lib/systemd/system/iptables.service; disabled; vendor preset: disabled)<br>   Active: inactive (dead)<br><br>[root@rocky01 ~]<span class="hljs-comment"># systemctl status firewalld</span><br>● firewalld.service - firewalld - dynamic firewall daemon<br>   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)<br>   Active: inactive (dead)<br>     Docs: man:firewalld(1)<br><br>[root@rocky01 ~]<span class="hljs-comment"># systemctl status nftables</span><br>● nftables.service - Netfilter Tables<br>   Loaded: loaded (/usr/lib/systemd/system/nftables.service; disabled; vendor preset: disabled)<br>   Active: inactive (dead)<br>     Docs: man:nft(8)<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="2-3-netfilter-中五个勾子函数和报文流向"><a href="#2-3-netfilter-中五个勾子函数和报文流向" class="headerlink" title="2.3 netfilter 中五个勾子函数和报文流向"></a>2.3 netfilter 中五个勾子函数和报文流向</h3><blockquote>
<p>Netfilter在内核中选取五个位置放了五个hook(勾子) function(INPUT、OUTPUT、FORWARD、PREROUTING、POSTROUTING)，而这五个hook function向用户开放，用户可以通过一个命令工具（iptables）向其写入规则</p>
<p>由信息过滤表（table）组成，包含控制IP包处理的规则集（rules），规则被分组放在链（chain）上</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221021155826630-240959642.png"><img src="2927659-20221021155826630-240959642.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<hr>
<h3 id="2-4-iptables的组成"><a href="#2-4-iptables的组成" class="headerlink" title="2.4 iptables的组成"></a>2.4 iptables的组成</h3><p>iptables由五个表table和五个链chain以及一些规则组成</p>
<blockquote>
<p><strong>链</strong> <strong>chain****：</strong></p>
<ul>
<li>内置链：每个内置链对应于一个钩子函数</li>
<li>自定义链：用于对内置链进行扩展或补充，可实现更灵活的规则组织管理机制；只有Hook钩子调用自定义链时，才生效</li>
</ul>
<p><strong>五个内置链****chain:</strong></p>
<ul>
<li><code>INPUT,OUTPUT,FORWARD,PREROUTING,POSTROUTING</code></li>
</ul>
<p><strong>五个表<strong><strong>table</strong></strong>：</strong>filter、nat、mangle、raw、security</p>
<ul>
<li>filter：过滤规则表，根据预定义的规则过滤符合条件的数据包,默认表</li>
<li>nat：network address translation 地址转换规则表</li>
<li>mangle：修改数据标记位规则表</li>
<li>raw：关闭启用的连接跟踪机制，加快封包穿越防火墙速度</li>
<li>security：用于强制访问控制（MAC）网络规则，由Linux安全模块（如SELinux）实现</li>
</ul>
<p><strong>优先级由高到低的顺序为：</strong></p>
<p>security –&gt;raw–&gt;mangle–&gt;nat–&gt;filter</p>
</blockquote>
<h4 id="范例：查询表和链的对应关系"><a href="#范例：查询表和链的对应关系" class="headerlink" title="范例：查询表和链的对应关系"></a>范例：查询表和链的对应关系</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># iptables -t filter -vnL</span><br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination<br><br>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination<br><br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination<br><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -t nat -vnL</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -t mangle -vnL</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -t raw -vnL</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -t security -vnL</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="2-5-netfilter-完整流程"><a href="#2-5-netfilter-完整流程" class="headerlink" title="2.5 netfilter 完整流程"></a>2.5 netfilter 完整流程</h3><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221021162824622-342021938.png"><img src="2927659-20221021162824622-342021938.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<hr>
<h2 id="3-iptables"><a href="#3-iptables" class="headerlink" title="3 iptables"></a>3 iptables</h2><h3 id="3-1-iptables-规则说明"><a href="#3-1-iptables-规则说明" class="headerlink" title="3.1 iptables 规则说明"></a>3.1 iptables 规则说明</h3><h4 id="3-1-1-iptables-规则组成"><a href="#3-1-1-iptables-规则组成" class="headerlink" title="3.1.1 iptables 规则组成"></a>3.1.1 iptables 规则组成</h4><blockquote>
<p>规则rule：根据规则的匹配条件尝试匹配报文，对匹配成功的报文根据规则定义的处理动作作出处理，规则在链接上的次序即为其检查时的生效次序</p>
<p>匹配条件：默认为与条件，同时满足</p>
<p>基本匹配：IP，端口，TCP的Flags（SYN,ACK等）</p>
<p>扩展匹配：通过复杂高级功能匹配</p>
<p>处理动作：称为target，跳转目标</p>
<ul>
<li>内建处理动作：ACCEPT,DROP,REJECT,SNAT,DNAT,MASQUERADE,MARK,LOG…</li>
<li>自定义处理动作：自定义chain，利用分类管理复杂情形</li>
</ul>
<p>规则要添加在链上，才生效；添加在自定义链上不会自动生效</p>
<p>白名单:只有指定的特定主机可以访问,其它全拒绝</p>
<p>黑名单:只有指定的特定主机拒绝访问,其它全允许,默认方式</p>
</blockquote>
<h4 id="3-1-2-iptables规则添加时考量点"><a href="#3-1-2-iptables规则添加时考量点" class="headerlink" title="3.1.2 iptables规则添加时考量点"></a>3.1.2 iptables规则添加时考量点</h4><blockquote>
<ul>
<li>要实现哪种功能：判断添加在哪张表上</li>
<li>报文流经的路径：判断添加在哪个链上</li>
<li>报文的流向：判断源和目的</li>
<li>匹配规则：业务需要</li>
</ul>
</blockquote>
<h4 id="3-1-3-环境准备"><a href="#3-1-3-环境准备" class="headerlink" title="3.1.3 环境准备"></a>3.1.3 环境准备</h4><blockquote>
<p><strong>systemctl stop firewalld.service</strong></p>
<p><strong>只是不使用系统的防火墙规则，并不是真正的关闭了firewalld</strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#CentOS 7，8：</span><br>systemctl stop firewalld.service <br>systemctl <span class="hljs-built_in">disable</span> firewalld. service<br><span class="hljs-comment">#或者</span><br>systemctl <span class="hljs-built_in">disable</span> --now firewalld. service<br><br><span class="hljs-comment">#CentOS 6：</span><br>service iptables stop<br>chkconfig iptables off<br></code></pre></td></tr></table></figure>

<h3 id="3-2-iptables-用法说明"><a href="#3-2-iptables-用法说明" class="headerlink" title="3.2 iptables 用法说明"></a>3.2 iptables 用法说明</h3><p>格式：<code>iptables [-t table] &#123;-A|-C|-D&#125; chain rule-specification</code></p>
<blockquote>
<p>命令详解：</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs inform7">iptables  <span class="hljs-comment">[-t table]</span>  SUBCOMMAND  chain  <span class="hljs-comment">[-m matchname <span class="hljs-comment">[per-match-options]</span>]</span> -j targetname <span class="hljs-comment">[per-target-options]</span><br></code></pre></td></tr></table></figure>

<p><strong>1**<strong>、</strong></strong>-t table**<strong>：指定表</strong></p>
<p>security,raw, mangle, nat, [filter]默认</p>
<p><strong>2<strong><strong>、</strong></strong>SUBCOMMAND****：子命令</strong></p>
<p><strong>链管理类</strong></p>
<ul>
<li>-N：new, 自定义一条新的规则链</li>
<li>-E：重命名自定义链；引用计数不为0的自定义链不能够被重命名，也不能被删除</li>
<li>-X：delete，删除自定义的空的规则链</li>
<li>-P：Policy，设置默认策略；对filter表中的链而言，其默认策略有：ACCEPT：接受, DROP：丢弃</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -N web</span><br><span class="hljs-comment">#改名</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -E web WEB</span><br><span class="hljs-comment">#添加规则</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A WEB -p tcp -m multiport --dports 80,443 -j ACCEPT</span><br><span class="hljs-comment">#删除</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -X WEB</span><br></code></pre></td></tr></table></figure>

<p><strong>查看类</strong></p>
<ul>
<li><strong>-L：list, 列出指定鏈上的所有规则，本选项须置后</strong></li>
<li><strong>-n：numberic，以数字格式显示地址和端口号</strong></li>
<li><strong>-v：verbose，详细信息</strong></li>
<li>-vv 更详细</li>
<li>-x：exactly，显示计数器结果的精确值,而非单位转换后的易读值</li>
<li><strong>–line-numbers：显示规则的序号</strong></li>
<li>-S selected,以iptables-save 命令格式显示链上规则</li>
</ul>
<p><strong>常用组合</strong></p>
<ul>
<li><strong>-vnL</strong></li>
<li><strong>-vvnxL –line-numbers</strong></li>
</ul>
<p><strong>规则管理类：</strong></p>
<ul>
<li><strong>-A：append，追加</strong></li>
<li><strong>-I：insert, 插入，要指明插入至的规则编号，默认为第一条</strong></li>
<li><strong>-D：delete，删除 (1) 指明规则序号 (2) 指明规则本身</strong></li>
<li>-R：replace，替换指定链上的指定规则编号</li>
<li>-F：flush，清空指定的规则链</li>
<li>-Z：zero，置零</li>
<li> iptables的每条规则都有两个计数器(1) 匹配到的报文的个数(2) 匹配到的所有报文的大小之和</li>
</ul>
</blockquote>
<h4 id="范例：Filter表中INPUT规则"><a href="#范例：Filter表中INPUT规则" class="headerlink" title="范例：Filter表中INPUT规则"></a>范例：Filter表中INPUT规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#一、丢弃从10.0.0.101发送过来的包</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -s 10.0.0.101 -j DROP</span><br><span class="hljs-comment">#二、拒绝从10.0.0.101发送过来的包</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -s 10.0.0.101 -j REJECT</span><br><span class="hljs-comment">#三、拒绝从10.0.0.0/24发送过来的包</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -s 10.0.0.0/24 -j REJECT</span><br><span class="hljs-comment">#四、插入一条允许10.0.0.1的规则（这里指定了插入在第2条）</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -I INPUT 2 -s 10.0.0.1 -j ACCEPT</span><br><span class="hljs-comment">#四、删除第2条规则</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -D INPUT 2</span><br><span class="hljs-comment">#五、允许从lo回环网卡发进来的数据</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -I INPUT -i lo -j ACCEPT</span><br><br><span class="hljs-comment">#查看规则</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -vnL --line-numbers</span><br><span class="hljs-comment">#查看收到的icmp包</span><br>[root@rocky01 ~]<span class="hljs-comment"># tcpdump -i eth0 -nn icmp</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-3-iptables-基本匹配条件"><a href="#3-3-iptables-基本匹配条件" class="headerlink" title="3.3 iptables 基本匹配条件"></a>3.3 iptables 基本匹配条件</h3><p>基本匹配条件：无需加载模块，由iptables/netfilter自行提供</p>
<blockquote>
<ul>
<li>[!] <strong>-s</strong>, –source address[/mask][,…]：源IP地址或者不连续的IP地址</li>
<li>[!] -d, –destination address[/mask][,…]：目标IP地址或者不连续的IP地址</li>
<li>[!] <strong>-p</strong>, –protocol protocol：指定协议，可使用数字如0（all）protocol: tcp, udp, icmp, icmpv6, udplite,esp, ah, sctp, mh or“all“  参看：/etc/protocols</li>
<li>[!] <strong>-i</strong>, –in-interface name：报文流入的接口；只能应用于数据报文流入环节，只应用于INPUT、FORWARD、PREROUTING链</li>
<li>[!] -o, –out-interface name：报文流出的接口；只能应用于数据报文流出的环节，只应用于FORWARD、OUTPUT、POSTROUTING链</li>
</ul>
</blockquote>
<h4 id="范例：使用方法-3"><a href="#范例：使用方法-3" class="headerlink" title="范例：使用方法"></a>范例：使用方法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#-s</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -s 10.0.0.6,10.0.0.10 -j REJECT</span><br><br><span class="hljs-comment">#-i</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -I INPUT -i lo -j ACCEPT</span><br><br><span class="hljs-comment">#-p</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -I INPUT 2 -s 10.0.0.6 ! -p icmp -j ACCEPT</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-4-iptables-扩展匹配条件"><a href="#3-4-iptables-扩展匹配条件" class="headerlink" title="3.4 iptables 扩展匹配条件"></a>3.4 iptables 扩展匹配条件</h3><blockquote>
<p>扩展匹配条件：需要加载扩展模块（/usr/lib64/xtables/*.so），方可生效</p>
<p>扩展模块的查看帮助 ：man iptables-extensions</p>
<p>扩展匹配条件：</p>
<ul>
<li>隐式扩展</li>
<li>显式扩展</li>
</ul>
</blockquote>
<h4 id="3-4-1-隐式扩展"><a href="#3-4-1-隐式扩展" class="headerlink" title="3.4.1 隐式扩展"></a>3.4.1 隐式扩展</h4><p>iptables 在使用-p选项指明了特定的协议时，无需再用-m选项指明扩展模块的扩展机制，不需要手动加载扩展模块</p>
<blockquote>
<p><strong>tcp</strong> <strong>协议的扩展选项</strong></p>
<ul>
<li>[!] –source-port, –sport port[:port]：匹配报文源端口,可为端口连续范围</li>
<li>[!] –destination-port,–dport port[:port]：匹配报文目标端口,可为连续范围</li>
<li>[!] –tcp-flags mask comp</li>
</ul>
<p><strong>udp</strong> <strong>协议的扩展选项</strong></p>
<ul>
<li>[!] –source-port, –sport port[:port]：匹配报文的源端口或端口范围</li>
<li>[!] –destination-port,–dport port[:port]：匹配报文的目标端口或端口范围</li>
</ul>
<p> <strong>icmp</strong> <strong>协议的扩展选项</strong></p>
<ul>
<li>[!] –icmp-type {type[/code]|typename}</li>
</ul>
<p>    type/code</p>
<p>    <strong>0/0  echo-reply   icmp应答</strong></p>
<p>    <strong>8/0  echo-request icmp请求</strong></p>
</blockquote>
<h5 id="范例：端口规则"><a href="#范例：端口规则" class="headerlink" title="范例：端口规则"></a>范例：端口规则</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#允许10.0.0.6能访问80端口</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -s 10.0.0.6 -p tcp --dport 80 -j ACCEPT</span><br><br><span class="hljs-comment">#允许10.0.0.6能访问80-100的端口</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -s 10.0.0.6 -p tcp --dport 80:100 -j ACCEPT</span><br><br><span class="hljs-comment">#我能ping通10.0.0.6，10.0.0.6不能ping通我</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -s 10.0.0.6 -p icmp --icmp-type 0 -j ACCEPT</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -s 10.0.0.6 -j REJECT</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-2-显式扩展及相关模块"><a href="#3-4-2-显式扩展及相关模块" class="headerlink" title="3.4.2 显式扩展及相关模块"></a>3.4.2 显式扩展及相关模块</h4><p>显示扩展即必须<strong>使用-m选项指明要调用的扩展模块名称</strong>，需要手动加载扩展模块</p>
<blockquote>
<p> <strong>扩展模块的使用帮助：</strong></p>
<ul>
<li>CentOS 7,8: man iptables-extensions</li>
<li>CentOS 6: man iptables</li>
</ul>
</blockquote>
<h5 id="3-4-2-1-multiport扩展"><a href="#3-4-2-1-multiport扩展" class="headerlink" title="3.4.2.1 multiport扩展"></a>3.4.2.1 multiport扩展</h5><blockquote>
<p>以离散方式定义多端口匹配,最多指定15个端口</p>
<p>#指定多个源端口</p>
<ul>
<li>[!] –source-ports,<strong>–sports port</strong>[,port|,port:port]…</li>
</ul>
<p># 指定多个目标端口</p>
<ul>
<li>[!] –destination-ports,–dports port[,port|,port:port]…</li>
</ul>
<p>#多个源或目标端</p>
<ul>
<li>[!] –ports port[,port|,port:port]…</li>
</ul>
</blockquote>
<h6 id="范例：端口规则-1"><a href="#范例：端口规则-1" class="headerlink" title="范例：端口规则"></a>范例：端口规则</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#允许10.0.0.6能访问80和443端口</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -s 10.0.0.6 -p tcp -m multiport --dports 80,443 -j ACCEPT</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-2-2-iprange扩展"><a href="#3-4-2-2-iprange扩展" class="headerlink" title="3.4.2.2 iprange扩展"></a>3.4.2.2 iprange扩展</h5><blockquote>
<p>指明连续的（但一般不是整个网络）ip地址范围</p>
<ul>
<li>[!] –src-range from[-to] 源IP地址范围</li>
<li>[!] –dst-range from[-to] 目标IP地址范围</li>
</ul>
</blockquote>
<p><strong>范例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -p tcp --dport 80 -m iprange --src-range 172.16.1.5-172.16.1.10 -j DROP</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-2-3-mac扩展"><a href="#3-4-2-3-mac扩展" class="headerlink" title="3.4.2.3 mac扩展"></a>3.4.2.3 mac扩展</h5><blockquote>
<p>mac 模块可以指明源MAC地址,，适用于：PREROUTING, FORWARD，INPUT chains</p>
<ul>
<li>[!] –mac-source XX:XX:XX:XX:XX:XX</li>
</ul>
</blockquote>
<p><strong>范例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#允许MAC地址为00:50:56:12:34:56</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -m mac --mac-source 00:50:56:12:34:56 -j ACCEPT</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-2-4-string扩展"><a href="#3-4-2-4-string扩展" class="headerlink" title="3.4.2.4 string扩展"></a>3.4.2.4 string扩展</h5><blockquote>
<ul>
<li>对报文中的应用层数据做字符串模式匹配检测</li>
<li>–algo {bm|kmp} 字符串匹配检测算法</li>
</ul>
<p>  bm：Boyer-Moore</p>
<p>  kmp：Knuth-Pratt-Morris</p>
<ul>
<li>–from offset 开始偏移</li>
<li>–to offset  结束偏移</li>
<li>[!] –string pattern 要检测的字符串模式</li>
<li>[!] –hex-string pattern 要检测字符串模式，16进制格式</li>
</ul>
</blockquote>
<p><strong>范例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#如果index.html含&quot;google&quot;,就拒绝</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A OUTPUT -m string --algo bm --from 62 --string &quot;google&quot; -j REJECT</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-2-5-time扩展"><a href="#3-4-2-5-time扩展" class="headerlink" title="3.4.2.5 time扩展"></a>3.4.2.5 time扩展</h5><p><strong>注意：****CentOS 8</strong> <strong>此模块有问题</strong></p>
<blockquote>
<ul>
<li>–datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]] 日期</li>
<li>–datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]</li>
<li>–timestart hh:mm[:ss]    时间</li>
<li>–timestop hh:mm[:ss]</li>
<li>[!] –monthdays day[,day…]  每个月的几号</li>
<li>[!] –weekdays day[,day…]  星期几，1 – 7 分别表示星期一到星期日</li>
<li>–kerneltz：内核时区（当地时间），不建议使用，CentOS 7版本以上系统默认为 UTC</li>
</ul>
<p>注意： centos6 不支持kerneltz ，–localtz指定本地时区(默认)</p>
</blockquote>
<p><strong>范例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos7 ~]<span class="hljs-comment"># iptables -A INPUT -m time --timestart 14:30 --timestop 18:30 --weekdays 1,2,3,4,5 -j REJECT</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-2-6-connlimit扩展"><a href="#3-4-2-6-connlimit扩展" class="headerlink" title="3.4.2.6 connlimit扩展"></a>3.4.2.6 connlimit扩展</h5><blockquote>
<p>根据每客户端IP做并发连接数数量匹配</p>
<p>可防止Dos(Denial of Service，拒绝服务)攻击</p>
<ul>
<li>–connlimit-upto N #连接的数量小于等于N时匹配</li>
<li>–connlimit-above N #连接的数量大于N时匹配</li>
</ul>
</blockquote>
<p><strong>范例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#连接数量大于10就拒绝</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -m connlimit --connlimit-above 10 -j REJECT</span><br></code></pre></td></tr></table></figure>

<h5 id="3-4-2-7-limit扩展"><a href="#3-4-2-7-limit扩展" class="headerlink" title="3.4.2.7 limit扩展"></a>3.4.2.7 limit扩展</h5><blockquote>
<p>基于收发报文的速率做匹配 , 令牌桶过滤器</p>
<ul>
<li>–limit-burst number #前多少个包不限制</li>
<li>–limit #[/second|/minute|/hour|/day]</li>
</ul>
</blockquote>
<p><strong>范例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#1分钟限制10个报文，前5个不限制，第5个之后开始限流</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -p icmp -m limit --limit 10/minute --limit-burst 5 -j ACCEPT</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -I INPUT 2 -p icmp -j REJECT</span><br>[root@rocky01 ~]<span class="hljs-comment"># hostname -I</span><br>10.0.0.128<br><br><span class="hljs-comment">#测试</span><br>[root@ubuntu01 ~]<span class="hljs-comment"># ping 10.0.0.128</span><br>PING 10.0.0.128 (10.0.0.128) 56(84) bytes of data.<br>64 bytes from 10.0.0.128: icmp_seq=1 ttl=64 time=0.512 ms<br>64 bytes from 10.0.0.128: icmp_seq=2 ttl=64 time=0.728 ms<br>64 bytes from 10.0.0.128: icmp_seq=3 ttl=64 time=0.479 ms<br>64 bytes from 10.0.0.128: icmp_seq=4 ttl=64 time=0.876 ms<br>64 bytes from 10.0.0.128: icmp_seq=5 ttl=64 time=0.587 ms<br>From 10.0.0.128 icmp_seq=6 Destination Port Unreachable<br>64 bytes from 10.0.0.128: icmp_seq=7 ttl=64 time=0.662 ms<br>From 10.0.0.128 icmp_seq=8 Destination Port Unreachable<br>From 10.0.0.128 icmp_seq=9 Destination Port Unreachable<br>From 10.0.0.128 icmp_seq=10 Destination Port Unreachable<br>From 10.0.0.128 icmp_seq=11 Destination Port Unreachable<br>From 10.0.0.128 icmp_seq=12 Destination Port Unreachable<br>64 bytes from 10.0.0.128: icmp_seq=13 ttl=64 time=0.392 ms<br>From 10.0.0.128 icmp_seq=14 Destination Port Unreachable<br></code></pre></td></tr></table></figure>

<h5 id="3-4-2-8-state扩展"><a href="#3-4-2-8-state扩展" class="headerlink" title="3.4.2.8 state扩展"></a>3.4.2.8 state扩展</h5><blockquote>
<p>state 扩展模块，可以根据”连接追踪机制“去检查连接的状态，较耗资源</p>
<p>conntrack机制：追踪本机上的请求和响应之间的关系</p>
<p><strong>状态类型</strong></p>
<ul>
<li><strong>NEW：新发出请求；连接追踪信息库中不存在此连接的相关信息条目，因此，将其识别为第一次发出的请求</strong></li>
<li><strong>ESTABLISHED：NEW状态之后，连接追踪信息库中为其建立的条目失效之前期间内所进行的通信状态</strong></li>
<li><strong>RELATED：新发起的但与已有连接相关联的连接，如：ftp协议中的数据连接与命令连接之间的关系</strong></li>
<li>INVALID：无效的连接，如flag标记不正确</li>
<li>UNTRACKED：未进行追踪的连接，如：raw表中关闭追踪</li>
</ul>
</blockquote>
<h6 id="调整连接追踪功能所能够容纳的最大连接数量"><a href="#调整连接追踪功能所能够容纳的最大连接数量" class="headerlink" title="调整连接追踪功能所能够容纳的最大连接数量"></a>调整连接追踪功能所能够容纳的最大连接数量</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># cat /proc/sys/net/netfilter/nf_conntrack_max</span><br>65536<br>[root@centos8 ~]<span class="hljs-comment"># cat /proc/sys/net/nf_conntrack_max</span><br>65536<br></code></pre></td></tr></table></figure>

<h6 id="范例-面试题"><a href="#范例-面试题" class="headerlink" title="范例: 面试题"></a>范例: 面试题</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment"># echo 1 &gt; /proc/sys/net/netfilter/nf_conntrack_max</span><br>[root@centos8 ~]<span class="hljs-comment"># tail /var/log/messages </span><br>Jul  8 10:03:53 centos8 kernel: nf_conntrack: nf_conntrack: table full, dropping packet<br>[root@centos6 ~]<span class="hljs-comment"># tail /var/log/messages</span><br>Jul  8 09:51:16 centos6 kernel: nf_conntrack: table full, dropping packet.<br><br><span class="hljs-comment">#问：在日志中发现Jul  8 10:03:53 centos8 kernel: nf_conntrack: nf_conntrack: table full, dropping packet</span><br><span class="hljs-comment">#这条记录出现，为什么？</span><br><br><span class="hljs-comment">#解：连接过多的解决方法两个：</span><br>(1) 加大nf_conntrack_max 值<br>vim /etc/sysctl.conf<br>net.nf_conntrack_max = 393216<br>net.netfilter.nf_conntrack_max = 393216<br>(2) 降低 nf_conntrack <span class="hljs-built_in">timeout</span>时间<br>vim /etc/sysctl.conf<br>net.netfilter.nf_conntrack_tcp_timeout_established = 300<br>net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120<br>net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60<br>net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120<br>iptables -t nat -L -n<br></code></pre></td></tr></table></figure>

<h6 id="范例-单向通讯"><a href="#范例-单向通讯" class="headerlink" title="范例: 单向通讯"></a>范例: 单向通讯</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#我能访问你，你不能访问我</span><br><span class="hljs-comment">#方法一：单个</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -s 10.0.0.129 -m state --state NEW -j REJECT</span><br><br><span class="hljs-comment">#方法二：多个</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -I INPUT -m state --state ESTABLISHED -j ACCEPT</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -A INPUT -j REJECT</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-5-Target"><a href="#3-5-Target" class="headerlink" title="3.5 Target"></a>3.5 Target</h3><blockquote>
<p>target 包括以下类型：</p>
<ul>
<li>自定义链, ACCEPT， DROP， REJECT，RETURN,LOG，SNAT，DNAT，REDIRECT，MASQUERADE</li>
<li>LOG：非中断target,本身不拒绝和允许,放在拒绝和允许规则前，并将日志记录在/var/log/messages系统日志中</li>
<li>–log-level level  级别： debug，info，notice, warning, error, crit, alert,emerg</li>
<li>–log-prefix prefix 日志前缀，用于区别不同的日志，最多29个字符</li>
</ul>
</blockquote>
<hr>
<h3 id="3-6-规则优化最佳实践"><a href="#3-6-规则优化最佳实践" class="headerlink" title="3.6 规则优化最佳实践"></a>3.6 规则优化最佳实践</h3><blockquote>
<ol>
<li>安全放行所有入站和出站的状态为ESTABLISHED状态连接,建议放在第一条，效率更高</li>
<li>谨慎放行入站的新请求</li>
<li>有特殊目的限制访问功能，要在放行规则之前加以拒绝</li>
<li><strong>同类规则（访问同一应用，比如：http ），匹配范围小的放在前面，用于特殊处理</strong></li>
<li><strong>不同类的规则（访问不同应用，一个是http，另一个是mysql ），匹配范围大的放在前面，效率更高</strong></li>
<li>应该将那些可由一条规则能够描述的多个规则合并为一条,减少规则数量,提高检查效率</li>
<li>设置默认策略，建议白名单（只放行特定连接）</li>
</ol>
<ul>
<li><ul>
<li>iptables -P，不建议，容易出现“自杀现象”</li>
<li>规则的最后定义规则做为默认策略，推荐使用，放在最后一条</li>
</ul>
</li>
</ul>
</blockquote>
<hr>
<h3 id="3-7-iptables规则保存"><a href="#3-7-iptables规则保存" class="headerlink" title="3.7 iptables规则保存"></a>3.7 iptables规则保存</h3><p>使用iptables命令定义的规则，手动删除之前，其生效期限为kernel存活期限</p>
<blockquote>
<p><strong>持久保存规则</strong></p>
<ul>
<li>CentOS 7,8</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">iptables-save &gt; /PATH/TO/SOME_RULES_FILE<br></code></pre></td></tr></table></figure>

<ul>
<li>CentOS 6</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#将规则覆盖保存至/etc/sysconfig/iptables文件中</span><br>service iptables save<br></code></pre></td></tr></table></figure>

<p><strong>加载规则</strong></p>
<ul>
<li>CentOS 7,8 重新载入预存规则文件中规则</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">iptables-restore &lt; /PATH/FROM/SOME_RULES_FILE<br></code></pre></td></tr></table></figure>

<ul>
<li>iptables-restore选项</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">-n, --noflush：不清除原有规则<br>-t, --<span class="hljs-built_in">test</span>：仅分析生成规则集，但不提交<br></code></pre></td></tr></table></figure>

<ul>
<li> CentOS 6</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#会自动从/etc/sysconfig/iptables 重新载入规则</span><br>service iptables restart<br></code></pre></td></tr></table></figure>

<p><strong>开机自动重载规则</strong></p>
<ul>
<li>用脚本保存各个iptables命令；让此脚本开机后自动运行**/etc/rc.d/rc.loca**l文件中添加脚本路径 /PATH/TO/SOME_SCRIPT_FILE</li>
<li>用规则文件保存各个规则，开机时自动载入此规则文件中的规则在/etc/rc.d/rc.local文件添加</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">iptables-restore &lt; /PATH/FROM/IPTABLES_RULES_FILE<br></code></pre></td></tr></table></figure>

<ul>
<li>定义Unit File, CentOS 7，8 可以安装 <strong>iptables-services</strong> 实现iptables.service</li>
</ul>
<p>范例: CentOS 7，8 使用 iptables-services</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装服务</span><br>[root@centos8 ~]<span class="hljs-comment"># yum -y install iptables-services</span><br><br><span class="hljs-comment">#备份</span><br>[root@centos8 ~]<span class="hljs-comment"># cp /etc/sysconfig/iptables&#123;,.bak&#125;</span><br><br><span class="hljs-comment">#保存现在的规则到文件中方法1</span><br>[root@centos8 ~]<span class="hljs-comment"># /usr/libexec/iptables/iptables.init save</span><br><br><span class="hljs-comment">#保存现在的规则到文件中方法2</span><br>[root@centos8 ~]<span class="hljs-comment"># iptables-save &gt; /etc/sysconfig/iptables</span><br><br><span class="hljs-comment">#开机启动</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl enable iptables.service    </span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl mask firewalld.service nftables.service</span><br></code></pre></td></tr></table></figure>
</blockquote>
<hr>
<h3 id="3-8-网络防火墙"><a href="#3-8-网络防火墙" class="headerlink" title="3.8 网络防火墙"></a>3.8 网络防火墙</h3><p>iptables/netfilter 利用filter表的FORWARD链,可以充当网络防火墙</p>
<h4 id="3-8-1-FORWARD-链实现内外网络的流量控制"><a href="#3-8-1-FORWARD-链实现内外网络的流量控制" class="headerlink" title="3.8.1 FORWARD 链实现内外网络的流量控制"></a>3.8.1 FORWARD 链实现内外网络的流量控制</h4><h5 id="范例-实现内网访问可以访问外网-反之禁止"><a href="#范例-实现内网访问可以访问外网-反之禁止" class="headerlink" title="范例: 实现内网访问可以访问外网,反之禁止"></a>范例: 实现内网访问可以访问外网,反之禁止</h5><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221022151736334-206807770.png"><img src="2927659-20221022151736334-206807770.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#一、从10.0.0.0/24网段到除了10.0.0.0/24网段的第一个包接收</span><br>[root@firewall ~]<span class="hljs-comment"># iptables -I FORWARD 1 -s 10.0.0.0/24 ! -d 10.0.0.0/24 -m state --state NEW -j ACCEPT</span><br><br><span class="hljs-comment">#二、接收所有ESTABLISHED的包</span><br>[root@firewall ~]<span class="hljs-comment"># iptables -I FORWARD 2 -m state --state ESTABLISHED -j ACCEPT</span><br><br><span class="hljs-comment">#三、外部网络到的10.0.0.7允许</span><br>[root@firewall ~]<span class="hljs-comment"># iptables -I FORWARD 3 ! -s 10.0.0.0/24 -d 10.0.0.7 -m state --state NEW -j ACCEPT</span><br><br><span class="hljs-comment">#四、</span><br>[root@firewall ~]<span class="hljs-comment"># iptables -I FORWARD 4 -j REJECT</span><br></code></pre></td></tr></table></figure>

<hr>
<h4 id="3-8-2-NAT-表"><a href="#3-8-2-NAT-表" class="headerlink" title="3.8.2 NAT 表"></a>3.8.2 NAT 表</h4><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221022162202913-1703421813.png"><img src="2927659-20221022162202913-1703421813.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<p>NAT: network address translation，支持PREROUTING，INPUT，OUTPUT，POSTROUTING四个链</p>
<p>请求报文：修改源/目标IP，由定义如何修改</p>
<p>响应报文：修改源/目标IP，根据跟踪机制自动实现</p>
<p>NAT的实现分为下面类型：</p>
<ul>
<li>SNAT：source NAT ，支持POSTROUTING, INPUT，让本地网络中的主机通过某一特定地址访问外部网络，实现地址伪装,请求报文：修改源IP</li>
<li>DNAT：destination NAT 支持PREROUTING , OUTPUT，把本地网络中的主机上的某服务开放给外部网络访问(发布服务和端口映射)，但隐藏真实IP,请求报文：修改目标IP</li>
<li>PNAT: port nat，端口和IP都进行修改</li>
</ul>
</blockquote>
<hr>
<h4 id="3-8-3-SNAT"><a href="#3-8-3-SNAT" class="headerlink" title="3.8.3 SNAT"></a>3.8.3 SNAT</h4><blockquote>
<p>SNAT：基于nat表的target，适用于固定的公网IP。<strong>适用于专线网络</strong></p>
<p>SNAT选项：</p>
<ul>
<li>–to-source [ipaddr[-ipaddr]][:port[-port]]</li>
<li>–random</li>
</ul>
<p>格式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j SNAT --to-source ExtIP<br></code></pre></td></tr></table></figure>

<p><strong>注意</strong><strong>:</strong> <strong>需要开启</strong> <strong>ip_forward</strong></p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">iptables -t nat -A POSTROUTING -s 10.0.0.0/24 ! –d 10.0.0.0/24 -j SNAT --tosource 172.18.1.6-172.18.1.9<br></code></pre></td></tr></table></figure>

<p>MASQUERADE：基于nat表的target，<strong>适用于动态的公网IP，如：拨号网络。专线适用</strong></p>
<p>MASQUERADE选项：</p>
<ul>
<li>–to-ports port[-port]</li>
<li>–random</li>
</ul>
<p>格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j MASQUERADE<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">iptables -t nat -A POSTROUTING -s 10.0.0.0/24 ! -d 10.0.0.0/24 -j MASQUERADE<br></code></pre></td></tr></table></figure>
</blockquote>
<h5 id="范例：查看本地主机访问公网时使用的IP"><a href="#范例：查看本地主机访问公网时使用的IP" class="headerlink" title="范例：查看本地主机访问公网时使用的IP"></a>范例：查看本地主机访问公网时使用的IP</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#curl http://ifconfig.me</span><br>111.199.191.204<br><br>[root@centos8 ~]<span class="hljs-comment">#curl -L http://tool.lu/ip</span><br>当前IP: 111.199.191.204<br>归属地: 中国 北京 北京<br><br>[root@firewall ~]<span class="hljs-comment">#curl cip.cc</span><br>IP : 39.164.140.134<br>地址 : 中国 河南 鹤壁<br>运营商 : 移动<br>数据二 : 河南省郑州市 | 移动<br>数据三 : <br>URL : http://www.cip.cc/39.164.140.134<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="3-8-4-DNAT"><a href="#3-8-4-DNAT" class="headerlink" title="3.8.4 DNAT"></a>3.8.4 DNAT</h4><blockquote>
<p><strong>DNAT：nat表的target，适用于端口映射，即可重定向到本机，也可以支持重定向至不同主机的不同端口</strong>，但不支持多目标，即不支持负载均衡功能</p>
<p>DNAT选项：</p>
<p>–to-destination [ipaddr[-ipaddr]][:port[-port]]</p>
<p>格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">iptables -t nat -A PREROUTING -d ExtIP -p tcp|udp --dport PORT -j DNAT --todestination InterSeverIP[:PORT]<br></code></pre></td></tr></table></figure>

<p><strong>注意</strong><strong>:</strong> <strong>需要开启</strong> <strong>ip_forward</strong></p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#启用路由转发</span><br>[root@firewall ~]<span class="hljs-comment"># vim /etc/sysctl.conf </span><br>net.ipv4.ip_forward=1<br>[root@firewall ~]<span class="hljs-comment"># sysctl -p</span><br><br><span class="hljs-comment">#公网6.6.6.8访问内网10.0.0.7:80转发到内网10.0.0.7:8080</span><br>[root@firewall ~]<span class="hljs-comment"># iptables -t nat -A PREROUTING -d 6.6.6.8 -p tcp --dport 80 -j DNAT --to-destination 10.0.0.7:8080</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="3-8-5-REDIRECT-转发"><a href="#3-8-5-REDIRECT-转发" class="headerlink" title="3.8.5 REDIRECT 转发"></a>3.8.5 REDIRECT 转发</h4><blockquote>
<p>REDIRECT，是NAT表的 target，通过改变目标IP和端口，将接受的包转发至同一个主机的不同端口，可用于PREROUTING OUTPUT链</p>
<p>REDIRECT选项：</p>
<ul>
<li>–to-ports port[-port]</li>
</ul>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># hostname -I</span><br>10.0.0.128<br><br><span class="hljs-comment">#将访问本机的80端口转到8080端口</span><br>[root@rocky01 ~]<span class="hljs-comment"># iptables -t nat -A PREROUTING -d 10.0.0.128 -p tcp --dport 80 -j REDIRECT --to-ports 8080</span><br></code></pre></td></tr></table></figure>
</blockquote>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/28/linux%E8%BF%9B%E9%98%B6%E6%8A%80%E8%83%BD/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">linux进阶技能</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/28/%E7%AC%AC%E4%B9%9D%E5%91%A8/">
                        <span class="hidden-mobile">第九周</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://qm.qq.com/cgi-bin/qm/qr?k=A5I1aDMT5p5nmi3zDa8t7gWOHawJhjyi&noverify=0&personal_qrcode_source=4" target="_blank" rel="nofollow noopener"><span>JohnBakcu</span></a> <i class="iconfont icon-love"></i> <a href="https://www.magedu.com"  target="_blank" rel="nofollow noopener"><span>Mgedu</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
