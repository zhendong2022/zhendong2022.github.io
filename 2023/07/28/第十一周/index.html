

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="1 ansible 常用指令总结，并附有相关示例。 &#x2F;usr&#x2F;bin&#x2F;ansible 主程序，临时命令执行工具 &#x2F;usr&#x2F;bin&#x2F;ansible-doc 查看配置文档，模块功能查看工具,相当于man &#x2F;usr&#x2F;bin&#x2F;ansible-playbook 定制自动化任务，编排剧本工具,相当于脚本 &#x2F;usr&#x2F;bin&#x2F;ansible-pull 远程执行命令的工具 &#x2F;usr&#x2F;bin&#x2F;ansible-vaul">
<meta property="og:type" content="article">
<meta property="og:title" content="第十一周">
<meta property="og:url" content="http://example.com/2023/07/28/%E7%AC%AC%E5%8D%81%E4%B8%80%E5%91%A8/index.html">
<meta property="og:site_name" content="Mgedu-N80054">
<meta property="og:description" content="1 ansible 常用指令总结，并附有相关示例。 &#x2F;usr&#x2F;bin&#x2F;ansible 主程序，临时命令执行工具 &#x2F;usr&#x2F;bin&#x2F;ansible-doc 查看配置文档，模块功能查看工具,相当于man &#x2F;usr&#x2F;bin&#x2F;ansible-playbook 定制自动化任务，编排剧本工具,相当于脚本 &#x2F;usr&#x2F;bin&#x2F;ansible-pull 远程执行命令的工具 &#x2F;usr&#x2F;bin&#x2F;ansible-vaul">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/07/28/%E7%AC%AC%E5%8D%81%E4%B8%80%E5%91%A8/3077161-20230110094302604-1848189472.png">
<meta property="og:image" content="http://example.com/2023/07/28/%E7%AC%AC%E5%8D%81%E4%B8%80%E5%91%A8/3077161-20230110094302648-1358849118.png">
<meta property="og:image" content="http://example.com/2023/07/28/%E7%AC%AC%E5%8D%81%E4%B8%80%E5%91%A8/3077161-20230110094302642-1874303812.png">
<meta property="article:published_time" content="2023-07-28T20:38:30.000Z">
<meta property="article:modified_time" content="2023-07-30T21:21:41.289Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/07/28/%E7%AC%AC%E5%8D%81%E4%B8%80%E5%91%A8/3077161-20230110094302604-1848189472.png">
  
  
  <title>第十一周 - Mgedu-N80054</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>JohnBackus</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="第十一周">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-07-28 20:38" pubdate>
        July 28, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      35k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      296 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第十一周</h1>
            
            <div class="markdown-body">
              <h2 id="1-ansible-常用指令总结，并附有相关示例。"><a href="#1-ansible-常用指令总结，并附有相关示例。" class="headerlink" title="1 ansible 常用指令总结，并附有相关示例。"></a>1 ansible 常用指令总结，并附有相关示例。</h2><ul>
<li><code>/usr/bin/ansible</code> 主程序，临时命令执行工具</li>
<li><code>/usr/bin/ansible-doc </code>查看配置文档，模块功能查看工具,相当于man</li>
<li><code>/usr/bin/ansible-playbook</code> 定制自动化任务，编排剧本工具,相当于脚本</li>
<li><code>/usr/bin/ansible-pull </code>远程执行命令的工具</li>
<li><code>/usr/bin/ansible-vault</code> 文件加密工具</li>
<li><code>/usr/bin/ansible-console</code> 基于Console界面与用户交互的执行工具</li>
<li><code>/usr/bin/ansible-galaxy</code> 下载/上传优秀代码或Roles模块的官网平台</li>
</ul>
<p><strong>利用ansible实现管理的主要方式：</strong></p>
<ul>
<li><code>Ansible Ad-Hoc</code> 即利用ansible命令，主要用于临时命令使用场景</li>
<li><code>Ansible playbook</code> 主要用于长期规划好的，大型项目的场景，需要有前期的规划过程</li>
</ul>
<p><strong>ansible 使用前准备</strong></p>
<p>ansible 相关工具大多数是通过ssh协议，实现对远程主机的配置管理、应用部署、任务执行等功能</p>
<p>建议：使用此工具前，先配置ansible主控端能基于密钥认证的方式联系各个被管理节点</p>
<h3 id="1-1-ansible-doc"><a href="#1-1-ansible-doc" class="headerlink" title="1.1 ansible-doc"></a>1.1 ansible-doc</h3><p>此工具用来显示模块帮助,相当于man</p>
<p>格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs bash">ansible-doc [options] [module...]<br>-l, --list <span class="hljs-comment">#列出可用模块</span><br>-s, --snippet <span class="hljs-comment">#显示指定模块的playbook片段</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#列出所有模块</span><br>ansible-doc -l<br><span class="hljs-comment">#查看指定模块帮助用法</span><br>ansible-doc ping<br><span class="hljs-comment">#查看指定模块帮助用法</span><br>ansible-doc -s ping<br></code></pre></td></tr></table></figure>

<p>范例: 查看指定的插件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[13:38:40 root@ansible-rocky ~]$ ansible-doc -t connection -l<br>[13:39:08 root@ansible-rocky ~]$ ansible-doc -t lookup -l<br></code></pre></td></tr></table></figure>

<h3 id="1-2-ansible"><a href="#1-2-ansible" class="headerlink" title="1.2 ansible"></a>1.2 ansible</h3><h4 id="1-2-1-Ansible-Ad-Hoc-介绍"><a href="#1-2-1-Ansible-Ad-Hoc-介绍" class="headerlink" title="1.2.1 Ansible Ad-Hoc 介绍"></a>1.2.1 Ansible Ad-Hoc 介绍</h4><p>Ansible Ad-Hoc 的执行方式的主要工具就是 ansible<br>特点: 一次性的执行,不会保存执行命令信息,只适合临时性或测试性的任务</p>
<h4 id="1-2-2-ansible-命令用法"><a href="#1-2-2-ansible-命令用法" class="headerlink" title="1.2.2 ansible 命令用法"></a>1.2.2 ansible 命令用法</h4><p>格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible &lt;host-pattern&gt; [-m module_name] [-a args]<br></code></pre></td></tr></table></figure>

<p>选项说明：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">--version                               <span class="hljs-comment">#显示版本</span><br>-m module                               <span class="hljs-comment">#指定模块，默认为command</span><br>-v                                      <span class="hljs-comment">#详细过程 -vv -vvv更详细</span><br>--list-hosts                            <span class="hljs-comment">#显示主机列表，可简写 --list</span><br>-C, --check                             <span class="hljs-comment">#检查，并不执行</span><br>-T, --<span class="hljs-built_in">timeout</span>=TIMEOUT                   <span class="hljs-comment">#执行命令的超时时间，默认10s</span><br>-k, --ask-pass                          <span class="hljs-comment">#提示输入ssh连接密码，默认Key验证</span><br>-u, --user=REMOTE_USER                  <span class="hljs-comment">#执行远程执行的用户,默认root</span><br>-b, --become                            <span class="hljs-comment">#代替旧版的sudo实现通过sudo机制实现提升权限</span><br>--become-user=USERNAME                  <span class="hljs-comment">#指定sudo的run as用户，默认为root</span><br>-K, --ask-become-pass                   <span class="hljs-comment">#提示输入sudo时的口令</span><br>-f FORKS, --forks FORKS                 <span class="hljs-comment">#指定并发同时执行ansible任务的主机数</span><br>-i INVENTORY, --inventory INVENTORY     <span class="hljs-comment">#指定主机清单文件</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#先打通基于key验证</span><br><span class="hljs-comment">#以yanlinux用户执行ping存活检测</span><br>[14:28:30 yanlinux@ansible-rocky ~]$ ansible all -m ping -u yanlinux<br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/libexec/platform-python&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.102 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python3&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><br><span class="hljs-comment">#以yanlinux sudo至root执行命令</span><br><span class="hljs-comment">##没有添加sudo授权之前</span><br>[14:36:46 yanlinux@ansible-rocky ~]$ ansible all -a <span class="hljs-string">&#x27;ls /root&#x27;</span><br>10.0.0.18 | FAILED | rc=2 &gt;&gt;<br><span class="hljs-built_in">ls</span>: cannot open directory <span class="hljs-string">&#x27;/root&#x27;</span>: Permission deniednon-zero <span class="hljs-built_in">return</span> code<br>10.0.0.102 | FAILED | rc=2 &gt;&gt;<br><span class="hljs-built_in">ls</span>: cannot open directory <span class="hljs-string">&#x27;/root&#x27;</span>: Permission deniednon-zero <span class="hljs-built_in">return</span> code<br>10.0.0.7 | FAILED | rc=2 &gt;&gt;<br><span class="hljs-built_in">ls</span>: cannot open directory /root: Permission deniednon-zero <span class="hljs-built_in">return</span> code<br><span class="hljs-comment">##在所有被控制主机上都加上suod授权</span><br>[14:30:46 root@ansible-rocky ~]$ <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;yanlinux    ALL=(ALL)   NOPASSWD: ALL&quot;</span> &gt;&gt; /etc/sudoers<br>[14:37:01 yanlinux@ansible-rocky ~]$ ansible all -a <span class="hljs-string">&#x27;ls /root&#x27;</span> -b<br>10.0.0.102 | CHANGED | rc=0 &gt;&gt;<br>init_os.sh<br>snap<br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>anaconda-ks.cfg<br>init_os.sh<br>10.0.0.18 | CHANGED | rc=0 &gt;&gt;<br>anaconda-ks.cfg<br>init_os.sh<br><span class="hljs-comment">##所有被管理主机上创建用户magedu</span><br>[14:37:05 yanlinux@ansible-rocky ~]$ ansible all -a <span class="hljs-string">&#x27;useradd magedu&#x27;</span> -b<br>10.0.0.102 | CHANGED | rc=0 &gt;&gt;<br><br>10.0.0.18 | CHANGED | rc=0 &gt;&gt;<br><br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br><br>[14:39:46 yanlinux@ansible-rocky ~]$ ansible all -a <span class="hljs-string">&#x27;getent passwd magedu&#x27;</span> -b<br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>magedu:x:1002:1002::/home/magedu:/bin/bash<br>10.0.0.102 | CHANGED | rc=0 &gt;&gt;<br>magedu:x:1001:1001::/home/magedu:/bin/sh<br>10.0.0.18 | CHANGED | rc=0 &gt;&gt;<br>magedu:x:1001:1001::/home/magedu:/bin/bash<br></code></pre></td></tr></table></figure>

<p>范例: 并发执行控制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#并发是1一个主机一个主机的执行，一条条返回结果</span><br>[14:42:47 root@ansible-rocky ~]$ ansible all -a <span class="hljs-string">&#x27;sleep 5&#x27;</span> -f1<br><span class="hljs-comment">#并发是10，同时10个主机执行命令，返回结果</span><br>[14:42:47 root@ansible-rocky ~]$ ansible all -a <span class="hljs-string">&#x27;sleep 5&#x27;</span> -f10<br></code></pre></td></tr></table></figure>

<p>范例: 使用普通用户连接远程主机执行代替另一个用户身份执行操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在被管理主机上创建用户并sudo授权</span><br>[14:34:00 root@ubuntu2004 ~]$ useradd magedu<br>[14:34:29 root@ubuntu2004 ~]$ <span class="hljs-built_in">echo</span> magedu:centos1 |chpasswd<br><br><span class="hljs-comment">#以yanlinux的用户连接用户并利用sudo代表magedu执行whoami命令</span><br>[14:58:37 yanlinux@ansible-rocky ~]$ ansible all -a <span class="hljs-string">&#x27;whoami&#x27;</span> -b --become-user=magedu<br>10.0.0.18 | CHANGED | rc=0 &gt;&gt;<br>magedu<br>10.0.0.7 | CHANGED | rc=0 &gt;&gt;<br>magedu<br></code></pre></td></tr></table></figure>

<h3 id="1-3-ansible-console"><a href="#1-3-ansible-console" class="headerlink" title="1.3 ansible-console"></a>1.3 ansible-console</h3><p>此工具可交互执行命令，支持tab，ansible 2.0+新增<br>提示符格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$<br></code></pre></td></tr></table></figure>

<p>常用子命令：</p>
<ul>
<li>设置并发数： <code>forks n</code> 例如： <code>forks 10</code></li>
<li>切换组： <code>cd</code> 主机组 例如： <code>cd web</code></li>
<li>列出当前组主机列表： <code>list</code></li>
<li>列出所有的内置命令： <code>?或help</code></li>
</ul>
<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">[15:24:28 root@ansible-rocky ~]$ ansible-console <br>Welcome to the ansible console. Type <span class="hljs-built_in">help</span> or ? to list commands.<br><br>root@all (3)[f:5]$ ping<br>10.0.0.18 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/libexec/platform-python&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.102 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python3&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>10.0.0.7 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>root@all (3)[f:5]$ list<br>10.0.0.18<br>10.0.0.7<br>10.0.0.102<br>root@all (3)[f:5]$ <span class="hljs-built_in">cd</span> websrvs<br>root@websrvs (2)[f:5]$ list<br>10.0.0.18<br>10.0.0.7<br>root@websrvs (2)[f:5]$ forks 10<br>root@websrvs (2)[f:10]$ <span class="hljs-built_in">cd</span> appsrvs<br>root@appsrvs (2)[f:10]$ list<br>10.0.0.102<br>10.0.0.18<br></code></pre></td></tr></table></figure>

<h3 id="1-4-ansible-playbook"><a href="#1-4-ansible-playbook" class="headerlink" title="1.4 ansible-playbook"></a>1.4 ansible-playbook</h3><p>此工具用于执行编写好的 playbook 任务<br>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[15:27:57 root@ansible-rocky ~]$ vi hello.yml<br>---<br><span class="hljs-comment">#hello world yml file</span><br>- hosts: websrvs<br>  remote_user: root<br>  gather_facts: no<br><br>  tasks:<br>    - name: hello world<br>      <span class="hljs-built_in">command</span>: /usr/bin/wall hello world<br>[15:30:12 root@ansible-rocky ~]$ ansible-playbook hello.yml <br><br>PLAY [websrvs] ****************************************************************************************<br><br>TASK [hello world] ************************************************************************************<br>changed: [10.0.0.18]<br>changed: [10.0.0.7]<br><br>PLAY RECAP ********************************************************************************************<br>10.0.0.18                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   <br>10.0.0.7                   : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://img2023.cnblogs.com/blog/3077161/202301/3077161-20230110094302604-1848189472.png"><img src="3077161-20230110094302604-1848189472.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://img2023.cnblogs.com/blog/3077161/202301/3077161-20230110094302648-1358849118.png"><img src="3077161-20230110094302648-1358849118.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h3 id="1-5-ansible-vault"><a href="#1-5-ansible-vault" class="headerlink" title="1.5 ansible-vault"></a>1.5 ansible-vault</h3><p>此工具可以用于加密解密yml文件</p>
<p>格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ansible-vault [create|decrypt|edit|encrypt|rekey|view]<br></code></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#1 加密</span><br>[15:31:01 root@ansible-rocky ~]$ ansible-vault encrypt hello.yml <br>New Vault password: <br>Confirm New Vault password: <br>Encryption successful<br><span class="hljs-comment">##查看文件内容</span><br>[15:38:15 root@ansible-rocky ~]$ <span class="hljs-built_in">cat</span> hello.yml <br><span class="hljs-variable">$ANSIBLE_VAULT</span>;1.1;AES256<br>65323766623831636563636132623333623932633461396563383764333037396563633766363231<br>3335646336346136626231353133623566626166626336380a306630643338353031353739353538<br>62373930306636633430653537363534376231323839643131376335653366656634616365663063<br>6236663364343461610a383365643534646564316261326166316233393039386134363436313138<br>63323939663537666462646233613262646637306130626336336239323737623833393735666364<br>36336334316666326265356166326163373039616533353564353964396266376637363037353338<br>37623639656262303966363766356630376466666463363338353535623635633137616335383333<br>65333263643762353264326563326362393663316538666530616664643438666435373162616164<br>30313761323030343165666330326537653430333764363834326566333666316133386465663334<br>63353035616266396366366662643839353431653736353465626261623433343735663534663831<br>32636632653730323465366531353531633761623930303138643337613162613062333237633566<br>39663562393535343165<br><br><span class="hljs-comment">#2 解密</span><br>[15:38:18 root@ansible-rocky ~]$ ansible-vault decrypt hello.yml <br>Vault password: <br>Decryption successful<br>[15:39:50 root@ansible-rocky ~]$ <span class="hljs-built_in">cat</span> hello.yml <br>---<br><span class="hljs-comment">#hello world yml file</span><br>- hosts: websrvs<br>  remote_user: root<br>  gather_facts: no<br><br>  tasks:<br>    - name: hello world<br>      <span class="hljs-built_in">command</span>: /usr/bin/wall hello world<br>      <br><span class="hljs-comment">#3 查看加密后的yml文件内容</span><br>[15:41:44 root@ansible-rocky ~]$ ansible-vault view hello.yml <br>Vault password: <br>---<br><span class="hljs-comment">#hello world yml file</span><br>- hosts: websrvs<br>  remote_user: root<br>  gather_facts: no<br><br>  tasks:<br>    - name: hello world<br>      <span class="hljs-built_in">command</span>: /usr/bin/wall hello world<br><br><span class="hljs-comment">#4 编辑加密文件</span><br>[15:41:50 root@ansible-rocky ~]$ ansible-vault edit hello.yml <br>Vault password:             <span class="hljs-comment">#输入密码后进入vim编辑器进行编辑</span><br><br><span class="hljs-comment">#5 修改口令</span><br>[15:44:53 root@ansible-rocky ~]$ ansible-vault rekey hello.yml <br>Vault password:    <span class="hljs-comment">#先前的口令</span><br>New Vault password:  <span class="hljs-comment">#修改为的口令</span><br>Confirm New Vault password:  <span class="hljs-comment">#再确认一遍</span><br>Rekey successful<br><br><span class="hljs-comment">#6 创建加密新文件</span><br>[15:46:31 root@ansible-rocky ~]$ ansible-vault create new.yml<br>New Vault password: <br>Confirm New Vault password:<br><br><span class="hljs-comment">#7 交互式输入密码来执行加密文件</span><br>[15:46:46 root@ansible-rocky ~]$ ansible-playbook --ask-vault-pass hello.yml <br>Vault password: <br><br>PLAY [websrvs] ****************************************************************************************<br><br>TASK [hello world] ************************************************************************************<br>changed: [10.0.0.18]<br>changed: [10.0.0.7]<br><br>PLAY RECAP ********************************************************************************************<br>10.0.0.18                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   <br>10.0.0.7                   : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 <br><br><span class="hljs-comment">#8 从文件中读取密码</span><br>[15:52:56 root@ansible-rocky ~]$ ansible-playbook --vault-password-file pass.txt hello.yml <br><br>PLAY [websrvs] ****************************************************************************************<br><br>TASK [hello world] ************************************************************************************<br>changed: [10.0.0.18]<br>changed: [10.0.0.7]<br><br>PLAY RECAP ********************************************************************************************<br>10.0.0.18                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   <br>10.0.0.7                   : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0<br><br><span class="hljs-comment">#9 从配置文件中添加密码文件</span><br>[15:53:33 root@ansible-rocky ~]$ vi /etc/ansible/ansible.cfg<br><span class="hljs-comment">#添加以下一行信息</span><br>ault-password-file=pass.txt<br>[15:58:58 root@ansible-rocky ~]$ ansible-playbook hello.yml <br><br>PLAY [websrvs] ****************************************************************************************<br><br>TASK [hello world] ************************************************************************************<br>changed: [10.0.0.18]<br>changed: [10.0.0.7]<br><br>PLAY RECAP ********************************************************************************************<br>10.0.0.18                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   <br>10.0.0.7                   : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0<br></code></pre></td></tr></table></figure>

<h3 id="1-6-ansible-galaxy"><a href="#1-6-ansible-galaxy" class="headerlink" title="1.6 ansible-galaxy"></a>1.6 ansible-galaxy</h3><p>Galaxy 是一个免费网站, 类似于github网站, 网站上发布了很多的共享的roles角色。</p>
<p>Ansible 提供了ansible-galaxy命令行工具连接 <a target="_blank" rel="noopener" href="https://galaxy.ansible.com/">https://galaxy.ansible.com</a> 网站下载相应的roles, 进行init(初始化、search( 查拘、install(安装、 remove(移除)等操作。</p>
<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#搜索项目</span><br>[16:05:04 root@ansible-rocky ~]$ ansible-galaxy search lamp<br><br>Found 100 roles matching your search:<br><br> Name                                      Description<br> ----                                      -----------<br> abhiarun_94.apache_lamp                   your role description<br> adelaidearnauld.galaxy-lamp               your description<br> adelaidearnauld.lamp_compose              your description<br> ajish_antony.ansible_lamp                 your role description<br> AlexanderAllen.Liara                      The sexiest toolkit <span class="hljs-keyword">for</span> LAMP hackers.<br> alphinaugustine.ansible_role              your description<br> amtega.horde                              Setup horde<br> ......<br> <br><br><span class="hljs-comment">#2 列出所有已安装的galaxy</span><br>[16:06:32 root@ansible-rocky ~]$ ansible-galaxy list<br><span class="hljs-comment"># /usr/share/ansible/roles</span><br><span class="hljs-comment"># /etc/ansible/roles</span><br><br><br><span class="hljs-comment">#3 安装galaxy，默认下载到~/.ansible/roles</span><br>[16:14:06 root@ansible-rocky ~]$ ansible-galaxy install 想要安装的galaxy<br><br><span class="hljs-comment">#删除</span><br>ansible-galaxy remove <br></code></pre></td></tr></table></figure>

<h2 id="2-总结ansible-role目录结构及文件用途。"><a href="#2-总结ansible-role目录结构及文件用途。" class="headerlink" title="2 总结ansible role目录结构及文件用途。"></a>2 总结ansible role目录结构及文件用途。</h2><p><strong>roles目录结构：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">├── playbook1.yml<br>├── playbook2.yml<br>├── roles/<br>│   ├── project1/<br>│   │	├── tasks/<br>│   │	├── files/<br>│   │	├── vars/<br>│   │	├── templates/<br>│   │	├── handlers/<br>│   │	├── default/<br>│   │	└── meta/<br>│   ├── project2/<br>│   │	├── tasks/<br>│   │	├── files/<br>│   │	├── vars/<br>│   │	├── templates/<br>│   │	├── handlers/<br>│   │	├── default/<br>│   │	└── meta/<br></code></pre></td></tr></table></figure>

<p><strong>Roles各目录作用</strong></p>
<p><code>roles/project/ </code>:项目名称,有以下子目录</p>
<ul>
<li><code>files/</code> ：存放由<code>copy</code>或<code>script</code>模块等调用的文件</li>
<li><code>templates/</code>：<code>template</code>模块查找所需要模板文件的目录</li>
<li><code>tasks/</code>：定义<code>task</code>,<code>role</code>的基本元素，至少应该包含一个名为<code>main.yml</code>的文件；其它的文件需要在此文件中通过<code>include</code>进行包含</li>
<li><code>handlers/</code>：至少应该包含一个名为<code>main.yml</code>的文件；此目录下的其它的文件需要在此文件中通过<code>include</code>进行包含</li>
<li><code>vars/</code>：<strong>定义变量</strong>，至少应该包含一个名为<code>main.yml</code>的文件；此目录下的其它的变量文件需要在此文件中通过include进行包含,也可以通过项目目录中的<code>group_vars/all</code>定义变量,从而实现角色通用代码和项目数据的分离</li>
<li><code>meta/</code>：<strong>定义当前角色的特殊设定及其依赖关系</strong>,至少应该包含一个名为<code>main.yml</code>的文件，其它文件需在此文件中通过include进行包含</li>
<li><code>default/</code>：设定默认变量时使用此目录中的main.yml文件，比<code>vars</code>的<strong>优先级低</strong></li>
</ul>
<h2 id="3-使用ansible-playbook实现一个mysql角色。"><a href="#3-使用ansible-playbook实现一个mysql角色。" class="headerlink" title="3 使用ansible playbook实现一个mysql角色。"></a>3 使用ansible playbook实现一个mysql角色。</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#mysql角色目录</span><br>[18:16:16 root@ansible-rocky opt]$ tree<br>.<br>├── ansible.cfg<br>├── hosts<br>├── mysql_role.yml<br>└── roles<br>    └── mysql<br>        ├── files<br>        │   └── mysql-8.0.31-linux-glibc2.12-x86_64.tar.xz<br>        ├── tasks<br>        │   └── main.yml<br>        └── templates<br>            └── my.cnf.j2<br>            <br><span class="hljs-comment">#定义主机及变量</span><br>[18:22:50 root@ansible-rocky opt]$ <span class="hljs-built_in">tail</span> -n9 hosts <br>[dbsrvs:vars]<br>db_group=mysql<br>db_gid=306<br>db_user=mysql<br>db_uid=306<br>db_version=8.0.31<br>db_file=<span class="hljs-string">&quot;mysql-&#123;&#123;db_version&#125;&#125;-linux-glibc2.12-x86_64.tar.xz&quot;</span><br>db_data_dir=<span class="hljs-string">&quot;/data/mysql&quot;</span><br>db_root_passwd=<span class="hljs-string">&quot;lgq123456**&quot;</span><br><br><span class="hljs-comment">#下载准备mysql源文件包</span><br>[18:22:54 root@ansible-rocky opt]$ <span class="hljs-built_in">ls</span> roles/mysql/files/<br>mysql-8.0.31-linux-glibc2.12-x86_64.tar.xz<br><br><span class="hljs-comment">#创建task文件</span><br>[18:24:40 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> roles/mysql/tasks/main.yml <br>- name: install dependent package<br>  yum:<br>    name: <span class="hljs-string">&quot;&#123;&#123; item &#125;&#125;&quot;</span><br>  loop:<br>    - libaio<br>    - numactl-libs<br><br>- name: create mysql group<br>  group: name=&#123;&#123;db_group&#125;&#125; gid=&#123;&#123;db_gid&#125;&#125;<br><br>- name: create mysql user<br>  user: name=&#123;&#123;db_user&#125;&#125; uid=&#123;&#123;db_uid&#125;&#125; system=<span class="hljs-built_in">yes</span> shell=<span class="hljs-string">&quot;/sbin/nologin&quot;</span> create_home=no group=&#123;&#123;db_group&#125;&#125;<br><br>- name: copy tar to remote host and file mode<br>  unarchive:<br>    src: <span class="hljs-string">&quot;&#123;&#123; db_file &#125;&#125;&quot;</span><br>    dest: <span class="hljs-string">&quot;/usr/local/&quot;</span><br>    owner: root<br>    group: root<br><br>- name: create lingfile /usr/local/mysql<br>  file:<br>    src: <span class="hljs-string">&quot;/usr/local/mysql-&#123;&#123; db_version &#125;&#125;-linux-glibc2.12-x86_64&quot;</span><br>    dest: <span class="hljs-string">&quot;/usr/local/mysql&quot;</span><br>    state: <span class="hljs-built_in">link</span><br><br>- name: path file<br>  copy:<br>    content: <span class="hljs-string">&quot;PATH=/usr/local/mysql/bin:<span class="hljs-variable">$PATH</span>&quot;</span><br>    dest: <span class="hljs-string">&quot;/etc/profile.d/mysql.sh&quot;</span><br><br>- name: config file<br>  template:<br>    src: my.cnf.j2<br>    dest: <span class="hljs-string">&quot;/etc/my.cnf&quot;</span><br><br>- name: create directory<br>  file:<br>    name: <span class="hljs-string">&quot;/data&quot;</span><br>    state: directory<br><br>- name: init mysql data<br>  shell:<br>    cmd: <span class="hljs-string">&quot;/usr/local/mysql/bin/mysqld --initialize-insecure --user=&#123;&#123; db_user &#125;&#125; --datadir=&#123;&#123; db_data_dir &#125;&#125;&quot;</span><br>  tags:<br>    - init<br><br>- name: service script<br>  copy:<br>    src: <span class="hljs-string">&quot;/usr/local/mysql/support-files/mysql.server&quot;</span><br>    dest: <span class="hljs-string">&quot;/etc/init.d/mysqld&quot;</span><br>    remote_src: <span class="hljs-built_in">yes</span><br>    mode: <span class="hljs-string">&#x27;+x&#x27;</span><br><br>- name: start service<br>  shell:<br>    cmd: chkconfig --add mysqld;chkconfig mysqld on;service mysqld start<br><br>- name: change root password<br>  shell:<br>    cmd: <span class="hljs-string">&quot;/usr/local/mysql/bin/mysqladmin -uroot password &#123;&#123; db_root_passwd &#125;&#125;&quot;</span><br>    <br>    <br><span class="hljs-comment">#准备MySQL 配置文件模板</span><br>[18:25:25 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> roles/mysql/templates/my.cnf.j2 <br>[mysqld]<br>server-id=1<br>log-bin<br>datadir=&#123;&#123; db_data_dir &#125;&#125;<br>socket=&#123;&#123; db_data_dir &#125;&#125;/mysql.sock<br>log-error=&#123;&#123; db_data_dir &#125;&#125;/mysql.log<br>pid-file=&#123;&#123; db_data_dir &#125;&#125;/mysql.pid<br><br>[client]<br>socket=&#123;&#123; db_data_dir &#125;&#125;/mysql.sock<br><br><span class="hljs-comment">#准备MySQL角色playbook文件</span><br>[18:25:38 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> mysql_role.yml <br>- hosts: dbsrvs<br>  remote_user: root<br>  gather_facts: no<br><br>  roles:<br>    - mysql<br>    <br><span class="hljs-comment">#部署MySQL</span><br>[18:26:34 root@ansible-rocky opt]$ ansible-playbook -i hosts mysql_role.yml<br>PLAY [dbsrvs] *****************************************************************************************<br><br>TASK [mysql : install dependent package] **************************************************************<br>ok: [10.0.0.38] =&gt; (item=libaio)<br>ok: [10.0.0.38] =&gt; (item=numactl-libs)<br><br>TASK [mysql : create mysql group] *********************************************************************<br>changed: [10.0.0.38]<br><br>TASK [mysql : create mysql user] **********************************************************************<br>changed: [10.0.0.38]<br><br>TASK [mysql : copy tar to remote host and file mode] **************************************************<br>changed: [10.0.0.38]<br><br>TASK [mysql : create lingfile /usr/local/mysql] *******************************************************<br>changed: [10.0.0.38]<br><br>TASK [mysql : path file] ******************************************************************************<br>changed: [10.0.0.38]<br><br>TASK [mysql : config file] ****************************************************************************<br>changed: [10.0.0.38]<br><br>TASK [mysql : create directory] ***********************************************************************<br>ok: [10.0.0.38]<br><br>TASK [mysql : init mysql data] ************************************************************************<br>changed: [10.0.0.38]<br><br>TASK [mysql : service script] *************************************************************************<br>changed: [10.0.0.38]<br><br>TASK [mysql : start service] **************************************************************************<br>changed: [10.0.0.38]<br><br>TASK [mysql : change root password] *******************************************************************<br>changed: [10.0.0.38]<br><br>PLAY RECAP ********************************************************************************************<br>10.0.0.38                  : ok=12   changed=10   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0<br></code></pre></td></tr></table></figure>

<h2 id="4-基于角色完成部署LNMP架构，并支持一键发布，回滚应用。同时基于zabbix角色批量部署zabbix。"><a href="#4-基于角色完成部署LNMP架构，并支持一键发布，回滚应用。同时基于zabbix角色批量部署zabbix。" class="headerlink" title="4 基于角色完成部署LNMP架构，并支持一键发布，回滚应用。同时基于zabbix角色批量部署zabbix。"></a>4 基于角色完成部署LNMP架构，并支持一键发布，回滚应用。同时基于zabbix角色批量部署zabbix。</h2><h3 id="4-1-部署LNMP架构"><a href="#4-1-部署LNMP架构" class="headerlink" title="4.1 部署LNMP架构"></a>4.1 部署LNMP架构</h3><h4 id="4-1-1-目录结构"><a href="#4-1-1-目录结构" class="headerlink" title="4.1.1 目录结构"></a>4.1.1 目录结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">[18:57:47 root@ansible-rocky opt]$ tree /opt/<br>/opt/<br>├── ansible.cfg<br>├── hosts<br>├── lnmp_role.yml<br>├── mysql_role.yml<br>├── nginx_role.yml<br>├── php-fpm_role.yml<br>├── roles<br>│   ├── mysql<br>│   │   ├── files<br>│   │   │   └── mysql-8.0.31-linux-glibc2.12-x86_64.tar.xz<br>│   │   ├── tasks<br>│   │   │   └── main.yml<br>│   │   └── templates<br>│   │       └── my.cnf.j2<br>│   ├── nginx<br>│   │   ├── handlers<br>│   │   │   └── main.yml<br>│   │   ├── tasks<br>│   │   │   └── main.yml<br>│   │   └── templates<br>│   │       ├── nginx.conf.j2<br>│   │       └── nginx.service.j2<br>│   ├── php-fpm<br>│   │   ├── files<br>│   │   │   ├── test.php<br>│   │   │   └── www.conf<br>│   │   ├── handlers<br>│   │   │   └── main.yml<br>│   │   ├── tasks<br>│   │   │   └── main.yml<br>│   │   └── templates<br>│   │       ├── php-fpm.conf.j2<br>│   │       └── php.ini.j2<br>│   └── wordpress<br>│       ├── files<br>│       │   └── wordpress-6.1.1-zh_CN.zip<br>│       └── tasks<br>│           └── main.yml<br>└── wordpress_role.yml<br><br>17 directories, 22 files<br></code></pre></td></tr></table></figure>

<h4 id="4-1-2-LNMP架构所需主机清单以及变量设置"><a href="#4-1-2-LNMP架构所需主机清单以及变量设置" class="headerlink" title="4.1.2 LNMP架构所需主机清单以及变量设置"></a>4.1.2 LNMP架构所需主机清单以及变量设置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">[18:58:15 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> hosts <br>[websrvs]<br>10.0.0.18<br>10.0.0.28<br><br>[websrvs:vars]<br>version=<span class="hljs-string">&quot;1.20.2&quot;</span><br>url=<span class="hljs-string">&quot;http://nginx.org/download/nginx-&#123;&#123; version &#125;&#125;.tar.gz&quot;</span><br>install_dir=<span class="hljs-string">&quot;/apps/nginx&quot;</span><br>fqdn=<span class="hljs-string">&quot;www.yanlinux.org&quot;</span><br>root_path=<span class="hljs-string">&quot;/data/wordpress&quot;</span><br>app=<span class="hljs-string">&quot;wordpress-6.1.1-zh_CN&quot;</span><br><br>[dbsrvs]<br>10.0.0.38<br><br>[dbsrvs:vars]<br>db_group=mysql<br>db_gid=306<br>db_user=mysql<br>db_uid=306<br>db_version=8.0.31<br>db_file=<span class="hljs-string">&quot;mysql-&#123;&#123;db_version&#125;&#125;-linux-glibc2.12-x86_64.tar.xz&quot;</span><br>db_data_dir=<span class="hljs-string">&quot;/data/mysql&quot;</span><br>db_root_passwd=<span class="hljs-string">&quot;lgq123456**&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="4-1-2-实现编译安装nginx角色"><a href="#4-1-2-实现编译安装nginx角色" class="headerlink" title="4.1.2 实现编译安装nginx角色"></a>4.1.2 实现编译安装nginx角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#task文件</span><br>[17:55:17 root@ansible-rocky roles]$ <span class="hljs-built_in">cat</span> nginx/tasks/main.yml <br>- name: add group nginx<br>  group: name=nginx system=<span class="hljs-built_in">yes</span> gid=80<br><br>- name: add user nginx<br>  user: name=nginx group=nginx uid=80 system=<span class="hljs-built_in">yes</span> shell=<span class="hljs-string">&quot;/sbin/nologin&quot;</span> create_home=no<br><br>- name: install dependent package<br>  yum: name=&#123;&#123;item&#125;&#125; state=latest<br>  loop:<br>    - gcc<br>    - make<br>    - pcre-devel<br>    - openssl-devel<br>    - zlib-devel<br>    - perl-ExtUtils-Embed<br><br>- name: get nginx <span class="hljs-built_in">source</span><br>  unarchive:<br>    src: <span class="hljs-string">&quot;&#123;&#123; url &#125;&#125;&quot;</span><br>    dest: <span class="hljs-string">&quot;/usr/local/src&quot;</span><br>    remote_src: <span class="hljs-built_in">yes</span><br><br>- name: compile and install<br>  shell:<br>    cmd: <span class="hljs-string">&quot;./configure --prefix=&#123;&#123;install_dir&#125;&#125; --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module &amp;&amp; make &amp;&amp; make install&quot;</span><br>    <span class="hljs-built_in">chdir</span>: <span class="hljs-string">&quot;/usr/local/src/nginx-&#123;&#123; version &#125;&#125;&quot;</span><br>    creates: <span class="hljs-string">&quot;&#123;&#123;install_dir&#125;&#125;/sbin/nginx&quot;</span><br><br>- name: config file<br>  template:<br>    src: nginx.conf.j2<br>    dest: <span class="hljs-string">&quot;&#123;&#123;install_dir&#125;&#125;/conf/nginx.conf&quot;</span><br>    owner: nginx<br>    group: nginx<br>  notify: restart service<br>  tags:<br>    - config<br><br>- name: create directory<br>  file:<br>    path: <span class="hljs-string">&quot;&#123;&#123;install_dir&#125;&#125;/conf/conf.d&quot;</span><br>    state: directory<br>    owner: nginx<br>    group: nginx<br><br>- name: change install directory owner<br>  file:<br>    path: <span class="hljs-string">&quot;&#123;&#123;install_dir&#125;&#125;&quot;</span><br>    owner: nginx<br>    group: nginx<br>    recurse: <span class="hljs-built_in">yes</span><br><br>- name: copy service file<br>  template:<br>    src: nginx.service.j2<br>    dest: <span class="hljs-string">&quot;/lib/systemd/system/nginx.service&quot;</span><br><br>- name: check config<br>  shell:<br>    cmd: <span class="hljs-string">&quot;&#123;&#123;install_dir&#125;&#125;/sbin/nginx -t&quot;</span><br>  register: check_nginx_config<br>  changed_when:<br>    - check_nginx_config.stdout.find(<span class="hljs-string">&#x27;successful&#x27;</span>)<br>    - <span class="hljs-literal">false</span><br><br>- name: start service<br>  systemd:<br>    daemon_reload: <span class="hljs-built_in">yes</span><br>    name: nginx.service<br>    state: started<br>    enabled: <span class="hljs-built_in">yes</span><br>      <br><span class="hljs-comment">#创建handler文件</span><br>[17:59:27 root@ansible-rocky roles]$ <span class="hljs-built_in">cat</span> nginx/handlers/main.yml <br>- name: restart service<br>  service:<br>    name: nginx<br>    state: restarted<br><br><span class="hljs-comment">#准备两个template文件</span><br>[17:59:51 root@ansible-rocky roles]$ <span class="hljs-built_in">cat</span> nginx/templates/nginx.conf.j2 <br><br><span class="hljs-comment">#user  nobody;</span><br>user nginx;<br>worker_processes  &#123;&#123; ansible_processor_vcpus*2 &#125;&#125;;<br>events &#123;<br>    worker_connections  1024;<br>&#125;<br>http &#123;<br>    include       mime.types;<br>    default_type  application/octet-stream;<br>    log_format  access_json <span class="hljs-string">&#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;responsetime&quot;:$request_time,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;uri&quot;:&quot;$uri&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;tcp_xff&quot;:&quot;$proxy_protocol_addr&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#x27;</span><br>        <span class="hljs-string">&#x27;&quot;status&quot;:&quot;$status&quot;&#125;&#x27;</span>;<br>    <span class="hljs-comment"># logging                                                                                          </span><br>    access_log &#123;&#123;install_dir&#125;&#125;/logs/access-json.log access_json;<br>    error_log &#123;&#123;install_dir&#125;&#125;/logs/error.log warn;<br><br>    keepalive_timeout  65;<br>    include &#123;&#123;install_dir&#125;&#125;/conf/conf.d/*.conf;<br>&#125;<br>[18:00:28 root@ansible-rocky roles]$ <span class="hljs-built_in">cat</span> nginx/templates/nginx.service.j2 <br>[Unit]<br>Description=The nginx HTTP and reverse proxy server<br>After=network.target remote-fs.target nss-lookup.target<br><br>[Service]<br>Type=forking<br>PIDFile=&#123;&#123;install_dir&#125;&#125;/logs/nginx.pid<br>ExecStartPre=/bin/rm -f &#123;&#123;install_dir&#125;&#125;/logs/nginx.pid<br>ExecStartPre=&#123;&#123;install_dir&#125;&#125;/sbin/nginx -t<br>ExecStart=&#123;&#123;install_dir&#125;&#125;/sbin/nginx<br>ExecReload=/bin/kill -s HUP \<span class="hljs-variable">$MAINPID</span><br>KillSignal=SIGQUIT<br>TimeoutStopSec=5<br>KillMode=process<br>PrivateTmp=<span class="hljs-literal">true</span>                                                                                        <br>LimitNOFILE=100000<br><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-comment">#总入口playbook文件</span><br>[18:09:50 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> /opt/nginx_role.yml <br>- hosts: websrvs<br>  remote_user: root<br><br>  roles:<br>    - nginx<br></code></pre></td></tr></table></figure>

<h4 id="4-1-4-实现php-fpm角色"><a href="#4-1-4-实现php-fpm角色" class="headerlink" title="4.1.4 实现php-fpm角色"></a>4.1.4 实现php-fpm角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#首先准备php.ini.j2和www.conf文件</span><br><span class="hljs-comment">#修改php上传限制配置</span><br>[17:04:11 root@ansible-rocky ~]$ vi /opt/roles/php-fpm/templates/php.ini.j2<br>post_max_size = 100M <span class="hljs-comment">#将次行从8M修改为100M</span><br>upload_max_filesize = 100M <span class="hljs-comment">#将此行从2M改为100M</span><br><br><span class="hljs-comment">#修改配置文件</span><br>[17:14:03 root@proxy ~]$ vi /opt/roles/php-fpm/files/www.conf<br>user = nginx <span class="hljs-comment">#修改为nginx</span><br>group = nginx <span class="hljs-comment">#修改为nginx</span><br>;listen = /run/php-fpm/www.sock <span class="hljs-comment">#注释此行</span><br>listen = 127.0.0.1:9000 <span class="hljs-comment">#添加此行，监控本机的9000端口</span><br><br><span class="hljs-comment">#准备网页配置文件</span><br>[19:51:32 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> /opt/roles/php-fpm/templates/php-fpm.conf.j2 <br>server &#123;<br>    listen 80;<br>    server_name &#123;&#123; fqdn &#125;&#125;;<br>    location / &#123;<br>        root           &#123;&#123; root_path  &#125;&#125;;<br>        fastcgi_pass   127.0.0.1:9000;<br>        fastcgi_index  index.php;<br>        fastcgi_param  SCRIPT_FILENAME $document_root<span class="hljs-variable">$fastcgi_script_name</span>;<br>        include        fastcgi_params;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">#准备tasks文件</span><br>[19:40:32 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> /opt/roles/php-fpm/tasks/main.yml<br>- name: install package<br>  yum:<br>    name: <span class="hljs-string">&quot;&#123;&#123; item &#125;&#125;&quot;</span><br>  loop:<br>    - php-fpm<br>    - php-mysqlnd<br>    - php-json<br>    - php-xml<br>    - php-gd<br>    - php-pecl-zip<br><br>- name: php path permissions<br>  file:<br>    path: /var/lib/php/<br>    owner: nginx<br>    group: nginx<br>    recurse: <span class="hljs-built_in">yes</span><br><br>- name: config php.ini<br>  template:<br>    src: php.ini.j2<br>    dest: /etc/php.ini<br><br>- name: config www.conf<br>  copy:<br>    src: www.conf<br>    dest: /etc/php-fpm.d/www.conf<br><br>- name: website config<br>  template:<br>    src: php-fpm.conf.j2<br>    dest: <span class="hljs-string">&quot;&#123;&#123; install_dir &#125;&#125;/conf/conf.d/php-fpm.conf&quot;</span><br>    owner: nginx<br>    group: nginx<br>  notify: restart nginx<br><br>- name: start service<br>  service:<br>    name: php-fpm<br>    state: started<br>    enabled: <span class="hljs-built_in">yes</span><br>    <br><span class="hljs-comment">#准备handler文件</span><br>[19:53:47 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> /opt/roles/php-fpm/handlers/main.yml <br>- name: restart nginx<br>  service:<br>    name: nginx<br>    state: restarted<br>    <br><span class="hljs-comment">#准备总入口playbook文件</span><br>[19:54:48 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> /opt/php-fpm_role.yml <br>- hosts: websrvs<br>  remote_user: root<br><br>  roles:<br>    - php-fpm<br></code></pre></td></tr></table></figure>

<h4 id="4-1-5-实现MySQL角色"><a href="#4-1-5-实现MySQL角色" class="headerlink" title="4.1.5 实现MySQL角色"></a>4.1.5 实现MySQL角色</h4><p><strong>注意：ansible playbook调用mysql系列模块需要依赖python3-mysql包和利用pip安装pymysql</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载准备mysql源文件包</span><br>[18:22:54 root@ansible-rocky opt]$ <span class="hljs-built_in">ls</span> roles/mysql/files/<br>mysql-8.0.31-linux-glibc2.12-x86_64.tar.xz<br><br><span class="hljs-comment">#创建task文件</span><br>[18:24:40 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> roles/mysql/tasks/main.yml <br>- name: install dependent package<br>  yum:<br>    name: <span class="hljs-string">&quot;&#123;&#123; item &#125;&#125;&quot;</span><br>  loop:<br>    - libaio<br>    - numactl-libs<br>    - python39<br>    - python3-mysql<br><br>- name: install pymysql<br>  pip:<br>    name: pymysql<br>    state: present<br>    <br>- name: create mysql group<br>  group: name=&#123;&#123;db_group&#125;&#125; gid=&#123;&#123;db_gid&#125;&#125;<br><br>- name: create mysql user<br>  user: name=&#123;&#123;db_user&#125;&#125; uid=&#123;&#123;db_uid&#125;&#125; system=<span class="hljs-built_in">yes</span> shell=<span class="hljs-string">&quot;/sbin/nologin&quot;</span> create_home=no group=&#123;&#123;db_group&#125;&#125;<br><br>- name: copy tar to remote host and file mode<br>  unarchive:<br>    src: <span class="hljs-string">&quot;&#123;&#123; db_file &#125;&#125;&quot;</span><br>    dest: <span class="hljs-string">&quot;/usr/local/&quot;</span><br>    owner: root<br>    group: root<br><br>- name: create lingfile /usr/local/mysql<br>  file:<br>    src: <span class="hljs-string">&quot;/usr/local/mysql-&#123;&#123; db_version &#125;&#125;-linux-glibc2.12-x86_64&quot;</span><br>    dest: <span class="hljs-string">&quot;/usr/local/mysql&quot;</span><br>    state: <span class="hljs-built_in">link</span><br><br>- name: path file<br>  copy:<br>    content: <span class="hljs-string">&quot;PATH=/usr/local/mysql/bin:<span class="hljs-variable">$PATH</span>&quot;</span><br>    dest: <span class="hljs-string">&quot;/etc/profile.d/mysql.sh&quot;</span><br><br>- name: config file<br>  template:<br>    src: my.cnf.j2<br>    dest: <span class="hljs-string">&quot;/etc/my.cnf&quot;</span><br><br>- name: create directory<br>  file:<br>    name: <span class="hljs-string">&quot;/data&quot;</span><br>    state: directory<br><br>- name: init mysql data<br>  shell:<br>    cmd: <span class="hljs-string">&quot;/usr/local/mysql/bin/mysqld --initialize-insecure --user=&#123;&#123; db_user &#125;&#125; --datadir=&#123;&#123; db_data_dir &#125;&#125;&quot;</span><br>  tags:<br>    - init<br><br>- name: service script<br>  copy:<br>    src: <span class="hljs-string">&quot;/usr/local/mysql/support-files/mysql.server&quot;</span><br>    dest: <span class="hljs-string">&quot;/etc/init.d/mysqld&quot;</span><br>    remote_src: <span class="hljs-built_in">yes</span><br>    mode: <span class="hljs-string">&#x27;+x&#x27;</span><br><br>- name: start service<br>  shell:<br>    cmd: chkconfig --add mysqld;chkconfig mysqld on;service mysqld start<br><br>- name: change root password<br>  shell:<br>    cmd: <span class="hljs-string">&quot;/usr/local/mysql/bin/mysqladmin -uroot password &#123;&#123; db_root_passwd &#125;&#125;&quot;</span><br>    <br>- name: create &#123;&#123; wp_db_name &#125;&#125; database<br>  mysql_db:<br>    login_host: <span class="hljs-string">&quot;localhost&quot;</span><br>    login_user: <span class="hljs-string">&quot;root&quot;</span><br>    login_password: <span class="hljs-string">&quot;&#123;&#123; db_root_passwd &#125;&#125;&quot;</span><br>    login_port: 3306<br>    login_unix_socket: <span class="hljs-string">&quot;&#123;&#123; db_data_dir &#125;&#125;/mysql.sock&quot;</span><br>    name: <span class="hljs-string">&quot;&#123;&#123; wp_db_name &#125;&#125;&quot;</span><br>    state: present<br>  when: <span class="hljs-string">&quot;&#123;&#123; wp_db_name &#125;&#125; is defined&quot;</span><br><br>- name: create &#123;&#123; wp_db_user &#125;&#125;<br>  mysql_user:<br>    login_host: <span class="hljs-string">&quot;localhost&quot;</span><br>    login_user: <span class="hljs-string">&quot;root&quot;</span><br>    login_password: <span class="hljs-string">&quot;&#123;&#123; db_root_passwd &#125;&#125;&quot;</span><br>    login_port: 3306<br>    login_unix_socket: <span class="hljs-string">&quot;&#123;&#123; db_data_dir &#125;&#125;/mysql.sock&quot;</span><br>    name: <span class="hljs-string">&quot;&#123;&#123; wp_db_user&#125;&#125;&quot;</span><br>    password: <span class="hljs-string">&quot;&#123;&#123; wp_db_passwd &#125;&#125;&quot;</span><br>    priv: <span class="hljs-string">&quot;&#123;&#123; wp_db_name &#125;&#125;.*:ALL&quot;</span><br>    host: <span class="hljs-string">&quot;10.0.0.%&quot;</span><br>    state: present<br>  when: <span class="hljs-string">&quot;&#123;&#123; wp_db_user &#125;&#125; is defined&quot;</span><br>    <br>    <br><span class="hljs-comment">#准备MySQL 配置文件模板</span><br>[18:25:25 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> roles/mysql/templates/my.cnf.j2 <br>[mysqld]<br>server-id=1<br>log-bin<br>datadir=&#123;&#123; db_data_dir &#125;&#125;<br>socket=&#123;&#123; db_data_dir &#125;&#125;/mysql.sock<br>log-error=&#123;&#123; db_data_dir &#125;&#125;/mysql.log<br>pid-file=&#123;&#123; db_data_dir &#125;&#125;/mysql.pid<br><br>[client]<br>socket=&#123;&#123; db_data_dir &#125;&#125;/mysql.sock<br><br><span class="hljs-comment">#准备总入口playbook文件</span><br>[18:25:38 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> mysql_role.yml <br>- hosts: dbsrvs<br>  remote_user: root<br>  gather_facts: no<br><br>  roles:<br>    - mysql<br></code></pre></td></tr></table></figure>

<h3 id="4-2-基于zabbix角色批量部署zabbix"><a href="#4-2-基于zabbix角色批量部署zabbix" class="headerlink" title="4.2 基于zabbix角色批量部署zabbix"></a>4.2 基于zabbix角色批量部署zabbix</h3><p><strong>依赖上面搭建好的LNMP架构实现</strong></p>
<h4 id="4-2-1-部署zabbix-server"><a href="#4-2-1-部署zabbix-server" class="headerlink" title="4.2.1 部署zabbix-server"></a>4.2.1 部署zabbix-server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#总体目录结构</span><br>[20:27:58 root@ansible-rocky opt]$ tree<br>.<br>├── ansible.cfg<br>├── hosts<br>├── hosts_zabbix<br>├── roles<br>│   ├── mysql<br>│   │   ├── files<br>│   │   │   ├── create.sql.gz<br>│   │   │   └── mysql-8.0.31-linux-glibc2.12-x86_64.tar.xz<br>│   │   ├── tasks<br>│   │   │   └── main.yml<br>│   │   └── templates<br>│   │       └── my.cnf.j2<br>│   ├── nginx<br>│   │   ├── files<br>│   │   ├── handlers<br>│   │   │   └── main.yml<br>│   │   ├── tasks<br>│   │   │   └── main.yml<br>│   │   └── templates<br>│   │       ├── nginx.conf.j2<br>│   │       └── nginx.service.j2<br>│   ├── php-fpm<br>│   │   ├── files<br>│   │   │   ├── test.php<br>│   │   │   └── www.conf<br>│   │   ├── handlers<br>│   │   │   └── main.yml<br>│   │   ├── tasks<br>│   │   │   └── main.yml<br>│   │   └── templates<br>│   │       ├── php-fpm.conf.j2<br>│   │       └── php.ini.j2<br>│   └── zabbix_server<br>│       ├── handlers<br>│       │   └── main.yml<br>│       ├── tasks<br>│       │   └── main.yml<br>│       └── templates<br>│           ├── zabbix.conf.j2<br>│           ├── zabbix_server.conf.j2<br>│           └── zabbix-server-ngx.conf.j2<br>└── zabbix_server.yml<br><br>29 directories, 26 files<br><br><span class="hljs-comment">#主入口playbook</span><br>[20:24:45 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> zabbix_server.yml <br>- hosts: websrvs<br>  remote_user: root<br>  roles:<br>    - nginx<br>    - php-fpm<br><br>- hosts: dbsrvs<br>  remote_user: root<br>  roles:<br>    - mysql<br><br>- hosts: websrvs<br>  remote_user: root<br>  roles:<br>    - zabbix_server<br><br><br><span class="hljs-comment">#tasks文件</span><br>[20:30:01 root@ansible-rocky zabbix_server]$ <span class="hljs-built_in">cat</span> /opt/roles/zabbix_server/tasks/main.yml <br>- name: config zabbix yum repo<br>  yum_repository:<br>    name: <span class="hljs-string">&quot;ansible_zabbix&quot;</span><br>    description: <span class="hljs-string">&quot;zabbix repo&quot;</span><br>    baseurl: <span class="hljs-string">&quot;https://mirrors.aliyun.com/zabbix/zabbix/&#123;&#123; zabbix_version &#125;&#125;/rhel/&#123;&#123; ansible_distribution_major_version &#125;&#125;/&#123;&#123; ansible_architecture &#125;&#125;/&quot;</span><br>    gpgcheck: <span class="hljs-built_in">yes</span><br>    gpgkey: <span class="hljs-string">&quot;https://mirrors.aliyun.com/zabbix/zabbix-official-repo.key&quot;</span><br><br>- name: install zabbix-server<br>  yum:<br>    name: <span class="hljs-string">&quot;&#123;&#123; item &#125;&#125;&quot;</span><br>  loop:<br>    - zabbix-server-mysql<br>    - zabbix-agent2<br>    - zabbix-get<br>    - zabbix-web-mysql<br><br>- name: copy zabbix_server.conf <br>  template:<br>    src: zabbix_server.conf.j2<br>    dest: /etc/zabbix/zabbix_server.conf<br>    mode: 0600<br>  notify:<br>    - restart zabbix-server<br>  tags: restart zabbix-server<br><br>- name: <span class="hljs-built_in">chown</span>  zabbix-web<br>  file:<br>    path:  /etc/zabbix/web    <br>    state: directory<br>    owner: nginx<br>    group: nginx<br>    recurse: <span class="hljs-built_in">yes</span><br><br>- name: copy zabbix-server web conf<br>  template:<br>    src: zabbix-server-ngx.conf.j2<br>    dest: <span class="hljs-string">&quot;&#123;&#123; install_dir &#125;&#125;/conf/conf.d/zabbix_server_ngx.conf&quot;</span><br>    owner: nginx<br>    group: nginx<br>  notify:<br>    - restart nginx<br><br>- name: copy zabbix.conf into php-fpm.d<br>  template:<br>    src: zabbix.conf.j2<br>    dest: <span class="hljs-string">&quot;/etc/php-fpm.d/zabbix.conf&quot;</span><br>  notify:<br>    - restart php-fpm<br><br>- name: start zabbix-server<br>  service:<br>    name: zabbix-server<br>    state: restarted<br>    enabled: <span class="hljs-built_in">yes</span><br>    <br><span class="hljs-comment">#查看handler</span><br>[20:34:11 root@ansible-rocky zabbix_server]$ <span class="hljs-built_in">cat</span> /opt/roles/zabbix_server/handlers/main.yml <br>- name: restart zabbix-server<br>  service:<br>    name: zabbix-server<br>    state: restarted<br><br>- name: restart nginx<br>  service:<br>    name: nginx<br>    state: restarted<br><br>- name: restart php-fpm<br>  service:<br>    name: php-fpm<br>    state: restarted<br>    <br><span class="hljs-comment">#查看template文件</span><br>[20:34:15 root@ansible-rocky zabbix_server]$ <span class="hljs-built_in">cat</span> /opt/roles/zabbix_server/templates/zabbix.conf.j2 <br>[zabbix]<br>user = nginx<br>group = nginx<br><br>listen = /run/php-fpm/zabbix.sock<br>listen.acl_users = apache,nginx<br>listen.allowed_clients = 127.0.0.1<br><br>pm = dynamic<br>pm.max_children = 50<br>pm.start_servers = 5<br>pm.min_spare_servers = 5<br>pm.max_spare_servers = 35<br>pm.max_requests = 200<br><br>php_value[session.save_handler] = files<br>php_value[session.save_path]    = /var/lib/php/session<br><br>php_value[max_execution_time] = 300<br>php_value[memory_limit] = 128M<br>php_value[post_max_size] = 80M<br>php_value[upload_max_filesize] = 80M<br>php_value[max_input_time] = 300<br>php_value[max_input_vars] = 10000<br>php_value[date.timezone] = Asia/Shanghai<br><br>[20:38:05 root@ansible-rocky zabbix_server]$ grep -Ev <span class="hljs-string">&#x27;^$|#&#x27;</span> /opt/roles/zabbix_server/templates/zabbix_server.conf.j2 <br>LogFile=/var/log/zabbix/zabbix_server.log<br>LogFileSize=0<br>PidFile=/var/run/zabbix/zabbix_server.pid<br>SocketDir=/var/run/zabbix<br>DBHost=10.0.0.58<br>DBName=zabbix<br>DBUser=zabbix<br>DBPassword=lgq123456<br>SNMPTrapperFile=/var/log/snmptrap/snmptrap.log<br>Timeout=4<br>AlertScriptsPath=/usr/lib/zabbix/alertscripts<br>ExternalScripts=/usr/lib/zabbix/externalscripts<br>LogSlowQueries=3000<br>StatsAllowedIP=127.0.0.1<br><span class="hljs-comment">##zabbix网页配置文件</span><br>[20:39:05 root@ansible-rocky zabbix_server]$ <span class="hljs-built_in">cat</span> /opt/roles/zabbix_server/templates/zabbix-server-ngx.conf.j2<br>server &#123;<br>    listen 80;<br>    server_name &#123;&#123; zabbix_fqdn &#125;&#125;;<br>    root /usr/share/zabbix;<br>    index index.php;<br>    location = /favicon.ico &#123;<br>        log_not_found   off;<br>    &#125;<br><br>    location / &#123;<br>        try_files       <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ =404;<br>    &#125;<br><br>    location /assets &#123;<br>         access_log      off;<br>         expires         10d;<br>    &#125;<br><br>    location ~ /\.ht &#123;<br>         deny            all;<br>    &#125;<br><br>    location ~ /(api\/|conf[^\.]|include|locale|vendor) &#123;<br>         deny            all;<br>         <span class="hljs-built_in">return</span>          404;<br>    &#125;<br>    location ~ [^/]\.php(/|$) &#123;<br>        fastcgi_pass   127.0.0.1:9000;<br>        <span class="hljs-comment">#fastcgi_pass    unix:/run/php-fpm/zabbix.sock;</span><br>        fastcgi_split_path_info ^(.+\.php)(/.+)$;<br>        fastcgi_index   index.php;<br><br>        fastcgi_param   DOCUMENT_ROOT   /usr/share/zabbix;<br>        fastcgi_param   SCRIPT_FILENAME /usr/share/zabbix<span class="hljs-variable">$fastcgi_script_name</span>;<br>        fastcgi_param   PATH_TRANSLATED /usr/share/zabbix<span class="hljs-variable">$fastcgi_script_name</span>;<br><br>        include fastcgi_params;<br>        fastcgi_param   QUERY_STRING    <span class="hljs-variable">$query_string</span>;<br>        fastcgi_param   REQUEST_METHOD  <span class="hljs-variable">$request_method</span>;<br>        fastcgi_param   CONTENT_TYPE    <span class="hljs-variable">$content_type</span>;<br>        fastcgi_param   CONTENT_LENGTH  <span class="hljs-variable">$content_length</span>;<br><br>        fastcgi_intercept_errors        on;<br>        fastcgi_ignore_client_abort     off;<br>        fastcgi_connect_timeout         60;<br>        fastcgi_send_timeout            180;<br>        fastcgi_read_timeout            180;<br>        fastcgi_buffer_size             128k;<br>        fastcgi_buffers                 4 256k;<br>        fastcgi_busy_buffers_size       256k;<br>        fastcgi_temp_file_write_size    256k;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://img2023.cnblogs.com/blog/3077161/202301/3077161-20230110094302642-1874303812.png"><img src="3077161-20230110094302642-1874303812.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h4 id="4-2-2-部署zabbix-agent"><a href="#4-2-2-部署zabbix-agent" class="headerlink" title="4.2.2 部署zabbix-agent"></a>4.2.2 部署zabbix-agent</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#目录结构</span><br>[22:59:31 root@ansible-rocky zabbix_agent2]$ tree<br>.<br>├── files<br>│   └── zabbix_agnet2.d<br>│       ├── login.conf<br>│       ├── mem.conf<br>│       ├── mysql.conf<br>│       ├── mysql_repl_status.sh<br>│       ├── mysql.sh<br>│       ├── nginx_status.conf<br>│       ├── nginx_status.sh<br>│       └── tcp_state.conf<br>├── handlers<br>│   └── main.yml<br>├── tasks<br>│   └── main.yml<br>└── templates<br>    └── zabbix_agent2.conf.j2<br><br>5 directories, 11 files<br><br><span class="hljs-comment">#task文件</span><br>[23:14:12 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> /opt/roles/zabbix_agent2/tasks/main.yml <br>- name: install repo <br>  yum_repository:<br>    name: <span class="hljs-string">&quot;ansible_zabbix&quot;</span><br>    description: <span class="hljs-string">&quot;zabbix repo&quot;</span><br>    baseurl: <span class="hljs-string">&quot;https://mirrors.aliyun.com/zabbix/zabbix/&#123;&#123; zabbix_version &#125;&#125;/rhel/&#123;&#123; ansible_distribution_major_version &#125;&#125;/&#123;&#123; ansible_architecture &#125;&#125;/&quot;</span><br>    gpgcheck: <span class="hljs-built_in">yes</span><br>    gpgkey: <span class="hljs-string">&quot;https://mirrors.aliyun.com/zabbix/zabbix-official-repo.key&quot;</span><br><br>- name: install agent2 <span class="hljs-keyword">for</span> centos or rocky<br>  yum:<br>    name: zabbix-agent2<br>  when: <br>    - ansible_distribution == <span class="hljs-string">&quot;Rocky&quot;</span> or ansible_distribution == <span class="hljs-string">&quot;Centos&quot;</span><br><br>- name: install agent2 <span class="hljs-keyword">for</span> centos or ubuntu<br>  apt:<br>    name: zabbix-agent2<br>    update_cache: <span class="hljs-built_in">yes</span><br>  when:<br>    - ansible_distribution == <span class="hljs-string">&quot;Ubuntu&quot;</span><br><br>- name: config file<br>  template:<br>    src: zabbix_agent2.conf.j2<br>    dest: <span class="hljs-string">&quot;/etc/zabbix/zabbix_agent2.conf&quot;</span><br>    mode: 0644<br>  notify:<br>    - restart zabbix-agent2<br><br>- name: copy zabbix-agent2.d content<br>  copy:<br>    src: zabbix_agent2.d<br>    dest: <span class="hljs-string">&quot;/etc/zabbix&quot;</span><br>  notify:<br>    - restart zabbix-agent2<br>  tags: zabbix_agent2.d<br><br>- name: start zabbix-agent2<br>  service:<br>    name: zabbix-agent2<br>    state: started<br>    enabled: <span class="hljs-built_in">yes</span><br>    <br><span class="hljs-comment">#handler文件</span><br>[23:14:14 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> /opt/roles/zabbix_agent2/handlers/main.yml <br>- name: restart zabbix_agent2<br>  service:<br>    name: zabbix-agent2<br>    state: restarted<br>    <br><span class="hljs-comment">#template文件</span><br>[23:14:43 root@ansible-rocky opt]$ <span class="hljs-built_in">cat</span> /opt/roles/zabbix_agent2/templates/zabbix_agent2.conf.j2 <br>PidFile=/var/run/zabbix/zabbix_agent2.pid<br>LogFile=/var/log/zabbix/zabbix_agent2.<span class="hljs-built_in">log</span><br>LogFileSize=0<br>Server=&#123;&#123; zabbix_server_ip &#125;&#125;<br>ServerActive=&#123;&#123; zabbix_server_ip &#125;&#125;<br>Hostname=&#123;&#123; ansible_default_ipv4.address &#125;&#125;<br>Include=/etc/zabbix/zabbix_agent2.d/*.conf<br>ControlSocket=/tmp/agent.sock<br></code></pre></td></tr></table></figure>

<h4 id="4-2-3-测试"><a href="#4-2-3-测试" class="headerlink" title="4.2.3 测试"></a>4.2.3 测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[23:15:29 root@rocky8 /etc/zabbix]$ zabbix_get -s 10.0.0.18 -k mem_use_percent<br>20.1886<br>[23:16:51 root@rocky8 /etc/zabbix]$ zabbix_get -s 10.0.0.18 -k tcp_state[ESTABLISHED]<br>32<br>[23:17:30 root@rocky8 /etc/zabbix]$ zabbix_get -s 10.0.0.28 -k tcp_state[ESTABLISHED]<br>28<br>[23:17:35 root@rocky8 /etc/zabbix]$ zabbix_get -s 10.0.0.58 -k tcp_state[ESTABLISHED]<br>55<br></code></pre></td></tr></table></figure>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/28/%E7%AC%AC%E5%8D%81%E4%BA%8C%E5%91%A8/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第十二周</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/28/%E7%AC%AC%E5%8D%81%E5%91%A8/">
                        <span class="hidden-mobile">第十周</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://qm.qq.com/cgi-bin/qm/qr?k=A5I1aDMT5p5nmi3zDa8t7gWOHawJhjyi&noverify=0&personal_qrcode_source=4" target="_blank" rel="nofollow noopener"><span>JohnBakcu</span></a> <i class="iconfont icon-love"></i> <a href="https://www.magedu.com"  target="_blank" rel="nofollow noopener"><span>Mgedu</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
