

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、数据库原理1 数据的分类  结构化的数据：即有固定格式和有限长度的数据。例如填的表格就是结构化的数据，国籍：中华人民共和国，民族：汉，性别：男，这都叫结构化数据 非结构化的数据：非结构化的数据越来越多，就是不定长、无固定格式的数据，例如: 网页,图片文件，有时候非常大，有时候很小；例如语音，视频都是非结构化的数据 半结构化数据：比如：XML或者HTML的格式的数据    2 数据库的发展史">
<meta property="og:type" content="article">
<meta property="og:title" content="MYSQL实战">
<meta property="og:url" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="Mgedu-N80054">
<meta property="og:description" content="一、数据库原理1 数据的分类  结构化的数据：即有固定格式和有限长度的数据。例如填的表格就是结构化的数据，国籍：中华人民共和国，民族：汉，性别：男，这都叫结构化数据 非结构化的数据：非结构化的数据越来越多，就是不定长、无固定格式的数据，例如: 网页,图片文件，有时候非常大，有时候很小；例如语音，视频都是非结构化的数据 半结构化数据：比如：XML或者HTML的格式的数据    2 数据库的发展史">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221023135818720-1923411036.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221023191447604-677340251.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221024144010486-207436707.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221024145636530-1221441424.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221024235653104-2038438940.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221025000056713-825473659.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221027151700903-1871285651.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221028155910039-1167769648.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221028155943963-1488506353.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221029141333403-1330195887.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221029141835265-924928128.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221029153718663-1729899877.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221030162855255-1949246472.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221030165619817-1909115986.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221030195227996-1454244001.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221031164131126-799572710.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221101211217831-989078873.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221102173735932-1137784711.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221103020600806-794369464.png">
<meta property="og:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221103162914460-1126578628.png">
<meta property="og:image" content="https://img2022.cnblogs.com/blog/2927659/202211/2927659-20221104015036118-1429453128.png">
<meta property="article:published_time" content="2023-07-28T20:22:25.000Z">
<meta property="article:modified_time" content="2023-07-30T21:21:40.975Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/07/28/MYSQL%E5%AE%9E%E6%88%98/2927659-20221023135818720-1923411036.png">
  
  
  <title>MYSQL实战 - Mgedu-N80054</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>JohnBackus</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="MYSQL实战">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-07-28 20:22" pubdate>
        July 28, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      112k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      934 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">MYSQL实战</h1>
            
            <div class="markdown-body">
              <h1 id="一、数据库原理"><a href="#一、数据库原理" class="headerlink" title="一、数据库原理"></a>一、数据库原理</h1><h2 id="1-数据的分类"><a href="#1-数据的分类" class="headerlink" title="1 数据的分类"></a>1 数据的分类</h2><blockquote>
<ul>
<li>结构化的数据：即有固定格式和有限长度的数据。例如填的表格就是结构化的数据，国籍：中华人民共和国，民族：汉，性别：男，这都叫结构化数据</li>
<li>非结构化的数据：非结构化的数据越来越多，就是不定长、无固定格式的数据，例如: 网页,图片文件，有时候非常大，有时候很小；例如语音，视频都是非结构化的数据</li>
<li>半结构化数据：比如：XML或者HTML的格式的数据</li>
</ul>
</blockquote>
<hr>
<h2 id="2-数据库的发展史"><a href="#2-数据库的发展史" class="headerlink" title="2 数据库的发展史"></a>2 数据库的发展史</h2><blockquote>
<ul>
<li>萌芽阶段：文件系统</li>
</ul>
<p>    使用磁盘文件来存储数据</p>
<ul>
<li>初级阶段：第一代数据库</li>
</ul>
<p>    出现了网状模型、层次模型的数据库</p>
<ul>
<li>中级阶段：第二代数据库</li>
</ul>
<p>    关系型数据库和结构化查询语言</p>
<ul>
<li>高级阶段：新一代数据库</li>
</ul>
<p>    “关系-对象”型数据库</p>
</blockquote>
<hr>
<h2 id="3-数据库管理系统"><a href="#3-数据库管理系统" class="headerlink" title="3 数据库管理系统"></a>3 数据库管理系统</h2><h3 id="3-1-相关概念"><a href="#3-1-相关概念" class="headerlink" title="3.1 相关概念"></a>3.1 相关概念</h3><blockquote>
<p>Database：数据库是数据的汇集，它以一定的组织形式存于存储介质上</p>
<p><strong>DBMS：Database Management System, 是管理数据库的系统软件，它实现数据库系统的各种功能。是数据库系统的核心</strong></p>
<p>DBA：Database Administrator, 负责数据库的规划、设计、协调、维护和管理等工作</p>
<p>Application：应用程序,指以数据库为基础的应用程序</p>
</blockquote>
<h3 id="3-2-数据库管理系统的优点"><a href="#3-2-数据库管理系统的优点" class="headerlink" title="3.2 数据库管理系统的优点"></a>3.2 数据库管理系统的优点</h3><blockquote>
<ul>
<li>程序与数据相互独立</li>
<li>保证数据的安全、可靠</li>
<li>最大限度地保证数据的正确性</li>
<li>数据可以并发使用并能同时保证一致性</li>
<li>相互关联的数据的集合</li>
<li>较少的数据冗余</li>
</ul>
</blockquote>
<h4 id="3-2-1-RDBMS-关系型数据库"><a href="#3-2-1-RDBMS-关系型数据库" class="headerlink" title="3.2.1 RDBMS 关系型数据库"></a>3.2.1 RDBMS 关系型数据库</h4><blockquote>
<p>Relational Database Management System,关系模型最初由IBM公司的英国计算机科学家埃德加·科德(Edgar F. Codd)于1969年描述1974年，IBM开始开发系统R，这是一个开发RDBMS原型的研究项目。然而，第一个商业上可用的RDBMS是甲骨文，于1979年由关系软件（现为甲骨文oracle公司）发布</p>
</blockquote>
<h5 id="3-2-1-1-关系统型数据库相关概念"><a href="#3-2-1-1-关系统型数据库相关概念" class="headerlink" title="3.2.1.1 关系统型数据库相关概念"></a>3.2.1.1 关系统型数据库相关概念</h5><blockquote>
<ul>
<li>关系Relational ：关系就是二维表，其中：表中的行、列次序并不重要</li>
<li><strong>行row：表中的每一行，又称为一条记录record</strong></li>
<li><strong>列column：表中的每一列，称为属性，字段，域field</strong></li>
<li><strong>主键Primary key：PK ,一个或多个字段的组合, 用于惟一确定一个记录的字段，一张表只有一个主键, 主键字段不能为空NULL</strong></li>
<li><strong>唯一键Unique key: 一个或多个字段的组合,用于惟一确定一个记录的字段,一张表可以有多个UK,而且UK字段可以为NULL</strong></li>
<li><strong>域domain：属性的取值范围，如，性别只能是’男’和’女’两个值，人类的年龄只能0-150</strong></li>
</ul>
</blockquote>
<h5 id="3-2-1-2常用关系数据库"><a href="#3-2-1-2常用关系数据库" class="headerlink" title="3.2.1.2常用关系数据库"></a>3.2.1.2常用关系数据库</h5><blockquote>
<ul>
<li>MySQL: MySQL, MariaDB, Percona Server</li>
<li>PostgreSQL: 简称为pgsql，EnterpriseDB</li>
<li>Oracle</li>
<li>MSSQL Server</li>
<li>DB2</li>
</ul>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking">数据库排行</a></p>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221023135818720-1923411036.png"><img src="2927659-20221023135818720-1923411036.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<hr>
<h2 id="4-关系型数据库理论"><a href="#4-关系型数据库理论" class="headerlink" title="4 关系型数据库理论"></a>4 关系型数据库理论</h2><h3 id="4-1-实体-联系模型E-R"><a href="#4-1-实体-联系模型E-R" class="headerlink" title="4.1 实体-联系模型E-R"></a>4.1 实体-联系模型E-R</h3><h3 id="4-2-联系类型"><a href="#4-2-联系类型" class="headerlink" title="4.2 联系类型"></a>4.2 联系类型</h3><blockquote>
<ul>
<li>一对一联系(1:1): 在表A或表B中创建一个字段﹐存储另一个表的主键值 如: 一个人只有一个身份证</li>
<li>一对多联系(1:n)：外键, 如: 部门和员工</li>
<li>多对多联系(m:n)：增加第三张表, 如: 学生和课程</li>
</ul>
</blockquote>
<h3 id="4-3-数据的操作"><a href="#4-3-数据的操作" class="headerlink" title="4.3 数据的操作"></a>4.3 数据的操作</h3><blockquote>
<p>开发工程师 CRUD (增加Create、查询Read或 Retrieve、更新Update、 删除Delete)</p>
<ul>
<li>数据提取：在数据集合中提取感兴趣的内容。SELECT</li>
<li>数据更新：变更数据库中的数据。INSERT、DELETE、UPDATE</li>
</ul>
</blockquote>
<h3 id="4-4-数据库的正规化分析"><a href="#4-4-数据库的正规化分析" class="headerlink" title="4.4 数据库的正规化分析"></a>4.4 数据库的正规化分析</h3><blockquote>
<ul>
<li>数据库规范化，又称数据库或资料库的正规化、标准化，是数据库设计中的一系列原理和技术，以减少数据库中数据冗余，增进数据的一致性。关系模型的发明者埃德加·科德最早提出这一概念，并于1970年代初定义了第一范式、第二范式和第三范式的概念</li>
<li>设计关系数据库时，遵从不同的规范要求，设计出合理的关系型数据库，不同的规范要求被称为不同范式，各种范式呈递次规范，<strong>越高的范式数据库冗余越小</strong></li>
<li> 目前关系数据库有六种范式：第一范式（1NF）、第二范式（2NF）、第三范式（3NF）、巴德斯科范式（BCNF）、第四范式(4NF）和第五范式（5NF，又称完美范式）。满足最低要求的范式是第一范式（1NF）。在第一范式的基础上进一步满足更多规范要求的称为第二范式（2NF），其余范式以次类推。一般数据库只需满足第三范式(3NF）即可</li>
<li>规则是死的,人是活的,所以<strong>范式是否必须遵守,要看业务需要而定</strong></li>
<li>掌握范式的目的是为了在合适的场景下违反范式</li>
</ul>
</blockquote>
<h4 id="4-4-1-第一范式：1NF"><a href="#4-4-1-第一范式：1NF" class="headerlink" title="4.4.1 第一范式：1NF"></a>4.4.1 第一范式：1NF</h4><blockquote>
<p>无重复的列，每一列都是不可分割的基本数据项，同一列中不能有多个值，即实体中的某个属性不能有多个值或者不能有重复的属性，确保每一列的原子性。除去同类型的字段，就是无重复的列</p>
<p>说明：第一范式（1NF）是对关系模式的基本要求，不满足第一范式（1NF）的数据库就不是关系数据库</p>
</blockquote>
<h4 id="4-4-2-第二范式：2NF"><a href="#4-4-2-第二范式：2NF" class="headerlink" title="4.4.2 第二范式：2NF"></a>4.4.2 第二范式：2NF</h4><blockquote>
<p>第二范式必须先满足第一范式，属性完全依赖于主键，要求表中的每个行必须可以被唯一地区分，通常为表加上每行的唯一标识主键PK，非PK的字段需要与整个PK有直接相关性,即非PK的字段不能依赖于部分主键</p>
</blockquote>
<h4 id="4-4-3-第三范式：3NF"><a href="#4-4-3-第三范式：3NF" class="headerlink" title="4.4.3 第三范式：3NF"></a>4.4.3 第三范式：3NF</h4><blockquote>
<p>满足第三范式必须先满足第二范式属性，非主键属性不依赖于其它非主键属性。第三范式要求一个数据表中不包含已在其它表中已包含的非主关键字信息，非PK的字段间不能有从属关系</p>
</blockquote>
<h3 id="4-5-SQL-结构化查询语言简介"><a href="#4-5-SQL-结构化查询语言简介" class="headerlink" title="4.5 SQL 结构化查询语言简介"></a>4.5 SQL 结构化查询语言简介</h3><blockquote>
<p>SQL：Structure Query Language,结构化查询语言是1974年由Boyce和Chamberlin提出的一个通用的、功能极强的关系性数据库语言</p>
<p>SQL解释器：将SQL语句解释成机器语言</p>
<p>数据存储协议：应用层协议，C/S</p>
<ul>
<li>S：server, 监听于套接字，接收并处理客户端的应用请求</li>
<li>C：Client</li>
</ul>
<p>客户端程序接口</p>
<ul>
<li>CLI</li>
<li>GUI</li>
</ul>
<p>应用编程接口</p>
<ul>
<li>ODBC：Open Database Connectivity</li>
<li>JDBC：Java Data Base Connectivity</li>
</ul>
</blockquote>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><hr>
<h1 id="二、MySQL安装和基本使用"><a href="#二、MySQL安装和基本使用" class="headerlink" title="二、MySQL安装和基本使用"></a>二、MySQL安装和基本使用</h1><h2 id="1-MySQL-介绍"><a href="#1-MySQL-介绍" class="headerlink" title="1 MySQL 介绍"></a>1 MySQL 介绍</h2><h3 id="1-1-MySQL系列"><a href="#1-1-MySQL系列" class="headerlink" title="1.1 MySQL系列"></a>1.1 MySQL系列</h3><blockquote>
<p><strong>MySQL 的三大主要分支</strong></p>
<ul>
<li>MySQL</li>
<li>Mariadb</li>
<li>Percona Server</li>
</ul>
<p><strong>官方网址</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.mysql.com/">https://www.mysql.com/</a></li>
<li><a target="_blank" rel="noopener" href="http://mariadb.org/">http://mariadb.org/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.percona.com/">https://www.percona.com</a></li>
</ul>
<p><strong>官方文档</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/">https://dev.mysql.com/doc/</a></li>
<li><a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/">https://mariadb.com/kb/en/</a>  </li>
<li><a target="_blank" rel="noopener" href="https://www.percona.com/software/mysql-database/percona-server">https://www.percona.com/software/mysql-database/percona-server</a></li>
</ul>
<p><strong>版本演变</strong></p>
<ul>
<li>MySQL：5.1 –&gt; 5.5 –&gt; 5.6 –&gt; 5.7 –&gt;8.0</li>
<li>MariaDB：5.1 –&gt;5.5 –&gt;10.0–&gt; 10.1 –&gt; 10.2 –&gt; 10.3 –&gt; 10.4 –&gt; 10.5</li>
<li>MySQL被Sun收购后，搞了个过渡的6.0版本，没多久就下线了,后来被Oracle收购后，终于迎来了像样的5.6版本，之后就是5.7、8.0版本。由于6.0版本号已被用过，7.x系列版本专用于NDB Cluster，因而新版本号从8.0开始。</li>
</ul>
</blockquote>
<h3 id="1-2-MySQL的特性"><a href="#1-2-MySQL的特性" class="headerlink" title="1.2 MySQL的特性"></a>1.2 MySQL的特性</h3><blockquote>
<ul>
<li>开源免费</li>
<li>插件式存储引擎：也称为”表类型”，存储管理器有多种实现版本，功能和特性可能均略有差别；用户可根据需要灵活选择,Mysql5.5.5开始<strong>innoDB引擎是MYSQL默认引擎</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs bash">MyISAM ==&gt; Aria <br>InnoDB ==&gt; XtraDB<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>单进程，多线程</strong></li>
<li>诸多扩展和新特性</li>
<li>提供了较多测试组件</li>
</ul>
</blockquote>
<hr>
<h2 id="2-MySQL-安装方式介绍和快速安装"><a href="#2-MySQL-安装方式介绍和快速安装" class="headerlink" title="2 MySQL 安装方式介绍和快速安装"></a>2 MySQL 安装方式介绍和快速安装</h2><h3 id="2-1-yum-安装"><a href="#2-1-yum-安装" class="headerlink" title="2.1 yum 安装"></a>2.1 yum 安装</h3><p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/">mysql最新源</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># yum install -y mysql-server</span><br>[root@rocky01 ~]<span class="hljs-comment"># systemctl enable --now mysqld</span><br>Created symlink /etc/systemd/system/multi-user.target.wants/mysqld.service → /usr/lib/systemd/system/mysqld.service.<br>[root@rocky01 ~]<span class="hljs-comment"># ss -ntl</span><br>State      Recv-Q      Send-Q           Local Address:Port            Peer Address:Port     Process<br>LISTEN     0           70                           *:33060                      *:*<br>LISTEN     0           128                          *:3306                       *:*<br><br>[root@rocky01 ~]<span class="hljs-comment"># mysql</span><br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection <span class="hljs-built_in">id</span> is 13<br>Server version: 8.0.26 Source distribution<br><br>Copyright (c) 2000, 2021, Oracle and/or its affiliates.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; status<br>--------------<br>mysql  Ver 8.0.26 <span class="hljs-keyword">for</span> Linux on x86_64 (Source distribution)<br><br>Connection <span class="hljs-built_in">id</span>:		13<br>Current database:<br>Current user:		root@localhost<br>SSL:			Not <span class="hljs-keyword">in</span> use<br>Current pager:		stdout<br>Using outfile:		<span class="hljs-string">&#x27;&#x27;</span><br>Using delimiter:	;<br>Server version:		8.0.26 Source distribution<br>Protocol version:	10<br>Connection:		Localhost via UNIX socket<br>Server characterset:	utf8mb4<br>Db     characterset:	utf8mb4<br>Client characterset:	utf8mb4<br>Conn.  characterset:	utf8mb4<br>UNIX socket:		/var/lib/mysql/mysql.sock<br>Binary data as:		Hexadecimal<br>Uptime:			47 min 31 sec<br><br>Threads: 2  Questions: 21  Slow queries: 0  Opens: 140  Flush tables: 3  Open tables: 56  Queries per second avg: 0.007<br>--------------<br><br>mysql&gt;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-初始化脚本提高安全性"><a href="#2-2-初始化脚本提高安全性" class="headerlink" title="2.2 初始化脚本提高安全性"></a>2.2 初始化脚本提高安全性</h3><p>运行脚本：[root@centos7 ~]# <strong>mysql_secure_installation</strong> </p>
<blockquote>
<ul>
<li><strong>设置数据库管理员root口令</strong></li>
<li><strong>禁止root远程登录</strong></li>
<li><strong>删除anonymous（匿名）用户帐号</strong></li>
<li><strong>删除test数据库</strong></li>
</ul>
</blockquote>
<hr>
<h2 id="3-MySQL-组成和常用工具"><a href="#3-MySQL-组成和常用工具" class="headerlink" title="3 MySQL 组成和常用工具"></a>3 MySQL 组成和常用工具</h2><h3 id="3-1-客户端程序"><a href="#3-1-客户端程序" class="headerlink" title="3.1 客户端程序"></a>3.1 客户端程序</h3><blockquote>
<ul>
<li>mysql: 基于mysql协议交互式或非交互式的CLI工具</li>
<li>mysqldump：备份工具，基于mysql协议向mysqld发起查询请求，并将查得的所有数据转换成insert等写操作语句保存文本文件中</li>
<li>mysqladmin：基于mysql协议管理mysqld</li>
<li>mysqlimport：数据导入工具</li>
</ul>
<p>MyISAM存储引擎的管理工具：</p>
<ul>
<li>myisamchk：检查MyISAM库</li>
<li>myisampack：打包MyISAM表，只读</li>
</ul>
</blockquote>
<h3 id="3-2-服务器端程序"><a href="#3-2-服务器端程序" class="headerlink" title="3.2 服务器端程序"></a>3.2 服务器端程序</h3><blockquote>
<ul>
<li>mysqld_safe</li>
<li>mysqld</li>
<li>mysqld_multi 多实例 ，示例：mysqld_multi –example</li>
</ul>
</blockquote>
<h3 id="3-3-用户账号"><a href="#3-3-用户账号" class="headerlink" title="3.3 用户账号"></a>3.3 用户账号</h3><blockquote>
<p>说明：</p>
<ul>
<li><p><strong>HOST限制此用户可通过哪些远程主机连接mysql服务器</strong></p>
</li>
<li><p>支持使用通配符</p>
</li>
<li><ul>
<li><strong>% 匹配任意长度的任意字符,相当于shell中*</strong>, 示例: 172.16.0.0/255.255.0.0 或 172.16.%.%</li>
<li><strong>_ 匹配任意单个字符,相当于shell中?</strong></li>
</ul>
</li>
</ul>
</blockquote>
<p>mysql用户账号由两部分组成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&#x27;USERNAME&#x27;</span>@<span class="hljs-string">&#x27;HOST&#x27;</span><br>root@<span class="hljs-string">&#x27;10.0.0.100&#x27;</span><br>root@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span><br>root@<span class="hljs-string">&#x27;%&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-mysql-客户端命令"><a href="#3-4-mysql-客户端命令" class="headerlink" title="3.4 mysql 客户端命令"></a>3.4 mysql 客户端命令</h3><h4 id="3-4-1-mysql-运行命令类型"><a href="#3-4-1-mysql-运行命令类型" class="headerlink" title="3.4.1 mysql 运行命令类型"></a>3.4.1 mysql 运行命令类型</h4><blockquote>
<ul>
<li>客户端命令：本地执行，每个命令都完整形式和简写格式</li>
<li>服务端命令：通过mysql协议发往服务器执行并取回结果，<strong>命令末尾都必须使用命令结束符号</strong>，默认为分号</li>
</ul>
</blockquote>
<h5 id="范例：查看版本"><a href="#范例：查看版本" class="headerlink" title="范例：查看版本"></a>范例：查看版本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#客户端</span><br>[root@rocky01 ~]<span class="hljs-comment"># mysql -V</span><br>mysql  Ver 8.0.26 <span class="hljs-keyword">for</span> Linux on x86_64 (Source distribution)<br><br><span class="hljs-comment">#服务端</span><br>mysql&gt; SELECT VERSION();<br>+-----------+<br>| VERSION() |<br>+-----------+<br>| 8.0.26    |<br>+-----------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h4 id="3-4-2-mysql-使用模式"><a href="#3-4-2-mysql-使用模式" class="headerlink" title="3.4.2 mysql 使用模式"></a>3.4.2 mysql 使用模式</h4><blockquote>
<ul>
<li>交互模式</li>
<li>脚本模式：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql -uUSERNAME -pPASSWORD &lt; /path/somefile.sql<br><span class="hljs-built_in">cat</span> /path/somefile.sql |mysql -uUSERNAME -pPASSWORD<br>mysql&gt;<span class="hljs-built_in">source</span> /path/from/somefile.sql<br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="3-4-3-mysql命令使用格式"><a href="#3-4-3-mysql命令使用格式" class="headerlink" title="3.4.3 mysql命令使用格式"></a>3.4.3 mysql命令使用格式</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">mysql <span class="hljs-selector-attr">[OPTIONS]</span> <span class="hljs-selector-attr">[database]</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>mysql客户端常用选项：</p>
<ul>
<li>-A, –no-auto-rehash 禁止补全</li>
<li><strong>-u, –user= 用户名,默认为root</strong></li>
<li><strong>-h, –host= 服务器主机,默认为localhost</strong></li>
<li><strong>-p, –passowrd= 用户密码,建议使用-p,默认为空密码</strong></li>
<li><strong>-P, –port= 服务器端口</strong></li>
<li>-S, –socket= 指定连接socket文件路径</li>
<li>-D, –database= 指定默认数据库</li>
<li>-C, –compress 启用压缩</li>
<li><strong>-e  “SQL” 执行SQL命令</strong></li>
<li>-V, –version 显示版本</li>
<li>-v  –verbose 显示详细信息</li>
<li>–print-defaults 获取程序默认使用的配置</li>
</ul>
</blockquote>
<h5 id="范例：修改提示符"><a href="#范例：修改提示符" class="headerlink" title="范例：修改提示符"></a>范例：修改提示符</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#临时修改mysql提示符</span><br>[root@rocky01 ~]<span class="hljs-comment"># mysql -uroot -p123456 --prompt=&quot;(\\u@\\h) [\\d]&gt;\\_&quot; </span><br><br><span class="hljs-comment">#临时修改mysql提示符</span><br>[root@rocky01 ~]<span class="hljs-comment"># export MYSQL_PS1=&quot;(\\u@\\h) [\\d]&gt;\\_&quot;  </span><br><br><span class="hljs-comment">#持久修改mysql提示符</span><br>[root@rocky01 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysql]<br>prompt=<span class="hljs-string">&quot;[\\u@\\h \\d]&gt;\\_&quot;</span><br></code></pre></td></tr></table></figure>

<h5 id="范例：配置所有MySQL-客户端的自动登录"><a href="#范例：配置所有MySQL-客户端的自动登录" class="headerlink" title="范例：配置所有MySQL 客户端的自动登录"></a>范例：配置所有MySQL 客户端的自动登录</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysql]<br>user=root<br>password=123456<br></code></pre></td></tr></table></figure>

<h4 id="3-4-4-mysqladmin命令"><a href="#3-4-4-mysqladmin命令" class="headerlink" title="3.4.4 mysqladmin命令"></a>3.4.4 mysqladmin命令</h4><p>mysqladmin 命令格式</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">mysqladmin [OPTIONS] <span class="hljs-keyword">command</span> <span class="hljs-keyword">command</span>.<span class="hljs-string">...</span><br></code></pre></td></tr></table></figure>

<h5 id="使用范例"><a href="#使用范例" class="headerlink" title="使用范例"></a>使用范例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看mysql服务是否正常，如果正常提示mysqld is alive</span><br>mysqladmin -uroot -p123456 ping<br><br><span class="hljs-comment">#关闭mysql服务，但mysqladmin命令无法开启mysql</span><br>mysqladmin -uroot -p123456 shutdown<br><br><span class="hljs-comment">#创建数据库testdb</span><br>mysqladmin -uroot -p123456 create testdb <br><br><span class="hljs-comment">#删除数据库testdb</span><br>mysqladmin -uroot -p123456 drop testdb<br><br><span class="hljs-comment">#修改root密码</span><br>mysqladmin -uroot -p123456 password <span class="hljs-string">&quot;654321&quot;</span><br><br><span class="hljs-comment">#日志滚动,生成新文件/var/lib/mysql/mariadb-bin.00000N</span><br>mysqladmin -uroot -p123456 flush-logs<br></code></pre></td></tr></table></figure>

<h4 id="3-4-5-mycli"><a href="#3-4-5-mycli" class="headerlink" title="3.4.5 mycli"></a>3.4.5 mycli</h4><p>MyCLI 是基于Python开发的MySQL的命令行工具，具有自动完成和语法突出显示功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#CentOS8安装</span><br>[root@centos8 ~]<span class="hljs-comment">#yum install python3-pip -y</span><br>[root@centos8 ~]<span class="hljs-comment">#pip3 install mycli</span><br><br><span class="hljs-comment">#ubuntu安装</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#apt -y install mycli</span><br>[root@ubuntu1804 ~]<span class="hljs-comment">#mycli -u root -S /var/run/mysqld/mysqld.sock</span><br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221023191447604-677340251.png"><img src="2927659-20221023191447604-677340251.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<hr>
<h3 id="3-5-服务器端配置"><a href="#3-5-服务器端配置" class="headerlink" title="3.5 服务器端配置"></a>3.5 服务器端配置</h3><h4 id="3-5-1-服务器端配置文件"><a href="#3-5-1-服务器端配置文件" class="headerlink" title="3.5.1 服务器端配置文件"></a>3.5.1 服务器端配置文件</h4><blockquote>
<p> 服务器端(mysqld)：工作特性有多种配置方式</p>
<p>1、命令行选项：</p>
<p>2、配置文件：类ini格式,集中式的配置，能够为mysql的各应用程序提供配置信息</p>
<p>服务器端配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">/etc/my.cnf   <span class="hljs-comment">#Global选项</span><br>/etc/mysql/my.cnf <span class="hljs-comment">#Global选项</span><br>~/.my.cnf <span class="hljs-comment">#User-specific 选项</span><br></code></pre></td></tr></table></figure>

<p>配置文件格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[mysqld]<br>[mysqld_safe]<br>[mysqld_multi]<br>[mysql]<br>[mysqladmin]<br>[mysqldump]<br>[server]<br>[client]<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>[client] 里面的内容可以被 mysql,mysqladmin,mysqldump 等客户端读取的，而 [mysql]里的内容只能给mysql客户端读取</strong></li>
<li><strong>两者都配置了一样的参数时，遵循覆盖原则，选取最下面的</strong></li>
<li>MySQL的客户端都是可以在命令行指定连接参数的，<strong>如配置文件的参数错误，可直接在命令行输入该参数覆盖参数文件参数</strong></li>
</ul>
<p>说明：</p>
<ul>
<li><strong>_和- 相同</strong></li>
<li><strong>1，ON，TRUE意义相同</strong></li>
<li><strong>0，OFF，FALSE意义相同,无区分大小写</strong></li>
</ul>
</blockquote>
<h4 id="3-5-2-socket-连接说明"><a href="#3-5-2-socket-连接说明" class="headerlink" title="3.5.2 socket 连接说明"></a>3.5.2 socket 连接说明</h4><blockquote>
<p> 服务器监听的两种 socket 地址：</p>
<ul>
<li>ip socket: 监听在tcp的3306端口，支持远程通信 ，侦听3306/tcp端口可以在绑定有一个或全部接口IP上</li>
<li>unix sock: 监听在sock文件上，仅支持本机通信, 如：/var/lib/mysql/mysql.sock)</li>
</ul>
<p>说明：host为localhost 时自动使用unix sock</p>
</blockquote>
<h5 id="范例：MySQL的端口"><a href="#范例：MySQL的端口" class="headerlink" title="范例：MySQL的端口"></a>范例：MySQL的端口</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost (none)]&gt; SHOW VARIABLES LIKE <span class="hljs-string">&#x27;port&#x27;</span>;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| port          | 3306  |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br><br><span class="hljs-comment">#MySQL8.0增加了一个33060/tcp端口</span><br><span class="hljs-comment">#Port 33060 is the default port for the MySQL Database Extended Interface (the MySQL X Protocol).扩展接口的端口</span><br>[root@localhost (none)]&gt; SHOW VARIABLES LIKE <span class="hljs-string">&#x27;mysqlx_port&#x27;</span>;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| mysqlx_port   | 33060 |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h4 id="3-5-3-关闭mysqld网络连接"><a href="#3-5-3-关闭mysqld网络连接" class="headerlink" title="3.5.3 关闭mysqld网络连接"></a>3.5.3 关闭mysqld网络连接</h4><blockquote>
<p>只侦听本地客户端， 所有客户端和服务器的交互都通过一个socket文件实现，socket的配置存放在/var/lib/mysql/mysql.sock） 可在/etc/my.cnf修改</p>
</blockquote>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/my.cnf<br>[mysqld]<br>skip-networking=1<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="4-通用二进制格式安装-MySQL"><a href="#4-通用二进制格式安装-MySQL" class="headerlink" title="4 通用二进制格式安装 MySQL"></a>4 通用二进制格式安装 MySQL</h2><h3 id="实战案例：手动安装MySQL-5-7、MySQL8-0"><a href="#实战案例：手动安装MySQL-5-7、MySQL8-0" class="headerlink" title="实战案例：手动安装MySQL 5.7、MySQL8.0"></a>实战案例：手动安装MySQL 5.7、MySQL8.0</h3><h4 id="（1）安装相关包"><a href="#（1）安装相关包" class="headerlink" title="（1）安装相关包"></a>（1）安装相关包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># yum -y install libaio numactl-libs</span><br></code></pre></td></tr></table></figure>

<h4 id="（2）创建用户和组"><a href="#（2）创建用户和组" class="headerlink" title="（2）创建用户和组"></a>（2）创建用户和组</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">groupadd mysql<br>useradd -r -g mysql -s /bin/false mysql<br></code></pre></td></tr></table></figure>

<h4 id="（3）准备程序文件"><a href="#（3）准备程序文件" class="headerlink" title="（3）准备程序文件"></a>（3）准备程序文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#官网下载二进制包</span><br>https://dev.mysql.com/downloads/mysql/<br><br>[root@rocky01 ~]<span class="hljs-comment"># tar xf mysql-8.0.31-linux-glibc2.12-x86_64.tar.xz -C /usr/local</span><br>[root@rocky01 ~]<span class="hljs-comment"># ln -s /usr/local/mysql-8.0.31-linux-glibc2.12-x86_64/ mysql</span><br>[root@rocky01 ~]<span class="hljs-comment"># chown -R root:root /usr/local/mysql/</span><br></code></pre></td></tr></table></figure>

<h4 id="（5）准备环境变量"><a href="#（5）准备环境变量" class="headerlink" title="（5）准备环境变量"></a>（5）准备环境变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># echo &#x27;PATH=/usr/local/mysql/bin:$PATH&#x27; &gt; /etc/profile.d/mysql.sh</span><br>[root@rocky01 ~]<span class="hljs-comment"># . /etc/profile.d/mysql.sh</span><br></code></pre></td></tr></table></figure>

<h4 id="（6）准备配置文件"><a href="#（6）准备配置文件" class="headerlink" title="（6）准备配置文件"></a>（6）准备配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>datadir=/data/mysql<br>skip_name_resolve=1<br>socket=/data/mysql/mysql.sock        <br>log-error=/data/mysql/mysql.log<br>pid-file=/data/mysql/mysql.pid<br>[client]<br>socket=/data/mysql/mysql.sock<br></code></pre></td></tr></table></figure>

<h4 id="（7）初始化数据库文件并提取root密码"><a href="#（7）初始化数据库文件并提取root密码" class="headerlink" title="（7）初始化数据库文件并提取root密码"></a>（7）<strong>初始化数据库文件并提取<strong><strong>root</strong></strong>密码</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#/data/mysql 会自动生成,但是/data/必须事先存在</span><br>[root@rocky01 ~]<span class="hljs-comment"># mkdir -pv /data/mysql</span><br></code></pre></td></tr></table></figure>

<p> <strong>方式****1:</strong> <strong>生成随机密码</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># mysqld --initialize --user=mysql --datadir=/data/mysql</span><br>[root@rocky01 ~]<span class="hljs-comment"># grep password /data/mysql/mysql.log</span><br>2022-10-23T13:54:58.508775Z 6 [Note] [MY-010454] [Server] A temporary password is generated <span class="hljs-keyword">for</span> root@localhost: L!fdbgQpH2AQ<br><br><span class="hljs-comment">#这后面为生成的随机密码</span><br><span class="hljs-comment">#密码L!fdbgQpH2AQ</span><br></code></pre></td></tr></table></figure>

<p><strong>方式****2:</strong> <strong>生成</strong> <strong>root</strong> <strong>空密码</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysqld --initialize-insecure --user=mysql --datadir=/data/mysql<br></code></pre></td></tr></table></figure>

<h4 id="（8）准备服务脚本和启动"><a href="#（8）准备服务脚本和启动" class="headerlink" title="（8）准备服务脚本和启动"></a>（8）准备服务脚本和启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br>[root@rocky01 ~]<span class="hljs-comment"># chkconfig --add mysqld</span><br>[root@rocky01 ~]<span class="hljs-comment"># service mysqld start</span><br>Starting MySQL.. SUCCESS!<br></code></pre></td></tr></table></figure>

<p><strong>（9）修改口令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#修改前面生成的随机密码为指定密码</span><br>[root@rocky01 ~]<span class="hljs-comment"># mysqladmin -uroot -p&#x27;L!fdbgQpH2AQ&#x27; password 123456</span><br>mysqladmin: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Warning: Since password will be sent to server <span class="hljs-keyword">in</span> plain text, use ssl connection to ensure password safety.<br><br><span class="hljs-comment">#修改前面生成的空密码为指定密码</span><br>mysqladmin -uroot password 123456<br></code></pre></td></tr></table></figure>

<h4 id="（10）测试登录"><a href="#（10）测试登录" class="headerlink" title="（10）测试登录"></a>（10）测试登录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@rocky01 ~]<span class="hljs-comment"># mysql -uroot -p123456</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection <span class="hljs-built_in">id</span> is 8<br>Server version: 8.0.31 MySQL Community Server - GPL<br>...省略..<br><br><span class="hljs-comment">#注：若报如下错误，请执行下面命令</span><br>[root@rocky01 ~]<span class="hljs-comment"># mysql -uroot -p123456</span><br>mysql: error <span class="hljs-keyword">while</span> loading shared libraries: libtinfo.so.5: cannot open shared object file: No such file or directory<br>[root@rocky01 ~]<span class="hljs-comment"># ln -s /usr/lib64/libtinfo.so.6.1 /usr/lib64/libtinfo.so.5</span><br></code></pre></td></tr></table></figure>

<h3 id="实战案例：一键安装MySQL5-7、MySQL8-0脚本"><a href="#实战案例：一键安装MySQL5-7、MySQL8-0脚本" class="headerlink" title="实战案例：一键安装MySQL5.7、MySQL8.0脚本"></a>实战案例：一键安装MySQL5.7、MySQL8.0脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#bin/bash</span><br><span class="hljs-comment">#https://dev.mysql.com/downloads/mysql/</span><br><br>. /etc/init.d/functions<br>SRC_DIR=`<span class="hljs-built_in">pwd</span>`<br><br>MYSQL=<span class="hljs-string">&#x27;mysql-8.0.31-linux-glibc2.12-x86_64.tar.xz&#x27;</span><br><span class="hljs-comment">#MYSQL=&#x27;mysql-8.0.23-linux-glibc2.12-x86_64.tar.xz&#x27;</span><br>MYSQL_ROOT_PASSWORD=123456<br><br><br>COLOR=<span class="hljs-string">&#x27;echo -e \E[01;31m&#x27;</span><br>END=<span class="hljs-string">&#x27;\E[0m&#x27;</span><br><br><br><span class="hljs-function"><span class="hljs-title">check</span></span> ()&#123;<br><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$UID</span> -ne 0 ]; <span class="hljs-keyword">then</span><br>  action <span class="hljs-string">&quot;当前用户不是root,安装失败&quot;</span> <span class="hljs-literal">false</span><br>  <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">cd</span>  <span class="hljs-variable">$SRC_DIR</span><br><br><br><span class="hljs-keyword">if</span> [ !  -e <span class="hljs-variable">$MYSQL</span> ];<span class="hljs-keyword">then</span><br>        <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;缺少<span class="hljs-variable">$&#123;MYSQL&#125;</span>文件&quot;</span><span class="hljs-variable">$END</span><br>		<span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;请将相关软件放在<span class="hljs-variable">$&#123;SRC_DIR&#125;</span>目录下&quot;</span><span class="hljs-variable">$END</span><br>        <span class="hljs-built_in">exit</span><br><span class="hljs-keyword">elif</span> [ -e /usr/local/mysql ];<span class="hljs-keyword">then</span><br>        action <span class="hljs-string">&quot;数据库已存在，安装失败&quot;</span> <span class="hljs-literal">false</span><br>        <span class="hljs-built_in">exit</span><br><span class="hljs-keyword">else</span><br>	<span class="hljs-built_in">return</span><br><span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">install_mysql</span></span>()&#123;<br>    <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;开始安装MySQL数据库...&quot;</span><span class="hljs-variable">$END</span><br>    yum  -y -q install libaio numactl-libs<br>    tar xf <span class="hljs-variable">$MYSQL</span> -C /usr/local/<br>    MYSQL_DIR=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MYSQL</span>| sed -nr <span class="hljs-string">&#x27;s/^(.*[0-9]).*/\1/p&#x27;</span>`<br>    <span class="hljs-built_in">ln</span> -s  /usr/local/<span class="hljs-variable">$MYSQL_DIR</span> /usr/local/mysql<br>    <span class="hljs-built_in">chown</span> -R  root.root /usr/local/mysql/<br>    <span class="hljs-built_in">id</span> mysql &amp;&gt; /dev/null || &#123; useradd -s /sbin/nologin -r  mysql ; action <span class="hljs-string">&quot;创建mysql用户&quot;</span>; &#125;<br><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;PATH=/usr/local/mysql/bin/:$PATH&#x27;</span> &gt; /etc/profile.d/mysql.sh<br>    .  /etc/profile.d/mysql.sh<br>	<span class="hljs-built_in">ln</span> -s /usr/local/mysql/bin/* /usr/bin/<br>    <span class="hljs-built_in">cat</span> &gt; /etc/my.cnf &lt;&lt;-<span class="hljs-string">EOF</span><br><span class="hljs-string">[mysqld]</span><br><span class="hljs-string">server-id=`hostname -I|cut -d. -f4`</span><br><span class="hljs-string">log-bin</span><br><span class="hljs-string">datadir=/data/mysql</span><br><span class="hljs-string">socket=/data/mysql/mysql.sock</span><br><span class="hljs-string">log-error=/data/mysql/mysql.log</span><br><span class="hljs-string">pid-file=/data/mysql/mysql.pid</span><br><span class="hljs-string">[client]</span><br><span class="hljs-string">socket=/data/mysql/mysql.sock</span><br><span class="hljs-string">EOF</span><br>    [ -d /data ] || <span class="hljs-built_in">mkdir</span> /data<br>	mysqld --initialize-insecure --user=mysql --datadir=/data/mysql<br>    <span class="hljs-built_in">cp</span> /usr/local/mysql/support-files/mysql.server  /etc/init.d/mysqld<br>    chkconfig --add mysqld<br>    chkconfig mysqld on<br>    service mysqld start<br>    [ $? -ne 0 ] &amp;&amp; &#123; <span class="hljs-variable">$COLOR</span><span class="hljs-string">&quot;数据库启动失败，退出!&quot;</span><span class="hljs-variable">$END</span>;<span class="hljs-built_in">exit</span>; &#125;<br>    <span class="hljs-comment">#MYSQL_OLDPASSWORD=`awk &#x27;/A temporary password/&#123;print $NF&#125;&#x27; /data/mysql/mysql.log`</span><br>    <span class="hljs-comment">#mysqladmin  -uroot -p$MYSQL_OLDPASSWORD password $MYSQL_ROOT_PASSWORD &amp;&gt;/dev/null</span><br>	<span class="hljs-built_in">sleep</span> 3<br>    mysqladmin  -uroot  password <span class="hljs-variable">$MYSQL_ROOT_PASSWORD</span> &amp;&gt;/dev/null<br>    action <span class="hljs-string">&quot;数据库安装完成&quot;</span><br>&#125;<br><br><br>check<br><br>install_mysql<br></code></pre></td></tr></table></figure>

<h1 id="-1"><a href="#-1" class="headerlink" title=""></a></h1><hr>
<h1 id="三、SQL-语言"><a href="#三、SQL-语言" class="headerlink" title="三、SQL 语言"></a>三、SQL 语言</h1><h2 id="1-关系型数据库的常见组件"><a href="#1-关系型数据库的常见组件" class="headerlink" title="1 关系型数据库的常见组件"></a>1 关系型数据库的常见组件</h2><blockquote>
<ul>
<li>数据库：database 表的集合，物理上表现为一个目录</li>
<li>表：table，行：row 列：column</li>
<li>索引：index</li>
<li>视图：view，虚拟的表</li>
<li>存储过程：procedure</li>
<li>存储函数：function</li>
<li>触发器：trigger</li>
<li>事件调度器：event scheduler，任务计划</li>
<li>用户：user</li>
<li>权限：privilege</li>
</ul>
</blockquote>
<h2 id="2-SQL-语法标准"><a href="#2-SQL-语法标准" class="headerlink" title="2 SQL 语法标准"></a>2 SQL 语法标准</h2><h3 id="2-1-SQL-语言规范"><a href="#2-1-SQL-语言规范" class="headerlink" title="2.1 SQL 语言规范"></a>2.1 SQL 语言规范</h3><blockquote>
<ul>
<li>在数据库系统中，SQL 语句不区分大小写，建议用大写</li>
<li>SQL语句可单行或多行书写，默认以 “ ; “ 结尾</li>
<li>关键词不能跨多行或简写</li>
<li>用空格和TAB 缩进来提高语句的可读性</li>
<li>子句通常位于独立行，便于编辑，提高可读性</li>
</ul>
<p><strong>注释：</strong></p>
<ul>
<li>SQL标准：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#单行注释，注意有空格</span><br>-- 注释内容   <br><br><span class="hljs-comment">#多行注释</span><br>/*注释内容<br>注释内容<br>注释内容*/  <br></code></pre></td></tr></table></figure>

<ul>
<li>MySQL注释：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 注释内容</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="2-2-数据库对象和命名"><a href="#2-2-数据库对象和命名" class="headerlink" title="2.2 数据库对象和命名"></a>2.2 数据库对象和命名</h3><blockquote>
<p><strong>数据库的组件</strong>**(<strong><strong>对象</strong></strong>)**<strong>：</strong></p>
<ul>
<li>数据库、表、索引、视图、用户、存储过程、函数、触发器、事件调度器等</li>
</ul>
<p><strong>命名规则：</strong></p>
<ul>
<li>必须以字母开头，后续可以包括字母,数字和三个特殊字符（# _ $）</li>
<li>不要使用MySQ</li>
</ul>
</blockquote>
<h3 id="2-3-SQL语句分类"><a href="#2-3-SQL语句分类" class="headerlink" title="2.3 SQL语句分类"></a>2.3 SQL语句分类</h3><blockquote>
<ul>
<li><strong>DDL: Data Defination Language 数据定义语言</strong></li>
</ul>
<p>    <strong>CREATE，DROP，ALTER</strong></p>
<ul>
<li><strong>DML: Data Manipulation Language 数据操纵语言</strong></li>
</ul>
<p>    <strong>INSERT，DELETE，UPDATE</strong></p>
<p>    软件开发：CRUD</p>
<ul>
<li><strong>DQL：Data Query Language 数据查询语言</strong></li>
</ul>
<p>    <strong>SELECT</strong></p>
<ul>
<li>DCL：Data Control Language 数据控制语言</li>
</ul>
<p>    GRANT，REVOKE</p>
<ul>
<li>TCL：Transaction Control Language 事务控制语言</li>
</ul>
<p>    COMMIT，ROLLBACK，SAVEPOINT</p>
</blockquote>
<h3 id="2-4-SQL语句构成"><a href="#2-4-SQL语句构成" class="headerlink" title="2.4 SQL语句构成"></a>2.4 SQL语句构成</h3><p>关健字Keyword组成子句clause，多条clause组成语句</p>
<p>示例：一组SQL语句由三个子句构成，SELECT,FROM和WHERE是关键字</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">SELECT *         <span class="hljs-comment">#SELECT子句</span><br>FROM products    <span class="hljs-comment">#FROM子句</span><br>WHERE price&gt;666  <span class="hljs-comment">#WHERE子句</span><br></code></pre></td></tr></table></figure>

<h4 id="范例：查看SQL帮助"><a href="#范例：查看SQL帮助" class="headerlink" title="范例：查看SQL帮助"></a>范例：查看SQL帮助</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost (none)]&gt; <span class="hljs-built_in">help</span> contents<br>You asked <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span> about <span class="hljs-built_in">help</span> category: <span class="hljs-string">&quot;Contents&quot;</span><br>For more information, <span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;help &lt;item&gt;&#x27;</span>, <span class="hljs-built_in">where</span> &lt;item&gt; is one of the following<br>categories:<br>   Account Management<br>   Administration<br>   Components<br>   Compound Statements<br>   Contents<br>   Data Definition<br>   Data Manipulation<br>   Data Types<br>...省略...<br></code></pre></td></tr></table></figure>

<h3 id="2-5-字符集和排序"><a href="#2-5-字符集和排序" class="headerlink" title="2.5 字符集和排序"></a>2.5 字符集和排序</h3><p>早期MySQL版本默认为 latin1，从MySQL8.0开始默认字符集已经为 utf8mb4</p>
<h4 id="查看支持所有字符集"><a href="#查看支持所有字符集" class="headerlink" title="查看支持所有字符集"></a>查看支持所有字符集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW CHARACTER SET;<br>SHOW CHARSET;<br></code></pre></td></tr></table></figure>

<h4 id="查看当前使用的字符集"><a href="#查看当前使用的字符集" class="headerlink" title="查看当前使用的字符集"></a>查看当前使用的字符集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW VARIABLES LIKE <span class="hljs-string">&#x27;%char%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="查看支持所有排序规则"><a href="#查看支持所有排序规则" class="headerlink" title="查看支持所有排序规则"></a>查看支持所有排序规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW COLLATION;<br><span class="hljs-comment">#注意</span><br>utf8_general_ci不区分大小写<br>utf8_bin 区分大小写<br></code></pre></td></tr></table></figure>

<h4 id="查看当前使用的排序规则"><a href="#查看当前使用的排序规则" class="headerlink" title="查看当前使用的排序规则"></a>查看当前使用的排序规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW VARIABLES LIKE <span class="hljs-string">&#x27;collation%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="设置服务器默认的字符集"><a href="#设置服务器默认的字符集" class="headerlink" title="设置服务器默认的字符集"></a>设置服务器默认的字符集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/my.cnf<br>[mysqld]<br>character-set-server=utf8mb4<br></code></pre></td></tr></table></figure>

<h4 id="设置客户端默认的字符集"><a href="#设置客户端默认的字符集" class="headerlink" title="设置客户端默认的字符集"></a>设置客户端默认的字符集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/my.cnf<br><span class="hljs-comment">#针对mysql客户端</span><br>[mysql]<br>default-character-set=utf8mb4<br><span class="hljs-comment">#针对所有MySQL客户端</span><br>[client]<br>default-character-set=utf8mb4<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="3-管理数据库"><a href="#3-管理数据库" class="headerlink" title="3 管理数据库"></a>3 管理数据库</h2><h3 id="3-1-创建数据库"><a href="#3-1-创建数据库" class="headerlink" title="3.1 创建数据库"></a>3.1 创建数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE DATABASE|SCHEMA [IF NOT EXISTS] <span class="hljs-string">&#x27;DB_NAME&#x27;</span><br>CHARACTER SET <span class="hljs-string">&#x27;character set name&#x27;</span><br>COLLATE <span class="hljs-string">&#x27;collate name&#x27;</span>;<br><br><span class="hljs-comment">#Mysql中DATABASE和SCHEMA是等价的</span><br></code></pre></td></tr></table></figure>

<h4 id="范例：常见用法"><a href="#范例：常见用法" class="headerlink" title="范例：常见用法"></a>范例：常见用法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建数据库</span><br>[root@localhost (none)]&gt; create database IF NOT EXISTS db1;<br>Query OK, 1 row affected (0.00 sec)<br><br><span class="hljs-comment">#显示创建数据库的语句</span><br>[root@localhost (none)]&gt; show create database db1;<br>+----------+-------------------------------------------------------------------------------------------------------------------------------+<br>| Database | Create Database                       |<br>+----------+-------------------------------------------------------------------------------------------------------------------------------+<br>| db1      | CREATE DATABASE `db1` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */ /*!80016 DEFAULT ENCRYPTION=<span class="hljs-string">&#x27;N&#x27;</span> */ |<br>+----------+-------------------------------------------------------------------------------------------------------------------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#显示warnings</span><br>[root@localhost (none)]&gt; show warnings;<br>Empty <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#创建数据库</span><br>[root@localhost (none)]&gt; create database IF NOT EXISTS db1;<br>Query OK, 1 row affected, 1 warning (0.00 sec)<br><br><span class="hljs-comment">#显示warnings</span><br>[root@localhost (none)]&gt; show warnings;<br>+-------+------+----------------------------------------------+<br>| Level | Code | Message                                      |<br>+-------+------+----------------------------------------------+<br>| Note  | 1007 | Can<span class="hljs-string">&#x27;t create database &#x27;</span>db1<span class="hljs-string">&#x27;; database exists |</span><br><span class="hljs-string">+-------+------+----------------------------------------------+</span><br><span class="hljs-string">1 row in set (0.00 sec)</span><br></code></pre></td></tr></table></figure>

<h4 id="范例：指定字符集创建数据库"><a href="#范例：指定字符集创建数据库" class="headerlink" title="范例：指定字符集创建数据库"></a>范例：指定字符集创建数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#指定字符集</span><br>[root@localhost (none)]&gt; create database IF NOT EXISTS db2 CHARACTER SET <span class="hljs-string">&#x27;utf8&#x27;</span>;<br>Query OK, 1 row affected, 1 warning (0.00 sec)<br><br><span class="hljs-comment">#简写</span><br>create database db2 charset=utf8;<br><br><span class="hljs-comment">#指定字符集和排序规则（utf8_bin为区分大小写）</span><br>[root@localhost (none)]&gt; create database zabbix character <span class="hljs-built_in">set</span> utf8 collate utf8_bin;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-修改数据库"><a href="#3-2-修改数据库" class="headerlink" title="3.2 修改数据库"></a>3.2 修改数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ALTER DATABASE DB_NAME character <span class="hljs-built_in">set</span> utf8;<br></code></pre></td></tr></table></figure>

<p>范例：使用方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#改变数据库的字符集和排序规则</span><br>[root@localhost (none)]&gt;  ALTER DATABASE db1 character <span class="hljs-built_in">set</span> utf8 COLLATE utf8_bin;<br>Query OK, 1 row affected, 2 warnings (0.00 sec)<br></code></pre></td></tr></table></figure>

<h3 id="3-3-删除数据库"><a href="#3-3-删除数据库" class="headerlink" title="3.3 删除数据库"></a>3.3 删除数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">DROP DATABASE|SCHEMA [IF EXISTS] <span class="hljs-string">&#x27;DB_NAME&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>范例：使用方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost (none)]&gt; drop database db1;<br>Query OK, 0 rows affected (0.00 sec)<br><br>[root@rocky01 ~]<span class="hljs-comment"># ls -l /var/lib/mysql |grep ^d</span><br>drwxr-x--- 2 mysql mysql      187 Oct 24 00:29 <span class="hljs-comment">#innodb_temp</span><br>drwxr-x--- 2 mysql mysql      143 Oct 23 15:38 mysql<br>drwxr-x--- 2 mysql mysql     8192 Oct 23 15:38 performance_schema<br>drwxr-x--- 2 mysql mysql       28 Oct 23 15:38 sys<br></code></pre></td></tr></table></figure>

<h3 id="3-4-查看数据库列表"><a href="#3-4-查看数据库列表" class="headerlink" title="3.4 查看数据库列表"></a>3.4 查看数据库列表</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW DATABASES;<br></code></pre></td></tr></table></figure>

<p> 范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost (none)]&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>+--------------------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="4-数据类型"><a href="#4-数据类型" class="headerlink" title="4 数据类型"></a>4 数据类型</h2><blockquote>
<p><strong>数据类型</strong>：</p>
<ul>
<li>数据长什么样</li>
<li>数据需要多少空间来存放</li>
</ul>
<p><strong>数据类型</strong></p>
<ul>
<li>系统内置数据类型</li>
<li>用户定义数据类型</li>
</ul>
<p><strong>MySQL****支持多种内置数据类型</strong></p>
<ul>
<li>数值类型</li>
<li>日期/时间类型</li>
<li>字符串(字符)类型</li>
</ul>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221024144010486-207436707.png"><img src="2927659-20221024144010486-207436707.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<p><strong>选择正确的数据类型对于获得高性能至关重要，三大原则：</strong></p>
<ol>
<li>更小的通常更好，尽量使用可正确存储数据的最小数据类型</li>
<li>简单就好，简单数据类型的操作通常需要更少的CPU周期</li>
<li>尽量避免NULL，包含为NULL的列，对MySQL更难优化</li>
</ol>
</blockquote>
<h3 id="4-1-整数型"><a href="#4-1-整数型" class="headerlink" title="4.1 整数型"></a>4.1 整数型</h3><blockquote>
<ul>
<li>tinyint(m) 1个字节 范围(-128~127)</li>
<li>smallint(m) 2个字节 范围(-32768~32767)</li>
<li>mediumint(m) 3个字节 范围(-8388608~8388607)</li>
<li>int(m) 4个字节 范围(-2147483648~2147483647)</li>
<li>bigint(m) 8个字节 范围(+-9.22*10的18次方)</li>
</ul>
<p><strong>上述数据类型，如果加修饰符unsigned（取消负数，全是正数）后，则最大值翻倍</strong></p>
<p><strong>如：tinyint unsigned的取值范围为(0~255)</strong></p>
<p><strong>int(m)里的m是表示SELECT查询结果集中的显示宽度</strong>，并不影响实际的取值范围，规定了MySQL的一些交互工具（例如MySQL命令行客户端）用来显示字符的个数。对于存储和计算来说，Int(1)和Int(20)是相同的</p>
<p>BOOL，BOOLEAN：布尔型，是TINYINT(1)的同义词。zero值被视为假，非zero值视为真</p>
</blockquote>
<h3 id="4-2-浮点型-float和double-，近似值"><a href="#4-2-浮点型-float和double-，近似值" class="headerlink" title="4.2 浮点型(float和double)，近似值"></a>4.2 浮点型(float和double)，近似值</h3><blockquote>
<p>float(m,d) 单精度浮点型 8位精度(4字节) m总个数，d小数位, 注意: 小数点不占用总个数</p>
<p>double(m,d) 双精度浮点型16位精度(8字节) m总个数，d小数位, 注意: 小数点不占用总个数</p>
<p>设一个字段定义为float(6,3)，如果插入一个数123.45678,实际数据库里存的是123.457，但总个数还以实际为准，即6位</p>
</blockquote>
<h3 id="4-3-定点数"><a href="#4-3-定点数" class="headerlink" title="4.3 定点数"></a>4.3 定点数</h3><h3 id="4-4-字符串-char-varchar-text"><a href="#4-4-字符串-char-varchar-text" class="headerlink" title="4.4 字符串(char,varchar,text)"></a>4.4 字符串(char,varchar,text)</h3><blockquote>
<ul>
<li>char(n) 固定长度，最多255个字符,注意不是字节</li>
<li>varchar(n) 可变长度，最多65535个字符</li>
<li>tinytext 可变长度，最多255个字符</li>
<li>text 可变长度，最多65535个字符</li>
<li>mediumtext 可变长度，最多2的24次方-1个字符</li>
<li>longtext 可变长度，最多2的32次方-1个字符</li>
<li>BINARY(M) 固定长度，可存二进制或字符，长度为0-M字节</li>
<li>VARBINARY(M) 可变长度，可存二进制或字符，允许长度为0-M字节</li>
<li>内建类型：ENUM枚举, SET集合</li>
</ul>
<p>char类型的字符串检索速度要比varchar类型的快</p>
<p>varchar查询速度快于text</p>
</blockquote>
<p><strong>char<strong><strong>和</strong></strong>varchar****的比较：</strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221024145636530-1221441424.png"><img src="2927659-20221024145636530-1221441424.png" srcset="/img/loading.gif" lazyload alt="img"></a></strong></p>
<h4 id="面试题-VARCHAR-50-能存放几个-UTF8-编码的汉字？"><a href="#面试题-VARCHAR-50-能存放几个-UTF8-编码的汉字？" class="headerlink" title="面试题: VARCHAR(50) 能存放几个 UTF8 编码的汉字？"></a>面试题: VARCHAR(50) 能存放几个 UTF8 编码的汉字？</h4><blockquote>
<p>存放的汉字个数与版本相关。</p>
<ul>
<li>mysql 4.0以下版本，varchar(50) 指的是 50 字节，如果存放 UTF8 格式编码的汉字时（每个汉字3字节），只能存放16 个。</li>
<li>mysql 5.0以上版本，varchar(50) 指的是 50 字符，无论存放的是数字、字母还是 UTF8 编码的汉字，都可以存放 50 个。</li>
</ul>
</blockquote>
<h3 id="4-5-二进制数据BLOB"><a href="#4-5-二进制数据BLOB" class="headerlink" title="4.5 二进制数据BLOB"></a>4.5 二进制数据BLOB</h3><blockquote>
<p>BLOB和text存储方式不同，TEXT以文本方式存储，英文存储区分大小写，而Blob以二进制方式存储，不分大小写</p>
<p>BLOB存储的数据只能整体读出</p>
<p>TEXT可以指定字符集，BLOB不用指定字符集</p>
</blockquote>
<h3 id="4-6-日期时间类型"><a href="#4-6-日期时间类型" class="headerlink" title="4.6 日期时间类型"></a><strong>4.6</strong> <strong>日期时间类型</strong></h3><blockquote>
<p>date 日期 ‘2008-12-2’</p>
<p>time 时间 ‘12:25:36’</p>
<p>datetime 日期时间 ‘2008-12-2 22:06:44’</p>
<p>timestamp 自动存储记录修改时间</p>
<p>YEAR(2), YEAR(4)：年份</p>
<p>timestamp 此字段里的时间数据会随其他字段修改的时候自动刷新，这个数据类型的字段可以存放这条记录最后被修改的时间</p>
</blockquote>
<h3 id="4-7-修饰符"><a href="#4-7-修饰符" class="headerlink" title="4.7 修饰符"></a>4.7 修饰符</h3><blockquote>
<p><strong>适用所有类型的修饰符：</strong></p>
<ul>
<li>NULL 数据列可包含NULL值，默认值</li>
<li>NOT NULL 数据列不允许包含NULL值，相当于网站注册表中的 * 为必填选项</li>
<li>DEFAULT 默认值</li>
<li>PRIMARY KEY 主键，所有记录中此字段的值不能重复，且不能为NULL</li>
<li>UNIQUE KEY 唯一键，所有记录中此字段的值不能重复，但可以为NULL</li>
<li>CHARACTER SET name 指定一个字符集</li>
</ul>
<p><strong>适用数值型的修饰符：</strong></p>
<ul>
<li>AUTO_INCREMENT 自动递增，适用于整数类型, 必须作用于某个 key 的字段,比如primary key</li>
<li>UNSIGNED 无符号</li>
</ul>
</blockquote>
<h2 id="5-DDL-语句"><a href="#5-DDL-语句" class="headerlink" title="5 DDL 语句"></a>5 DDL 语句</h2><h3 id="5-1-create-创建表"><a href="#5-1-create-创建表" class="headerlink" title="5.1 create 创建表"></a>5.1 create 创建表</h3><h4 id="（1）-直接创建"><a href="#（1）-直接创建" class="headerlink" title="（1） 直接创建"></a>（1） 直接创建</h4><blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE TABLE [IF NOT EXISTS] <span class="hljs-string">&#x27;tbl_name&#x27;</span> (col1 type1 修饰符, col2 type2 修饰符, ...)<br><span class="hljs-comment">#字段信息</span><br>col type1 <br>PRIMARY KEY(col1,...)<br>INDEX(col1, ...)<br>UNIQUE KEY(col1, ...)<br><span class="hljs-comment">#表选项：</span><br>ENGINE [=] engine_name<br>ROW_FORMAT [=] &#123;DEFAULT|DYNAMIC|FIXED|COMPRESSED|REDUNDANT|COMPACT&#125;<br></code></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>Storage Engine是指表类型，也即在表创建时指明其使用的存储引擎</li>
<li>同一库中不同表可以使用不同的存储引擎</li>
<li>同一个库中表建议要使用同一种存储引擎类型</li>
</ul>
</blockquote>
<h5 id="范例：用法"><a href="#范例：用法" class="headerlink" title="范例：用法"></a>范例：用法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#直接创建表</span><br>[root@localhost zabbix]&gt; create table student (<br>    -&gt; <span class="hljs-built_in">id</span> tinyint unsigned primary key auto_increment ,<br>    -&gt; name char(4) not null,<br>    -&gt; gender char(1),<br>    -&gt; age tinyint unsigned  );<br>Query OK, 0 rows affected (0.01 sec)<br></code></pre></td></tr></table></figure>

<h4 id="（2）-通过查询现存表创建"><a href="#（2）-通过查询现存表创建" class="headerlink" title="（2） 通过查询现存表创建"></a>（2） 通过查询现存表创建</h4><blockquote>
<p>新表会被直接插入查询而来的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name [(create_definition,...)] [table_options] [partition_options] select_statement<br></code></pre></td></tr></table></figure>
</blockquote>
<h5 id="范例：用法-1"><a href="#范例：用法-1" class="headerlink" title="范例：用法"></a>范例：用法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost zabbix]&gt; create table userhost select user,host from mysql.user;<br>Query OK, 4 rows affected (0.01 sec)<br>Records: 4  Duplicates: 0  Warnings: 0<br></code></pre></td></tr></table></figure>

<h4 id="（3）-通过复制现存的表的表结构创建"><a href="#（3）-通过复制现存的表的表结构创建" class="headerlink" title="（3） 通过复制现存的表的表结构创建"></a>（3） 通过复制现存的表的表结构创建</h4><blockquote>
<p>不复制数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name &#123; LIKE old_tbl_name | (LIKE old_tbl_name) &#125;<br></code></pre></td></tr></table></figure>
</blockquote>
<h5 id="范例：用法-2"><a href="#范例：用法-2" class="headerlink" title="范例：用法"></a>范例：用法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost zabbix]&gt; create table user like student;<br>Query OK, 0 rows affected (0.01 sec)<br></code></pre></td></tr></table></figure>

<h3 id="5-2-show-表查看"><a href="#5-2-show-表查看" class="headerlink" title="5.2 show 表查看"></a>5.2 show 表查看</h3><h4 id="查看表"><a href="#查看表" class="headerlink" title="查看表"></a>查看表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW TABLES [FROM db_name]<br></code></pre></td></tr></table></figure>

<h4 id="查看表创建命令"><a href="#查看表创建命令" class="headerlink" title="查看表创建命令"></a>查看表创建命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW CREATE TABLE tbl_name<br></code></pre></td></tr></table></figure>

<h4 id="查看表结构"><a href="#查看表结构" class="headerlink" title="查看表结构"></a>查看表结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#常用</span><br>DESC [db_name.]tb_name<br><br><span class="hljs-comment">#比较少用</span><br>SHOW COLUMNS FROM [db_name.]tb_name<br></code></pre></td></tr></table></figure>

<h4 id="查看表状态"><a href="#查看表状态" class="headerlink" title="查看表状态"></a>查看表状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#显示指定表的状态</span><br>SHOW TABLE STATUS LIKE <span class="hljs-string">&#x27;tbl_name&#x27;</span>\G<br><br><span class="hljs-comment">#查看库中所有表状态</span><br>SHOW TABLE STATUS FROM db_name<br></code></pre></td></tr></table></figure>

<h4 id="查看支持的engine类型"><a href="#查看支持的engine类型" class="headerlink" title="查看支持的engine类型"></a>查看支持的engine类型</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW ENGINES;<br></code></pre></td></tr></table></figure>

<h5 id="范例：用法-3"><a href="#范例：用法-3" class="headerlink" title="范例：用法"></a>范例：用法</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看表创建命令</span><br>[root@localhost zabbix]&gt; show create table student;<br>+---------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+<br>| Table   | Create Table                                         |<br>+---------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+<br>| student | CREATE TABLE `student` (<br>  `<span class="hljs-built_in">id</span>` tinyint unsigned NOT NULL AUTO_INCREMENT,<br>  `name` char(4) NOT NULL,<br>  `gender` char(1) DEFAULT NULL,<br>  `age` tinyint unsigned DEFAULT NULL,<br>  PRIMARY KEY (`<span class="hljs-built_in">id</span>`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci |<br>+---------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#查看表结构</span><br>[root@localhost zabbix]&gt; desc student;<br>+--------+------------------+------+-----+---------+----------------+<br>| Field  | Type             | Null | Key | Default | Extra          |<br>+--------+------------------+------+-----+---------+----------------+<br>| <span class="hljs-built_in">id</span>     | tinyint unsigned | NO   | PRI | NULL    | auto_increment |<br>| name   | char(4)          | NO   |     | NULL    |                |<br>| gender | char(1)          | YES  |     | NULL    |                |<br>| age    | tinyint unsigned | YES  |     | NULL    |                |<br>+--------+------------------+------+-----+---------+----------------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#显示表的信息</span><br>[root@localhost zabbix]&gt; select * from student;<br>Empty <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#查看表状态</span><br>[root@localhost zabbix]&gt; SHOW TABLE STATUS LIKE <span class="hljs-string">&#x27;student&#x27;</span>\G<br>*************************** 1. row ***************************<br>           Name: student<br>         Engine: InnoDB<br>        Version: 10<br>     Row_format: Dynamic<br>           Rows: 0<br> Avg_row_length: 0<br>    Data_length: 16384<br>Max_data_length: 0<br>   Index_length: 0<br>      Data_free: 0<br> Auto_increment: 1<br>    Create_time: 2022-10-24 19:30:14<br>    Update_time: NULL<br>     Check_time: NULL<br>      Collation: utf8mb4_0900_ai_ci<br>       Checksum: NULL<br> Create_options:<br>        Comment:<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h3 id="5-3-修改和删除表"><a href="#5-3-修改和删除表" class="headerlink" title="5.3 修改和删除表"></a>5.3 修改和删除表</h3><h4 id="alter-修改表"><a href="#alter-修改表" class="headerlink" title="alter 修改表"></a>alter 修改表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">ALTER TABLE <span class="hljs-string">&#x27;tbl_name&#x27;</span><br><span class="hljs-comment">#字段：</span><br><span class="hljs-comment">#添加字段：add</span><br>ADD col1 data_type [FIRST|AFTER col_name] <br><span class="hljs-comment">#删除字段：drop</span><br><span class="hljs-comment">#修改字段：</span><br>alter（默认值）, change（字段名）, modify（字段属性）<br></code></pre></td></tr></table></figure>

<h4 id="drop-删除表"><a href="#drop-删除表" class="headerlink" title="drop 删除表"></a>drop 删除表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">DROP TABLE [IF EXISTS] <span class="hljs-string">&#x27;tbl_name&#x27;</span>;<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="6-DML-语句"><a href="#6-DML-语句" class="headerlink" title="6 DML 语句"></a>6 DML 语句</h2><p>DML: INSERT, DELETE, UPDATE</p>
<h3 id="6-1-INSERT-语句"><a href="#6-1-INSERT-语句" class="headerlink" title="6.1 INSERT 语句"></a>6.1 INSERT 语句</h3><blockquote>
<p>功能：一次插入一行或多行数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#方法一</span><br>INSERT [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [IGNORE]<br>    [INTO] tbl_name [(col_name,...)]<br>    &#123;VALUES | VALUE&#125; (&#123;<span class="hljs-built_in">expr</span> | DEFAULT&#125;,...),(...),...<br>    [ ON DUPLICATE KEY UPDATE <span class="hljs-comment">#如果重复更新之</span><br>     col_name=<span class="hljs-built_in">expr</span><br>        [, col_name=<span class="hljs-built_in">expr</span>] ... ]<br><br><span class="hljs-comment">#方法二</span><br>INSERT [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [IGNORE]<br>    [INTO] tbl_name<br>    SET col_name=&#123;<span class="hljs-built_in">expr</span> | DEFAULT&#125;, ...<br>    [ ON DUPLICATE KEY UPDATE<br>     col_name=<span class="hljs-built_in">expr</span><br>        [, col_name=<span class="hljs-built_in">expr</span>] ... ]<br><br><span class="hljs-comment">#方法三</span><br>INSERT [LOW_PRIORITY | HIGH_PRIORITY] [IGNORE]<br>    [INTO] tbl_name [(col_name,...)]<br>    SELECT ...<br>    [ ON DUPLICATE KEY UPDATE<br>     col_name=<span class="hljs-built_in">expr</span><br>        [, col_name=<span class="hljs-built_in">expr</span>] ... ]<br></code></pre></td></tr></table></figure>

<p>简化写法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">INSERT tbl_name [(col1,...)] VALUES (val1,...), (val21,...)<br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="范例：用法-4"><a href="#范例：用法-4" class="headerlink" title="范例：用法"></a>范例：用法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注：以下命令的into都可省略</span><br><span class="hljs-comment">#方法一：插入一条</span><br>[root@localhost zabbix]&gt; insert into student (<span class="hljs-built_in">id</span>,name,gender,age) values(1,<span class="hljs-string">&#x27;Rye&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>,20);<br>Query OK, 1 row affected (0.00 sec)<br><br><span class="hljs-comment">#方法一：全部字段都需要赋值时可省略不写</span><br>[root@localhost zabbix]&gt; insert student values(1,<span class="hljs-string">&#x27;Rye&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>,20);<br>Query OK, 1 row affected (0.00 sec)<br><br><span class="hljs-comment">#方法一：插入多条</span><br>[root@localhost zabbix]&gt; insert into student (name,gender,age) values(<span class="hljs-string">&#x27;Rye2&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>,21),(<span class="hljs-string">&#x27;Rye3&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>,22);<br>Query OK, 2 rows affected (0.00 sec)<br>Records: 2  Duplicates: 0  Warnings: 0<br><br><span class="hljs-comment">#方法二：插入一条</span><br>[root@localhost zabbix]&gt; insert into student <span class="hljs-built_in">set</span> name=<span class="hljs-string">&#x27;Rye4&#x27;</span>,gender=<span class="hljs-string">&#x27;F&#x27;</span>;<br>Query OK, 1 row affected (0.00 sec)<br><br><span class="hljs-comment">#方法三：复制表数据，前提表结构一致</span><br>[root@localhost zabbix]&gt; insert user select * from student;<br>Query OK, 4 rows affected (0.01 sec)<br>Records: 4  Duplicates: 0  Warnings: 0<br><br><span class="hljs-comment">#综上，查看</span><br>[root@localhost zabbix]&gt; select * from student;<br>+----+------+--------+------+<br>| <span class="hljs-built_in">id</span> | name | gender | age  |<br>+----+------+--------+------+<br>|  1 | Rye  | M      |   20 |<br>|  2 | Rye2 | M      |   21 |<br>|  3 | Rye3 | M      |   22 |<br>|  4 | Rye4 | F      | NULL |<br>+----+------+--------+------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h3 id="6-2-UPDATE-语句"><a href="#6-2-UPDATE-语句" class="headerlink" title="6.2 UPDATE 语句"></a>6.2 UPDATE 语句</h3><blockquote>
<p>语法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">UPDATE [LOW_PRIORITY] [IGNORE] table_reference<br>    SET col_name1=&#123;expr1|DEFAULT&#125; [, col_name2=&#123;expr2|DEFAULT&#125;] ...<br>    [WHERE where_condition]<br>    [ORDER BY ...]<br>    [LIMIT row_count]<br></code></pre></td></tr></table></figure>

<p><strong>注意：一定要有限制条件，否则将修改所有行的指定字段</strong></p>
</blockquote>
<h4 id="范例：用法-5"><a href="#范例：用法-5" class="headerlink" title="范例：用法"></a>范例：用法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#用法</span><br>[root@localhost zabbix]&gt; update student <span class="hljs-built_in">set</span> age=23 <span class="hljs-built_in">where</span> <span class="hljs-built_in">id</span>=4;<br>Query OK, 1 row affected (0.00 sec)<br>Rows matched: 1  Changed: 1  Warnings: 0<br><br><span class="hljs-comment">#查看</span><br>[root@localhost zabbix]&gt; select * from student;<br>+----+------+--------+------+<br>| <span class="hljs-built_in">id</span> | name | gender | age  |<br>+----+------+--------+------+<br>|  1 | Rye  | M      |   20 |<br>|  2 | Rye2 | M      |   21 |<br>|  3 | Rye3 | M      |   22 |<br>|  4 | Rye4 | M      |   23 |<br>+----+------+--------+------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h3 id="6-3-DELETE-语句"><a href="#6-3-DELETE-语句" class="headerlink" title="6.3 DELETE 语句"></a>6.3 DELETE 语句</h3><blockquote>
<p>删除表中数据，但不会自动缩减数据文件的大小。</p>
<p>语法:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">DELETE [LOW_PRIORITY] [QUICK] [IGNORE] FROM tbl_name<br>    [WHERE where_condition]<br>    [ORDER BY ...]<br>    [LIMIT row_count]<br><span class="hljs-comment">#可先排序再指定删除的行数</span><br></code></pre></td></tr></table></figure>

<p><strong>注意：一定要有限制条件，否则将清空表中的所有数据</strong></p>
<p>可利用mysql 选项避免此错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#方法一</span><br><span class="hljs-comment">#登陆时加如下参数（选一个即可）</span><br>mysql -U <br>mysql --safe-updates<br>mysql --i-am-a-dummy<br><br><span class="hljs-comment">#方法二</span><br>[root@rocky01 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysql]<br>safe-updates<br></code></pre></td></tr></table></figure>
</blockquote>
<p>如果想清空表，保留表结构，也可以使用下面语句，此语句会自动缩减数据文件的大小。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">TRUNCATE TABLE tbl_name;<br></code></pre></td></tr></table></figure>

<p><strong>缩减表大小</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">OPTIMIZE TABLE tb_name<br></code></pre></td></tr></table></figure>

<h4 id="范例：用法-6"><a href="#范例：用法-6" class="headerlink" title="范例：用法"></a>范例：用法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#用法</span><br>[root@localhost zabbix]&gt; delete from student <span class="hljs-built_in">where</span> age&gt;=21;<br>Query OK, 0 rows affected (0.00 sec)<br><br><span class="hljs-comment">#查看</span><br>[root@localhost zabbix]&gt; select * from student;<br>+----+------+--------+------+<br>| <span class="hljs-built_in">id</span> | name | gender | age  |<br>+----+------+--------+------+<br>|  1 | Rye  | M      |   20 |<br>+----+------+--------+------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="7-DQL-语句（select）"><a href="#7-DQL-语句（select）" class="headerlink" title="7 DQL 语句（select）"></a>7 DQL 语句（select）</h2><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221024235653104-2038438940.png"><img src="2927659-20221024235653104-2038438940.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h3 id="7-1-单表操作"><a href="#7-1-单表操作" class="headerlink" title="7.1 单表操作"></a>7.1 单表操作</h3><blockquote>
<p>语法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">SELECT<br> [ALL | DISTINCT | DISTINCTROW ]<br> [SQL_CACHE | SQL_NO_CACHE]<br> select_expr [, select_expr ...]<br>    [FROM table_references<br>    [WHERE where_condition]<br>    [GROUP BY &#123;col_name | <span class="hljs-built_in">expr</span> | position&#125;<br>      [ASC | DESC], ... [WITH ROLLUP]]<br>    [HAVING where_condition]<br>    [ORDER BY &#123;col_name | <span class="hljs-built_in">expr</span> | position&#125;<br>      [ASC | DESC], ...]<br>    [LIMIT &#123;[offset,] row_count | row_count OFFSET offset&#125;]<br>    [FOR UPDATE | LOCK IN SHARE MODE]<br></code></pre></td></tr></table></figure>

<p><strong>说明：</strong></p>
<ul>
<li><p>字段显示可以使用别名：</p>
</li>
<li><ul>
<li>col1 AS alias1, col2 AS alias2, …</li>
</ul>
</li>
<li><p><strong>WHERE子句</strong>：指明过滤条件以实现”选择”的功能：</p>
</li>
<li><ul>
<li>过滤条件：布尔型表达式</li>
<li>算术操作符：+, -, *, /, %</li>
<li>比较操作符：=,&lt;=&gt;（相等或都为空）, &lt;&gt;, !=(非标准SQL), &gt;, &gt;=, &lt;, &lt;=</li>
<li>范例查询: BETWEEN min_num AND max_num</li>
<li>不连续的查询: IN (element1, element2, …)</li>
<li>空查询: IS NULL, IS NOT NULL</li>
<li>DISTINCT 去除重复行，范例：SELECT DISTINCT gender FROM students;</li>
<li>模糊查询: LIKE 使用 % 表示任意长度的任意字符 _ 表示任意单个字符</li>
<li>RLIKE：正则表达式，索引失效，不建议使用</li>
<li>REGEXP：匹配字符串可用正则表达式书写模式，同上</li>
<li>逻辑操作符：NOT，AND，OR，XOR</li>
</ul>
</li>
<li><p><strong>GROUP BY：根据指定的条件把查询结果进行”分组”以用于做”聚合”运算</strong></p>
</li>
<li><ul>
<li><strong>常见聚合函数： count(), sum(), max(), min(), avg(),注意:聚合函数不对null统计</strong></li>
<li><strong>HAVING: 对分组聚合运算后的结果指定过滤条件</strong></li>
<li><strong>一旦分组 group by ，select语句后只跟分组的字段，聚合函数</strong></li>
</ul>
</li>
<li><p><strong>ORDER BY: 根据指定的字段对查询结果进行排序</strong></p>
</li>
<li><ul>
<li><strong>升序：ASC</strong></li>
<li><strong>降序：DESC</strong></li>
</ul>
</li>
<li><p><strong>LIMIT</strong> [[offset,]row_count]：对查询的结果进行输出行数数量限制,跳过offset,显示row_count行,offset默为值为0</p>
</li>
<li><p>对查询结果中的数据请求施加”锁”</p>
</li>
<li><ul>
<li>FOR UPDATE: 写锁，独占或排它锁，只有一个读和写操作</li>
<li>LOCK IN SHARE MODE: 读锁，共享锁，同时多个读操作</li>
</ul>
</li>
</ul>
</blockquote>
<h4 id="范例：字段别名"><a href="#范例：字段别名" class="headerlink" title="范例：字段别名"></a>范例：字段别名</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">MariaDB [hellodb]&gt; select stuid 学员ID,name as 姓名,gender 性别 from students;<br>+----------+---------------+--------+<br>| 学员ID   | 姓名          | 性别   |<br>+----------+---------------+--------+<br>|        1 | Shi Zhongyu   | M      |<br>|        2 | Shi Potian    | M      |<br>|        3 | Xie Yanke     | M      |<br>|        4 | Ding Dian     | M      |<br>|        5 | Yu Yutong     | M      |<br></code></pre></td></tr></table></figure>

<h4 id="范例：判断是否为NULL"><a href="#范例：判断是否为NULL" class="headerlink" title="范例：判断是否为NULL"></a>范例：判断是否为NULL</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">MariaDB [hellodb]&gt; select * from students <span class="hljs-built_in">where</span> classid is null;<br>+-------+-------------+-----+--------+---------+-----------+<br>| StuID | Name        | Age | Gender | ClassID | TeacherID |<br>+-------+-------------+-----+--------+---------+-----------+<br>|    24 | Xu Xian     |  27 | M      |    NULL |      NULL |<br>|    25 | Sun Dasheng | 100 | M      |    NULL |      NULL |<br>+-------+-------------+-----+--------+---------+-----------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.002 sec)<br><br><br>MariaDB [hellodb]&gt; select * from students <span class="hljs-built_in">where</span> classid is not null;<br></code></pre></td></tr></table></figure>

<h4 id="范例：去重"><a href="#范例：去重" class="headerlink" title="范例：去重"></a>范例：去重</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">MariaDB [hellodb]&gt; select distinct gender from students ;<br>+--------+<br>| gender |<br>+--------+<br>| M      |<br>| F      |<br>+--------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.001 sec)<br><br><span class="hljs-comment">#将age和gender多个字段重复的记录去重</span><br>MariaDB [hellodb]&gt; select distinct age,gender from students;<br></code></pre></td></tr></table></figure>

<h4 id="范例：SQL-注入攻击"><a href="#范例：SQL-注入攻击" class="headerlink" title="范例：SQL 注入攻击"></a>范例：SQL 注入攻击</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">select * from user <span class="hljs-built_in">where</span> name=<span class="hljs-string">&#x27;admin&#x27;</span> and password=<span class="hljs-string">&#x27;&#x27;</span> or <span class="hljs-string">&#x27;1&#x27;</span>=<span class="hljs-string">&#x27;1&#x27;</span>;<br>select * from user <span class="hljs-built_in">where</span> name=<span class="hljs-string">&#x27;admin&#x27;</span> and password=<span class="hljs-string">&#x27;&#x27;</span> or <span class="hljs-string">&#x27;1=1&#x27;</span>;<br>select * from user <span class="hljs-built_in">where</span> name=<span class="hljs-string">&#x27;admin&#x27;</span>; -- <span class="hljs-string">&#x27; and password=&#x27;</span>123<span class="hljs-string">&#x27;;</span><br><span class="hljs-string">select * from user where name=&#x27;</span>admin<span class="hljs-string">&#x27;; # &#x27;</span> and password=<span class="hljs-string">&#x27;123&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="范例：分页查询"><a href="#范例：分页查询" class="headerlink" title="范例：分页查询"></a>范例：分页查询</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#只取前3个</span><br>mysql&gt; select * from students <span class="hljs-built_in">limit</span> 0,3;<br>mysql&gt; select * from students <span class="hljs-built_in">limit</span> 3;<br>+-------+-------------+-----+--------+---------+-----------+<br>| StuID | Name       | Age | Gender | ClassID | TeacherID |<br>+-------+-------------+-----+--------+---------+-----------+<br>|     1 | Shi Zhongyu |  22 | M     |       2 |         3 |<br>|     2 | Shi Potian |  22 | M     |       1 |         7 |<br>|     3 | Xie Yanke   |  53 | M     |       2 |        16 |<br>+-------+-------------+-----+--------+---------+-----------+<br>3 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#跳过第一个之后，取前三个</span><br>mysql&gt; select * from students <span class="hljs-built_in">limit</span> 1,3;<br>+-------+------------+-----+--------+---------+-----------+<br>| StuID | Name       | Age | Gender | ClassID | TeacherID |<br>+-------+------------+-----+--------+---------+-----------+<br>|     2 | Shi Potian |  22 | M     |       1 |         7 |<br>|     3 | Xie Yanke |  53 | M     |       2 |        16 |<br>|     4 | Ding Dian |  32 | M     |       4 |         4 |<br>+-------+------------+-----+--------+---------+-----------+<br>3 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h4 id="范例：聚合函数"><a href="#范例：聚合函数" class="headerlink" title="范例：聚合函数"></a>范例：聚合函数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; select <span class="hljs-built_in">sum</span>(age)/count(*) from students <span class="hljs-built_in">where</span> gender =<span class="hljs-string">&#x27;M&#x27;</span>;<br>+-------------------+<br>| <span class="hljs-built_in">sum</span>(age)/count(*) |<br>+-------------------+<br>|           33.0000 |<br>+-------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h4 id="范例：分组统计"><a href="#范例：分组统计" class="headerlink" title="范例：分组统计"></a>范例：分组统计</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; select classid, count(*) 数量 from students group by classid;<br>+---------+--------+<br>| classid | 数量   |<br>+---------+--------+<br>|       2 |      3 |<br>|       1 |      4 |<br>|       4 |      4 |<br>|       3 |      4 |<br>|       5 |      1 |<br>|       7 |      3 |<br>|       6 |      4 |<br>|    NULL |      2 |<br>+---------+--------+<br>8 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#分组统计</span><br>select classid,avg(age) as 平均年龄 from students <span class="hljs-built_in">where</span> classid &gt; 3 group by classid having 平均年龄 &gt;30 ;<br>select gender,avg(age) 平均年龄 from students group by gender having gender=<span class="hljs-string">&#x27;M&#x27;</span>;<br><br><span class="hljs-comment">#多个字段分组统计</span><br>select classid,gender,count(*) 数量 from students group by classid,gender; <br>select classid,gender,count(*) 数量 from students group by gender,classid;<br></code></pre></td></tr></table></figure>

<h4 id="范例：排序"><a href="#范例：排序" class="headerlink" title="范例：排序"></a>范例：排序</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#只取前3个</span><br>mysql&gt; select * from students order by age desc <span class="hljs-built_in">limit</span> 3;<br>+-------+-------------+-----+--------+---------+-----------+<br>| StuID | Name       | Age | Gender | ClassID | TeacherID |<br>+-------+-------------+-----+--------+---------+-----------+<br>|    25 | Sun Dasheng | 100 | M     |   NULL |     NULL |<br>|     3 | Xie Yanke   |  53 | M     |      2 |       16 |<br>|     6 | Shi Qing    |  46 | M     |      5 |     NULL |<br>+-------+-------------+-----+--------+---------+-----------+<br>3 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#跳过前3个只显示后续的2个</span><br>mysql&gt; select * from students order by age desc <span class="hljs-built_in">limit</span> 3,2;<br>+-------+--------------+-----+--------+---------+-----------+<br>| StuID | Name         | Age | Gender | ClassID | TeacherID |<br>+-------+--------------+-----+--------+---------+-----------+<br>|    13 | Tian Boguang |  33 | M     |       2 |     NULL |<br>|     4 | Ding Dian    |  32 | M     |       4 |        4 |<br>+-------+--------------+-----+--------+---------+-----------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h4 id="范例：分组和排序"><a href="#范例：分组和排序" class="headerlink" title="范例：分组和排序"></a>范例：分组和排序</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; select classid,count(*) 数量  from students group by classid order by 数量<br>;<br>+---------+--------+<br>| classid | 数量   |<br>+---------+--------+<br>|       5 |      1 |<br>|    NULL |      2 |<br>|       2 |      3 |<br>|       7 |      3 |<br>|       1 |      4 |<br>|       4 |      4 |<br>|       3 |      4 |<br>|       6 |      4 |<br>+---------+--------+<br>8 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h3 id="7-2-多表查询"><a href="#7-2-多表查询" class="headerlink" title="7.2 多表查询"></a>7.2 多表查询</h3><p>多表查询，即查询结果来自于多张表</p>
<blockquote>
<ul>
<li>子查询：在SQL语句嵌套着查询语句，性能较差，基于某语句的查询结果再次进行的查询</li>
<li>联合查询：UNION</li>
<li>交叉连接：笛卡尔乘积 CROSS JOIN</li>
<li>内连接：</li>
</ul>
<p>    等值连接：让表之间的字段以”等值”建立连接关系</p>
<p>    不等值连接</p>
<p>    自然连接：去掉重复列的等值连接 , 语法: <strong>FROM</strong> table1 <strong>NATURAL JOIN</strong> table2;</p>
<ul>
<li>外连接：</li>
</ul>
<p>    左外连接：FROM tb1 LEFT JOIN tb2 ON tb1.col=tb2.col</p>
<p>    右外连接：FROM tb1 RIGHT JOIN tb2 ON tb1.col=tb2.col</p>
<p>    完全外连接: FROM tb1 FULL OUTER JOIN tb2 ON tb1.col=tb2.col 注意:MySQL 不支持此SQL语法</p>
<ul>
<li>自连接：本表和本表进行连接查询</li>
</ul>
</blockquote>
<h4 id="7-2-1-子查询"><a href="#7-2-1-子查询" class="headerlink" title="7.2.1 子查询"></a>7.2.1 子查询</h4><blockquote>
<p>select 的执行结果，被其它SQL调用</p>
</blockquote>
<p>常用范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#子查询：select 的执行结果，被其它SQL调用</span><br>SELECT Name,Age FROM students WHERE Age&gt;(SELECT avg(Age) FROM teachers);<br>update students <span class="hljs-built_in">set</span> Age=(SELECT avg(Age) FROM teachers) <span class="hljs-built_in">where</span> stuid=25;<br></code></pre></td></tr></table></figure>

<h4 id="7-2-2-联合查询"><a href="#7-2-2-联合查询" class="headerlink" title="7.2.2 联合查询"></a>7.2.2 联合查询</h4><blockquote>
<p>联合查询 Union 实现的条件,多个表的字段数量相同,字段名和数据类型可以不同,但一般数据类型是相同的</p>
</blockquote>
<p>常用范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#多表纵向合并union</span><br>SELECT Name,Age FROM students UNION SELECT Name,Age FROM teachers;<br><br><span class="hljs-comment">#UNION ALL不会去重，UNION会去重</span><br>SELECT Name,Age FROM students UNION ALL SELECT Name,Age FROM teachers;<br></code></pre></td></tr></table></figure>

<h4 id="7-2-3-交叉连接"><a href="#7-2-3-交叉连接" class="headerlink" title="7.2.3 交叉连接"></a>7.2.3 交叉连接</h4><blockquote>
<p>cross join 即多表的记录之间做笛卡尔乘积组合，并且多个表的列横向合并相加, “雨露均沾”</p>
<p>比如: 第一个表3行4列,第二个表5行6列,cross join后的结果为3*5=15行,4+6=10列</p>
<p>交叉连接生成的记录可能会非常多,建议慎用</p>
</blockquote>
<p>常用范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#横向合并，交叉连接（横向笛卡尔）</span><br><span class="hljs-comment">#方法一</span><br>MariaDB [hellodb]&gt; select * from students cross <span class="hljs-built_in">join</span> teachers;<br><br><span class="hljs-comment">#方法二</span><br>MariaDB [hellodb]&gt; select * from teachers , students;<br></code></pre></td></tr></table></figure>

<h4 id="7-2-4-内连接"><a href="#7-2-4-内连接" class="headerlink" title="7.2.4 内连接"></a>7.2.4 内连接</h4><blockquote>
<p>inner join 内连接取多个表的交集</p>
</blockquote>
<p>常用范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#内连接inner join </span><br>MariaDB [hellodb]&gt; select * from students inner <span class="hljs-built_in">join</span> teachers on students.teacherid=teachers.tid;<br></code></pre></td></tr></table></figure>

<h4 id="7-2-5-左和右外连接"><a href="#7-2-5-左和右外连接" class="headerlink" title="7.2.5 左和右外连接"></a>7.2.5 左和右外连接</h4><blockquote>
<ul>
<li>左连接: 以左表为主根据条件查询右表数据﹐如果根据条件查询右表数据不存在使用null值填充</li>
<li>右连接: 以右表为主根据条件查询左表数据﹐如果根据条件查询左表数据不存在使用null值填充</li>
</ul>
</blockquote>
<p>常用范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#左外连接，s和t是别名</span><br>MariaDB [hellodb]&gt; select s.stuid,s.name,s.age,s.teacherid,t.tid,t.name,t.age from students as s left outer <span class="hljs-built_in">join</span> teachers as t on s.teacherid=t.tid;<br><br><span class="hljs-comment">#左外连接扩展</span><br>MariaDB [hellodb]&gt; select * from students s left outer <span class="hljs-built_in">join</span> teachers t on s.teacherid=t.tid <span class="hljs-built_in">where</span> t.tid is null;<br></code></pre></td></tr></table></figure>

<h4 id="7-2-6-完全外连接"><a href="#7-2-6-完全外连接" class="headerlink" title="7.2.6 完全外连接"></a>7.2.6 完全外连接</h4><blockquote>
<p>MySQL 不支持完全外连接full outer join语法</p>
</blockquote>
<p> 常用范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#MySQL不支持完全外连接 full outer join,利用以下方式法代替</span><br>MariaDB [hellodb]&gt; select * from students left <span class="hljs-built_in">join</span> teachers on students.teacherid=teachers.tid<br>    -&gt; union<br>    -&gt; select * from students right <span class="hljs-built_in">join</span> teachers on students.teacherid=teachers.tid;<br></code></pre></td></tr></table></figure>

<h4 id="7-2-7-自连接"><a href="#7-2-7-自连接" class="headerlink" title="7.2.7 自连接"></a>7.2.7 自连接</h4><blockquote>
<p>自连接, 即表自身连接自身</p>
</blockquote>
<p> 常用范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#表</span><br>MariaDB [hellodb]&gt; select * from emp;<br>+------+----------+----------+<br>| <span class="hljs-built_in">id</span>   | name     | leaderid |<br>+------+----------+----------+<br>|    1 | mage     |     NULL |<br>|    2 | zhangsir |        1 |<br>|    3 | wang     |        2 |<br>|    4 | zhang    |        3 |<br>+------+----------+----------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#操作</span><br>MariaDB [hellodb]&gt; select e.name,l.name from emp as e inner <span class="hljs-built_in">join</span> emp as l on e.leaderid=l.id;<br>+----------+----------+<br>| name     | name     |<br>+----------+----------+<br>| zhangsir | mage     |<br>| wang     | zhangsir |<br>| zhang    | wang     |<br>+----------+----------+<br>3 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h3 id="7-3-SELECT-语句处理的顺序"><a href="#7-3-SELECT-语句处理的顺序" class="headerlink" title="7.3 SELECT 语句处理的顺序"></a>7.3 SELECT 语句处理的顺序</h3><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221025000056713-825473659.png"><img src="2927659-20221025000056713-825473659.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>SELECT语句的执行流程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM Clause --&gt; WHERE Clause --&gt; GROUP BY --&gt; HAVING Clause --&gt;SELECT --&gt; ORDER BY --&gt; LIMIT<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="8-VIEW-视图"><a href="#8-VIEW-视图" class="headerlink" title="8 VIEW 视图"></a>8 VIEW 视图</h2><blockquote>
<p>视图：虚拟表，保存有实表的查询结果，相当于别名</p>
<p>利用视图,可以隐藏表的真实结构,在程序中利用视图进行查询,可以避免表结构的变化,而修改程序,降低程序和数据库之间的耦合度</p>
</blockquote>
<h3 id="创建方法"><a href="#创建方法" class="headerlink" title="创建方法"></a>创建方法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE   VIEW view_name [(column_list)]<br>     AS select_statement<br>     [WITH [CASCADED | LOCAL] CHECK OPTION]<br></code></pre></td></tr></table></figure>

<h3 id="查看视图定义"><a href="#查看视图定义" class="headerlink" title="查看视图定义"></a>查看视图定义</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW CREATE VIEW view_name <span class="hljs-comment">#只能看视图定义</span><br>SHOW CREATE TABLE view_name <span class="hljs-comment"># 可以查看表和视图</span><br></code></pre></td></tr></table></figure>

<h3 id="删除视图"><a href="#删除视图" class="headerlink" title="删除视图"></a>删除视图</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">DROP VIEW [IF EXISTS]<br>   view_name [, view_name] ...<br>    [RESTRICT | CASCADE]<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="9-FUNCTION-函数"><a href="#9-FUNCTION-函数" class="headerlink" title="9 FUNCTION 函数"></a>9 FUNCTION 函数</h2><p>函数：分为系统内置函数和自定义函数</p>
<blockquote>
<p><strong>创建<strong><strong>UDF</strong></strong>语法</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE [AGGREGATE] FUNCTION function_name(parameter_name <span class="hljs-built_in">type</span>,[parameter_name <br><span class="hljs-built_in">type</span>,...])<br>   RETURNS &#123;STRING|INTEGER|REAL&#125;<br> runtime_body<br></code></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>参数可以有多个,也可以没有参数</li>
<li>无论有无参数，小括号（）是必须的</li>
<li>必须有且只有一个返回值</li>
</ul>
</blockquote>
<h3 id="查看函数列表"><a href="#查看函数列表" class="headerlink" title="查看函数列表"></a>查看函数列表</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW FUNCTION STATUS;<br></code></pre></td></tr></table></figure>

<h3 id="查看函数定义"><a href="#查看函数定义" class="headerlink" title="查看函数定义"></a>查看函数定义</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW CREATE FUNCTION function_name<br></code></pre></td></tr></table></figure>

<h3 id="删除UDF"><a href="#删除UDF" class="headerlink" title="删除UDF"></a>删除UDF</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">DROP FUNCTION function_name<br></code></pre></td></tr></table></figure>

<h3 id="调用自定义函数语法"><a href="#调用自定义函数语法" class="headerlink" title="调用自定义函数语法"></a>调用自定义函数语法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SELECT function_name(parameter_value,...)<br></code></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#默认MySQL8.0开启二进制日志,而不允许创建函数</span><br>mysql&gt; show variables like <span class="hljs-string">&#x27;log_bin_trust_function_creators&#x27;</span>;<br>+---------------------------------+-------+<br>| Variable_name                   | Value |<br>+---------------------------------+-------+<br>| log_bin_trust_function_creators | OFF   |<br>+---------------------------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#打开此变量允许二进制日志信息函数创建</span><br>mysql&gt; <span class="hljs-built_in">set</span> global log_bin_trust_function_creators=ON;<br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure>

<h3 id="使用范例-1"><a href="#使用范例-1" class="headerlink" title="使用范例"></a>使用范例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#无参UDF</span><br>CREATE FUNCTION simpleFun() RETURNS VARCHAR(20) RETURN <span class="hljs-string">&quot;Hello World&quot;</span>;<br><br><span class="hljs-comment">#有参数UDF</span><br>DELIMITER //<br>CREATE FUNCTION deleteById(<span class="hljs-built_in">id</span> SMALLINT UNSIGNED) RETURNS VARCHAR(20)<br>BEGIN<br>     DELETE FROM students WHERE stuid = <span class="hljs-built_in">id</span>;<br>     RETURN (SELECT COUNT(*) FROM students);<br>END//<br>DELIMITER ;<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="10-PROCEDURE-存储过程"><a href="#10-PROCEDURE-存储过程" class="headerlink" title="10 PROCEDURE 存储过程"></a>10 PROCEDURE 存储过程</h2><blockquote>
<p>存储过程：多表SQL的语句的集合，可以独立执行，存储过程保存在mysql.proc表中</p>
<p><strong>存储过程优势</strong></p>
<ul>
<li>存储过程把经常使用的SQL语句或业务逻辑封装起来,预编译保存在数据库中,当需要时从数据库中直接调</li>
<li>用,省去了编译的过程，提高了运行速度，同时降低网络数据传输量</li>
</ul>
<p><strong>存储过程与自定义函数的区别</strong></p>
<ul>
<li>存储过程实现的过程要复杂一些,而函数的针对性较强</li>
<li>存储过程可以有多个返回值,而自定义函数只有一个返回值</li>
<li>存储过程一般可独立执行,而函数往往是作为其他SQL语句的一部分来使用</li>
<li>无参数的存储过程执行过程中可以不加(),函数必须加 ( )</li>
</ul>
</blockquote>
<h3 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE PROCEDURE sp_name ([ proc_parameter [,proc_parameter ...]])<br>routime_body <br>proc_parameter : [IN|OUT|INOUT] parameter_name <span class="hljs-built_in">type</span><br><br>说明：其中IN表示输入参数，OUT表示输出参数，INOUT表示既可以输入也可以输出；<br>param_name表示参数名称；<span class="hljs-built_in">type</span>表示参数的类型<br></code></pre></td></tr></table></figure>

<h3 id="查看存储过程列表"><a href="#查看存储过程列表" class="headerlink" title="查看存储过程列表"></a>查看存储过程列表</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW PROCEDURE  STATUS;<br></code></pre></td></tr></table></figure>

<h3 id="调用存储过程"><a href="#调用存储过程" class="headerlink" title="调用存储过程"></a>调用存储过程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">CALL sp_name ([ proc_parameter [,proc_parameter ...]])<br></code></pre></td></tr></table></figure>

<h3 id="删除存储过程"><a href="#删除存储过程" class="headerlink" title="删除存储过程"></a>删除存储过程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">DROP PROCEDURE [IF EXISTS] sp_name<br></code></pre></td></tr></table></figure>

<h3 id="使用范例-2"><a href="#使用范例-2" class="headerlink" title="使用范例"></a>使用范例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">delimiter //<br>CREATE PROCEDURE dorepeat(n INT)<br>BEGIN<br>    SET @i = 0;<br>    SET @<span class="hljs-built_in">sum</span> = 0;<br>    REPEAT SET @<span class="hljs-built_in">sum</span> = @<span class="hljs-built_in">sum</span>+@i; <br>    SET @i = @i + 1;<br>    UNTIL @i &gt; n END REPEAT;<br>END//<br>delimiter ;<br>CALL dorepeat(100);<br>SELECT @<span class="hljs-built_in">sum</span>;<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="11-TRIGGER-触发器"><a href="#11-TRIGGER-触发器" class="headerlink" title="11 TRIGGER 触发器"></a>11 TRIGGER 触发器</h2><blockquote>
<p>触发器的执行不是由程序调用，也不是由手工启动，而是由事件来触发、激活从而实现执行</p>
</blockquote>
<h3 id="使用范例-3"><a href="#使用范例-3" class="headerlink" title="使用范例"></a>使用范例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建触发器，在向学生表INSERT数据时，学生数增加，DELETE学生时，学生数减少</span><br>CREATE TABLE student_info (<br>    stu_id INT(11) NOT NULL AUTO_INCREMENT ,<br>    stu_name VARCHAR(255) DEFAULT NULL,<br>    PRIMARY KEY (stu_id)<br>);<br>CREATE TABLE student_count (<br>     student_count  INT(11) DEFAULT 0<br>);<br>INSERT INTO student_count VALUES(0);<br><br>CREATE TRIGGER trigger_student_count_insert<br>AFTER INSERT<br>ON student_info FOR EACH ROW<br>UPDATE student_count SET student_count=student_count+1;<br><br>CREATE TRIGGER trigger_student_count_delete<br>AFTER DELETE<br>ON student_info FOR EACH ROW<br>UPDATE student_count SET student_count=student_count-1;<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="12-Event-事件"><a href="#12-Event-事件" class="headerlink" title="12 Event 事件"></a>12 Event 事件</h2><blockquote>
<p>事件（event）是MySQL在相应的时刻调用的过程式数据库对象。一个事件可调用一次，也可周期性的启动，它由一个特定的线程来管理的，也就是所谓的”事件调度器”。</p>
<p>事件和触发器类似，都是在某些事情发生的时候启动。当数据库上启动一条语句的时候，触发器就启动了，而事件是根据调度事件来启动的。由于它们彼此相似，所以事件也称为临时性触发器。</p>
<p>事件取代了原先只能由操作系统的计划任务来执行的工作，而且MySQL的事件调度器可以精确到每秒钟执行一个任务，而操作系统的计划任务（如：Linux下的CRON或Windows下的任务计划）只能精确到每分钟执行一次。</p>
<p><strong>事件的优缺点</strong></p>
<p>优点：一些对数据定时性操作不再依赖外部程序，而直接使用数据库本身提供的功能，可以实现每秒钟执行一个任务，这在一些对实时性要求较高的环境下就非常实用</p>
<p>缺点：定时触发，不可以直接调用</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#默认事件调度功能是关闭的,MySQL8.0默认是开启的</span><br>[root@localhost (none)]&gt; select @@event_scheduler;<br>+-------------------+<br>| @@event_scheduler |<br>+-------------------+<br>| ON                |<br>+-------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="13-MySQL-用户管理"><a href="#13-MySQL-用户管理" class="headerlink" title="13 MySQL 用户管理"></a>13 MySQL 用户管理</h2><h3 id="相关数据库和表"><a href="#相关数据库和表" class="headerlink" title="相关数据库和表"></a>相关数据库和表</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">元数据数据库：mysql<br>系统授权表：db, host, user,columns_priv, tables_priv, procs_priv, proxies_priv<br></code></pre></td></tr></table></figure>

<h3 id="用户帐号"><a href="#用户帐号" class="headerlink" title="用户帐号"></a>用户帐号</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&#x27;USERNAME&#x27;</span>@<span class="hljs-string">&#x27;HOST&#x27;</span><br>@<span class="hljs-string">&#x27;HOST&#x27;</span>: 主机名： user1@<span class="hljs-string">&#x27;web1.magedu.org&#x27;</span><br>IP地址或Network <br> 通配符： %   _<br> 示例：wang@<span class="hljs-string">&#x27;172.16.%.%&#x27;</span>  <br>     user2@<span class="hljs-string">&#x27;192.168.1.%&#x27;</span><br>     mage@<span class="hljs-string">&#x27;10.0.0.0/255.255.0.0&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE USER <span class="hljs-string">&#x27;USERNAME&#x27;</span>@<span class="hljs-string">&#x27;HOST&#x27;</span> [IDENTIFIED BY <span class="hljs-string">&#x27;password&#x27;</span>]；<br><span class="hljs-comment">#示例:</span><br>create user test2@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by 123456;<br>create user <span class="hljs-built_in">test</span>@<span class="hljs-string">&#x27;10.0.0.0/255.255.255.0&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h3 id="用户重命名"><a href="#用户重命名" class="headerlink" title="用户重命名"></a>用户重命名</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">RENAME USER old_user_name TO new_user_name;<br></code></pre></td></tr></table></figure>

<h3 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">DROP USER <span class="hljs-string">&#x27;USERNAME&#x27;</span>@<span class="hljs-string">&#x27;HOST&#x27;</span><br></code></pre></td></tr></table></figure>

<h4 id="范例：删除默认的空用户"><a href="#范例：删除默认的空用户" class="headerlink" title="范例：删除默认的空用户"></a>范例：删除默认的空用户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">DROP USER <span class="hljs-string">&#x27;&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="范例：MySQL5-7和8-0-破解root密码"><a href="#范例：MySQL5-7和8-0-破解root密码" class="headerlink" title="范例：MySQL5.7和8.0 破解root密码"></a>范例：MySQL5.7和8.0 破解root密码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#方法1、2实现前提步骤</span><br>[root@centos8 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>skip-grant-tables  <br>skip-networking  <span class="hljs-comment">#MySQL8.0不需要</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl restart mysqld</span><br><br><span class="hljs-comment">#方法1</span><br>mysql&gt; update mysql.user <span class="hljs-built_in">set</span> authentication_string=<span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-built_in">where</span> user=<span class="hljs-string">&#x27;root&#x27;</span> and host=<span class="hljs-string">&#x27;localhost&#x27;</span>; <br><br><span class="hljs-comment">#方法2</span><br>mysql&gt; flush privileges;<br><span class="hljs-comment">#再执行下面任意一个命令</span><br>mysql&gt; alter user root@<span class="hljs-string">&#x27;localhost&#x27;</span> identified by <span class="hljs-string">&#x27;ubuntu&#x27;</span>;<br>mysql&gt; <span class="hljs-built_in">set</span> password <span class="hljs-keyword">for</span> root@<span class="hljs-string">&#x27;localhost&#x27;</span>=<span class="hljs-string">&#x27;ubuntu&#x27;</span>;<br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/my.cnf</span><br>[mysqld]<br><span class="hljs-comment">#skip-grant-tables                                                               </span><br><span class="hljs-comment">#skip-networking</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl restart mysqld</span><br>[root@centos8 ~]<span class="hljs-comment"># mysql -uroot -pubuntu</span><br></code></pre></td></tr></table></figure>

<h4 id="范例：删库跑路之清空root密码方法"><a href="#范例：删库跑路之清空root密码方法" class="headerlink" title="范例：删库跑路之清空root密码方法"></a>范例：删库跑路之清空root密码方法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#此方法适用于包安装方式的MySQL或Mariadb</span><br>[root@centos8 ~]<span class="hljs-comment">#systemctl stop mysqld</span><br>[root@centos8 ~]<span class="hljs-comment">#rm -rf /var/lib/mysql/*</span><br>[root@centos8 ~]<span class="hljs-comment">#systemctl start mysqld</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="14-权限管理和DCL语句"><a href="#14-权限管理和DCL语句" class="headerlink" title="14 权限管理和DCL语句"></a>14 权限管理和DCL语句</h2><h3 id="GRANT-授权"><a href="#GRANT-授权" class="headerlink" title="GRANT 授权"></a>GRANT 授权</h3><blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">GRANT priv_type [(column_list)],... ON [object_type] priv_level TO <span class="hljs-string">&#x27;user&#x27;</span>@<span class="hljs-string">&#x27;host&#x27;</span> <br>[IDENTIFIED BY <span class="hljs-string">&#x27;password&#x27;</span>] [WITH GRANT OPTION];<br>priv_type: ALL [PRIVILEGES]<br>object_type:TABLE | FUNCTION | PROCEDURE<br>priv_level:  *(所有库)  |*.*   | db_name.*  | db_name.tbl_name  | tbl_name(当前库的<br>表)  | db_name.routine_name(指定库的函数,存储过程,触发器)<br>with_option: GRANT OPTION<br>  | MAX_QUERIES_PER_HOUR count<br>  | MAX_UPDATES_PER_HOUR count<br>  | MAX_CONNECTIONS_PER_HOUR count<br>  | MAX_USER_CONNECTIONS count<br></code></pre></td></tr></table></figure>
</blockquote>
<p><strong>使用范例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">GRANT ALL ON wordpress.* TO wordpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> ;<br><br>GRANT SELECT (col1), INSERT (col1,col2) ON mydb.mytbl TO <span class="hljs-string">&#x27;someuser&#x27;</span>@<span class="hljs-string">&#x27;somehost&#x27;</span>;<br><br>GRANT ALL PRIVILEGES ON *.* TO <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>  WITH GRANT OPTION;<br><br><span class="hljs-comment">#创建用户和授权同时执行的方式在MySQL8.0取消了</span><br>GRANT ALL ON wordpress.* TO wordpress@<span class="hljs-string">&#x27;192.168.8.%&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;123456&#x27;</span>;<br>GRANT ALL PRIVILEGES ON *.* TO <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;192.168.8.%&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;123456&#x27;</span> WITH GRANT OPTION;<br></code></pre></td></tr></table></figure>

<h3 id="REVOKE-取消权限"><a href="#REVOKE-取消权限" class="headerlink" title="REVOKE 取消权限"></a>REVOKE 取消权限</h3><blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">REVOKE priv_type [(column_list)] [, priv_type [(column_list)]] ... ON [object_type] priv_level FROM user [, user] ...<br></code></pre></td></tr></table></figure>
</blockquote>
<p><strong>使用范例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">REVOKE DELETE ON *.* FROM <span class="hljs-string">&#x27;testuser&#x27;</span>@<span class="hljs-string">&#x27;172.16.0.%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h3 id="查看指定用户获得的授权"><a href="#查看指定用户获得的授权" class="headerlink" title="查看指定用户获得的授权"></a>查看指定用户获得的授权</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">Help SHOW GRANTS<br>SHOW GRANTS FOR <span class="hljs-string">&#x27;user&#x27;</span>@<span class="hljs-string">&#x27;host&#x27;</span>; <br>SHOW GRANTS FOR CURRENT_USER[()];<br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：</p>
<p>MariaDB服务进程启动时会读取mysql库中所有授权表至内存</p>
<p>(1) GRANT或REVOKE等执行权限操作会保存于系统表中，MariaDB的服务进程通常会自动重读授权表，使之生效</p>
<p>(2) 对于不能够或不能及时重读授权表的命令，可手动让MariaDB的服务进程重读授权表：</p>
<p>mysql&gt; FLUSH PRIVILEGES;</p>
</blockquote>
<h1 id="-2"><a href="#-2" class="headerlink" title=""></a></h1><hr>
<h1 id="四、MySQL-架构和性能优化"><a href="#四、MySQL-架构和性能优化" class="headerlink" title="四、MySQL 架构和性能优化"></a>四、MySQL 架构和性能优化</h1><h2 id="1-存储引擎"><a href="#1-存储引擎" class="headerlink" title="1 存储引擎"></a>1 存储引擎</h2><blockquote>
<p>MySQL中的数据用各种不同的技术存储在文件（或者内存）中。这些技术中的每一种技术都使用不同的存储机制、索引技巧、锁定水平并且最终提供广泛的不同的功能和能力,此种技术称为存储擎,MySQL 支持多种存储引擎其中目前应用最广泛的是<strong>InnoDB和MyISAM两种</strong></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221027151700903-1871285651.png"><img src="2927659-20221027151700903-1871285651.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h3 id="1-1-MyISAM-存储引擎"><a href="#1-1-MyISAM-存储引擎" class="headerlink" title="1.1 MyISAM 存储引擎"></a>1.1 MyISAM 存储引擎</h3><blockquote>
<p><strong>MyISAM 引擎特点</strong></p>
<ul>
<li><strong>不支持事务</strong></li>
<li><strong>表级锁定</strong></li>
<li><strong>读写相互阻塞，写入不能读，读时不能写</strong></li>
<li><strong>只缓存索引</strong></li>
<li><strong>不支持外键约束</strong></li>
<li><strong>不支持聚簇索引</strong></li>
<li><strong>读取数据较快，占用资源较少</strong></li>
<li><strong>不支持MVCC（多版本并发控制机制）高并发</strong></li>
<li><strong>崩溃恢复性较差</strong></li>
<li><strong>MySQL5.5.5 前默认的数据库引擎</strong></li>
</ul>
<p><strong>MyISAM</strong> <strong>存储引擎适用场景</strong></p>
<ul>
<li>只读（或者写较少）</li>
<li>表较小（可以接受长时间进行修复操作）</li>
</ul>
<p><strong>MyISAM 引擎文件</strong></p>
<ul>
<li><strong>tbl_name.frm 表格式定义</strong></li>
<li><strong>tbl_name.MYD 数据文件</strong></li>
<li><strong>tbl_name.MYI 索引文件</strong></li>
</ul>
</blockquote>
<h3 id="1-2-InnoDB-引擎"><a href="#1-2-InnoDB-引擎" class="headerlink" title="1.2 InnoDB 引擎"></a>1.2 InnoDB 引擎</h3><blockquote>
<p><strong>InnoDB引擎特点</strong></p>
<ul>
<li><strong>行级锁</strong></li>
<li><strong>支持事务，适合处理大量短期事务</strong></li>
<li><strong>读写阻塞与事务隔离级别相关</strong></li>
<li><strong>可缓存数据和索引</strong></li>
<li><strong>支持聚簇索引</strong></li>
<li><strong>崩溃恢复性更好</strong></li>
<li><strong>支持MVCC高并发</strong></li>
<li><strong>从MySQL5.5后支持全文索引</strong></li>
<li><strong>从MySQL5.5.5开始为默认的数据库引擎</strong></li>
</ul>
<p><strong>InnoDB****数据库文件</strong></p>
<ul>
<li>所有InnoDB表的数据和索引放置于同一个表空间中</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">数据文件：ibdata1, ibdata2,存放在datadir定义的目录下<br>表格式定义：tb_name.frm,存放在datadir定义的每个数据库对应的目录下<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>每个表单独使用一个表空间存储表的数据和索引</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">两类文件放在对应每个数据库独立目录中<br>数据文件(存储数据和索引)：tb_name.ibd <br>表格式定义：tb_name.frm<br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="1-3-管理存储引擎"><a href="#1-3-管理存储引擎" class="headerlink" title="1.3 管理存储引擎"></a>1.3 管理存储引擎</h3><h4 id="查看mysql支持的存储引擎"><a href="#查看mysql支持的存储引擎" class="headerlink" title="查看mysql支持的存储引擎"></a>查看mysql支持的存储引擎</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">show engines;<br></code></pre></td></tr></table></figure>

<h4 id="查看当前默认的存储引擎"><a href="#查看当前默认的存储引擎" class="headerlink" title="查看当前默认的存储引擎"></a>查看当前默认的存储引擎</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">show variables like <span class="hljs-string">&#x27;%storage_engine%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="设置默认的存储引擎"><a href="#设置默认的存储引擎" class="headerlink" title="设置默认的存储引擎"></a>设置默认的存储引擎</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/my.cnf<br>[mysqld]<br>default_storage_engine= InnoDB<br></code></pre></td></tr></table></figure>

<h4 id="查看库中所有表使用的存储引擎"><a href="#查看库中所有表使用的存储引擎" class="headerlink" title="查看库中所有表使用的存储引擎"></a>查看库中所有表使用的存储引擎</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">show table status from db_name;<br></code></pre></td></tr></table></figure>

<h4 id="查看库中指定表的存储引擎"><a href="#查看库中指定表的存储引擎" class="headerlink" title="查看库中指定表的存储引擎"></a>查看库中指定表的存储引擎</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">show table status like  <span class="hljs-string">&#x27;tb_name&#x27;</span>;<br>show create table tb_name;<br></code></pre></td></tr></table></figure>

<h4 id="设置表的存储引擎"><a href="#设置表的存储引擎" class="headerlink" title="设置表的存储引擎"></a>设置表的存储引擎</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE TABLE tb_name(... ) ENGINE=InnoDB;<br>ALTER TABLE tb_name ENGINE=InnoDB;<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="2-MySQL-中的系统数据库"><a href="#2-MySQL-中的系统数据库" class="headerlink" title="2 MySQL 中的系统数据库"></a>2 MySQL 中的系统数据库</h2><blockquote>
<ul>
<li><strong>mysql</strong> <strong>数据库</strong></li>
</ul>
<p>    是mysql的核心数据库，类似于Sql Server中的master库，主要负责存储数据库的用户、权限设置、关键字等mysql自己需要使用的控制和管理信息</p>
<ul>
<li><strong>information_schema</strong> <strong>数据库</strong></li>
</ul>
<p>    MySQL 5.0之后产生的，一个虚拟数据库，物理上并不存在information_schema数据库类似与”数据字典”，提供了访问数据库元数据的方式，即数据的数据。比如数据库名或表名，列类型，访问权限（更加细化的访问方式）</p>
<ul>
<li><strong>performance_schema</strong> <strong>数据库</strong></li>
</ul>
<p>    MySQL 5.5开始新增的数据库，主要用于收集数据库服务器性能参数,库里表的存储引擎均为PERFORMANCE_SCHEMA，用户不能创建存储引擎为PERFORMANCE_SCHEMA的表</p>
<ul>
<li><strong>sys</strong> <strong>数据库</strong></li>
</ul>
<p>    MySQL5.7之后新增加的数据库，库中所有数据源来自performance_schema。目标是把performance_schema的把复杂度降低，让DBA能更好的阅读这个库里的内容。让DBA更快的了解DataBase的运行情况</p>
</blockquote>
<hr>
<h2 id="3-服务器配置和状态"><a href="#3-服务器配置和状态" class="headerlink" title="3 服务器配置和状态"></a>3 服务器配置和状态</h2><blockquote>
<p>可以通过mysqld选项，服务器系统变量和服务器状态变量进行MySQL的配置和查看状态</p>
<p><strong>注意</strong>：</p>
<ul>
<li>其中有些参数支持运行时修改，会立即生效</li>
<li>有些参数不支持动态修改，且只能通过修改配置文件，并重启服务器程序生效</li>
<li>有些参数作用域是全局的，为所有会话设置</li>
<li>有些可以为每个用户提供单独（会话）的设置</li>
</ul>
</blockquote>
<h3 id="3-1-服务器选项"><a href="#3-1-服务器选项" class="headerlink" title="3.1 服务器选项"></a>3.1 服务器选项</h3><blockquote>
<p><strong>注意</strong><strong>:</strong> <strong>服务器选项用横线</strong>**,**<strong>不用下划线</strong></p>
</blockquote>
<h4 id="获取mysqld的可用选项列表"><a href="#获取mysqld的可用选项列表" class="headerlink" title="获取mysqld的可用选项列表"></a>获取mysqld的可用选项列表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看mysqld可用选项列表和及当前值</span><br>mysqld --verbose --<span class="hljs-built_in">help</span><br><br><span class="hljs-comment">#获取mysqld当前启动选项</span><br>mysqld --print-defaults<br><br><span class="hljs-comment">#查看可用选项列表和当前值</span><br>[root@centos8 ~]<span class="hljs-comment">#/usr/libexec/mysqld --verbose --help</span><br><br><span class="hljs-comment">#查看mysqld的当前启动选项</span><br>[root@centos8 ~]<span class="hljs-comment">#/usr/libexec/mysqld --print-defaults</span><br>/usr/libexec/mysqld would have been started with the following arguments:<br>--plugin-load-add=auth_gssapi.so --datadir=/var/lib/mysql --<br>socket=/var/lib/mysql/mysql.sock --log-error=/var/log/mariadb/mariadb.log --pidfile=/run/mariadb/mariadb.pid<br></code></pre></td></tr></table></figure>

<h4 id="设置服务器选项方法"><a href="#设置服务器选项方法" class="headerlink" title="设置服务器选项方法"></a>设置服务器选项方法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#1.在命令行中设置</span><br>shell&gt; /usr/bin/mysqld_safe --skip-name-resolve=1<br>shell&gt; /usr/libexec/mysqld --basedir=/usr<br><br><span class="hljs-comment">#2.在配置文件my.cnf中设置</span><br>vim /etc/my.cnf<br>[mysqld]<br>skip_name_resolve=1<br>skip-grant-tables<br></code></pre></td></tr></table></figure>

<h3 id="3-2-服务器系统变量"><a href="#3-2-服务器系统变量" class="headerlink" title="3.2 服务器系统变量"></a>3.2 服务器系统变量</h3><blockquote>
<p>服务器系统变量：可以分全局和会话两种</p>
<p><strong>注意</strong><strong>:</strong> <strong>系统变量用下划线</strong>**,**<strong>不用横线</strong></p>
</blockquote>
<h4 id="获取系统变量"><a href="#获取系统变量" class="headerlink" title="获取系统变量"></a>获取系统变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#只查看global变量</span><br>SHOW GLOBAL VARIABLES; <br><span class="hljs-comment">#查看所有变量(包括global和session)</span><br>SHOW [SESSION] VARIABLES;<br><br><span class="hljs-comment">#查看指定的系统变量</span><br>SHOW VARIABLES LIKE <span class="hljs-string">&#x27;VAR_NAME&#x27;</span>;<br>SELECT @@VAR_NAME;<br><br><span class="hljs-comment">#查看选项和部分变量</span><br>[root@centos8 ~]<span class="hljs-comment">#mysqladmin variables</span><br></code></pre></td></tr></table></figure>

<h4 id="修改变量的值"><a href="#修改变量的值" class="headerlink" title="修改变量的值"></a>修改变量的值</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#修改服务器变量的值</span><br><span class="hljs-built_in">help</span> SET<br><br><span class="hljs-comment">#修改全局变量：仅对修改后新创建的会话有效；对已经建立的会话无效</span><br>SET GLOBAL system_var_name=value;<br>SET @@global.system_var_name=value;<br><br><span class="hljs-comment">#修改会话变量</span><br>SET [SESSION] system_var_name=value;<br>SET @@[session.]system_var_name=value;<br></code></pre></td></tr></table></figure>

<h3 id="3-3-服务器状态变量"><a href="#3-3-服务器状态变量" class="headerlink" title="3.3 服务器状态变量"></a>3.3 服务器状态变量</h3><blockquote>
<p>服务器状态变量：分全局和会话两种</p>
<p>状态变量（只读）：用于保存mysqld运行中的统计数据的变量，不可更改</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW GLOBAL STATUS;<br>SHOW [SESSION] STATUS;<br><br><span class="hljs-comment">#范例</span><br>MariaDB [hellodb]&gt; SHOW GLOBAL STATUS like <span class="hljs-string">&#x27;com_select&#x27;</span>;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| Com_select    | 5     |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.001 sec)<br></code></pre></td></tr></table></figure>

<h3 id="3-4-服务器变量-SQL-MODE"><a href="#3-4-服务器变量-SQL-MODE" class="headerlink" title="3.4 服务器变量 SQL_MODE"></a>3.4 服务器变量 SQL_MODE</h3><blockquote>
<p>SQL_MODE：对其设置可以完成一些约束检查的工作,可分别进行全局的设置或当前会话的设置</p>
<p><strong>常见****MODE:</strong></p>
<ul>
<li>NO_AUTO_CREATE_USER： 禁止GRANT创建密码为空的用户</li>
<li>NO_ZERO_DATE：在严格模式，不允许使用’0000-00-00’的时间</li>
<li>ONLY_FULL_GROUP_BY： 对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么将认为这个SQL是不合法的</li>
<li>NO_BACKSLASH_ESCAPES： 反斜杠”&quot;作为普通字符而非转义字符</li>
<li>PIPES_AS_CONCAT： 将”||”视为连接操作符而非”或”运算符</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost (none)]&gt; show variables like <span class="hljs-string">&#x27;sql_mode&#x27;</span>;<br>+---------------+-----------------------------------------------------------------------------------------------------------------------+<br>| Variable_name | Value  |<br>+---------------+-----------------------------------------------------------------------------------------------------------------------+<br>| sql_mode      | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION |<br>+---------------+-----------------------------------------------------------------------------------------------------------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="4-INDEX-索引"><a href="#4-INDEX-索引" class="headerlink" title="4 INDEX 索引"></a>4 INDEX 索引</h2><h3 id="4-1-索引介绍"><a href="#4-1-索引介绍" class="headerlink" title="4.1 索引介绍"></a>4.1 索引介绍</h3><blockquote>
<p>索引：是排序的快速查找的特殊数据结构，定义作为查找条件的字段上，又称为键key，索引通过存储引擎实现</p>
<p><strong>优点：</strong></p>
<ul>
<li>索引可以降低服务需要扫描的数据量，减少了IO次数</li>
<li>索引可以帮助服务器避免排序和使用临时表</li>
<li>索引可以帮助将随机I/O转为顺序 I/O</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>占用额外空间，影响插入速度</li>
</ul>
<p><strong>索引类型：</strong></p>
<ul>
<li>B+ TREE、HASH、R TREE、FULL TEXT</li>
<li>聚簇（集）索引、非聚簇索引：数据和索引是否存储在一起</li>
<li>主键索引、二级（辅助）索引</li>
<li>稠密索引、稀疏索引：是否索引了每一个数据项</li>
<li>简单索引、组合索引: 是否是多个字段的索引</li>
<li>左前缀索引：取前面的字符做索引</li>
<li>覆盖索引：从索引中即可取出要查询的数据，性能高</li>
</ul>
</blockquote>
<h3 id="4-2-索引结构"><a href="#4-2-索引结构" class="headerlink" title="4.2 索引结构"></a>4.2 索引结构</h3><h4 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h4><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221028155910039-1167769648.png"><img src="2927659-20221028155910039-1167769648.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h4 id="红黑树"><a href="#红黑树" class="headerlink" title="红黑树"></a>红黑树</h4><blockquote>
<ul>
<li>根节点是黑色的, 叶节点是不存储数据的黑色空节点,图中叶节点为正方形的黑色节点</li>
<li>任何相邻的两个节点不能同时为红色,红色节点被黑色节点隔开,红色节点的子节点是黑色的</li>
<li>任意节点到其可到达的叶节点间包含相同数量的黑色节点,保证任何路径相差不会超出2倍,从而实现基本平衡</li>
</ul>
</blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221028155943963-1488506353.png"><img src="2927659-20221028155943963-1488506353.png" srcset="/img/loading.gif" lazyload alt="img"></a></strong></p>
<h4 id="B-Tree索引"><a href="#B-Tree索引" class="headerlink" title="B-Tree索引"></a>B-Tree索引</h4><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221029141333403-1330195887.png"><img src="2927659-20221029141333403-1330195887.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h4 id="B-Tree索引-1"><a href="#B-Tree索引-1" class="headerlink" title="B+Tree索引"></a>B+Tree索引</h4><blockquote>
<p>B+Tree索引：按顺序存储，每一个叶子节点到根结点的距离是相同的；左前缀索引，适合查询范围类的数据</p>
<p><strong>可以使用<strong><strong>B+Tree</strong></strong>索引的查询类型：</strong>(假设前提: 姓,名,年龄三个字段建立了一个复合索引)</p>
<ul>
<li>全值匹配：精确所有索引列，如：姓wang，名xiaochun，年龄30</li>
<li>匹配最左前缀：即只使用索引的第一列，如：姓wang</li>
<li>匹配列前缀：只匹配一列值开头部分，如：姓以w开头的记录</li>
<li>匹配范围值：如：姓ma和姓wang之间</li>
<li>精确匹配某一列并范围匹配另一列：如：姓wang,名以x开头的记录</li>
<li>只访问索引的查询</li>
</ul>
<p><strong>B+Tree****索引的限制：</strong></p>
<ul>
<li>如不从最左列开始，则无法使用索引，如：查找名为xiaochun，或姓为g结尾</li>
<li>不能跳过索引中的列：如：查找姓wang，年龄30的，只能使用索引第一列</li>
</ul>
<p><strong>特别提示：</strong></p>
<ul>
<li>索引列的顺序和查询语句的写法应相匹配，才能更好的利用索引</li>
<li>为优化性能，可能需要针对相同的列但顺序不同创建不同的索引来满足不同类型的查询需求</li>
</ul>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221029141835265-924928128.png"><img src="2927659-20221029141835265-924928128.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h5 id="面试题-InnoDB中一颗的B-树可以存放多少行数据"><a href="#面试题-InnoDB中一颗的B-树可以存放多少行数据" class="headerlink" title="面试题: InnoDB中一颗的B+树可以存放多少行数据"></a>面试题: InnoDB中一颗的B+树可以存放多少行数据</h5><blockquote>
<p>假设定义一颗B+树高度为2，即一个根节点和若干叶子节点。那么这棵B+树的存放总行记录数=根节点指针数<em>单个叶子记录的行数。这里先计算叶子节点，B+树中的单个叶子节点的大小为16K，假设每一条目为1K，那么记录数即为16(16k/1K=16)，然后计算非叶子节点能够存放多少个指针，假设主键ID为bigint类型，那么长度为8字节，而指针大小在InnoDB中是设置为6个字节，这样加起来一共是14个字节。那么通过页大小/(主键ID大小+指针大小），即16384/14=1170个指针，所以一颗高度为2的B+树能存放16</em>1170=18720条这样的记录。根据这个原理就可以算出一颗高度为3的B+树可以存放16<em>1170</em>1170=21902400条记录。所以在InnoDB中B+树高度一般为2-3层，它就能满足千万级的数据存储</p>
</blockquote>
<h3 id="4-3-索引优化"><a href="#4-3-索引优化" class="headerlink" title="4.3 索引优化"></a>4.3 索引优化</h3><blockquote>
<ul>
<li>独立地使用列：尽量避免其参与运算，独立的列指索引列不能是表达式的一部分，也不能是函数的参数，在where条件中，始终将索引列单独放在比较符号的一侧，尽量不要在列上进行运算（函数操作和表达式操作）</li>
<li>左前缀索引：构建指定索引字段的左侧的字符数，要通过索引选择性（不重复的索引值和数据表的记录总数的比值）来评估，尽量使用短索引，如果可以，应该制定一个前缀长度</li>
<li>多列索引：AND操作时更适合使用多列索引，而非为每个列创建单独的索引</li>
<li>选择合适的索引列顺序：无排序和分组时，将选择性最高放左侧</li>
<li>只要列中含有NULL值，就最好不要在此列设置索引，复合索引如果有NULL值，此列在使用时也不会使用索引</li>
<li>对于经常在where子句使用的列，最好设置索引</li>
<li>对于有多个列where或者order by子句，应该建立复合索引</li>
<li>对于like语句，以 % 或者 _ 开头的不会使用索引，以 % 结尾会使用索引</li>
<li>尽量不要使用not in和&lt;&gt;操作,虽然可能使用索引,但性能不高</li>
<li>不要使用RLIKE正则表达式会导致索引失效</li>
<li>查询时，能不要<em>就不用</em>，尽量写全字段名，比如:select id,name,age from students;</li>
<li>大部分情况连接效率远大于子查询</li>
<li>在有大量记录的表分页时使用limit</li>
<li>对于经常使用的查询，可以开启查询缓存</li>
<li>多使用explain和profile分析查询语句</li>
<li>查看慢查询日志，找出执行时间长的sql语句优化</li>
</ul>
</blockquote>
<h3 id="4-4-管理索引"><a href="#4-4-管理索引" class="headerlink" title="4.4 管理索引"></a>4.4 管理索引</h3><h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE [UNIQUE] INDEX index_name ON tbl_name (index_col_name[(length)],...);<br>ALTER TABLE tbl_name ADD INDEX index_name(index_col_name[(length)]);<br><span class="hljs-built_in">help</span> CREATE INDEX;<br></code></pre></td></tr></table></figure>

<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">DROP INDEX index_name ON tbl_name;<br>ALTER TABLE tbl_name DROP INDEX index_name(index_col_name);<br></code></pre></td></tr></table></figure>

<h4 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW INDEX FROM [db_name.]tbl_name;<br></code></pre></td></tr></table></figure>

<h4 id="优化表空间"><a href="#优化表空间" class="headerlink" title="优化表空间"></a>优化表空间</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">OPTIMIZE TABLE tb_name;<br></code></pre></td></tr></table></figure>

<h4 id="查看索引的使用"><a href="#查看索引的使用" class="headerlink" title="查看索引的使用"></a>查看索引的使用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">SET GLOBAL userstat=1;  <span class="hljs-comment">#MySQL无此变量</span><br>SHOW INDEX_STATISTICS;<br></code></pre></td></tr></table></figure>

<h5 id="范例：创建索引和使用索引"><a href="#范例：创建索引和使用索引" class="headerlink" title="范例：创建索引和使用索引"></a>范例：创建索引和使用索引</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">MariaDB [hellodb]&gt; create index idx_name on students(name(10));<br>Query OK, 0 rows affected (0.009 sec)<br>Records: 0 Duplicates: 0  Warnings: 0<br>MariaDB [hellodb]&gt; show indexes from students\G<br>*************************** 1. row ***************************<br>        Table: students<br>   Non_unique: 0<br>     Key_name: PRIMARY<br> Seq_in_index: 1<br> Column_name: StuID<br>    Collation: A<br> Cardinality: 25<br>     Sub_part: NULL<br>       Packed: NULL<br>         Null: <br>   Index_type: BTREE<br>      Comment: <br>Index_comment: <br>*************************** 2. row ***************************<br>        Table: students<br>   Non_unique: 1<br>     Key_name: idx_name<br> Seq_in_index: 1<br> Column_name: Name<br>    Collation: A<br> Cardinality: 25<br>     Sub_part: 10<br>       Packed: NULL<br>         Null: <br>   Index_type: BTREE<br>      Comment: <br>Index_comment: <br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.000 sec)<br></code></pre></td></tr></table></figure>

<h3 id="4-5-EXPLAIN-工具"><a href="#4-5-EXPLAIN-工具" class="headerlink" title="4.5 EXPLAIN 工具"></a>4.5 EXPLAIN 工具</h3><blockquote>
<p>可以通过EXPLAIN来分析索引的有效性,获取查询执行计划信息，用来查看查询优化器如何执行查询</p>
<p>语法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">EXPLAIN SELECT clause<br></code></pre></td></tr></table></figure>

<p>说明： type显示的是访问类型，是较为重要的一个指标，结果值从好到坏依次是：NULL&gt; system &gt;const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt;range &gt; index &gt; ALL ，<strong>一般来说，得保证查询至少达到range级别（未达到建议优化，比如加索引）</strong>，最好能达到ref</p>
</blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221029153718663-1729899877.png"><img src="2927659-20221029153718663-1729899877.png" srcset="/img/loading.gif" lazyload alt="img"></a></strong></p>
<p><strong>使用范例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">MariaDB [hellodb]&gt; explain select * from students <span class="hljs-built_in">where</span> stuid not <span class="hljs-keyword">in</span> (5,10,20);<br>+------+-------------+----------+------+---------------+------+---------+------+-<br>-----+-------------+<br>| <span class="hljs-built_in">id</span>   | select_type | table    | <span class="hljs-built_in">type</span> | possible_keys | key  | key_len | ref  |<br>rows | Extra       |<br>+------+-------------+----------+------+---------------+------+---------+------+-<br>-----+-------------+<br>|    1 | SIMPLE      | students | ALL  | PRIMARY       | NULL | NULL    | NULL |<br>  25 | Using <span class="hljs-built_in">where</span> |<br>+------+-------------+----------+------+---------------+------+---------+------+-<br>-----+-------------+<br></code></pre></td></tr></table></figure>

<h3 id="4-6-使用-profile-工具"><a href="#4-6-使用-profile-工具" class="headerlink" title="4.6 使用 profile 工具"></a>4.6 使用 profile 工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#打开后，会显示语句执行详细的过程</span><br><span class="hljs-built_in">set</span> profiling = ON;<br><br><span class="hljs-comment">#查看语句,注意结果中的query_id值</span><br><span class="hljs-comment">#show profiles ; </span><br>MariaDB [hellodb]&gt; show profiles ;<br>+----------+------------+-------------------------------------+<br>| Query_ID | Duration   | Query                               |<br>+----------+------------+-------------------------------------+<br>|        1 | 0.00019238 | select  @@profiling                 |<br>|        2 | 0.00115590 | select * from students <span class="hljs-built_in">where</span> age=20 |<br>|        3 | 0.00006616 | show profiles <span class="hljs-keyword">for</span> query 2           |<br>|        4 | 4.00319568 | select <span class="hljs-built_in">sleep</span>(1) from teachers       |<br>+----------+------------+-------------------------------------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.000 sec)<br><br><span class="hljs-comment">#显示语句的详细执行步骤和时长</span><br><span class="hljs-comment">#Show profile for query #</span><br>MariaDB [hellodb]&gt; show profile <span class="hljs-keyword">for</span> query 4;<br><br><span class="hljs-comment">#显示cpu使用情况</span><br><span class="hljs-comment">#Show profile cpu for query # </span><br>MariaDB [hellodb]&gt; Show profile cpu <span class="hljs-keyword">for</span> query 4;<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="5-并发控制"><a href="#5-并发控制" class="headerlink" title="5 并发控制"></a>5 并发控制</h2><h3 id="5-1-锁机制"><a href="#5-1-锁机制" class="headerlink" title="5.1 锁机制"></a>5.1 锁机制</h3><blockquote>
<p><strong>锁类型：</strong></p>
<ul>
<li>读锁：共享锁，也称为 S 锁,只读不可写（包括当前事务） ，多个读互不阻塞</li>
<li>写锁：独占锁，排它锁，也称为 X 锁,写锁会阻塞其它事务（不包括当前事务）的读和写</li>
<li>S 锁和 S 锁是<strong>兼容</strong>的，X 锁和其它锁都<strong>不兼容</strong>，举个例子，事务 T1 获取了一个行 r1 的 S 锁，另外事务 T2 可以立即获得行 r1 的 S 锁，此时 T1 和 T2 共同获得行 r1 的 S 锁，此种情况称为<strong>锁兼容</strong>，但是另外一个事务 T2 此时如果想获得行 r1 的 X 锁，则必须等待 T1 对行 r1 锁的释放，此种情况也称为<strong>锁冲突</strong></li>
</ul>
<p><strong>锁粒度：</strong></p>
<ul>
<li>表级锁：MyISAM</li>
<li>行级锁：InnoDB</li>
</ul>
</blockquote>
<h3 id="5-2-显式使用锁"><a href="#5-2-显式使用锁" class="headerlink" title="5.2 显式使用锁"></a>5.2 显式使用锁</h3><h4 id="加锁"><a href="#加锁" class="headerlink" title="加锁"></a>加锁</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">LOCK TABLES tbl_name [[AS] <span class="hljs-built_in">alias</span>] lock_type  [, tbl_name [[AS] <span class="hljs-built_in">alias</span>]lock_type] ...<br><br><span class="hljs-comment">#lock_type: </span><br>READ   <span class="hljs-comment">#读锁</span><br>WRITE  <span class="hljs-comment">#写锁</span><br></code></pre></td></tr></table></figure>

<h4 id="解锁"><a href="#解锁" class="headerlink" title="解锁"></a>解锁</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">UNLOCK TABLES<br></code></pre></td></tr></table></figure>

<h5 id="范例-加读锁"><a href="#范例-加读锁" class="headerlink" title="范例: 加读锁"></a>范例: 加读锁</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; lock tables students <span class="hljs-built_in">read</span> ;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; update students <span class="hljs-built_in">set</span> classid=2 <span class="hljs-built_in">where</span> stuid=24;<br>ERROR 1099 (HY000): Table <span class="hljs-string">&#x27;students&#x27;</span> was locked with a READ lock and can<span class="hljs-string">&#x27;t be updated</span><br><span class="hljs-string"></span><br><span class="hljs-string">mysql&gt; unlock tables ;</span><br><span class="hljs-string"></span><br><span class="hljs-string">mysql&gt; update students set classid=2 where stuid=24;</span><br><span class="hljs-string">Query OK, 1 row affected (1 min 45.52 sec)</span><br><span class="hljs-string">Rows matched: 1 Changed: 1 Warnings: 0</span><br></code></pre></td></tr></table></figure>

<h5 id="范例-同时在两个终端对同一行记录修改"><a href="#范例-同时在两个终端对同一行记录修改" class="headerlink" title="范例: 同时在两个终端对同一行记录修改"></a>范例: 同时在两个终端对同一行记录修改</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#同时对同一行记录执行update</span><br><span class="hljs-comment">#在第一终端提示1行成功</span><br>MariaDB [hellodb]&gt; update students <span class="hljs-built_in">set</span> classid=1 <span class="hljs-built_in">where</span> stuid=24;<br>Query OK, 1 row affected (0.002 sec)<br>Rows matched: 1 Changed: 1 Warnings: 0<br><br><span class="hljs-comment">#在第二终端提示0行修改</span><br>MariaDB [hellodb]&gt; update students <span class="hljs-built_in">set</span> classid=1 <span class="hljs-built_in">where</span> stuid=24;<br>Query OK, 0 rows affected (0.000 sec)<br>Rows matched: 1 Changed: 0 Warnings: 0<br></code></pre></td></tr></table></figure>

<h3 id="5-3-事务"><a href="#5-3-事务" class="headerlink" title="5.3 事务"></a>5.3 事务</h3><blockquote>
<p>事务 Transactions：一组原子性的 SQL语句，或一个独立工作单元</p>
<p>事务日志：记录事务信息，实现undo,redo等故障恢复功能</p>
</blockquote>
<h4 id="5-3-1-事务特性"><a href="#5-3-1-事务特性" class="headerlink" title="5.3.1 事务特性"></a>5.3.1 事务特性</h4><blockquote>
<p><strong>ACID****特性：</strong></p>
<ul>
<li><strong>A：atomicity 原子性；整个事务中的所有操作要么全部成功执行，要么全部失败后回滚</strong></li>
<li><strong>C：consistency 一致性；数据库总是从一个一致性状态转换为另一个一致性状态</strong></li>
<li><strong>I：Isolation 隔离性；一个事务所做出的操作在提交之前，是不能为其它事务所见；隔离有多种隔离级别，实现并发</strong></li>
<li><strong>D：durability 持久性；一旦事务提交，其所做的修改会永久保存于数据库中</strong></li>
</ul>
</blockquote>
<h4 id="5-3-2-管理事务"><a href="#5-3-2-管理事务" class="headerlink" title="5.3.2 管理事务"></a>5.3.2 管理事务</h4><h5 id="显式启动事务"><a href="#显式启动事务" class="headerlink" title="显式启动事务"></a>显式启动事务</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">BEGIN<br>BEGIN WORK<br>START TRANSACTION<br></code></pre></td></tr></table></figure>

<h5 id="提交-结束事务"><a href="#提交-结束事务" class="headerlink" title="提交\结束事务"></a>提交\结束事务</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#提交,相当于vi中的wq保存退出</span><br>COMMIT<br><br><span class="hljs-comment">#回滚,相当于vi中的q!不保存退出</span><br>ROLLBACK<br></code></pre></td></tr></table></figure>

<h5 id="自动提交"><a href="#自动提交" class="headerlink" title="自动提交"></a>自动提交</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> autocommit=&#123;1|0&#125;<br><br>默认为1，为0时设为非自动提交<br>建议：显式请求和提交事务，而不要使用<span class="hljs-string">&quot;自动提交&quot;</span>功能<br></code></pre></td></tr></table></figure>

<h5 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h5><blockquote>
<p>两个或多个事务在同一资源相互占用，并请求锁定对方占用的资源的状态</p>
</blockquote>
<h6 id="范例：找到未完成的导致阻塞的事务-支持Mariadb"><a href="#范例：找到未完成的导致阻塞的事务-支持Mariadb" class="headerlink" title="范例：找到未完成的导致阻塞的事务(支持Mariadb)"></a>范例：找到未完成的导致阻塞的事务(支持Mariadb)</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在第一会话中执行</span><br>MariaDB [hellodb]&gt; begin;<br>Query OK, 0 rows affected (0.000 sec)<br>MariaDB [hellodb]&gt; update students <span class="hljs-built_in">set</span> classid=10;<br><span class="hljs-comment">#在第二个会话中执行</span><br>MariaDB [hellodb]&gt; update students <span class="hljs-built_in">set</span> classid=20;<br><span class="hljs-comment">#在第三个会话中执行</span><br>MariaDB [hellodb]&gt; show engine innodb status;<br>...省略...<br>---TRANSACTION 120, ACTIVE 673 sec<br>2 lock struct(s), heap size 1136, 28 row lock(s), undo <span class="hljs-built_in">log</span> entries 27<br>MySQL thread <span class="hljs-built_in">id</span> 13, OS thread handle 139719808595712, query <span class="hljs-built_in">id</span> 206 localhost <br>root <br>...省略...<br><span class="hljs-comment">#此指令不支持MySQL8.0</span><br>MariaDB [hellodb]&gt; SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;<br>+-----------+-------------+-----------+-----------+----------------------+-------<br>-----+------------+-----------+----------+-----------+<br>| lock_id   | lock_trx_id | lock_mode | lock_type | lock_table           |<br>lock_index | lock_space | lock_page | lock_rec | lock_data |<br>+-----------+-------------+-----------+-----------+----------------------+-------<br>-----+------------+-----------+----------+-----------+<br>| 123:9:3:2 | 123         | X         | RECORD    | `hellodb`.`students` |<br>PRIMARY    |          9 |         3 |        2 | 1         |<br>| 120:9:3:2 | 120         | X         | RECORD    | `hellodb`.`students` |<br>PRIMARY    |          9 |         3 |        2 | 1         |<br>+-----------+-------------+-----------+-----------+----------------------+-------<br>-----+------------+-----------+----------+-----------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.001 sec)<br><span class="hljs-comment">#此指令不支持MySQL8.0</span><br>MariaDB [hellodb]&gt; SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;<br>+-------------------+-------------------+-----------------+------------------+<br>| requesting_trx_id | requested_lock_id | blocking_trx_id | blocking_lock_id |<br>+-------------------+-------------------+-----------------+------------------+<br>| 123               | 123:9:3:2         | 120             | 120:9:3:2        |<br>+-------------------+-------------------+-----------------+------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.000 sec)<br><span class="hljs-comment">#查看正在进行的事务</span><br>MariaDB [hellodb]&gt; SELECT * FROM information_schema.INNODB_TRX\G<br>*************************** 1. row ***************************<br>                   trx_id: 123<br>                 trx_state: LOCK WAIT<br>               trx_started: 2019-11-22 19:17:06<br>     trx_requested_lock_id: 123:9:3:2<br>         trx_wait_started: 2019-11-22 19:18:50<br>               trx_weight: 2<br>       trx_mysql_thread_id: 15 <span class="hljs-comment">#线程ID</span><br>                 trx_query: update students <span class="hljs-built_in">set</span> classid=20<br>       trx_operation_state: starting index <span class="hljs-built_in">read</span><br>         trx_tables_in_use: 1<br>         trx_tables_locked: 1<br>         trx_lock_structs: 2<br>     trx_lock_memory_bytes: 1136<br>           trx_rows_locked: 2<br>         trx_rows_modified: 0<br>   trx_concurrency_tickets: 0<br>       trx_isolation_level: REPEATABLE READ<br>         trx_unique_checks: 1<br>   trx_foreign_key_checks: 1<br>trx_last_foreign_key_error: NULL<br>         trx_is_read_only: 0<br>trx_autocommit_non_locking: 0<br>*************************** 2. row ***************************<br>                   trx_id: 120<br>                 trx_state: RUNNING<br>               trx_started: 2019-11-22 19:08:51<br>     trx_requested_lock_id: NULL<br>         trx_wait_started: NULL<br>               trx_weight: 29<br>       trx_mysql_thread_id: 13                                    <span class="hljs-comment">#线程ID</span><br>                 trx_query: NULL<br>       trx_operation_state: NULL<br>         trx_tables_in_use: 0<br>         trx_tables_locked: 1<br>         trx_lock_structs: 2<br>     trx_lock_memory_bytes: 1136<br>           trx_rows_locked: 28<br>         trx_rows_modified: 27<br>   trx_concurrency_tickets: 0<br>       trx_isolation_level: REPEATABLE READ<br>         trx_unique_checks: 1<br>   trx_foreign_key_checks: 1<br>trx_last_foreign_key_error: NULL<br>         trx_is_read_only: 0<br>trx_autocommit_non_locking: 0<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.000 sec)<br>MariaDB [hellodb]&gt; show processlist;<br>+----+-------------+-----------+---------+---------+------+----------------------<br>----+------------------+----------+<br>| Id | User        | Host      | db      | Command | Time | State               <br>     | Info             | Progress |<br>+----+-------------+-----------+---------+---------+------+----------------------<br>----+------------------+----------+<br>|  1 | system user |           | NULL    | Daemon  | NULL | InnoDB purge<br>coordinator | NULL             |    0.000 |<br>|  3 | system user |           | NULL    | Daemon  | NULL | InnoDB purge worker <br>     | NULL             |    0.000 |<br>|  4 | system user |           | NULL    | Daemon  | NULL | InnoDB purge worker <br>     | NULL             |    0.000 |<br>|  2 | system user |           | NULL    | Daemon  | NULL | InnoDB purge worker <br>     | NULL             |    0.000 |<br>|  5 | system user |           | NULL    | Daemon  | NULL | InnoDB shutdown <br>handler  | NULL             |    0.000 |<br>| 11 | root        | localhost | hellodb | Query   |    0 | Init                 <br>    | show processlist |    0.000 |<br>| 13 | root        | localhost | hellodb | Sleep   |   38 |                     <br>     | NULL             |    0.000 |<br>| 15 | root        | localhost | hellodb | Query   |   10 | Updating             <br>    | update students <span class="hljs-built_in">set</span> classid=20 |    0.000<br>+----+-------------+-----------+---------+---------+------+----------------------<br>----+------------------+----------+<br>7 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.000 sec)<br><span class="hljs-comment">#杀掉未完成的事务</span><br>MariaDB [hellodb]&gt; <span class="hljs-built_in">kill</span> 13;<br>Query OK, 0 rows affected (0.000 sec)<br><span class="hljs-comment">#查看事务锁的超时时长，默认50s</span><br>MariaDB [hellodb]&gt; show global variables like <span class="hljs-string">&#x27;innodb_lock_wait_timeout&#x27;</span>;<br>+--------------------------+-------+<br>| Variable_name            | Value |<br>+--------------------------+-------+<br>| innodb_lock_wait_timeout | 50    |<br>+--------------------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.001 sec)<br></code></pre></td></tr></table></figure>

<h4 id="5-3-3-事务隔离级别"><a href="#5-3-3-事务隔离级别" class="headerlink" title="5.3.3 事务隔离级别"></a>5.3.3 事务隔离级别</h4><blockquote>
<p>MySQL 支持四种隔离级别，事务隔离级别从上至下更加严格</p>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221030162855255-1949246472.png"><img src="2927659-20221030162855255-1949246472.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<ul>
<li><strong>READ UNCOMMITTED 读未提交</strong></li>
</ul>
<p>    可读取到未提交数据，产生<strong>脏读</strong></p>
<ul>
<li><strong>READ COMMITTED 读提交</strong></li>
</ul>
<p>    可读取到提交数据，但未提交数据不可读，产生<strong>不可重复读</strong>，即可读取到多个提交数据，导致每次读取数据不一致</p>
<ul>
<li><strong>REPEATABLE READ 可重复读</strong></li>
</ul>
<p>    可重复读，多次读取数据都一致，产生<strong>幻读</strong>，即读取过程中，即使有其它提交的事务修改数据，仍只能读取到未修改前的旧数据。<strong>此为MySQL默认设置</strong></p>
<ul>
<li><strong>SERIALIZABLE 序列化</strong></li>
</ul>
<p>    可串行化，未提交的读事务阻塞写事务（加读锁，但不阻塞读事务），或者未提交的写事务阻塞读和写事务（加写锁，其它事务的读，写都不可以执行）。会导致<strong>并发性能差</strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#服务器选项中指定</span><br>vim /etc/my.cnf<br>[mysqld]<br>transaction-isolation=SERIALIZABLE<br><br><span class="hljs-comment">#MySQL8.0 事务隔离级别系统变量tx_isolation已取消</span><br>mysql&gt; select @@tx_isolation;<br>ERROR 1193 (HY000): Unknown system variable <span class="hljs-string">&#x27;tx_isolation&#x27;</span><br><br>mysql&gt; select @@transaction_isolation;<br>+-------------------------+<br>| @@transaction_isolation |<br>+-------------------------+<br>| REPEATABLE-READ         |<br>+-------------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="6-日志管理"><a href="#6-日志管理" class="headerlink" title="6 日志管理"></a>6 日志管理</h2><blockquote>
<p>MySQL 支持丰富的日志类型，如下：</p>
<ul>
<li>事务日志：transaction log</li>
</ul>
<p>    事务日志的写入类型为”追加”，因此其操作为”顺序IO”；通常也被称为：预写式日志 write ahead logging</p>
<p>    事务日志文件： ib_logfile0， ib_logfile1</p>
<ul>
<li>错误日志error log</li>
<li>通用日志general log</li>
<li>慢查询日志 slow query log</li>
<li>二进制日志 binary log</li>
<li>中继日志reley log，在主从复制架构中，从服务器用于保存从主服务器的二进制日志中读取的事件</li>
</ul>
</blockquote>
<h3 id="6-1-事务日志"><a href="#6-1-事务日志" class="headerlink" title="6.1 事务日志"></a>6.1 事务日志</h3><h4 id="Innodb事务日志相关配置"><a href="#Innodb事务日志相关配置" class="headerlink" title="Innodb事务日志相关配置"></a>Innodb事务日志相关配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">show variables like <span class="hljs-string">&#x27;%innodb_log%&#x27;</span>;<br><br>innodb_log_file_size   50331648 <span class="hljs-comment">#每个日志文件大小</span><br>innodb_log_files_in_group 2     <span class="hljs-comment">#日志组成员个数</span><br>innodb_log_group_home_dir ./ <span class="hljs-comment">#事务文件路径</span><br><br>vim /etc/my.cnf<br>[mysqld]<br>innodb_log_group_home_dir=/data/<br><br><span class="hljs-built_in">chown</span> -R mysql./data<br></code></pre></td></tr></table></figure>

<h4 id="事务日志性能优化"><a href="#事务日志性能优化" class="headerlink" title="事务日志性能优化"></a>事务日志性能优化</h4><blockquote>
<ul>
<li>1 此为默认值，日志缓冲区将写入日志文件，并在每次事务后执行刷新到磁盘。 这是完全遵守ACID特性</li>
<li>0 提交时没有写磁盘的操作; 而是每秒执行一次将日志缓冲区的提交的事务写入刷新到磁盘。 这样可提供更好的性能，但服务器崩溃可能丢失最后一秒的事务</li>
<li>2 每次提交后都会写入OS的缓冲区，但每秒才会进行一次刷新到磁盘文件中。 性能比0略差一些，但操作系统或停电可能导致最后一秒的交易丢失</li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">innodb_flush_log_at_trx_commit=0|1|2<br></code></pre></td></tr></table></figure>

<p><strong><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221030165619817-1909115986.png"><img src="2927659-20221030165619817-1909115986.png" srcset="/img/loading.gif" lazyload alt="img"></a></strong></p>
<h3 id="6-2-错误日志"><a href="#6-2-错误日志" class="headerlink" title="6.2 错误日志"></a>6.2 错误日志</h3><blockquote>
<ul>
<li>mysqld启动和关闭过程中输出的事件信息</li>
<li>mysqld运行中产生的错误信息</li>
<li>event scheduler运行一个event时产生的日志信息</li>
<li>在主从复制架构中的从服务器上启动从服务器线程时产生的信息</li>
</ul>
</blockquote>
<h4 id="错误文件路径"><a href="#错误文件路径" class="headerlink" title="错误文件路径"></a>错误文件路径</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost (none)]&gt; SHOW GLOBAL VARIABLES LIKE <span class="hljs-string">&#x27;log_error&#x27;</span>;<br>+---------------+---------------------------+<br>| Variable_name | Value                     |<br>+---------------+---------------------------+<br>| log_error     | /var/log/mysql/mysqld.log |<br>+---------------+---------------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h3 id="6-3-通用日志"><a href="#6-3-通用日志" class="headerlink" title="6.3 通用日志"></a>6.3 通用日志</h3><blockquote>
<p>通用日志：记录对数据库的通用操作，包括:错误的SQL语句</p>
<p>通用日志可以保存在：file（默认值）或 table（mysql.general_log表）</p>
<p>通用日志相关设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">general_log=ON|OFF<br>general_log_file=HOSTNAME.<span class="hljs-built_in">log</span><br>log_output=TABLE|FILE|NONE<br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="范例-启用通用日志并记录至文件中"><a href="#范例-启用通用日志并记录至文件中" class="headerlink" title="范例: 启用通用日志并记录至文件中"></a>范例: 启用通用日志并记录至文件中</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#默认没有启用通用日志</span><br>mysql&gt; select @@general_log;<br>+---------------+<br>| @@general_log |<br>+---------------+<br>|             0 |<br>+---------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#启用</span><br>mysql&gt; <span class="hljs-built_in">set</span> global general_log=1;<br>Query OK, 0 rows affected (0.01 sec)<br>mysql&gt; select @@general_log;<br>+---------------+<br>| @@general_log |<br>+---------------+<br>|             1 |<br>+---------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#默认通用日志存放在文件中</span><br>mysql&gt; SHOW GLOBAL VARIABLES LIKE <span class="hljs-string">&#x27;log_output&#x27;</span>; <br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| log_output    | FILE  |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#通用日志存放的文件路径</span><br>mysql&gt; select @@general_log_file;<br>+----------------------------+<br>| @@general_log_file         |<br>+----------------------------+<br>| /var/lib/mysql/centos8.<span class="hljs-built_in">log</span> |<br>+----------------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h4 id="范例：通用日志记录到表中"><a href="#范例：通用日志记录到表中" class="headerlink" title="范例：通用日志记录到表中"></a>范例：通用日志记录到表中</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#修改通用日志，记录通用日志至mysql.general_log表中</span><br>MariaDB [mysql]&gt; <span class="hljs-built_in">set</span> global log_output=<span class="hljs-string">&quot;table&quot;</span>;<br>MariaDB [mysql]&gt; SHOW GLOBAL VARIABLES LIKE <span class="hljs-string">&#x27;log_output&#x27;</span>; <br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| log_output    | TABLE |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.002 sec)<br><br><span class="hljs-comment">#general_log表是CSV的文本文件</span><br>[root@centos8 ~]<span class="hljs-comment">#file /var/lib/mysql/mysql/general_log.CSV</span><br>/var/lib/mysql/mysql/general_log.CSV: ASCII text<br>[root@centos8 ~]<span class="hljs-comment">#head /var/lib/mysql/mysql/general_log.CSV</span><br><span class="hljs-string">&quot;2021-02-05 10:02:03.629031&quot;</span>,<span class="hljs-string">&quot;root[root] @ localhost []&quot;</span>,8,1,<span class="hljs-string">&quot;Query&quot;</span>,<span class="hljs-string">&quot;show databases&quot;</span><br><span class="hljs-string">&quot;2021-02-05 10:02:03.629901&quot;</span>,<span class="hljs-string">&quot;root[root] @ localhost []&quot;</span>,8,1,<span class="hljs-string">&quot;Query&quot;</span>,<span class="hljs-string">&quot;show tables&quot;</span><br>MariaDB [mysql]&gt; select * from mysql.general_log\G<br>...省略...<br>*************************** 7. row ***************************<br> event_time: 2019-11-25 11:03:44.549211<br>   user_host: root[root] @ localhost []<br>   thread_id: 8<br>   server_id: 1<br>command_type: Query<br>   argument: select * from general_log<br>7 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.000 sec)<br></code></pre></td></tr></table></figure>

<h3 id="6-4-慢查询日志"><a href="#6-4-慢查询日志" class="headerlink" title="6.4 慢查询日志"></a>6.4 慢查询日志</h3><blockquote>
<p>记录执行查询时长超出指定时长的操作</p>
</blockquote>
<h4 id="慢查询相关变量"><a href="#慢查询相关变量" class="headerlink" title="慢查询相关变量"></a>慢查询相关变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">slow_query_log=ON|OFF <span class="hljs-comment">#开启或关闭慢查询，支持全局和会话，只有全局设置才会生成慢查询文件</span><br>long_query_time=N <span class="hljs-comment">#慢查询的阀值，单位秒,默认为10s</span><br>slow_query_log_file=HOSTNAME-slow.log  <span class="hljs-comment">#慢查询日志文件</span><br>log_slow_filter = admin,filesort,filesort_on_disk,full_join,full_scan,<br>query_cache,query_cache_miss,tmp_table,tmp_table_on_disk <br><span class="hljs-comment">#上述查询类型且查询时长超过long_query_time，则记录日志</span><br>log_queries_not_using_indexes=ON  <span class="hljs-comment">#不使用索引或使用全索引扫描，不论是否达到慢查询阀值的语句是否记录日志，默认OFF，即不记录</span><br>log_slow_rate_limit = 1 <span class="hljs-comment">#多少次查询才记录，mariadb特有</span><br>log_slow_verbosity= Query_plan,explain <span class="hljs-comment">#记录内容</span><br>log_slow_queries = OFF    <span class="hljs-comment">#同slow_query_log，MariaDB 10.0/MySQL 5.6.1 版后已删除</span><br><br>select @@slow_query_log;<br></code></pre></td></tr></table></figure>

<h3 id="6-5-二进制日志-备份"><a href="#6-5-二进制日志-备份" class="headerlink" title="6.5 二进制日志(备份)"></a>6.5 二进制日志(备份)</h3><blockquote>
<ul>
<li>记录导致数据改变或潜在导致数据改变的SQL语句</li>
<li>记录已提交的日志</li>
<li>不依赖于存储引擎类型</li>
</ul>
<p>功能：通过”重放”日志文件中的事件来生成数据副本</p>
<p>注意：建议二进制日志和数据文件分开存放</p>
<p><strong>二进制日志记录三种格式</strong></p>
<ul>
<li>基于”<strong>语句</strong>“记录：statement，记录语句，默认模式（ MariaDB 10.2.3 版本以下 ），日志量较少</li>
<li>基于”<strong>行</strong>“记录：row，记录数据，日志量较大，更加安全，建议使用的格式,MySQL8.0默认格式</li>
<li>混合模式：mixed, 让系统自行判定该基于哪种方式进行，默认模式（ MariaDB 10.2.4及版本以上）</li>
</ul>
<p><strong>格式配置：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">MariaDB [hellodb]&gt; show variables like <span class="hljs-string">&#x27;binlog_format&#x27;</span>;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| binlog_format | MIXED |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.001 sec)<br><span class="hljs-comment">#MySQL 8.0 默认使用ROW方式</span><br>mysql&gt; show variables like <span class="hljs-string">&#x27;binlog_format&#x27;</span>;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| binlog_format | ROW   |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.07 sec)<br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="二进制日志文件的构成"><a href="#二进制日志文件的构成" class="headerlink" title="二进制日志文件的构成"></a>二进制日志文件的构成</h4><blockquote>
<p> 有两类文件</p>
<p>1.日志文件：mysql|mariadb-bin.文件名后缀，二进制格式,如： on.000001,mariadb-bin.000002</p>
<p>2.索引文件：mysql|mariadb-bin.index，文本格式,记录当前已有的二进制日志文件列表</p>
</blockquote>
<h4 id="二进制日志相关的服务器变量"><a href="#二进制日志相关的服务器变量" class="headerlink" title="二进制日志相关的服务器变量"></a>二进制日志相关的服务器变量</h4><blockquote>
<ul>
<li><strong>sql_log_bin=ON|OFF：#是否记录二进制日志，默认ON，支持动态修改，系统变量，而非服务器选项</strong></li>
<li><strong>log_bin=/PATH/BIN_LOG_FILE：#指定文件位置；默认OFF，表示不启用二进制日志功能，上述两项都开启才可以</strong></li>
<li>binlog_format=STATEMENT|ROW|MIXED：#二进制日志记录的格式，mariadb5.5默认STATEMENT</li>
<li>max_binlog_size=1073741824：#单个二进制日志文件的最大体积，到达最大值会自动滚动，默认为1G</li>
<li>#说明：文件达到上限时的大小未必为指定的精确值</li>
<li>binlog_cache_size=4m #此变量确定在每次事务中保存二进制日志更改记录的缓存的大小（每次连接）</li>
<li>max_binlog_cache_size=512m #限制用于缓存多事务查询的字节大小。</li>
<li>sync_binlog=1|0：#设定是否启动二进制日志即时同步磁盘功能，默认0，由操作系统负责同步日志到磁盘</li>
<li>expire_logs_days=N：#二进制日志可以自动删除的天数。 默认为0，即不自动删除</li>
</ul>
</blockquote>
<h4 id="查看mariadb自行管理使用中的二进制日志文件列表，及大小"><a href="#查看mariadb自行管理使用中的二进制日志文件列表，及大小" class="headerlink" title="查看mariadb自行管理使用中的二进制日志文件列表，及大小"></a>查看mariadb自行管理使用中的二进制日志文件列表，及大小</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW &#123;BINARY | MASTER&#125; LOGS    <br></code></pre></td></tr></table></figure>

<h4 id="查看使用中的二进制日志文件"><a href="#查看使用中的二进制日志文件" class="headerlink" title="查看使用中的二进制日志文件"></a><strong>查看使用中的二进制日志文件</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW MASTER STATUS<br></code></pre></td></tr></table></figure>

<h4 id="在线查看二进制文件中的指定内容"><a href="#在线查看二进制文件中的指定内容" class="headerlink" title="在线查看二进制文件中的指定内容"></a>在线查看二进制文件中的指定内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW BINLOG EVENTS [IN <span class="hljs-string">&#x27;log_name&#x27;</span>] [FROM pos] [LIMIT [offset,] row_count]<br><br><span class="hljs-comment">#范例：</span><br>show binlog events <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;mysql-bin.000001&#x27;</span> from 6516 <span class="hljs-built_in">limit</span> 2,3<br></code></pre></td></tr></table></figure>

<h4 id="mysqlbinlog"><a href="#mysqlbinlog" class="headerlink" title="mysqlbinlog"></a>mysqlbinlog</h4><blockquote>
<p>二进制日志的客户端命令工具，支持离线查看二进制日志</p>
<p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysqlbinlog [OPTIONS] log_file…<br> --start-position=<span class="hljs-comment"># 指定开始位置</span><br> --stop-position=<span class="hljs-comment">#</span><br> --start-datetime=  <span class="hljs-comment">#时间格式：YYYY-MM-DD hh:mm:ss</span><br> --stop-datetime= <br> --base64-output[=name]<br>        -v -vvv<br></code></pre></td></tr></table></figure>
</blockquote>
<h5 id="使用范例-4"><a href="#使用范例-4" class="headerlink" title="使用范例"></a>使用范例</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysqlbinlog --start-position=678 --stop-position=752 /var/lib/mysql/mariadbbin.000003 -v<br>mysqlbinlog  --start-datetime=<span class="hljs-string">&quot;2018-01-30 20:30:10&quot;</span>   --stop-datetime=<span class="hljs-string">&quot;2018-01-30 20:35:22&quot;</span> mariadb-bin.000003 -vvv<br></code></pre></td></tr></table></figure>

<h5 id="范例：-同步远程主机的二进制日志"><a href="#范例：-同步远程主机的二进制日志" class="headerlink" title="范例： 同步远程主机的二进制日志"></a>范例： 同步远程主机的二进制日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#从10.0.0.8远程主机实时同步二进制日志binlog.000002开始向后进行同步到当前目录</span><br>[root@centos8 data]<span class="hljs-comment">#mysqlbinlog -R --host=10.0.0.8 --user=test --password=123456 --raw --stop-never binlog.000002</span><br></code></pre></td></tr></table></figure>

<h4 id="清除指定二进制日志"><a href="#清除指定二进制日志" class="headerlink" title="清除指定二进制日志"></a>清除指定二进制日志</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">PURGE &#123; BINARY | MASTER &#125; LOGS &#123; TO <span class="hljs-string">&#x27;log_name&#x27;</span> | BEFORE datetime_expr &#125;<br><br><span class="hljs-comment">#范例</span><br>PURGE BINARY LOGS TO <span class="hljs-string">&#x27;mariadb-bin.000003&#x27;</span>; <span class="hljs-comment">#删除mariadb-bin.000003之前的日志</span><br>PURGE BINARY LOGS BEFORE <span class="hljs-string">&#x27;2017-01-23&#x27;</span>;<br>PURGE BINARY LOGS BEFORE <span class="hljs-string">&#x27;2017-03-22 09:25:30&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="删除所有二进制日志，index文件重新记数"><a href="#删除所有二进制日志，index文件重新记数" class="headerlink" title="删除所有二进制日志，index文件重新记数"></a>删除所有二进制日志，index文件重新记数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">RESET MASTER [TO <span class="hljs-comment">#]; </span><br><span class="hljs-comment">#删除所有二进制日志文件，并重新生成日志文件，文件名从#开始记数，</span><br><span class="hljs-comment">#默认从1开始，一般是master主机第一次启动时执行，MariaDB 10.1.6开始支持TO #</span><br></code></pre></td></tr></table></figure>

<h4 id="切换日志文件"><a href="#切换日志文件" class="headerlink" title="切换日志文件"></a>切换日志文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">FLUSH LOGS;<br></code></pre></td></tr></table></figure>

<h1 id="-3"><a href="#-3" class="headerlink" title=""></a></h1><hr>
<h1 id="五、MySQL-备份和恢复"><a href="#五、MySQL-备份和恢复" class="headerlink" title="五、MySQL 备份和恢复"></a>五、MySQL 备份和恢复</h1><h2 id="1-备份恢复概述"><a href="#1-备份恢复概述" class="headerlink" title="1 备份恢复概述"></a>1 备份恢复概述</h2><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221030195227996-1454244001.png"><img src="2927659-20221030195227996-1454244001.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h3 id="1-1-备份类型"><a href="#1-1-备份类型" class="headerlink" title="1.1 备份类型"></a>1.1 备份类型</h3><blockquote>
<ul>
<li>完全备份，部分备份</li>
</ul>
<p>     完全备份：整个数据集</p>
<p>     部分备份：只备份数据子集，如部分库或表</p>
<ul>
<li>完全备份、增量备份、差异备份</li>
</ul>
<p>     增量备份：仅备份最近一次完全备份或增量备份（如果存在增量）以来变化的数据，备份较快，还原复杂</p>
<p>     差异备份：仅备份最近一次完全备份以来变化的数据，备份较慢，还原简单</p>
<p>注意：二进制日志文件不应该与数据文件放在同一磁盘</p>
<ul>
<li>冷、温、热备份</li>
</ul>
<p>     冷备：读、写操作均不可进行，数据库停止服务</p>
<p>     温备：读操作可执行；但写操作不可执行</p>
<p>     热备：读、写操作均可执行</p>
<p>      MyISAM：温备，不支持热备</p>
<p>      InnoDB：都支持</p>
<ul>
<li>物理和逻辑备份</li>
</ul>
<p>     物理备份：直接复制数据文件进行备份，与存储引擎有关，占用较多的空间，速度快</p>
<p>     逻辑备份：从数据库中”导出”数据另存而进行的备份，与存储引擎无关，占用空间少，速度慢，可能丢失精度</p>
</blockquote>
<h3 id="1-2-实战案例：数据库冷备份和还原"><a href="#1-2-实战案例：数据库冷备份和还原" class="headerlink" title="1.2 实战案例：数据库冷备份和还原"></a>1.2 实战案例：数据库冷备份和还原</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#MySQL8.0</span><br><span class="hljs-comment">#备份过程</span><br>[root@centos8 ~]<span class="hljs-comment">#systemctl stop mysqld</span><br><span class="hljs-comment">#备份数据</span><br>[root@centos8 ~]<span class="hljs-comment">#rsync -a /var/lib/mysql 10.0.0.28:/data/</span><br><span class="hljs-comment">#如果配置及二进制文件相关有特殊设置也需要备份</span><br><span class="hljs-comment">#还原</span><br>[root@centos8 ~]<span class="hljs-comment">#yum -y install mysql-server</span><br>[root@centos8 ~]<span class="hljs-comment">#cp -a /data/mysql/* /var/lib/mysql/</span><br>[root@centos8 ~]<span class="hljs-comment">#systemctl start mysqld</span><br><br><span class="hljs-comment">#Mariadb10.3</span><br><span class="hljs-comment">#在目标服务器（10.0.0.18）安装mariadb-server，不启动服务</span><br>[root@centos8 ~]<span class="hljs-comment">#dnf install mariadb-server</span><br><span class="hljs-comment">#在源主机（10.0.0.8）执行</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl stop mariadb</span><br><span class="hljs-comment">#复制相关文件</span><br>[root@centos8 ~]<span class="hljs-comment"># scp -r /var/lib/mysql/* 10.0.0.18:/var/lib/mysql/</span><br>[root@centos8 ~]<span class="hljs-comment"># scp /etc/my.cnf.d/mariadb-server.cnf 10.0.0.18:/etc/my.cnf.d/</span><br>[root@centos8 ~]<span class="hljs-comment"># scp -r /data/logbin/ 10.0.0.18:/data/   #10.0.0.18须事先存在/data/目录</span><br><span class="hljs-comment">#复制相关文件并保留属性：可以用rsync</span><br>[root@centos8 ~]<span class="hljs-comment">#rsync /etc/my.cnf.d/mariadb-server.cnf 10.0.0.18:/etc/my.cnf.d/</span><br>[root@centos8 ~]<span class="hljs-comment">#rsync -av /var/lib/mysql/ 10.0.0.18:/var/lib/mysql/ </span><br>[root@centos8 ~]<span class="hljs-comment">#rsync -av/data/logbin/ 10.0.0.18:/data/   #10.0.0.18 须事先存在/data/目录</span><br><span class="hljs-comment">#在目标主机（10.0.0.18）执行</span><br>[root@centos8 ~]<span class="hljs-comment">#chown -R mysql.mysql /var/lib/mysql/</span><br>[root@centos8 ~]<span class="hljs-comment">#chown -R mysql.mysql /data/logbin/</span><br>[root@centos8 ~]<span class="hljs-comment">#systemctl start mariadb</span><br></code></pre></td></tr></table></figure>

<h2 id="2-mysqldump-备份工具"><a href="#2-mysqldump-备份工具" class="headerlink" title="2 mysqldump 备份工具"></a>2 mysqldump 备份工具</h2><h3 id="2-1-mysqldump-说明"><a href="#2-1-mysqldump-说明" class="headerlink" title="2.1 mysqldump 说明"></a>2.1 mysqldump 说明</h3><blockquote>
<p><strong>命令格式</strong><strong>:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysqldump [OPTIONS] database [tables]   <span class="hljs-comment">#支持指定数据库和指定多表的备份，但数据库本身定义不备份</span><br>mysqldump [OPTIONS] -B DB1 [DB2 DB3...] <span class="hljs-comment">#支持指定数据库备份，包含数据库本身定义也会备份</span><br>mysqldump [OPTIONS] -A [OPTIONS]        <span class="hljs-comment">#备份所有数据库，包含数据库本身定义也会备份</span><br></code></pre></td></tr></table></figure>

<p><strong>mysqldump</strong> <strong>常见通用选项：</strong></p>
<ul>
<li><p><strong>-u, –user=name   User for login if not current user</strong></p>
</li>
<li><p><strong>-p, –password[=name]  Password to use when connecting to server</strong></p>
</li>
<li><p><strong>-A, –all-databases #备份所有数据库，含create database</strong></p>
</li>
<li><p><strong>-B, –databases db_name…  #指定备份的数据库，包括create database语句</strong></p>
</li>
<li><p>-E, –events：#备份相关的所有event scheduler</p>
</li>
<li><p>-R, –routines：#备份所有存储过程和自定义函数</p>
</li>
<li><p>–triggers：#备份表相关触发器，默认启用,用–skip-triggers，不备份触发器</p>
</li>
<li><p>–default-character-set=utf8 #指定字符集</p>
</li>
<li><p><strong>–master-data[=#]：#注意：MySQL8.0.26版以后，此选项变为–source-data</strong></p>
</li>
<li><p>#此选项须启用二进制日志</p>
</li>
<li><p><strong>#1</strong>：所备份的数据之前<strong>加一条记录为CHANGE MASTER TO</strong>语句，非注释，不指定#，<strong>默认为1</strong>，<strong>适合于主从复制多机使用</strong></p>
</li>
<li><p><strong>#2：记录为被注释的#CHANGE MASTER TO语句，适合于单机使用,适用于备份还原</strong></p>
</li>
<li><p>#此选项会自动关闭–lock-tables功能，自动打开-x | –lock-all-tables功能（除非开启–single-transaction）</p>
</li>
<li><p><strong>-F, –flush-logs #备份前滚动日志，锁定表完成后，执行flush logs命令,生成新的二进制日志文件，配合-A 或 -B 选项时，会导致刷新多次数据库。建议在同一时刻执行转储和日志刷新，可通过和–single-transaction</strong>或-x<strong>，–master-data 一起使用实现，此时只刷新一次二进制日志</strong></p>
</li>
<li><p>–compact     #去掉注释，适合调试，节约备份占用的空间,生产不使用</p>
</li>
<li><p>-d, –no-data   #只备份表结构,不备份数据,即只备份create table</p>
</li>
<li><p>-t, –no-create-info #只备份数据,不备份表结构,即不备份create table</p>
</li>
<li><p>-n,–no-create-db #不备份create database，可被-A或-B覆盖</p>
</li>
<li><p>–flush-privileges #备份mysql或相关时需要使用</p>
</li>
<li><p>-f, –force    #忽略SQL错误，继续执行</p>
</li>
<li><p>–hex-blob     #使用十六进制符号转储二进制列，当有包括BINARY,VARBINARY,BLOB，BIT的数据类型的列时使用，避免乱码</p>
</li>
<li><p>-q, –quick   #不缓存查询，直接输出，加快备份速度</p>
</li>
</ul>
</blockquote>
<blockquote>
<p><strong>mysqldump<strong><strong>的</strong></strong>MyISAM****存储引擎相关的备份选项：</strong></p>
<p>MyISAM不支持事务，只能支持温备；不支持热备，所以必须先锁定要备份的库，而后启动备份操作</p>
<ul>
<li>-x,–lock-all-tables #加全局读锁，锁定所有库的所有表，同时加–single-transaction或–lock-tables选项会关闭此选项功能，注意：数据量大时，可能会导致长时间无法并发访问数据库</li>
<li>-l,–lock-tables #对于需要备份的每个数据库，在启动备份之前分别锁定其所有表，默认为on,–skip-lock-tables选项可禁用,对备份MyISAM的多个库,可能会造成数据不一致<br>#注：以上选项对InnoDB表一样生效，实现温备，但不推荐使用</li>
</ul>
<p><strong>mysqldump<strong><strong>的</strong></strong>InnoDB****存储引擎相关的备份选项：</strong></p>
<p>InnoDB 存储引擎支持事务,可以利用事务的相应的隔离级别,实现热备，也可以实现温备但不建议用</p>
<ul>
<li><strong>–single-transaction</strong></li>
</ul>
<p>#此选项Innodb中推荐使用，且<strong>不会锁表</strong>！不适用MyISAM，此选项会开始备份前，先执行START TRANSACTION指令开启事务</p>
<p>#此选项通过在单个事务中转储所有表来创建一致的快照。 仅适用于存储在支持多版本控制的存储引擎中的表（目前只有InnoDB可以）; 转储不保证与其他存储引擎保持一致。 在进行单事务转储时，要确保有效的转储文件（正确的表内容和二进制日志位置），没有其他连接应该使用以下语句：ALTER TABLE，DROP TABLE，RENAME TABLE，TRUNCATE TABLE,此选项和–lock-tables（此选项隐含提交挂起的事务）选项是相互排斥,备份大型表时，建议将–single-transaction选项和–quick结合一起使用</p>
</blockquote>
<h3 id="2-2-生产环境实战备份策略"><a href="#2-2-生产环境实战备份策略" class="headerlink" title="2.2 生产环境实战备份策略"></a>2.2 生产环境实战备份策略</h3><h4 id="InnoDB建议备份策略"><a href="#InnoDB建议备份策略" class="headerlink" title="InnoDB建议备份策略"></a>InnoDB建议备份策略</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysqldump -uroot -p -A -F -E -R --triggers --single-transaction --master-data=1 \<br>--flush-privileges --default-character-set=utf8 --hex-blob &gt;<span class="hljs-variable">$&#123;BACKUP&#125;</span>/fullbak_<span class="hljs-variable">$&#123;BACKUP_TIME&#125;</span>.sql<br></code></pre></td></tr></table></figure>

<h4 id="MyISAM建议备份策略"><a href="#MyISAM建议备份策略" class="headerlink" title="MyISAM建议备份策略"></a>MyISAM建议备份策略</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysqldump -uroot -p -A -F -E -R -x --master-data=1 --flush-privileges  \<br>--triggers  --default-character-set=utf8  --hex-blob&gt;<span class="hljs-variable">$&#123;BACKUP&#125;</span>/fullbak_<span class="hljs-variable">$&#123;BACKUP_TIME&#125;</span>.sql<br></code></pre></td></tr></table></figure>

<h3 id="2-3-mysqldump-备份还原实战案例"><a href="#2-3-mysqldump-备份还原实战案例" class="headerlink" title="2.3 mysqldump 备份还原实战案例"></a>2.3 mysqldump 备份还原实战案例</h3><h4 id="实战案例：特定数据库的备份脚本"><a href="#实战案例：特定数据库的备份脚本" class="headerlink" title="实战案例：特定数据库的备份脚本"></a>实战案例：特定数据库的备份脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#cat mysql_backup.sh </span><br><span class="hljs-comment">#!/bin/bash</span><br>TIME=`<span class="hljs-built_in">date</span> +%F_%H-%M-%S`<br>DIR=/backup<br>DB=hellodb<br>PASS=123456<br>[ -d <span class="hljs-variable">$DIR</span> ] || <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$DIR</span><br>mysqldump -uroot -p <span class="hljs-string">&quot;<span class="hljs-variable">$PASS</span>&quot;</span> -F --triggers --single-transaction --master-data=2 -B <span class="hljs-variable">$DB</span> | gzip &gt; <span class="hljs-variable">$&#123;DIR&#125;</span>/<span class="hljs-variable">$&#123;DB&#125;</span>_<span class="hljs-variable">$&#123;TIME&#125;</span>.sql.gz<br><br><span class="hljs-comment">#只用上面的参数足够了</span><br>mysqldump -uroot -p <span class="hljs-string">&quot;<span class="hljs-variable">$PASS</span>&quot;</span> -F -E -R --triggers --single-transaction --master-data=2 --default-character-set=utf8 -q -B <span class="hljs-variable">$DB</span> | gzip &gt; <span class="hljs-variable">$&#123;DIR&#125;</span>/<span class="hljs-variable">$&#123;DB&#125;</span>_<span class="hljs-variable">$&#123;TIME&#125;</span>.sql.gz<br></code></pre></td></tr></table></figure>

<h4 id="实战案例：分库备份的实战脚本"><a href="#实战案例：分库备份的实战脚本" class="headerlink" title="实战案例：分库备份的实战脚本"></a>实战案例：分库备份的实战脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos8 ~]<span class="hljs-comment">#cat backup_db.sh </span><br><span class="hljs-comment">#!/bin/bash</span><br>TIME=`<span class="hljs-built_in">date</span> +%F_%H-%M-%S`<br>DIR=/backup<br>PASS=123456<br>[ -d <span class="hljs-string">&quot;<span class="hljs-variable">$DIR</span>&quot;</span> ] || <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$DIR</span><br><span class="hljs-keyword">for</span> DB <span class="hljs-keyword">in</span> `mysql -uroot -p <span class="hljs-string">&quot;<span class="hljs-variable">$PASS</span>&quot;</span> -e <span class="hljs-string">&#x27;show databases&#x27;</span> | grep -Ev <span class="hljs-string">&quot;^Database|.*schema$&quot;</span>`;<span class="hljs-keyword">do</span><br>    mysqldump -F --single-transaction --master-data=2 -B <span class="hljs-variable">$DB</span> | gzip &gt; <span class="hljs-variable">$&#123;DIR&#125;</span>/<span class="hljs-variable">$&#123;DB&#125;</span>_<span class="hljs-variable">$&#123;TIME&#125;</span>.sql.gz<br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment">#只用上面的参数足够了</span><br>mysqldump -F --single-transaction --master-data=2 --default-character-set=utf8 -q -B <span class="hljs-variable">$DB</span> | gzip &gt;  <span class="hljs-variable">$&#123;DIR&#125;</span>/<span class="hljs-variable">$&#123;DB&#125;</span>_<span class="hljs-variable">$&#123;TIME&#125;</span>.sql.gz<br></code></pre></td></tr></table></figure>

<h4 id="实战案例：恢复误删除的表"><a href="#实战案例：恢复误删除的表" class="headerlink" title="实战案例：恢复误删除的表"></a>实战案例：恢复误删除的表</h4><blockquote>
<p>案例说明：每天2：30做完全备份，早上10：00误删除了表students，10：10才发现故障，现需要将数据库还原到10：10的状态，且恢复被删除的students表</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#完全备份,要求必须开启二进制日志(@@sql_log_bin和@@log_bin)</span><br>[root@rocky01 ~]<span class="hljs-comment"># mkdir /backup</span><br>[root@rocky01 ~]<span class="hljs-comment"># mysqldump -uroot -p123456 -A -F --single-transaction --master-data=2 &gt; /backup/allbackup_`date +%F_%T`.sql</span><br>mysqldump: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br><br><span class="hljs-comment">#模拟完全备份后数据更新</span><br>MariaDB [testdb]&gt; insert students (name,age,gender) values(<span class="hljs-string">&#x27;rose&#x27;</span>,20,<span class="hljs-string">&#x27;f&#x27;</span>);<br>Query OK, 1 row affected (0.001 sec)<br>MariaDB [testdb]&gt; insert students (name,age,gender) values(<span class="hljs-string">&#x27;jack&#x27;</span>,22,<span class="hljs-string">&#x27;M&#x27;</span>);<br>Query OK, 1 row affected (0.001 sec)<br><br><span class="hljs-comment">#10：00误删除了一个重要的表</span><br>MariaDB [testdb]&gt; drop table students;<br>Query OK, 0 rows affected (0.021 sec)<br><br><span class="hljs-comment">#模拟后续其它表继续更新</span><br>MariaDB [testdb]&gt; use hellodb;<br>Reading table information <span class="hljs-keyword">for</span> completion of table and column names<br>You can turn off this feature to get a quicker startup with -A<br>Database changed<br>MariaDB [hellodb]&gt; insert teachers (name,age,gender)values(<span class="hljs-string">&#x27;wang&#x27;</span>,30,<span class="hljs-string">&#x27;M&#x27;</span>);<br>Query OK, 1 row affected (0.002 sec)<br>MariaDB [hellodb]&gt; insert teachers (name,age,gender)values(<span class="hljs-string">&#x27;mage&#x27;</span>,28,<span class="hljs-string">&#x27;M&#x27;</span>);<br>Query OK, 1 row affected (0.002 sec)<br>MariaDB [hellodb]&gt; select * from teachers;<br>+-----+---------------+-----+--------+<br>| TID | Name          | Age | Gender |<br>+-----+---------------+-----+--------+<br>|   1 | Song Jiang    |  45 | M      |<br>|   2 | Zhang Sanfeng |  94 | M      |<br>|   3 | Miejue Shitai |  77 | F      |<br>|   4 | Lin Chaoying  |  93 | F      |<br>|   5 | wang          |  30 | M      |<br>|   6 | mage          |  28 | M      |<br>+-----+---------------+-----+--------+<br>6 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.001 sec)<br><br><span class="hljs-comment">#10：10发现表删除，进行还原</span><br><span class="hljs-comment">#停止数据库访问</span><br><span class="hljs-comment">#从完全备份中，找到二进制位置</span><br>[root@rocky01 ~]<span class="hljs-comment"># grep &#x27;\-\- CHANGE MASTER TO&#x27; allbackup_2022-10-31_14\:52\:32.sql</span><br>-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="hljs-string">&#x27;binlog.000008&#x27;</span>, MASTER_LOG_POS=156;<br><br><span class="hljs-comment">#备份从完全备份后的二进制日志，若生成了新文件bin.000009等），则追加</span><br>[root@rocky01 ~]<span class="hljs-comment"># mysqlbinlog --start-position=156 /var/lib/mysql/binlog.000008 &gt; /backup/inc.sql</span><br>[root@rocky01 ~]<span class="hljs-comment"># mysqlbinlog /var/lib/mysql/mariadb-bin.000009 &gt;&gt; /backup/inc.sql</span><br>[root@rocky01 ~]<span class="hljs-comment"># mysqlbinlog /var/lib/mysql/mariadb-bin.000010 &gt;&gt; /backup/inc.sql</span><br><br><span class="hljs-comment">#找到误删除的语句，从备份中删除此语句</span><br>[root@rocky01 ~]<span class="hljs-comment"># vim /backup/inc.sql</span><br><span class="hljs-comment">#DROP TABLE `students` /* generated by server */</span><br><span class="hljs-comment">#如果文件过大，可以使用sed实现</span><br>[root@rocky01 ~]<span class="hljs-comment"># sed -i &#x27;/^DROP TABLE `students`/d&#x27; /backup/inc.sql</span><br><br><span class="hljs-comment">#利用完全备份和修改过的二进制日志进行还原</span><br>[root@rocky02 ~]<span class="hljs-comment"># mysql -uroot -p</span><br>MariaDB [hellodb]&gt; <span class="hljs-built_in">set</span> sql_log_bin=0;<br>MariaDB [hellodb]&gt; <span class="hljs-built_in">source</span> /backup/allbackup_2019-11-27_10:20:08.sql;<br>MariaDB [hellodb]&gt; <span class="hljs-built_in">source</span> /backup/inc.sql<br>MariaDB [hellodb]&gt; <span class="hljs-built_in">set</span> sql_log_bin=1;<br></code></pre></td></tr></table></figure>

<h2 id="3-xtrabackup-备份工具"><a href="#3-xtrabackup-备份工具" class="headerlink" title="3 xtrabackup 备份工具"></a>3 xtrabackup 备份工具</h2><blockquote>
<p>percona提供的mysql数据库备份工具，惟一开源的能够对innodb和xtradb数据库进行热备的工具</p>
<p><strong>xtrabackup 特点：</strong></p>
<ul>
<li>备份还原过程快速、可靠</li>
<li>备份过程不会打断正在执行的事务</li>
<li>能够基于压缩等功能节约磁盘空间和流量</li>
<li>自动实现备份检验</li>
<li>开源，免费</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.percona.com/downloads/">下载地址</a></p>
</blockquote>
<h3 id="3-1-xtrabackup-用法"><a href="#3-1-xtrabackup-用法" class="headerlink" title="3.1 xtrabackup 用法"></a>3.1 xtrabackup 用法</h3><blockquote>
<p>xtrabackup工具备份和还原，需要三步实现</p>
<ol>
<li>备份：对数据库做完全或增量备份</li>
<li>预准备： 还原前，先对备份的数据，整理至一个临时目录</li>
<li>还原：将整理好的数据，复制回数据库目录中</li>
</ol>
<ul>
<li><strong>–user：#该选项表示备份账号</strong></li>
<li><strong>–password：#该选项表示备份的密码</strong></li>
<li>–host：#该选项表示备份数据库的地址</li>
<li>–databases：#该选项接受的参数为数据库名，如果要指定多个数据库，彼此间需要以空格隔开；</li>
</ul>
<p>     如：”xtra_test dba_test”，同时，在指定某数据库时，也可以只指定其中的某张表。</p>
<p>     如：”mydatabase.mytable”。该选项对innodb引擎表无效，还是会备份所有innodb表</p>
<ul>
<li>–defaults-file：#该选项指定从哪个文件读取MySQL配置，必须放在命令行第一个选项位置</li>
<li>–incremental：#该选项表示创建一个增量备份，需要指定–incremental-basedir</li>
<li><strong>–incremental-basedir：#该选项指定为前一次全备份或增量备份的目录，与–incremental同时使用</strong></li>
<li><strong>–incremental-dir：#该选项表示还原时增量备份的目录</strong></li>
<li>–include=name：#指定表名，格式：databasename.tablename</li>
</ul>
</blockquote>
<h3 id="实战案例：利用-xtrabackup-实现完全备份及还原"><a href="#实战案例：利用-xtrabackup-实现完全备份及还原" class="headerlink" title="实战案例：利用 xtrabackup 实现完全备份及还原"></a>实战案例：利用 xtrabackup 实现完全备份及还原</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#利用xtrabackup8.0 完全备份和还原MySQL8.0</span><br><span class="hljs-comment">#1 安装xtrabackup包</span><br>[root@centos8 ~]<span class="hljs-comment">#yum -y install percona-xtrabackup-80-8.0.23-16.1.el8.x86_64.rpm</span><br><br><span class="hljs-comment">#2 在原主机做完全备份到/backup/base</span><br>[root@centos8 ~]<span class="hljs-comment">#mkdir /backup</span><br>[root@centos8 ~]<span class="hljs-comment">#xtrabackup -uroot -p123456 --backup --target-dir=/backup/base</span><br><span class="hljs-comment">#目标主机无需创建/backup目录,直接复制目录本身</span><br>[root@centos8 ~]<span class="hljs-comment">#scp -r /backup/   目标主机:/</span><br><br><span class="hljs-comment">#3 在目标主机上还原</span><br><span class="hljs-comment">#注意：恢复主机MySQL服务停止，并且数据目录为空</span><br><span class="hljs-comment">#1）预准备：确保数据一致，提交完成的事务，回滚未完成的事务</span><br>[root@centos8 ~]<span class="hljs-comment">#yum -y install percona-xtrabackup-80-8.0.23-16.1.el8.x86_64.rpm</span><br>[root@centos8 ~]<span class="hljs-comment">#xtrabackup --prepare --target-dir=/backup/base</span><br><span class="hljs-comment">#2）复制到数据库目录</span><br><span class="hljs-comment">#注意：数据库目录必须为空，MySQL服务不能启动</span><br>[root@centos8 ~]<span class="hljs-comment">#xtrabackup --copy-back --target-dir=/backup/base</span><br><span class="hljs-comment">#3）还原属性</span><br>[root@centos8 ~]<span class="hljs-comment">#chown -R mysql:mysql /var/lib/mysql</span><br><span class="hljs-comment">#4）启动服务</span><br>[root@centos8 ~]<span class="hljs-comment">#service mysqld start</span><br></code></pre></td></tr></table></figure>

<h3 id="实战案例：利用xtrabackup完全，增量备份及还原"><a href="#实战案例：利用xtrabackup完全，增量备份及还原" class="headerlink" title="实战案例：利用xtrabackup完全，增量备份及还原"></a>实战案例：利用xtrabackup完全，增量备份及还原</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#利用xtrabackup8.0 完全、增量备份及还原MySQL8.0</span><br><span class="hljs-comment">#1 备份过程</span><br><span class="hljs-comment">#1）完全备份：</span><br>[root@centos8 ~]<span class="hljs-comment">#yum -y install percona-xtrabackup-24-2.4.20-1.el8.x86_64.rpm</span><br>[root@centos8 ~]<span class="hljs-comment">#mkdir /backup/</span><br>[root@centos8 ~]<span class="hljs-comment">#xtrabackup -uroot -p123456 --backup --target-dir=/backup/base</span><br><br><span class="hljs-comment">#2）模拟第一次修改数据</span><br>mysql&gt;insert students (name,age,gender) values(<span class="hljs-string">&#x27;rose&#x27;</span>,20,<span class="hljs-string">&#x27;f&#x27;</span>);<br><span class="hljs-comment">#3）第一次增量备份</span><br>[root@centos8 ~]<span class="hljs-comment">#xtrabackup -uroot -p123456 --backup --target-dir=/backup/inc1 --incremental-basedir=/backup/base</span><br><br><span class="hljs-comment">#4）模拟第二次修改数据</span><br>mysql&gt;insert students (name,age,gender) values(<span class="hljs-string">&#x27;jack&#x27;</span>,22,<span class="hljs-string">&#x27;M&#x27;</span>);<br><span class="hljs-comment">#5）第二次增量</span><br>[root@centos8 ~]<span class="hljs-comment">#xtrabackup -uroot -p123456 --backup --target-dir=/backup/inc2 --incremental-basedir=/backup/inc1</span><br><br><span class="hljs-comment">#6）[root@centos8 ~]#scp -r /backup/* 目标主机:/backup/</span><br><span class="hljs-comment">#备份过程生成三个备份目录/backup/&#123;base，inc1，inc2&#125;</span><br><br><span class="hljs-comment">#2还原过程</span><br><span class="hljs-comment">#1）预准备完成备份，此选项--apply-log-only 阻止回滚未完成的事务</span><br>[root@centos8 ~]<span class="hljs-comment">#yum -y install percona-xtrabackup-24-2.4.20-1.el8.x86_64.rpm</span><br>[root@centos8 ~]<span class="hljs-comment">#xtrabackup --prepare --apply-log-only --target-dir=/backup/base</span><br><br><span class="hljs-comment">#2）合并第1次增量备份到完全备份</span><br>[root@centos8 ~]<span class="hljs-comment">#xtrabackup --prepare --apply-log-only --target-dir=/backup/base --incremental-dir=/backup/inc1</span><br><br><span class="hljs-comment">#3）合并第2次增量备份到完全备份：最后一次还原不需要加选项--apply-log-only</span><br>[root@centos8 ~]<span class="hljs-comment">#xtrabackup --prepare --target-dir=/backup/base --incremental-dir=/backup/inc2</span><br><br><span class="hljs-comment">#4）复制到数据库目录，注意数据库目录必须为空，MySQL服务不能启动</span><br>[root@centos8 ~]<span class="hljs-comment">#xtrabackup --copy-back --target-dir=/backup/base</span><br><br><span class="hljs-comment">#5）还原属性：</span><br>[root@centos8 ~]<span class="hljs-comment">#chown -R mysql:mysql /var/lib/mysql</span><br><span class="hljs-comment">#6）启动服务：</span><br>[root@centos8 ~]<span class="hljs-comment">#service mysqld start</span><br></code></pre></td></tr></table></figure>

<h1 id="-4"><a href="#-4" class="headerlink" title=""></a></h1><hr>
<h1 id="六、MySQL-集群-Cluster"><a href="#六、MySQL-集群-Cluster" class="headerlink" title="六、MySQL 集群 Cluster"></a>六、MySQL 集群 Cluster</h1><h2 id="1-MySQL-主从复制"><a href="#1-MySQL-主从复制" class="headerlink" title="1 MySQL 主从复制"></a>1 MySQL 主从复制</h2><h3 id="1-1-主从复制架构和原理"><a href="#1-1-主从复制架构和原理" class="headerlink" title="1.1 主从复制架构和原理"></a>1.1 主从复制架构和原理</h3><h4 id="（1）MySQL的主从复制"><a href="#（1）MySQL的主从复制" class="headerlink" title="（1）MySQL的主从复制"></a>（1）MySQL的主从复制</h4><blockquote>
<ul>
<li>读写分离</li>
<li>复制：每个节点都有相同的数据集，向外扩展，基于二进制日志的单向复制</li>
</ul>
</blockquote>
<h4 id="（2）主从复制原理"><a href="#（2）主从复制原理" class="headerlink" title="（2）主从复制原理"></a>（2）主从复制原理</h4><blockquote>
<p><strong>主从复制相关线程</strong></p>
<ul>
<li>主节点：</li>
</ul>
<p>     <strong>dump Thread****：</strong>为每个Slave的I/O Thread启动一个dump线程，用于向其发送binary log events</p>
<ul>
<li>从节点：</li>
</ul>
<p>     <strong>I/O Thread****：</strong>向Master请求二进制日志事件，并保存于中继日志中</p>
<p>     <strong>SQL Thread****：</strong>从中继日志中读取日志事件，在本地完成重放</p>
<p><strong>跟复制功能相关的文件：</strong></p>
<ul>
<li><strong>master.info</strong>：用于保存slave连接至master时的相关信息，例如账号、密码、服务器地址等</li>
<li><strong>relay-log.info</strong>：保存在当前slave节点上已经复制的当前二进制日志和本地relay log日志的对应关系</li>
<li>mysql-relay-bin.00000#: 中继日志,保存从主节点复制过来的二进制日志,本质就是二进制日志</li>
</ul>
<p><strong>复制需要考虑二进制日志事件记录格式</strong></p>
<ul>
<li>STATEMENT（5.0之前）, Mariadb5.5 默认使用此格式</li>
<li>ROW（5.1之后，推荐）,MySQL 8.0 默认使用此格式</li>
<li>MIXED: Mariadb10.3 默认使用此格式</li>
</ul>
</blockquote>
<p> <a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202210/2927659-20221031164131126-799572710.png"><img src="2927659-20221031164131126-799572710.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h3 id="1-2-实现主从复制配置"><a href="#1-2-实现主从复制配置" class="headerlink" title="1.2 实现主从复制配置"></a>1.2 实现主从复制配置</h3><h4 id="主节点配置"><a href="#主节点配置" class="headerlink" title="主节点配置"></a>主节点配置</h4><blockquote>
<p>(1) 启用二进制日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[mysqld]<br>log_bin<br></code></pre></td></tr></table></figure>

<p>(2) 为当前节点设置一个全局惟一的ID号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[mysqld]<br>server-id=<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#说明：</span><br><span class="hljs-comment">#server-id的取值范围</span><br><span class="hljs-comment">#1 to 4294967295 (&gt;= MariaDB 10.2.2)，默认值为1，MySQL8.0默认值为1</span><br><span class="hljs-comment">#0 to 4294967295 (&lt;= MariaDB 10.2.1)，默认值为0，如果从节点为0，所有master都将拒绝此slave的连接</span><br></code></pre></td></tr></table></figure>

<p>(3) 查看从二进制日志的文件和位置开始进行复制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SHOW MASTER STATUS;<br></code></pre></td></tr></table></figure>

<p>(4) 创建有复制权限的用户账号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">GRANT REPLICATION SLAVE ON *.* TO <span class="hljs-string">&#x27;repluser&#x27;</span>@<span class="hljs-string">&#x27;HOST&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;123456&#x27;</span>;<br><br><span class="hljs-comment">#MySQL8.0 分成两步实现</span><br>mysql&gt; create user repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>mysql&gt; grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;<br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="从节点配置"><a href="#从节点配置" class="headerlink" title="从节点配置"></a>从节点配置</h4><blockquote>
<p>(1) 启动中继日志（二进制日志）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[mysqld]<br>server_id=<span class="hljs-comment"># #为当前节点设置一个全局惟的ID号</span><br>log-bin<br>read_only=ON <span class="hljs-comment">#设置数据库只读，针对supper user超级用户无效</span><br></code></pre></td></tr></table></figure>

<p>(2) 使用有复制权限的用户账号连接至主服务器，并启动复制线程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">CHANGE MASTER TO <br>  MASTER_HOST=<span class="hljs-string">&#x27;masterhost&#x27;</span>, <br>  MASTER_USER=<span class="hljs-string">&#x27;repluser&#x27;</span>, <br>  MASTER_PASSWORD=<span class="hljs-string">&#x27;123456&#x27;</span>, <br>  MASTER_PORT=3306,<br>  MASTER_LOG_FILE=<span class="hljs-string">&#x27;mariadb-bin.xxxxxx&#x27;</span>, <br>  MASTER_LOG_POS= <br>  MASTER_DELAY=3; <span class="hljs-comment">#可指定延迟复制实现访问误操作（默认10s）,单位秒</span><br><br>start slave [IO_THREAD|SQL_THREAD];<br>SHOW SLAVE STATUS;<br><span class="hljs-comment">#查看 relaylog 事件</span><br>SHOW RELAYLOG EVENTS <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;relay-bin.00000x&#x27;</span>;<br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="1-3-主从复制相关命令"><a href="#1-3-主从复制相关命令" class="headerlink" title="1.3 主从复制相关命令"></a>1.3 主从复制相关命令</h3><h4 id="从节点清除信息"><a href="#从节点清除信息" class="headerlink" title="从节点清除信息"></a>从节点清除信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注意：以下都需要先 STOP SLAVE</span><br>RESET SLAVE <span class="hljs-comment">#从服务器清除master.info ，relay-log.info, relay log ，开始新的relay log</span><br>RESET SLAVE ALL <span class="hljs-comment">#清除所有从服务器上设置的主服务器同步信息，如HOST，PORT, USER和 PASSWORD 等</span><br></code></pre></td></tr></table></figure>

<h4 id="跳过复制错误"><a href="#跳过复制错误" class="headerlink" title="跳过复制错误"></a>跳过复制错误</h4><blockquote>
<p><strong>可以在从服务器忽略几个主服务器的复制事件，此为global变量，或指定跳过事件的ID</strong></p>
<p>注意: Centos 8.1以上版本上的MariaDB10.3主从节点同时建同名的库和表不会冲突，建主键记录会产生冲突</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#系统变量，指定跳过复制事件的个数</span><br>SET GLOBAL sql_slave_skip_counter = N<br><br><span class="hljs-comment">#服务器选项，只读系统变量，指定跳过事件的ID；show slave status\G 可查看到错误id</span><br>[mysqld]<br>slave_skip_errors=1007|ALL<br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="START-SLAVE-语句"><a href="#START-SLAVE-语句" class="headerlink" title="START SLAVE 语句"></a>START SLAVE 语句</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">START SLAVE [thread_types]<br>START SLAVE [SQL_THREAD] UNTIL MASTER_LOG_FILE = <span class="hljs-string">&#x27;log_name&#x27;</span>, MASTER_LOG_POS = log_pos<br>START SLAVE [SQL_THREAD] UNTIL RELAY_LOG_FILE = <span class="hljs-string">&#x27;log_name&#x27;</span>, RELAY_LOG_POS = log_pos<br><br>thread_types:<br>    [thread_type [, thread_type] ... ]<br>thread_type: IO_THREAD | SQL_THREAD<br></code></pre></td></tr></table></figure>

<h4 id="范例：主从复制（非新建）"><a href="#范例：主从复制（非新建）" class="headerlink" title="范例：主从复制（非新建）"></a>范例：主从复制（非新建）</h4><blockquote>
<p><strong>模拟主服务器非新建时</strong>**,**<strong>主服务器运行一段时间后，新增从节点服务器</strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#主节点10.0.0.8</span><br>[root@master ~]<span class="hljs-comment">#dnf -y install mysql-server</span><br>[root@master ~]<span class="hljs-comment">#vim /etc/my.cnf</span><br>[mysqld]<br>server-id=8<br>log_bin=/data/logbin/mysql-bin<br>[root@master ~]<span class="hljs-comment">#mkdir /data/logbin</span><br>[root@master ~]<span class="hljs-comment">#chown mysql:mysql /data/logbin</span><br>[root@master ~]<span class="hljs-comment">#systemctl restart mysqld</span><br><br><span class="hljs-comment">#创建复制用户</span><br>mysql&gt;create user <span class="hljs-string">&#x27;repluser&#x27;</span>@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>mysql&gt;grant replication slave on *.* to <span class="hljs-string">&#x27;repluser&#x27;</span>@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;<br><span class="hljs-comment">#如果是MySQL8.0以下版本可一步实现（授权时若用户不存在会自动创建）</span><br>MariaDB [(none)]&gt; grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br><span class="hljs-comment">#完全备份(先创建授权用户在备份的好处：万一从节点成了主节点以后就不用在创建授权账号了)</span><br>[root@master ~]<span class="hljs-comment">#mysqldump -uroot -p123456 -A -F --single-transaction --master-data=1 &gt; /backup/fullbackup_`date +%F_%T`.sql</span><br>mysqldump: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>[root@master ~]<span class="hljs-comment">#scp -r /backup/ 10.0.0.18:/</span><br><br><span class="hljs-comment">#从节点10.0.0.18</span><br>[root@slave1 ~]<span class="hljs-comment">#dnf -y install mysql-server</span><br>[root@slave1 ~]<span class="hljs-comment">#vim /etc/my.cnf</span><br>[mysqld]<br>server-id=18<br>read-only <span class="hljs-comment">#只读，建议加上</span><br><br>[root@slave1 ~]<span class="hljs-comment">#systemctl restart mysqld</span><br>[root@slave1 ~]<span class="hljs-comment">#mysql </span><br>mysql&gt; <span class="hljs-built_in">help</span> change master to<br>[root@slave1 ~]<span class="hljs-comment">#vim /backup/fullbackup_2022-10-31_21\:48\:48.sql</span><br>CHANGE MASTER TO<br>  MASTER_HOST=<span class="hljs-string">&#x27;10.0.0.8&#x27;</span>,<br>  MASTER_USER=<span class="hljs-string">&#x27;repluser&#x27;</span>,<br>  MASTER_PASSWORD=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>  MASTER_PORT=3306,<br>  MASTER_LOG_FILE=<span class="hljs-string">&#x27;mysql-bin.000003&#x27;</span>, MASTER_LOG_POS=156;<br><br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=0;<br>Query OK, 0 rows affected (0.00 sec)<br>mysql&gt; <span class="hljs-built_in">source</span> fullbackup_2022-10-31_21:48:48.sql;<br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=1;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; start slave;<br>Query OK, 0 rows affected, 1 warning (0.000 sec)<br>mysql&gt; show slave status\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> <span class="hljs-built_in">source</span> to send event<br>                  Master_Host: 10.0.0.8<br>                  Master_User: repluser<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000003<br>          Read_Master_Log_Pos: 156<br>               Relay_Log_File: rocky02-relay-bin.000002<br>                Relay_Log_Pos: 324<br>        Relay_Master_Log_File: mysql-bin.000003<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>...省略...<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span>, 1 warning (0.01 sec)<br></code></pre></td></tr></table></figure>

<h3 id="1-4-实现级联复制"><a href="#1-4-实现级联复制" class="headerlink" title="1.4 实现级联复制"></a>1.4 实现级联复制</h3><blockquote>
<p>需要在中间的从服务器启用以下配置 ，<strong>实现中间slave节点能将master的二进制日志在本机进行数据库更新，并且也同时更新本机的二进制</strong>，从而实现级联复制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[mysqld]<br>server-id=18<br>log_bin<br>log_slave_updates      <span class="hljs-comment">#级联复制中间节点的必选项,MySQL8.0此为默认值,可以不要人为添加,其它版本默认不开启</span><br>read-only<br></code></pre></td></tr></table></figure>
</blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202211/2927659-20221101211217831-989078873.png"><img src="2927659-20221101211217831-989078873.png" srcset="/img/loading.gif" lazyload alt="img"></a></strong></p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在10.0.0.8充当master</span><br><span class="hljs-comment">#在10.0.0.18充当级联slave</span><br><span class="hljs-comment">#在10.0.0.28充当slave</span><br><span class="hljs-comment">#在master实现</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/my.cnf.d/mariadb-server.cnf</span><br>[mysqld]<br>server-id=8<br>log-bin  <br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart mariadb</span><br>[root@centos8 ~]<span class="hljs-comment">#mysql </span><br>MariaDB [(none)]&gt; grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>[root@centos8 ~]<span class="hljs-comment">#mysqldump -A -F --single-transaction --master-data=1 &gt; /data/all.sql</span><br>[root@centos8 ~]<span class="hljs-comment">#scp /data/all.sql 10.0.0.18:/data</span><br>[root@centos8 ~]<span class="hljs-comment">#scp /data/all.sql 10.0.0.28:/data</span><br><br><span class="hljs-comment">#在中间级联slave实现</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/my.cnf.d/mariadb-server.cnf</span><br>[mysqld]<br>server-id=18<br>log-bin<br>read-only<br>log_slave_updates  <span class="hljs-comment">#级联复制中间节点的必选项,MySQL8.0此为默认值,可以不要人为添加</span><br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart mariadb</span><br><span class="hljs-comment">#还原数据库</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /data/all.sql</span><br>CHANGE MASTER TO<br>  MASTER_HOST=<span class="hljs-string">&#x27;master节点的iP&#x27;</span>,<br>  MASTER_USER=<span class="hljs-string">&#x27;repluser&#x27;</span>,<br>  MASTER_PASSWORD=<span class="hljs-string">&#x27;centos&#x27;</span>,<br>  MASTER_PORT=3306,<br>  MASTER_LOG_FILE=<span class="hljs-string">&#x27;mysql-bin.000004&#x27;</span>,<br>  MASTER_LOG_POS=523;<br>  <br>[root@centos8 ~]<span class="hljs-comment">#mysql </span><br>MariaDB [(none)]&gt; <span class="hljs-built_in">set</span> sql_log_bin=0;<br>MariaDB [(none)]&gt; <span class="hljs-built_in">source</span> /data/all.sql<br>MariaDB [(none)]&gt; show master logs;  <span class="hljs-comment">#记录二进制位置，给第三个节点使用  </span><br>MariaDB [(none)]&gt; <span class="hljs-built_in">set</span> sql_log_bin=0;<br>MariaDB [(none)]&gt; start slave;<br><br><span class="hljs-comment">#在第三个节点slave上实现</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/my.cnf.d/mariadb-server.cnf</span><br>[mysqld]<br>server-id=28<br>read-only<br>[root@centos8 ~]<span class="hljs-comment">#systemctl restart mariadb</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /data/all.sql </span><br>CHANGE MASTER TO<br>MASTER_HOST=<span class="hljs-string">&#x27;中间节点的IP&#x27;</span>,<br>MASTER_USER=<span class="hljs-string">&#x27;repluser&#x27;</span>,<br>MASTER_PASSWORD=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>MASTER_PORT=3306,<br>MASTER_LOG_FILE=<span class="hljs-string">&#x27;mariadb-bin.000002&#x27;</span>, MASTER_LOG_POS=344; <br>[root@centos8 ~]<span class="hljs-comment">#mysql &lt; /data/all.sql</span><br>[root@centos8 ~]<span class="hljs-comment">#mysql -e &#x27;start slave;&#x27;</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="1-5-主主复制"><a href="#1-5-主主复制" class="headerlink" title="1.5 主主复制"></a>1.5 主主复制</h3><blockquote>
<p>主主复制：两个节点，都可以更新数据，并且互为主从</p>
<p>容易产生的问题：数据不一致；因此慎用</p>
<p>考虑要点：自动增长id</p>
<p><strong>配置一个节点使用奇数id</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">auto_increment_offset=1   <span class="hljs-comment">#开始点</span><br>auto_increment_increment=2 <span class="hljs-comment">#增长幅度</span><br></code></pre></td></tr></table></figure>

<p><strong>另一个节点使用偶数id</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">auto_increment_offset=2<br>auto_increment_increment=2<br></code></pre></td></tr></table></figure>

<p><strong>主主复制的配置步骤：</strong></p>
<ul>
<li>(1) 各节点使用一个惟一server_id</li>
<li>(2) 都启动binary log和relay log</li>
<li>(3) 创建拥有复制权限的用户账号</li>
<li>(4) 定义自动增长id字段的数值范围各为奇偶</li>
<li>(5) 均把对方指定为主节点，并启动复制线程</li>
</ul>
</blockquote>
<h3 id="1-6-半同步复制"><a href="#1-6-半同步复制" class="headerlink" title="1.6 半同步复制"></a>1.6 半同步复制</h3><blockquote>
<ul>
<li><strong>默认情况下，MySQL的复制功能是异步的，异步复制可以提供最佳的性能，主库把binlog日志发送给从库即结束，并不验证从库是否接收完毕。这意味着当主服务器或从服务器端发生故障时，有可能从服务器没有接收到主服务器发送过来的binlog日志，这就会造成主服务器和从服务器的数据不一致，甚至在恢复时造成数据的丢失</strong></li>
<li>MySQL5.5版本为了保证主从数据的一致性问题。加入了<strong>半同步复制的组件(插件)</strong>,可以控制从库IO线程是否将relaylog落盘，一旦落盘通过插件返回ACK给主库ACK_REC。接受到ACK之后，主库的事务才能提交成功。在默认情况下，如果<strong>超过10秒没有返回ACK，此次复制行为会切换为异步复制</strong></li>
<li>在MySQL5.6,5.7 当中也加入了一些比较好的特性，也不能完全保证的数据一致。如果生产业务比较关注主从最终一致(比如:金融等)。推荐可以使用MGR的架构，或者PXC等一致性架构</li>
</ul>
</blockquote>
<blockquote>
<p><strong>半同步复制默认设置</strong></p>
<ul>
<li>缺点1： 幻读</li>
</ul>
<p>     当用户提交一个事务，该事务已经写入redo日志和binlog日志，但该事务还没写入从库，</p>
<p>     此时处在waiting slave dump处，此时另一个用户可以读取到这条数据，而他自己却不能；</p>
<ul>
<li>缺点2：数据丢失</li>
</ul>
<p>     一个提交的事务在waiting slave dump处crash后，主库将比从库多一条数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpl_semi_sync_master_wait_point=after_commit<br></code></pre></td></tr></table></figure>

<p><strong>增强半同步复制(MySQL5.7新增功能)</strong></p>
<ul>
<li>改善1：解决幻读</li>
</ul>
<p>     当用户发起一个事务，该事务先写入二进制后，再向从库进行同步，由于还没有完成提交，</p>
<p>     此时其他用户无法读取到该数据，解决了幻读</p>
<ul>
<li>改善2：解决数据丢失</li>
</ul>
<p>     一个事务在waiting slave dump处crash掉后，可以通过观察从库上是否存在主库的last gtid值，</p>
<p>     如果存在，这条数据正常恢复，如果不存在则删除主库的那条多余的GTID值，然后恢复，保证了数据的完整性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpl_semi_rsync_master_wait_point=after_sync<br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="范例：MySQL8-0-实现半同步复制"><a href="#范例：MySQL8-0-实现半同步复制" class="headerlink" title="范例：MySQL8.0 实现半同步复制"></a>范例：MySQL8.0 实现半同步复制</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#前提：已完成主从（默认的异步复制）</span><br><span class="hljs-comment">#查看插件文件</span><br>[root@rocky01 ~]<span class="hljs-comment"># rpm -ql mysql-server |grep semisync</span><br>/usr/lib64/mysql/plugin/semisync_master.so<br>/usr/lib64/mysql/plugin/semisync_slave.so<br><br><span class="hljs-comment">#master服务器10.0.0.8配置</span><br>[root@master ~]<span class="hljs-comment"># mysql</span><br>mysql&gt; INSTALL PLUGIN rpl_semi_sync_master SONAME <span class="hljs-string">&#x27;semisync_master.so&#x27;</span>; <span class="hljs-comment">#永久安装插件</span><br>mysql&gt; SHOW PLUGINS; <span class="hljs-comment">#查看插件</span><br>[root@master ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>server-id=8<br>log_bin=/data/logbin/mysql-bin<br>rpl_semi_sync_master_enabled=ON    <span class="hljs-comment">#修改此行,需要先安装semisync_master.so插件后,再重启,否则无法启动</span><br>rpl_semi_sync_master_timeout=3000  <span class="hljs-comment">#设置3s内无法同步（默认10s），也将返回成功信息给客户端</span><br>[root@master ~]<span class="hljs-comment"># systemctl restart mysqld</span><br><br><span class="hljs-comment">#slave1服务器10.0.0.18配置</span><br>[root@slave1 ~]<span class="hljs-comment"># mysql</span><br>mysql&gt; INSTALL PLUGIN rpl_semi_sync_slave SONAME <span class="hljs-string">&#x27;semisync_slave.so&#x27;</span>;<span class="hljs-comment">#永久安装插件</span><br>[root@slave1 ~]<span class="hljs-comment">#vim /etc/my.cnf</span><br>[mysqld]<br>server-id=18<br>read-only<br>rpl_semi_sync_slave_enabled=ON    <span class="hljs-comment">#修改此行,需要先安装semisync_slave.so插件后,再重启,否则无法启动</span><br>[root@slave1 ~]<span class="hljs-comment"># systemctl restart mysqld</span><br><br><span class="hljs-comment">#slave2服务器10.0.0.28配置</span><br>[root@slave2 ~]<span class="hljs-comment"># mysql</span><br>mysql&gt; INSTALL PLUGIN rpl_semi_sync_slave SONAME <span class="hljs-string">&#x27;semisync_slave.so&#x27;</span>;<span class="hljs-comment">#永久安装插件</span><br>[root@slave2 ~]<span class="hljs-comment">#vim /etc/my.cnf</span><br>[mysqld]<br>server-id=28<br>read-only<br>rpl_semi_sync_slave_enabled=ON    <span class="hljs-comment">#修改此行,需要先安装semisync_slave.so插件后,再重启,否则无法启动</span><br>[root@slave2 ~]<span class="hljs-comment"># systemctl restart mysqld</span><br><br><span class="hljs-comment">#以上步骤已完成半同步复制！</span><br><span class="hljs-comment">#主服务器相关命令:</span><br>mysql&gt;UNINSTALL PLUGIN rpl_semi_sync_master ; <span class="hljs-comment">#卸载插件</span><br>mysql&gt;SHOW PLUGINS; <span class="hljs-comment">#查看插件</span><br>mysql&gt;SET GLOBAL rpl_semi_sync_master_enabled=1; <span class="hljs-comment">#临时修改变量</span><br>mysql&gt;SET GLOBAL rpl_semi_sync_master_timeout = 3000;  <span class="hljs-comment">#临时超时长1s,默认值为10s</span><br><br>mysql&gt;SHOW GLOBAL VARIABLES LIKE <span class="hljs-string">&#x27;%semi%&#x27;</span>;<br>+-------------------------------------------+------------+<br>| Variable_name                             | Value      |<br>+-------------------------------------------+------------+<br>| rpl_semi_sync_master_enabled              | ON         |<br>| rpl_semi_sync_master_timeout              | 3000       |<br>| rpl_semi_sync_master_trace_level          | 32         |<br>| rpl_semi_sync_master_wait_for_slave_count | 1          |<br>| rpl_semi_sync_master_wait_no_slave        | ON         |<br>| rpl_semi_sync_master_wait_point           | AFTER_SYNC |<br>+-------------------------------------------+------------+<br>6 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>mysql&gt; SHOW GLOBAL STATUS LIKE <span class="hljs-string">&#x27;%semi%&#x27;</span>;<br>+--------------------------------------------+-------+<br>| Variable_name                              | Value |<br>+--------------------------------------------+-------+<br>| Rpl_semi_sync_master_clients               | 2     |<br>| Rpl_semi_sync_master_net_avg_wait_time     | 0     |<br>| Rpl_semi_sync_master_net_wait_time         | 0     |<br>| Rpl_semi_sync_master_net_waits             | 4     |<br>| Rpl_semi_sync_master_no_times              | 1     |<br>| Rpl_semi_sync_master_no_tx                 | 1     |<br>| Rpl_semi_sync_master_status                | ON    |<br>| Rpl_semi_sync_master_timefunc_failures     | 0     |<br>| Rpl_semi_sync_master_tx_avg_wait_time      | 669   |<br>| Rpl_semi_sync_master_tx_wait_time          | 1339  |<br>| Rpl_semi_sync_master_tx_waits              | 2     |<br>| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |<br>| Rpl_semi_sync_master_wait_sessions         | 0     |<br>| Rpl_semi_sync_master_yes_tx                | 2     |<br>+--------------------------------------------+-------+<br>14 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#从服务器相关命令:</span><br>mysql&gt;SET GLOBAL rpl_semi_sync_slave_enabled=1; <span class="hljs-comment">#临时修改变量</span><br><br>mysql&gt; SHOW GLOBAL VARIABLES LIKE <span class="hljs-string">&#x27;%semi%&#x27;</span>;<br>+---------------------------------+-------+<br>| Variable_name                   | Value |<br>+---------------------------------+-------+<br>| rpl_semi_sync_slave_enabled     | ON    |<br>| rpl_semi_sync_slave_trace_level | 32    |<br>+---------------------------------+-------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><br><span class="hljs-comment">#注意:如果已经实现主从复制,需要stop slave;start slave;</span><br>mysql&gt; stop slave;<br>mysql&gt; start slave;<br>mysql&gt; SHOW GLOBAL STATUS LIKE <span class="hljs-string">&#x27;%semi%&#x27;</span>;<br>+----------------------------+-------+<br>| Variable_name              | Value |<br>+----------------------------+-------+<br>| Rpl_semi_sync_slave_status | ON    |<br>+----------------------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure>

<h3 id="1-7-复制过滤器"><a href="#1-7-复制过滤器" class="headerlink" title="1.7 复制过滤器"></a>1.7 复制过滤器</h3><blockquote>
<p>让从节点仅复制指定的数据库，或指定数据库的指定表</p>
<p><strong>复制过滤器两种实现方式：</strong></p>
<p>(1) 服务器选项：主服务器仅向二进制日志中记录与特定数据库相关的事件</p>
<ul>
<li>缺点：基于二进制还原将无法实现；不建议使用</li>
<li>优点: 只需要在主节点配置一次即可</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/my.cnf<br>binlog-do-db=db1 <span class="hljs-comment">#数据库白名单列表，不支持同时指定多个值，如果想实现多个数据库需多行实现</span><br>binlog-do-db=db2 <br>binlog-ignore-db= <span class="hljs-comment">#数据库黑名单列表</span><br></code></pre></td></tr></table></figure>

<p>(2) 从服务器SQL_THREAD在relay log中的事件时，仅读取与特定数据库(特定表)相关的事件并应用于本地</p>
<ul>
<li>缺点：会造成网络及磁盘IO浪费,在所有从节点都要配置</li>
<li>优点: 不影响二进制备份还原</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#从服务器 上的复制过滤器相关变量</span><br>replicate_do_db=<span class="hljs-string">&quot;db1,db2,db3&quot;</span> <span class="hljs-comment">#指定复制库的白名单，变量可以指定逗号分隔的多个值，选项不支持多值,只能分别写多行实现</span><br>replicate_ignore_db= <span class="hljs-comment">#指定复制库黑名单</span><br>replicate_do_table= <span class="hljs-comment">#指定复制表的白名单</span><br>replicate_ignore_table= <span class="hljs-comment">#指定复制表的黑名单</span><br>replicate_wild_do_table= foo%.bar%  <span class="hljs-comment">#支持通配符</span><br>replicate_wild_ignore_table=<br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="1-8-GTID复制"><a href="#1-8-GTID复制" class="headerlink" title="1.8 GTID复制"></a>1.8 GTID复制</h3><blockquote>
<p><strong>GTID</strong> <strong>优点</strong><strong>:</strong></p>
<ul>
<li><p>保证事务全局统一</p>
</li>
<li><p>截取日志更加方便。跨多文件，判断起点终点更加方便</p>
</li>
<li><p>判断主从工作状态更加方便</p>
</li>
<li><p>传输日志，<strong>可以并发传输</strong>。SQL回放可以更高并发</p>
</li>
<li><p>主从复制构建更加方便</p>
</li>
<li><p>GTID = server_uuid:transaction_id，在一组复制中，全局唯一</p>
</li>
<li><p>server_uuid 来源于 /var/lib/mysql/auto.cnf</p>
</li>
</ul>
</blockquote>
<h4 id="1-8-1-GTID服务器相关选项"><a href="#1-8-1-GTID服务器相关选项" class="headerlink" title="1.8.1 GTID服务器相关选项"></a>1.8.1 GTID服务器相关选项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">gtid_mode <span class="hljs-comment">#gtid模式</span><br>enforce_gtid_consistency <span class="hljs-comment">#保证GTID安全的参数</span><br></code></pre></td></tr></table></figure>

<h4 id="1-8-2-GTID配置范例"><a href="#1-8-2-GTID配置范例" class="headerlink" title="1.8.2 GTID配置范例"></a>1.8.2 GTID配置范例</h4><h5 id="（1）主服务器"><a href="#（1）主服务器" class="headerlink" title="（1）主服务器"></a>（1）主服务器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/my.cnf<br>server-id=8<br>gtid_mode=ON<br>enforce_gtid_consistency<br>log-bin=mysql-bin<br><br>systemctl restart mysqld<br>mysql&gt; grant replication slave on *.* to <span class="hljs-string">&#x27;repluser&#x27;</span>@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h5 id="（2）从服务器"><a href="#（2）从服务器" class="headerlink" title="（2）从服务器"></a>（2）从服务器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/my.cnf<br>server-id=18<br>gtid_mode=ON<br>enforce_gtid_consistency<br><br>systemctl restart mysqld<br><br><span class="hljs-comment">#如果主服务器和从服务器数据不一致,需要先将主库数据备份还原至从库,再执行下面操作</span><br>mysqldump -A --master-data=2 &gt; /backup/full.sql<br>mysql&gt;CHANGE MASTER TO MASTER_HOST=<span class="hljs-string">&#x27;10.0.0.8&#x27;</span>,<br> MASTER_USER=<span class="hljs-string">&#x27;repluser&#x27;</span>,<br> MASTER_PASSWORD=<span class="hljs-string">&#x27;123456&#x27;</span>,<br> MASTER_PORT=3306,<br> MASTER_AUTO_POSITION=1;  <span class="hljs-comment">#使用GTID</span><br> <br> mysql&gt;start slave;<br><span class="hljs-comment">#注意观察:Retrieved_Gtid_set和Executed_Gtid_Set这两个值,</span><br><span class="hljs-comment">#对比主节点执行show master status的值,如果相同表示同步完成</span><br></code></pre></td></tr></table></figure>

<h3 id="1-9-MySQL-主从数据不一致（面试重点）"><a href="#1-9-MySQL-主从数据不一致（面试重点）" class="headerlink" title="1.9 MySQL 主从数据不一致（面试重点）"></a>1.9 MySQL 主从数据不一致（面试重点）</h3><h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><blockquote>
<ul>
<li><strong>主库binlog格式为Statement，同步到从库执行后可能造成主从不一致。</strong></li>
<li><strong>主库执行更改前有执行set sql_log_bin=0，会使主库不记录binlog，从库也无法变更这部分数据。</strong></li>
<li><strong>从节点未设置只读，误操作写入数据</strong></li>
<li><strong>主库或从库意外宕机，宕机可能会造成binlog或者relaylog文件出现损坏，导致主从不一致</strong></li>
<li><strong>主从实例版本不一致，特别是高版本是主，低版本为从的情况下，主数据库上面支持的功能，从数据库上面可能不支持该功能</strong></li>
<li><strong>主从sql_mode 不一致</strong></li>
<li><strong>MySQL自身bug导致</strong></li>
</ul>
</blockquote>
<h4 id="修复方法"><a href="#修复方法" class="headerlink" title="修复方法"></a>修复方法</h4><blockquote>
<ul>
<li>将从库重新实现</li>
</ul>
<p>虽然这也是一种解决方法，但是这个方案恢复时间比较慢，而且有时候从库也是承担一部分的查询操作的，不能贸然重建。</p>
<ul>
<li>使用percona-toolkit工具辅助</li>
</ul>
<p>PT工具包中包含pt-table-checksum和pt-table-sync两个工具，主要用于检测主从是否一致以及修复数据不一致情况。这种方案优点是修复速度快，不需要停止主从辅助，缺点是需要知识积累，需要时间去学习，去测试，特别是在生产环境，还是要小心使用</p>
<ul>
<li>手动重建不一致的表</li>
</ul>
<p>在从库发现某几张表与主库数据不一致，而这几张表数据量也比较大，手工比对数据不现实，并且重做整个库也比较慢，这个时候可以只重做这几张表来修复主从不一致这种方案缺点是在执行导入期间需要暂时停止从库复制，不过也是可以接受的</p>
<p><strong>范例：A,B,C这三张表主从数据不一致</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#1、从库停止Slave复制</span><br>mysql&gt;stop slave;<br><br><span class="hljs-comment">#2、在主库上dump这三张表，并记录下同步的binlog和POS点</span><br>mysqldump -uroot -p123456 -q --single-transaction --master-data=2 testdb A B C &gt;/backup/A_B_C.sql<br><br><span class="hljs-comment">#3、查看A_B_C.sql文件，找出记录的binlog和POS点</span><br><span class="hljs-built_in">head</span> A_B_C.sql<br><span class="hljs-comment">#例如:MASTERLOGFILE=&#x27;mysql-bin.000002&#x27;, MASTERLOGPOS=123;</span><br><br><span class="hljs-comment">#以下指令是为了保障其他表的数据不丢失，一直同步直到那个点结束，</span><br><span class="hljs-comment">#A,B,C表的数据在之前的备份已经生成了一份快照，只需要导入进入，然后开启同步即可</span><br><span class="hljs-comment">#4、把A_B_C.sql拷贝到Slave机器上，并做指向新位置</span><br>mysql&gt;start slave until MASTERLOGFILE=<span class="hljs-string">&#x27;mysql-bin.000002&#x27;</span>, MASTERLOGPOS=123;<br><br><span class="hljs-comment">#5、在Slave机器上导入A_B_C.sql</span><br>mysql -uroot -p123456 testdb <br>mysql&gt;<span class="hljs-built_in">set</span> sql_log_bin=0;<br>mysql&gt;<span class="hljs-built_in">source</span> /backup/A_B_C.sql<br>mysql&gt;<span class="hljs-built_in">set</span> sql_log_bin=1;<br><br><span class="hljs-comment">#6、导入完毕后，从库开启同步即可。</span><br>mysql&gt;start slave;<br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="如何避免"><a href="#如何避免" class="headerlink" title="如何避免"></a>如何避免</h4><blockquote>
<ul>
<li><strong>主库binlog采用ROW格式</strong></li>
<li><strong>主从实例数据库版本保持一致</strong></li>
<li><strong>主库做好账号权限把控，不可以执行set sql_log_bin=0</strong></li>
<li><strong>从库开启只读，不允许人为写入</strong></li>
<li><strong>定期进行主从一致性检验</strong></li>
</ul>
</blockquote>
<h2 id="2-MySQL-中间件代理服务器"><a href="#2-MySQL-中间件代理服务器" class="headerlink" title="2 MySQL 中间件代理服务器"></a>2 MySQL 中间件代理服务器</h2><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202211/2927659-20221102173735932-1137784711.png"><img src="2927659-20221102173735932-1137784711.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h3 id="2-1-Mycat"><a href="#2-1-Mycat" class="headerlink" title="2.1 Mycat"></a>2.1 Mycat</h3><blockquote>
<p><strong>基于心跳的自动故障切换，支持读写分离，支持MySQL主从，以及galera cluster集群</strong></p>
<p><strong>配置文件：</strong></p>
<ul>
<li>server.xml Mycat软件本身相关的配置文件，设置账号、参数等</li>
<li>schema.xml Mycat对应的物理数据库和数据库表的配置,读写分离、高可用、分布式策略定制、节点控制</li>
</ul>
</blockquote>
<h4 id="2-1-1-Mycat-安装"><a href="#2-1-1-Mycat-安装" class="headerlink" title="2.1.1 Mycat 安装"></a>2.1.1 Mycat 安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注：以下操作未实现读写分离</span><br><span class="hljs-comment">#1.下载安装JDK</span><br>yum -y install java<br><span class="hljs-comment">#确认安装成功</span><br>java -version<br><br><span class="hljs-comment">#2.下载安装mycat</span><br>wget http://dl.mycat.org.cn/1.6.7.4/Mycat-server-1.6.7.4-release/Mycat-server-1.6.7.4-release-20200105164103-linux.tar.gz<br><span class="hljs-built_in">mkdir</span> /apps<br>tar xvf Mycat-server-1.6.7.4-release-20200105164103-linux.tar.gz -C /apps<br><br><span class="hljs-comment">#3.配置环境变量</span><br>vim /etc/profile.d/mycat.sh<br>PATH=/apps/mycat/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">source</span> /etc/profile.d/mycat.sh<br><br><span class="hljs-comment">#4.启动并查看日志，确定成功</span><br>mycat start<br><span class="hljs-built_in">cat</span> /app/mycat/logs/wrapper.log <br>...省略...<br>INFO   | jvm 1   | 2019/11/01 21:41:02 | MyCAT Server startup successfully. see logs <span class="hljs-keyword">in</span> logs/mycat.log<br><br><span class="hljs-comment">#5.连接mycat：</span><br>mysql -uroot -p123456 -h 127.0.0.1 -P8066<br></code></pre></td></tr></table></figure>

<h4 id="实战案例：Mycat-实现读写分离"><a href="#实战案例：Mycat-实现读写分离" class="headerlink" title="实战案例：Mycat 实现读写分离"></a>实战案例：Mycat 实现读写分离</h4><blockquote>
<p><strong>服务器共三台</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">mycat 10.0.0.88 <span class="hljs-comment">#内存建议2G以上</span><br>master 10.0.0.8 MySQL 8.0 或者Mariadb 10.3.17<br>slave  10.0.0.18 MySQL 8.0 或者Mariadb 10.3.17<br></code></pre></td></tr></table></figure>

<p><strong>关闭<strong><strong>SELinux</strong></strong>和防火墙</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl stop firewalld<br>setenforce 0<br>时间同步<br></code></pre></td></tr></table></figure>
</blockquote>
<p><strong>（1）创建 MySQL 主从数据库</strong></p>
<p><strong>（2）<strong><strong>安装</strong></strong>mycat****并启动</strong></p>
<p><strong>（3）****mycat</strong> <strong>服务器上修改<strong><strong>server.xml</strong></strong>文件配置<strong><strong>Mycat</strong></strong>的连接信息</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@mycat ~]<span class="hljs-comment"># vim /apps/mycat/conf/server.xml</span><br>...省略...<br><span class="hljs-comment">#修改下面行的8066改为3306复制到到独立非注释行</span><br>&lt;property name=<span class="hljs-string">&quot;serverPort&quot;</span>&gt;3306&lt;/property&gt;<br>&lt;property name=<span class="hljs-string">&quot;handlelDistributedTransactions&quot;</span>&gt;0&lt;/property&gt; <span class="hljs-comment">#将上面行放在此行前面</span><br><br><span class="hljs-comment">#或者删除注释,并修改下面行的8066改为3306</span><br>&lt;property name=<span class="hljs-string">&quot;serverPort&quot;</span>&gt;3306&lt;/property&gt;<br>&lt;property name=<span class="hljs-string">&quot;managerPort&quot;</span>&gt;9066&lt;/property&gt;<br>&lt;property name=<span class="hljs-string">&quot;idleTimeout&quot;</span>&gt;300000&lt;/property&gt;<br>&lt;property name=<span class="hljs-string">&quot;authTimeout&quot;</span>&gt;15000&lt;/property&gt;<br>&lt;property name=<span class="hljs-string">&quot;bindIp&quot;</span>&gt;0.0.0.0&lt;/property&gt;<br>&lt;property name=<span class="hljs-string">&quot;dataNodeIdleCheckPeriod&quot;</span>&gt;300000&lt;/property&gt; <span class="hljs-comment">#5 * 60 * 1000L; //连接空闲检查 删除#后面此部分</span><br>&lt;property name=<span class="hljs-string">&quot;frontWriteQueueSize&quot;</span>&gt;4096&lt;/property&gt; &lt;property name=<span class="hljs-string">&quot;processors&quot;</span>&gt;32&lt;/property&gt; <span class="hljs-comment">#--&gt; 删除#后面此部分</span><br> .....<br>&lt;user name=<span class="hljs-string">&quot;root&quot;</span>&gt;                              <span class="hljs-comment">#连接Mycat的用户名</span><br>   &lt;property name=<span class="hljs-string">&quot;password&quot;</span>&gt;123456&lt;/property&gt;          <span class="hljs-comment">#连接Mycat的密码</span><br>   &lt;property name=<span class="hljs-string">&quot;schemas&quot;</span>&gt;TESTDB&lt;/property&gt;           <span class="hljs-comment">#数据库名要和schema.xml相对应</span><br>&lt;/user&gt;<br>&lt;/mycat:server&gt;<br><br><br><span class="hljs-comment">#这里使用的是root，密码为123456,逻辑数据库为TESTDB，这些信息都可以自己随意定义,</span><br><span class="hljs-comment">#读写权限都有，没有针对表做任何特殊的权限。重点关注上面这段配置，其他默认即可。</span><br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202211/2927659-20221103020600806-794369464.png"><img src="2927659-20221103020600806-794369464.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p><strong>（4）修改schema.xml实现读写分离策略</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">###  先删除所有&lt;!--  --&gt; 和&lt;table&gt;&lt;/table&gt; 的内容在对照下面的增删改  ###</span><br>[root@mycat ~]<span class="hljs-comment"># cat /apps/mycat/conf/schema.xml</span><br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span>?&gt;<br>&lt;!DOCTYPE mycat:schema SYSTEM <span class="hljs-string">&quot;schema.dtd&quot;</span>&gt;<br>&lt;mycat:schema xmlns:mycat=<span class="hljs-string">&quot;http://io.mycat/&quot;</span>&gt;<br>    &lt;schema name=<span class="hljs-string">&quot;TESTDB&quot;</span> checkSQLschema=<span class="hljs-string">&quot;false&quot;</span> sqlMaxLimit=<span class="hljs-string">&quot;100&quot;</span> dataNode=<span class="hljs-string">&quot;dn1&quot;</span>&gt;<br>    &lt;/schema&gt;<br>    &lt;dataNode name=<span class="hljs-string">&quot;dn1&quot;</span> dataHost=<span class="hljs-string">&quot;localhost1&quot;</span> database=<span class="hljs-string">&quot;hellodb&quot;</span> /&gt;<br>    &lt;dataHost name=<span class="hljs-string">&quot;localhost1&quot;</span> maxCon=<span class="hljs-string">&quot;1000&quot;</span> minCon=<span class="hljs-string">&quot;10&quot;</span> balance=<span class="hljs-string">&quot;1&quot;</span><br>              writeType=<span class="hljs-string">&quot;0&quot;</span> dbType=<span class="hljs-string">&quot;mysql&quot;</span> dbDriver=<span class="hljs-string">&quot;native&quot;</span> switchType=<span class="hljs-string">&quot;1&quot;</span>  slaveThreshold=<span class="hljs-string">&quot;100&quot;</span>&gt;<br>        &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;<br>        &lt;writeHost host=<span class="hljs-string">&quot;host1&quot;</span> url=<span class="hljs-string">&quot;10.0.0.8:3306&quot;</span> user=<span class="hljs-string">&quot;admin&quot;</span><br>                   password=<span class="hljs-string">&quot;123456&quot;</span>&gt;<br>         &lt;readHost host=<span class="hljs-string">&quot;host2&quot;</span> url=<span class="hljs-string">&quot;10.0.0.18:3306&quot;</span> user=<span class="hljs-string">&quot;admin&quot;</span> password=<span class="hljs-string">&quot;123456&quot;</span> /&gt;<br>        &lt;/writeHost&gt;<br>    &lt;/dataHost&gt;<br>&lt;/mycat:schema&gt;<br><br><span class="hljs-comment">###上面配置中，balance改为1，表示读写分离。</span><br><span class="hljs-comment">###需要赋予上面admin账号所有权限*.*</span><br><span class="hljs-comment">###以上配置达到的效果就是10.0.0.18为主库，10.0.0.28为从库。实现的是hellodb数据库的读写分离</span><br><span class="hljs-comment">###checkSQLschema 数据库前缀相关设置，这里为false</span><br><span class="hljs-comment">###balance=&quot;0&quot;: 不开启读写分离，读操作和写操作都是用的writeHost；</span><br><span class="hljs-comment">###balance=&quot;1&quot;: 开启读写分离，这种情况是存在多主多从的时候，一个主节点提供写操作，其他的主节点和所有从节点提供负载均衡的读操作</span><br><span class="hljs-comment">###balance=&quot;2&quot;: 读操作随机读选择主节点和从节点</span><br><span class="hljs-comment">###balance=&quot;3&quot;: 开启读写分离，写操作使用写主机（主节点也就是写主机，从节点是读主机），读操作使用读主</span><br></code></pre></td></tr></table></figure>

<p><strong>（5）重新启动mycat</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@mycat ~]<span class="hljs-comment"># mycat restart</span><br></code></pre></td></tr></table></figure>

<p><strong>（6）在主服务器创建用户并对mycat授权</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#mysql -uroot -p</span><br>mysql&gt;GRANT ALL ON *.* TO <span class="hljs-string">&#x27;admin&#x27;</span>@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;123456&#x27;</span> ;<br>mysql&gt; flush privileges;<br></code></pre></td></tr></table></figure>

<p><strong>（7）在<strong><strong>Mycat</strong></strong>服务器上连接并测试</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@mycat ~]<span class="hljs-comment"># mysql -uroot -p123456 -h127.0.0.1 TESTDB</span><br>mysql&gt; show databases;<br>+----------+<br>| DATABASE |<br>+----------+<br>| TESTDB   |   //只能看一个虚拟数据库<br></code></pre></td></tr></table></figure>

<p><strong>（8）通过通用日志确认实现读写分离</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在mysql中查看通用日志方法如下</span><br>show variables like <span class="hljs-string">&#x27;general_log&#x27;</span>;  <span class="hljs-comment">#查看日志是否开启</span><br><span class="hljs-built_in">set</span> global general_log=on;    <span class="hljs-comment">#开启日志功能</span><br>show variables like <span class="hljs-string">&#x27;general_log_file&#x27;</span>; <span class="hljs-comment">#查看日志文件保存位置</span><br><span class="hljs-built_in">set</span> global general_log_file=<span class="hljs-string">&#x27;tmp/general.log&#x27;</span>; <span class="hljs-comment">#设置日志文件保存位置</span><br><br><span class="hljs-comment">#在主和从服务器分别启用通用日志，查看读写分离（下面的是主节点，从节点操作一样）</span><br>[root@master ~]<span class="hljs-comment"># vim /etc/my.cnf.d/mariadb-server.cnf</span><br>[mysqld]<br>general_log=ON<br>[root@master ~]<span class="hljs-comment"># systemctl restart mariadb</span><br>[root@master ~]<span class="hljs-comment"># tail -f /var/lib/mysql/master.log</span><br></code></pre></td></tr></table></figure>

<p><strong>（9）MyCAT对后端服务器的健康性检查方法select user()</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#mycat判断数据库得存活性，定期发送(默认5秒/次) select user()</span><br><span class="hljs-comment">#查看通用日志</span><br>[root@master ~]<span class="hljs-comment"># tail -f /var/lib/mysql/master.log </span><br>/usr/libexec/mysqld, Version: 8.0.17 (Source distribution). started with:<br>Tcp port: 3306 Unix socket: /var/lib/mysql/mysql.sock<br>Time                 Id Command   Argument<br>2021-02-22T08:52:57.086198Z   17 Query select user()<br>2021-02-22T08:53:07.086340Z   24 Query select user()<br>2021-02-22T08:53:17.086095Z   16 Query select user()<br>2021-02-22T08:53:27.086629Z   18 Query select user()<br><br><br><span class="hljs-comment">#停止从节点，MyCAT自动调度“读”请求至主节点</span><br><span class="hljs-comment">#停止主节点，MyCAT不会自动调度“写”请求至从节点</span><br></code></pre></td></tr></table></figure>

<h3 id="2-2-ProxySQL"><a href="#2-2-ProxySQL" class="headerlink" title="2.2 ProxySQL"></a>2.2 ProxySQL</h3><blockquote>
<p> 暂略</p>
</blockquote>
<h2 id="3-MySQL-高可用"><a href="#3-MySQL-高可用" class="headerlink" title="3 MySQL 高可用"></a>3 MySQL 高可用</h2><h3 id="3-1-MHA-Master-High-Availability"><a href="#3-1-MHA-Master-High-Availability" class="headerlink" title="3.1 MHA Master High Availability"></a>3.1 MHA Master High Availability</h3><blockquote>
<p><strong>MHA****工作原理</strong></p>
<ul>
<li>MHA利用 SELECT 1 As Value 指令判断master服务器的健康性,<strong>一旦master 宕机，MHA 从宕机崩溃的master保存二进制日志事件</strong>（binlog events）<strong>识别含有最新更新的slave</strong></li>
<li>应用差异的中继日志（relay log）到其他的slave</li>
<li>应用从master保存的二进制日志事件（binlog events）到所有slave节点</li>
<li><strong>提升一个slave为新的master</strong></li>
<li>使其他的slave连接新的master进行复制</li>
<li>故障服务器自动被剔除集群(masterha_conf_host),将配置信息去掉</li>
<li><strong>MHA是一次性的高可用性解决方案,Manager会自动退出</strong></li>
</ul>
<p><strong>注意：</strong></p>
<p>为了尽可能的减少主库硬件损坏宕机造成的数据丢失，因此在配置MHA的同时<strong>建议配置成MySQL的半同步复制</strong></p>
</blockquote>
<h4 id="实战案例：实现-MHA"><a href="#实战案例：实现-MHA" class="headerlink" title="实战案例：实现 MHA"></a>实战案例：实现 MHA</h4><p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202211/2927659-20221103162914460-1126578628.png"><img src="2927659-20221103162914460-1126578628.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<blockquote>
<p><strong>环境:四台主机</strong></p>
<ul>
<li>10.0.0.7 CentOS7 MHA管理端</li>
<li>10.0.0.8 CentOS8 MySQL8.0 Master</li>
<li>10.0.0.18 CentOS8 MySQL8.0 Slave1</li>
<li>10.0.0.28 CentOS8 MySQL8.0 Slave2</li>
</ul>
<p><strong>说明</strong></p>
<ul>
<li>mha4mysql-manager-0.56-0.el6.noarch.rpm 不支持CentOS 8，只支持CentOS7 以下版本</li>
<li>mha4mysql-manager-0.58-0.el7.centos.noarch.rpm 支持MySQL5.7和MySQL8.0 ,但和CentOS8版本上的Mariadb -10.3.17不兼容</li>
</ul>
<p><strong>两个安装包</strong></p>
<ul>
<li>mha4mysql-manager  </li>
<li>mha4mysql-node</li>
</ul>
<p><strong>下载地址</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/yoshinorim/mha4mysql-manager">mha4mysql-manager</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/yoshinorim/mha4mysql-node/">mha4mysql-node</a></li>
</ul>
</blockquote>
<h5 id="（1）在管理节点上安装两个包mha4mysql-manager和mha4mysql-node"><a href="#（1）在管理节点上安装两个包mha4mysql-manager和mha4mysql-node" class="headerlink" title="（1）在管理节点上安装两个包mha4mysql-manager和mha4mysql-node"></a>（1）在管理节点上安装两个包mha4mysql-manager和mha4mysql-node</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注：需要配置epel源，且先安装mha4mysql-node，在安装mha4mysql-manager</span><br>[root@MHA ~]<span class="hljs-comment"># yum install -y mha4mysql-node-0.58-0.el7.centos.noarch.rpm</span><br>[root@MHA ~]<span class="hljs-comment"># yum install -y mha4mysql-manager-0.58-0.el7.centos.noarch.rpm</span><br><br><span class="hljs-comment">#若出现以下错误:Requires: perl(:MODULE_COMPAT_5.10.1),更新epel即可</span><br>[root@MHA ~]<span class="hljs-comment">#  yum install epel-release -y</span><br></code></pre></td></tr></table></figure>

<h5 id="（2）在所有MySQL服务器上安装mha4mysql-node包"><a href="#（2）在所有MySQL服务器上安装mha4mysql-node包" class="headerlink" title="（2）在所有MySQL服务器上安装mha4mysql-node包"></a>（2）在所有MySQL服务器上安装mha4mysql-node包</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@master ~]<span class="hljs-comment"># yum install -y mha4mysql-node-0.58-0.el7.centos.noarch.rpm</span><br>[root@slave1 ~]<span class="hljs-comment"># yum install -y mha4mysql-node-0.58-0.el7.centos.noarch.rpm</span><br>[root@slave2 ~]<span class="hljs-comment"># yum install -y mha4mysql-node-0.58-0.el7.centos.noarch.rpm</span><br></code></pre></td></tr></table></figure>

<h5 id="（3）在所有节点实现相互之间ssh-key验证"><a href="#（3）在所有节点实现相互之间ssh-key验证" class="headerlink" title="（3）在所有节点实现相互之间ssh key验证"></a>（3）在所有节点实现相互之间ssh key验证</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@MHA ~]<span class="hljs-comment"># ssh-keygen</span><br>[root@MHA ~]<span class="hljs-comment"># ssh-copy-id 127.0.0.1</span><br>[root@MHA ~]<span class="hljs-comment"># cat .ssh/known_hosts</span><br>127.0.0.1 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBIZoaMippL2cffS52fGVZF8UfywNMhFaVjFQ3LXHf6palT79jiSSBYODQgEM9O5caj9K/lu50LnkfTVq/OtEvw0=<br>10.0.0.7 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBIZoaMippL2cffS52fGVZF8UfywNMhFaVjFQ3LXHf6palT79jiSSBYODQgEM9O5caj9K/lu50LnkfTVq/OtEvw0=<br>10.0.0.8 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLTQXGNANczi5/GMOn9K20r3rh8MWxloJI1xh1AURK0I2G+d7LznBH3LY6IUzT23xD1i5NXFjkGFkuHynSNTToA=<br>10.0.0.18 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLTQXGNANczi5/GMOn9K20r3rh8MWxloJI1xh1AURK0I2G+d7LznBH3LY6IUzT23xD1i5NXFjkGFkuHynSNTToA=<br>10.0.0.28 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLTQXGNANczi5/GMOn9K20r3rh8MWxloJI1xh1AURK0I2G+d7LznBH3LY6IUzT23xD1i5NXFjkGFkuHynSNTToA=<br><br>[root@MHA ~]<span class="hljs-comment"># scp -rp .ssh/ 10.0.0.8:</span><br>[root@MHA ~]<span class="hljs-comment"># scp -rp .ssh/ 10.0.0.18:</span><br>[root@MHA ~]<span class="hljs-comment"># scp -rp .ssh/ 10.0.0.28:</span><br></code></pre></td></tr></table></figure>

<h5 id="（4）在管理节点建立配置文件"><a href="#（4）在管理节点建立配置文件" class="headerlink" title="（4）在管理节点建立配置文件"></a>（4）在管理节点建立配置文件</h5><blockquote>
<p><strong>格式说明</strong></p>
<ul>
<li><strong>user</strong>=mhauser     #用于远程连接MySQL所有节点的用户,需要有管理员的权限</li>
<li><strong>manager_workdir</strong>=/data/mastermha/app1/  #目录会自动生成,无需手动创建（MHA节点）</li>
<li><strong>remote_workdir</strong>=/data/mastermha/app1/ #mysql节点上生成的目录</li>
<li><strong>ssh_user</strong>=root    #用于实现远程ssh基于KEY的连接,访问二进制日志</li>
<li><strong>repl_user</strong>=repluser  #主从复制的用户信息</li>
<li><strong>ping_interval</strong>=1   #健康性检查的时间间隔（单位秒）</li>
<li><strong>master_ip_failover_script</strong>=/usr/local/bin/master_ip_failover #切换VIP的perl脚本（官网已提供）,不支持跨网络,也可用Keepalived实现</li>
<li><strong>report_script</strong>=/usr/local/bin/sendmail.sh  #当执行报警脚本</li>
<li><strong>check_repl_delay</strong>=0  #默认值为1,表示如果slave中从库落后主库relay log超过100M，主库不会选择这个从库为新的master，因为这个从库进行恢复需要很长的时间.通过设置参数check_repl_delay=0，mha触发主从切换时会忽略复制的延时，对于设置candidate_master=1的从库非常有用，这样确保这个从库一定能成为最新的master</li>
<li><strong>master_binlog_dir</strong>=/data/mysql/  #指定二进制日志存放的目录,mha4mysql-manager-0.58必须指定,之前版本不需要指定</li>
<li><strong>candidate_master</strong>=1 #设置为优先候选master，即使不是集群中事件最新的slave,也会优先当master</li>
</ul>
<p><strong>说明</strong><strong>:</strong> <strong>主库宕机谁来接管新的****master</strong></p>
<ol>
<li><strong>所有从节点日志都是一致的，默认会以配置文件的顺序去选择一个新主</strong></li>
<li><strong>从节点日志不一致，自动选择最接近于主库的从库充当新主</strong></li>
<li><strong>如果对于某节点设定了权重（candidate_master=1），权重节点会优先选择。但是此节点日志量落后主库超过100M日志的话，也不会被选择。可以配合check_repl_delay=0，关闭日志量的检查，强制选择候选节点</strong></li>
</ol>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#注意: 此文件的行尾不要加空格等符号</span><br>[root@MHA ~]<span class="hljs-comment"># mkdir /etc/mastermha/</span><br>[root@MHA ~]<span class="hljs-comment"># vim /etc/mastermha/app1.cnf</span><br>[server default]<br>user=mhauser<br>password=123456<br>manager_workdir=/data/mastermha/app1/<br>manager_log=/data/mastermha/app1/manager.log<br>remote_workdir=/data/mastermha/app1/<br>ssh_user=root<br>repl_user=repluser<br>repl_password=123456<br>ping_interval=1<br>master_ip_failover_script=/usr/local/bin/master_ip_failover<br>report_script=/usr/local/bin/sendmail.sh<br>check_repl_delay=0<br>master_binlog_dir=/data/mysql/<br><br>[server1]<br>hostname=10.0.0.8<br>candidate_master=1<br>[server2]<br>hostname=10.0.0.18<br>candidate_master=1<br>[server3]<br>hostname=10.0.0.28<br></code></pre></td></tr></table></figure>

<h5 id="（5）相关脚本"><a href="#（5）相关脚本" class="headerlink" title="（5）相关脚本"></a>（5）相关脚本</h5><h6 id="sendmail-sh"><a href="#sendmail-sh" class="headerlink" title="sendmail.sh"></a>sendmail.sh</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@MHA ~]<span class="hljs-comment"># chmod +x /usr/local/bin/sendmail.sh</span><br>[root@MHA ~]<span class="hljs-comment"># cat /usr/local/bin/sendmail.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br><br><span class="hljs-comment">#******************************************************</span><br><span class="hljs-comment"># Author:          会不会有那么一天</span><br><span class="hljs-comment"># E-mail:          willoneday@qq.com</span><br><span class="hljs-comment"># Date:            2022-11-03</span><br><span class="hljs-comment"># FileName:        sendmail.sh</span><br><span class="hljs-comment"># Version:         1.0.0</span><br><span class="hljs-comment"># Description:     The test script</span><br><span class="hljs-comment"># BLOG:            https://www.cnblogs.com/Willoneday</span><br><span class="hljs-comment">#******************************************************</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;MHA is failover!&quot;</span> | mail -s <span class="hljs-string">&quot;MHA Warning&quot;</span> willoneday@qq.com<br><br><span class="hljs-comment">#若未安装邮件服务操作如下</span><br>[root@MHA ~]<span class="hljs-comment"># yum install -y mailx</span><br>[root@MHA ~]<span class="hljs-comment"># cat /etc/mail.rc</span><br><span class="hljs-built_in">set</span> from=willoneday@qq.com<br><span class="hljs-built_in">set</span> smtp=smtp.qq.com<br><span class="hljs-built_in">set</span> smtp-auth-user=willoneday@qq.com<br><span class="hljs-built_in">set</span> smtp-auth-password=xxxxxxxxxx<br><span class="hljs-built_in">set</span> smtp-auth=login<br></code></pre></td></tr></table></figure>

<h6 id="master-ip-failover"><a href="#master-ip-failover" class="headerlink" title="master_ip_failover"></a>master_ip_failover</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#此脚本为官方提供</span><br>[root@MHA ~]<span class="hljs-comment"># chmod +x /usr/local/bin/master_ip_failover</span><br>[root@MHA ~]<span class="hljs-comment"># cat /usr/local/bin/master_ip_failover</span><br><span class="hljs-comment">#!/usr/bin/env perl</span><br><br><span class="hljs-comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#  This program is free software; you can redistribute it and/or modify</span><br><span class="hljs-comment">#  it under the terms of the GNU General Public License as published by</span><br><span class="hljs-comment">#  the Free Software Foundation; either version 2 of the License, or</span><br><span class="hljs-comment">#  (at your option) any later version.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#  This program is distributed in the hope that it will be useful,</span><br><span class="hljs-comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br><span class="hljs-comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span><br><span class="hljs-comment">#  GNU General Public License for more details.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#  You should have received a copy of the GNU General Public License</span><br><span class="hljs-comment">#   along with this program; if not, write to the Free Software</span><br><span class="hljs-comment">#  Foundation, Inc.,</span><br><span class="hljs-comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span><br><br><span class="hljs-comment">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span><br><br>use strict;<br>use warnings FATAL =&gt; <span class="hljs-string">&#x27;all&#x27;</span>;<br><br>use Getopt::Long;<br>use MHA::DBHelper;<br><br>my (<br>  <span class="hljs-variable">$command</span>,        <span class="hljs-variable">$ssh_user</span>,         <span class="hljs-variable">$orig_master_host</span>,<br>  <span class="hljs-variable">$orig_master_ip</span>, <span class="hljs-variable">$orig_master_port</span>, <span class="hljs-variable">$new_master_host</span>,<br>  <span class="hljs-variable">$new_master_ip</span>,  <span class="hljs-variable">$new_master_port</span>,  <span class="hljs-variable">$new_master_user</span>,<br>  <span class="hljs-variable">$new_master_password</span><br>);<br>my <span class="hljs-variable">$vip</span> = <span class="hljs-string">&#x27;10.0.0.100/24&#x27;</span>;<br>my <span class="hljs-variable">$key</span> = <span class="hljs-string">&quot;1&quot;</span>;<br>my <span class="hljs-variable">$ssh_start_vip</span> = <span class="hljs-string">&quot;/sbin/ifconfig eth0:<span class="hljs-variable">$key</span> <span class="hljs-variable">$vip</span>&quot;</span>;<br>my <span class="hljs-variable">$ssh_stop_vip</span> = <span class="hljs-string">&quot;/sbin/ifconfig eth0:<span class="hljs-variable">$key</span> down&quot;</span>;<br><br>GetOptions(<br>  <span class="hljs-string">&#x27;command=s&#x27;</span>             =&gt; \<span class="hljs-variable">$command</span>,<br>  <span class="hljs-string">&#x27;ssh_user=s&#x27;</span>            =&gt; \<span class="hljs-variable">$ssh_user</span>,<br>  <span class="hljs-string">&#x27;orig_master_host=s&#x27;</span>    =&gt; \<span class="hljs-variable">$orig_master_host</span>,<br>  <span class="hljs-string">&#x27;orig_master_ip=s&#x27;</span>      =&gt; \<span class="hljs-variable">$orig_master_ip</span>,<br>  <span class="hljs-string">&#x27;orig_master_port=i&#x27;</span>    =&gt; \<span class="hljs-variable">$orig_master_port</span>,<br>  <span class="hljs-string">&#x27;new_master_host=s&#x27;</span>     =&gt; \<span class="hljs-variable">$new_master_host</span>,<br>  <span class="hljs-string">&#x27;new_master_ip=s&#x27;</span>       =&gt; \<span class="hljs-variable">$new_master_ip</span>,<br>  <span class="hljs-string">&#x27;new_master_port=i&#x27;</span>     =&gt; \<span class="hljs-variable">$new_master_port</span>,<br>  <span class="hljs-string">&#x27;new_master_user=s&#x27;</span>     =&gt; \<span class="hljs-variable">$new_master_user</span>,<br>  <span class="hljs-string">&#x27;new_master_password=s&#x27;</span> =&gt; \<span class="hljs-variable">$new_master_password</span>,<br>);<br><br><span class="hljs-built_in">exit</span> &amp;main();<br><br>sub main &#123;<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-variable">$command</span> eq <span class="hljs-string">&quot;stop&quot;</span> || <span class="hljs-variable">$command</span> eq <span class="hljs-string">&quot;stopssh&quot;</span> ) &#123;<br><br>    <span class="hljs-comment"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span><br>    <span class="hljs-comment"># If you manage master ip address at global catalog database,</span><br>    <span class="hljs-comment"># invalidate orig_master_ip here.</span><br>    my <span class="hljs-variable">$exit_code</span> = 1;<br>    <span class="hljs-built_in">eval</span> &#123;<br><br>      <span class="hljs-comment"># updating global catalog, etc</span><br>      <span class="hljs-variable">$exit_code</span> = 0;<br>    &#125;;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$@</span>) &#123;<br>      warn <span class="hljs-string">&quot;Got Error: <span class="hljs-variable">$@</span>\n&quot;</span>;<br>      <span class="hljs-built_in">exit</span> <span class="hljs-variable">$exit_code</span>;<br>    &#125;<br>    <span class="hljs-built_in">exit</span> <span class="hljs-variable">$exit_code</span>;<br>  &#125;<br>    elsif ( <span class="hljs-variable">$command</span> eq <span class="hljs-string">&quot;start&quot;</span> ) &#123;<br><br>        <span class="hljs-comment"># all arguments are passed.</span><br>        <span class="hljs-comment"># If you manage master ip address at global catalog database,</span><br>        <span class="hljs-comment"># activate new_master_ip here.</span><br>        <span class="hljs-comment"># You can also grant write access (create user, set read_only=0, etc) here.</span><br>        my <span class="hljs-variable">$exit_code</span> = 10;<br>        <span class="hljs-built_in">eval</span> &#123;<br>            <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;Enabling the VIP - <span class="hljs-variable">$vip</span> on the new master - <span class="hljs-variable">$new_master_host</span> \n&quot;</span>;<br>            &amp;start_vip();<br>            &amp;stop_vip();<br>            <span class="hljs-variable">$exit_code</span> = 0;<br>        &#125;;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$@</span>) &#123;<br>            warn <span class="hljs-variable">$@</span>;<br>            <span class="hljs-built_in">exit</span> <span class="hljs-variable">$exit_code</span>;<br>        &#125;<br>        <span class="hljs-built_in">exit</span> <span class="hljs-variable">$exit_code</span>;<br>    &#125;<br>    elsif ( <span class="hljs-variable">$command</span> eq <span class="hljs-string">&quot;status&quot;</span> ) &#123;<br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;Checking the Status of the script.. OK \n&quot;</span>;<br>        `ssh <span class="hljs-variable">$ssh_user</span>\@<span class="hljs-variable">$orig_master_host</span> \&quot; <span class="hljs-variable">$ssh_start_vip</span> \&quot;`;<br>        <span class="hljs-built_in">exit</span> 0;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        &amp;usage();<br>        <span class="hljs-built_in">exit</span> 1;<br>    &#125;<br>&#125;<br><br><br>sub <span class="hljs-function"><span class="hljs-title">start_vip</span></span>() &#123;<br>    `ssh <span class="hljs-variable">$ssh_user</span>\@<span class="hljs-variable">$new_master_host</span> \&quot; <span class="hljs-variable">$ssh_start_vip</span> \&quot;`;<br>&#125;<br><span class="hljs-comment"># A simple system call that disable the VIP on the old_master</span><br>sub <span class="hljs-function"><span class="hljs-title">stop_vip</span></span>() &#123;<br>   `ssh <span class="hljs-variable">$ssh_user</span>\@<span class="hljs-variable">$orig_master_host</span> \&quot; <span class="hljs-variable">$ssh_stop_vip</span> \&quot;`;<br>&#125;<br><br><br>sub usage &#123;<br>  <span class="hljs-built_in">print</span><br><span class="hljs-string">&quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="（6）实现master"><a href="#（6）实现master" class="headerlink" title="（6）实现master"></a>（6）实现master</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@master ~]<span class="hljs-comment"># yum install -y mysql-server</span><br>[root@master ~]<span class="hljs-comment"># mkdir -p /data/mysql</span><br>[root@master ~]<span class="hljs-comment"># chown mysql.mysql /data/mysql/</span><br><br>[root@master ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>server-id=8<br>log-bin=/data/mysql/mysql-bin  <span class="hljs-comment">#指定二进制日志存放的目录,mha4mysql-manager-0.58必须指定（需要和/etc/mastermha/app1.cnf内的一致）</span><br>skip_name_resolve=1 <span class="hljs-comment">#禁止反向解析</span><br>general_log <span class="hljs-comment">#观察结果,非必须项,生产无需启用</span><br><br>[root@master ~]<span class="hljs-comment"># systemctl enable --now mysqld</span><br><br><span class="hljs-comment">#因为是新安装的机器，所以不需要完全备份。</span><br><span class="hljs-comment">#在未进行任何操作前记录下值（这样slvae会master同步下面两个授权账号）</span><br>[root@master ~]<span class="hljs-comment"># mysql</span><br>mysql&gt; show master logs;<br>+------------------+-----------+-----------+<br>| Log_name         | File_size | Encrypted |<br>+------------------+-----------+-----------+<br>| mysql-bin.000001 |       179 | No        |<br>| mysql-bin.000002 |       156 | No        |<br>+------------------+-----------+-----------+<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><span class="hljs-comment">#如果是MySQL8.0执行下面操操作</span><br>mysql&gt; create user repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>mysql&gt; grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;<br>mysql&gt; create user mhauser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>mysql&gt; grant all on *.* to mhauser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;<br><br><span class="hljs-comment">#如果是MySQL8.0以前版本执行下面操操作</span><br>mysql&gt;grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>mysql&gt;grant all on *.* to mhauser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br><br><span class="hljs-comment">#配置VIP</span><br><span class="hljs-comment">#此IP为master_ip_failover脚本里面的变量</span><br><span class="hljs-comment">#第一次需要手动添加（且别名为eth0:1）</span><br><span class="hljs-comment">#如果主节点down掉，那么此IP会自动转移到从节点上</span><br>[root@MHA ~]<span class="hljs-comment"># cat /usr/local/bin/master_ip_failover |grep &quot;^my&quot;</span><br>my <span class="hljs-variable">$vip</span> = <span class="hljs-string">&#x27;10.0.0.100/24&#x27;</span>;<br>my <span class="hljs-variable">$key</span> = <span class="hljs-string">&quot;1&quot;</span>;<br>my <span class="hljs-variable">$ssh_start_vip</span> = <span class="hljs-string">&quot;/sbin/ifconfig eth0:<span class="hljs-variable">$key</span> <span class="hljs-variable">$vip</span>&quot;</span>;<br>my <span class="hljs-variable">$ssh_stop_vip</span> = <span class="hljs-string">&quot;/sbin/ifconfig eth0:<span class="hljs-variable">$key</span> down&quot;</span>;<br>[root@master ~]<span class="hljs-comment"># ifconfig eth0:1 10.0.0.100/24</span><br></code></pre></td></tr></table></figure>

<h5 id="（7）实现-slave"><a href="#（7）实现-slave" class="headerlink" title="（7）实现****slave"></a>（7）<strong>实现****slave</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下面只演示slvae1操作过程，slave2也需操作</span><br><span class="hljs-comment">#slave1和slave2除server-id需不一致外其他操作相同</span><br>[root@slave1 ~]<span class="hljs-comment"># yum install -y mysql-server</span><br>[root@slave1 ~]<span class="hljs-comment"># mkdir -p /data/mysql</span><br>[root@slave1 ~]<span class="hljs-comment"># chown mysql.mysql /data/mysql/</span><br><br>[root@slave1 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>server-id=18 <span class="hljs-comment">#不同节点此值各不相同</span><br>log-bin=/data/mysql/mysql-bin  <span class="hljs-comment">#指定二进制日志存放的目录,mha4mysql-manager-0.58必须指定（需要和/etc/mastermha/app1.cnf内的一致）</span><br>read-only<br>relay-log-purge=0<br>skip-name-resolve=1 <span class="hljs-comment">#禁止反向解析</span><br>general_log <span class="hljs-comment">#观察结果,非必须项,生产无需启用</span><br><br>[root@slave1 ~]<span class="hljs-comment"># systemctl enable --now mysqld</span><br><br>[root@slave1 ~]<span class="hljs-comment"># mysql</span><br>mysql&gt; CHANGE MASTER TO<br>         MASTER_HOST=<span class="hljs-string">&#x27;10.0.0.8&#x27;</span>,<br>         MASTER_USER=<span class="hljs-string">&#x27;repluser&#x27;</span>,<br>         MASTER_PASSWORD=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>         MASTER_PORT=3306,<br>         MASTER_LOG_FILE=<span class="hljs-string">&#x27;mysql-bin.000002&#x27;</span>,<br>         MASTER_LOG_POS=156,<br>         MASTER_CONNECT_RETRY=3;<br>mysql&gt; start slave;<br></code></pre></td></tr></table></figure>

<h5 id="（8）检查MHA的环境"><a href="#（8）检查MHA的环境" class="headerlink" title="（8）检查MHA的环境"></a>（8）检查MHA的环境</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#检查环境</span><br>[root@MHA ~]<span class="hljs-comment"># masterha_check_ssh --conf=/etc/mastermha/app1.cnf</span><br>[root@MHA ~]<span class="hljs-comment"># masterha_check_repl --conf=/etc/mastermha/app1.cnf</span><br><br><span class="hljs-comment">#查看状态</span><br>[root@MHA ~]<span class="hljs-comment"># masterha_check_status --conf=/etc/mastermha/app1.cnf</span><br></code></pre></td></tr></table></figure>

<h5 id="（9）启动MHA"><a href="#（9）启动MHA" class="headerlink" title="（9）启动MHA"></a>（9）启动MHA</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#开启MHA,默认是前台运行,生产环境一般为后台执行</span><br>[root@MHA ~]<span class="hljs-comment"># nohup masterha_manager --conf=/etc/mastermha/app1.cnf --remove_dead_master_conf --ignore_last_failover &amp;&gt; /dev/null </span><br><span class="hljs-comment">#测试环境</span><br>[root@MHA ~]<span class="hljs-comment"># masterha_manager --conf=/etc/mastermha/app1.cnf --remove_dead_master_conf --ignore_last_failover</span><br><br><span class="hljs-comment">#如果想停止后台执行的MHA,可以执行下面命令</span><br>[root@MHA ~]<span class="hljs-comment"># masterha_stop --conf=/etc/mastermha/app1.cnf </span><br>Stopped app1 successfully.<br><br><span class="hljs-comment">#查看状态</span><br>[root@MHA ~]<span class="hljs-comment"># masterha_check_status --conf=/etc/mastermha/app1.cnf</span><br></code></pre></td></tr></table></figure>

<h5 id="（10）排错日志"><a href="#（10）排错日志" class="headerlink" title="（10）排错日志"></a>（10）排错日志</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@MHA ~]<span class="hljs-comment"># tail /data/mastermha/app1/manager.log</span><br><br><span class="hljs-comment">#健康性检查</span><br>[root@master ~]<span class="hljs-comment"># tail -f /var/lib/mysql/master.log</span><br>2022-11-03T17:41:32.075497Z	   22 Query	SELECT 1 As Value<br>2022-11-03T17:41:33.074744Z	   22 Query	SELECT 1 As Value<br>2022-11-03T17:41:34.076151Z	   22 Query	SELECT 1 As Value<br></code></pre></td></tr></table></figure>

<h5 id="（11）模拟故障"><a href="#（11）模拟故障" class="headerlink" title="（11）模拟故障"></a>（11）模拟故障</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#模拟故障</span><br>[root@master ~]<span class="hljs-comment"># systemctl stop mysqld</span><br><span class="hljs-comment">#当 master down机后,mha管理程序自动退出</span><br>[root@MHA ~]<span class="hljs-comment"># masterha_manager --conf=/etc/mastermha/app1.cnf --remove_dead_master_conf --ignore_last_</span><br>Fri Nov  4 09:39:37 2022 - [warning] Global configuration file /etc/masterha_default.cnf not found. Sk<br>Fri Nov  4 09:39:37 2022 - [info] Reading application default configuration from /etc/mastermha/app1.c<br>Fri Nov  4 09:39:37 2022 - [info] Reading server configuration from /etc/mastermha/app1.cnf..<br><br>  Creating /data/mastermha/app1 <span class="hljs-keyword">if</span> not exists..    ok.<br>  Checking output directory is accessible or not..<br>   ok.<br>  Binlog found at /data/mysql/, up to mysql-bin.000003<br>Fri Nov  4 09:45:55 2022 - [warning] Global configuration file /etc/masterha_default.cnf not found. Sk<br>Fri Nov  4 09:45:55 2022 - [info] Reading application default configuration from /etc/mastermha/app1.c<br>Fri Nov  4 09:45:55 2022 - [info] Reading server configuration from /etc/mastermha/app1.cnf..<br><br><span class="hljs-comment">#验证VIP漂移至新的Master上</span><br>[root@slave1 ~]<span class="hljs-comment"># ifconfig eth0:1</span><br>eth0:1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br>        inet 10.0.0.100  netmask 255.255.255.0  broadcast 10.0.0.255<br>        ether 00:0c:29:34:3d:e8  txqueuelen 1000  (Ethernet)<br><br><span class="hljs-comment">#自动修改manager节点上的配置文件,将master剔除</span><br>[root@slave1 ~]<span class="hljs-comment"># cat /etc/mastermha/app1.cnf</span><br>[server2]<br>hostname=10.0.0.18<br>port=3306<br>candidate_master=1<br>[server3]<br>hostname=10.0.0.28<br>port=3306<br></code></pre></td></tr></table></figure>

<p><strong>收到报警邮件</strong></p>
<p><a target="_blank" rel="noopener" href="https://img2022.cnblogs.com/blog/2927659/202211/2927659-20221104015036118-1429453128.png"><img src="https://img2022.cnblogs.com/blog/2927659/202211/2927659-20221104015036118-1429453128.png" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<h5 id="（12）修复主从"><a href="#（12）修复主从" class="headerlink" title="（12）修复主从"></a>（12）修复主从</h5><blockquote>
<ul>
<li>修复故障的主库,保证数据同步</li>
<li>修复主从,手工新故障库加入新的主,设为为从库</li>
<li>修复manager的配置文件</li>
<li>清理相关目录</li>
<li>检查ssh互信和replication的复制是否成功</li>
<li>检查VIP,如果有问题,重新配置VIP</li>
<li>重新运行MHA,查询MHA状态,确保运行正常</li>
</ul>
</blockquote>
<h5 id="（13）如果再次运行MHA-需要先删除下面文件"><a href="#（13）如果再次运行MHA-需要先删除下面文件" class="headerlink" title="（13）如果再次运行MHA,需要先删除下面文件"></a><strong>（13）如果再次运行MHA,需要先删除下面文件</strong></h5><blockquote>
<p> MHA只能漂移一次，如果多次使用必须删除以下文件，要不MHA不可重用</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@MHA ~]<span class="hljs-comment"># rm -rf /data/mastermha/app1/              #mha_master自己的工作路径</span><br>[root@MHA ~]<span class="hljs-comment"># rm -rf /data/mastermha/app1/manager.log   #mha_master自己的日志文件</span><br>[root@master ~]<span class="hljs-comment">#rm -rf /data/mastermha/app1/            #每个远程主机即三个节点的的工作目录</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-2-Galera-Cluster"><a href="#3-2-Galera-Cluster" class="headerlink" title="3.2 Galera Cluster"></a>3.2 Galera Cluster</h3><blockquote>
<p>Galera Cluster：集成了Galera插件的MySQL集群，是一种新型的，数据不共享的，高度冗余的高可用方案，目前Galera Cluster有两个版本，分别是<strong>Percona Xtradb Cluster</strong>及<strong>MariaDB Cluster</strong>，Galera本身是具有多主特性的，即采用multi-master的集群架构，是一个既稳健，又在数据一致性、完整性及高性能方面有出色表现的高可用解决方案</p>
<p><strong>特点</strong></p>
<ul>
<li>多主架构：真正的多点读写的集群，在任何时候读写数据，都是最新的</li>
<li>同步复制：改善了主从复制延迟问题，基本上达到了实时同步</li>
<li>并发复制：从节点APPLY数据时，支持并行执行，更好的性能</li>
<li>故障切换：在出现数据库故障时，因支持多点写入，切换容易</li>
</ul>
</blockquote>
<h4 id="实战案例：Percona-XtraDB-Cluster-PXC-5-7）"><a href="#实战案例：Percona-XtraDB-Cluster-PXC-5-7）" class="headerlink" title="实战案例：Percona XtraDB Cluster(PXC 5.7）"></a>实战案例：Percona XtraDB Cluster(PXC 5.7）</h4><blockquote>
<p><strong>环境准备</strong></p>
<p>四台主机：</p>
<ul>
<li>pxc1:10.0.0.7</li>
<li>pxc2:10.0.0.17</li>
<li>pxc3:10.0.0.27</li>
<li>pxc4:10.0.0.37</li>
<li>第4台模拟生产中后续增加的节点</li>
</ul>
<p><strong>OS</strong> <strong>版本目前不支持****CentOS 8</strong></p>
<ul>
<li>关闭防火墙和SELinux</li>
<li>保证时间同步</li>
</ul>
<p>注意：如果已经安装MySQL，必须卸载</p>
</blockquote>
<h5 id="（1）安装-Percona-XtraDB-Cluster-5-7"><a href="#（1）安装-Percona-XtraDB-Cluster-5-7" class="headerlink" title="（1）安装 Percona XtraDB Cluster 5.7"></a>（1）安装 Percona XtraDB Cluster 5.7</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#此处使用清华大学yum源，官方源太慢了</span><br>[root@pxc1 ~]<span class="hljs-comment">#vim /etc/yum.repos.d/pxc.repo</span><br>[percona]<br>name=percona_repo<br>baseurl=https://mirrors.tuna.tsinghua.edu.cn/percona/release/<span class="hljs-variable">$releasever</span>/RPMS/<span class="hljs-variable">$basearch</span><br>enabled=1<br>gpgcheck=0<br><br>[root@pxc1 ~]<span class="hljs-comment">#scp /etc/yum.repos.d/pxc.repo 10.0.0.17:/etc/yum.repos.d</span><br>[root@pxc1 ~]<span class="hljs-comment">#scp /etc/yum.repos.d/pxc.repo 10.0.0.27:/etc/yum.repos.d</span><br><span class="hljs-comment">#在三个节点都安装好PXC 5.7 </span><br>[root@pxc1 ~]<span class="hljs-comment">#yum install Percona-XtraDB-Cluster-57 -y</span><br>[root@pxc2 ~]<span class="hljs-comment">#yum install Percona-XtraDB-Cluster-57 -y</span><br>[root@pxc3 ~]<span class="hljs-comment">#yum install Percona-XtraDB-Cluster-57 -y</span><br></code></pre></td></tr></table></figure>

<h5 id="（2）在各个节点上分别配置mysql及集群配置文件"><a href="#（2）在各个节点上分别配置mysql及集群配置文件" class="headerlink" title="（2）在各个节点上分别配置mysql及集群配置文件"></a>（2）在各个节点上分别配置mysql及集群配置文件</h5><blockquote>
<p>/etc/my.cnf为主配置文件，当前版本中，其余的配置文件都放在/etc/percona-xtradb-cluster.conf.d目录里，包括下面三个文件</p>
<ul>
<li>mysqld.cnf</li>
<li>mysqld_safe.cnf</li>
<li>wsrep.cnf</li>
</ul>
<p>注意：尽管Galera Cluster不再需要通过binlog的形式进行同步，但还是建议在配置文件中开启二进制日志功能，原因是后期如果有新节点需要加入，老节点通过SST全量传输的方式向新节点传输数据，很可能会拖垮集群性能，所以让新节点先通过binlog方式完成同步后再加入集群会是一种更好的选择</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@pxc1 ~]<span class="hljs-comment">#ls /etc/percona-xtradb-cluster.conf.d/</span><br>mysqld.cnf mysqld_safe.cnf wsrep.cnf<br><span class="hljs-comment">#下面配置文件不需要修改</span><br>[root@pxc1 ~]<span class="hljs-comment">#cat /etc/percona-xtradb-cluster.conf.d/mysqld.cnf </span><br>...省略...<br>[client]<br>socket=/var/lib/mysql/mysql.sock<br>[mysqld]<br>server-id=1     <span class="hljs-comment">#建议各个节点不同</span><br>datadir=/var/lib/mysql<br>socket=/var/lib/mysql/mysql.sock<br>log-error=/var/log/mysqld.log<br>pid-file=/var/run/mysqld/mysqld.pid<br>log-bin     <span class="hljs-comment">#建议启用，非必须项</span><br>log_slave_updates<br>expire_logs_days=7<br><br><span class="hljs-comment">#PXC的配置文件必须修改</span><br>[root@pxc1 ~]<span class="hljs-comment">#vim /etc/percona-xtradb-cluster.conf.d/wsrep.cnf </span><br>[root@pxc1 ~]<span class="hljs-comment">#grep -Ev &quot;^#|^$&quot; /etc/percona-xtradb-cluster.conf.d/wsrep.cnf </span><br>[mysqld]<br>wsrep_provider=/usr/lib64/galera3/libgalera_smm.so<br>wsrep_cluster_address=gcomm://10.0.0.7,10.0.0.17,10.0.0.27 <span class="hljs-comment">#三个节点的IP</span><br>binlog_format=ROW<br>default_storage_engine=InnoDB<br>wsrep_slave_threads= 8<br>wsrep_log_conflicts<br>innodb_autoinc_lock_mode=2<br>wsrep_node_address=10.0.0.7 <span class="hljs-comment">#各个节点，指定自已的IP</span><br>wsrep_cluster_name=pxc-cluster<br>wsrep_node_name=pxc-cluster-node-1 <span class="hljs-comment">#各个节点，指定自已节点名称</span><br>pxc_strict_mode=ENFORCING<br>wsrep_sst_method=xtrabackup-v2<br>wsrep_sst_auth=<span class="hljs-string">&quot;sstuser:s3cretPass&quot;</span> <span class="hljs-comment">#取消本行注释,同一集群内多个节点的验证用户和密码信息必须一致</span><br><br>[root@pxc2 ~]<span class="hljs-comment">#grep -Ev &quot;^#|^$&quot; /etc/percona-xtradb-cluster.conf.d/wsrep.cnf </span><br>[mysqld]<br>wsrep_provider=/usr/lib64/galera3/libgalera_smm.so<br>wsrep_cluster_address=gcomm://10.0.0.7,10.0.0.17,10.0.0.27<br>binlog_format=ROW<br>default_storage_engine=InnoDB<br>wsrep_slave_threads= 8<br>wsrep_log_conflicts<br>innodb_autoinc_lock_mode=2          <br>wsrep_node_address=10.0.0.17 <span class="hljs-comment">#各个节点，指定自已的IP</span><br>wsrep_cluster_name=pxc-cluster<br>wsrep_node_name=pxc-cluster-node-2 <span class="hljs-comment">#各个节点，指定自已节点名称</span><br>pxc_strict_mode=ENFORCING<br>wsrep_sst_method=xtrabackup-v2<br>wsrep_sst_auth=<span class="hljs-string">&quot;sstuser:s3cretPass&quot;</span> <span class="hljs-comment">#取消本行注释</span><br><br>[root@pxc3 ~]<span class="hljs-comment">#grep -Ev &quot;^#|^$&quot; /etc/percona-xtradb-cluster.conf.d/wsrep.cnf </span><br>[mysqld]<br>wsrep_provider=/usr/lib64/galera3/libgalera_smm.so<br>wsrep_cluster_address=gcomm://10.0.0.7,10.0.0.17,10.0.0.27<br>binlog_format=ROW<br>default_storage_engine=InnoDB<br>wsrep_slave_threads= 8<br>wsrep_log_conflicts<br>innodb_autoinc_lock_mode=2   <br>wsrep_node_address=10.0.0.27 <span class="hljs-comment">#各个节点，指定自已的IP</span><br>wsrep_cluster_name=pxc-cluster<br>wsrep_node_name=pxc-cluster-node-3 <span class="hljs-comment">#各个节点，指定自已的IP</span><br>pxc_strict_mode=ENFORCING<br>wsrep_sst_method=xtrabackup-v2<br>wsrep_sst_auth=<span class="hljs-string">&quot;sstuser:s3cretPass&quot;</span>  <span class="hljs-comment">#取消本行注释</span><br></code></pre></td></tr></table></figure>

<h5 id="（3）启动PXC集群中第一个节点"><a href="#（3）启动PXC集群中第一个节点" class="headerlink" title="（3）启动PXC集群中第一个节点"></a>（3）启动PXC集群中第一个节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@pxc1 ~]<span class="hljs-comment">#systemctl start mysql@bootstrap.service</span><br>[root@pxc1 ~]<span class="hljs-comment">#ss -ntul</span><br>State       Recv-Q Send-Q             Local Address:Port                            Peer Address:Port                          <br>LISTEN      0      128                            *:4567                                       *:*                  <br>LISTEN      0      80                            :::3306                                      :::* <br><br><span class="hljs-comment">#查看root密码</span><br>[root@pxc1 ~]<span class="hljs-comment">#grep &quot;password&quot; /var/log/mysqld.log          </span><br>2022-11-04T19:30:20.592377Z 1 [Note] A temporary password is generated <span class="hljs-keyword">for</span> root@localhost: mNZTH2o*4Use<br>[root@pxc1 ~]<span class="hljs-comment">#mysql -uroot -p&#x27;=mNZTH2o*4Use&#x27;</span><br><span class="hljs-comment">#修改root密码</span><br>mysql&gt; alter user <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br><span class="hljs-comment">#创建相关用户并授权（下面所赋予的权限是官方文档里面提供的）</span><br>mysql&gt; CREATE USER <span class="hljs-string">&#x27;sstuser&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;s3cretPass&#x27;</span>;<br>mysql&gt; GRANT RELOAD, LOCK TABLES, PROCESS, REPLICATION CLIENT ON *.* TO <span class="hljs-string">&#x27;sstuser&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span>;<br><br><span class="hljs-comment">#查看相关变量</span><br>mysql&gt; SHOW VARIABLES LIKE <span class="hljs-string">&#x27;wsrep%&#x27;</span>\G<br><span class="hljs-comment">#查看相关状态变量</span><br>mysql&gt; SHOW STATUS LIKE <span class="hljs-string">&#x27;wsrep%&#x27;</span>\G<br></code></pre></td></tr></table></figure>

<h5 id="（5）启动PXC集群中其它所有节点"><a href="#（5）启动PXC集群中其它所有节点" class="headerlink" title="（5）启动PXC集群中其它所有节点"></a>（5）启动PXC集群中其它所有节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@pxc2 ~]<span class="hljs-comment">#systemctl start mysql</span><br></code></pre></td></tr></table></figure>

<h5 id="（6）查看集群状态，验证集群是否成功"><a href="#（6）查看集群状态，验证集群是否成功" class="headerlink" title="（6）查看集群状态，验证集群是否成功"></a>（6）查看集群状态，验证集群是否成功</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; SHOW VARIABLES LIKE <span class="hljs-string">&#x27;wsrep_on&#x27;</span>;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| wsrep_on      | ON    |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br>mysql&gt; SHOW STATUS LIKE <span class="hljs-string">&#x27;wsrep_cluster_size&#x27;</span>;<br>+--------------------+-------+<br>| Variable_name      | Value |<br>+--------------------+-------+<br>| wsrep_cluster_size | 3     |<br>+--------------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br></code></pre></td></tr></table></figure>

<h5 id="（7）在PXC集群中加入节点"><a href="#（7）在PXC集群中加入节点" class="headerlink" title="（7）在PXC集群中加入节点"></a>（7）在PXC集群中加入节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在PXC集群中再加一台新的主机PXC4：10.0.0.37</span><br>[root@pxc4 ~]<span class="hljs-comment">#yum install Percona-XtraDB-Cluster-57 -y</span><br>[root@pxc4 ~]<span class="hljs-comment">#vim /etc/percona-xtradb-cluster.conf.d/wsrep.cnf</span><br>[root@pxc4 ~]<span class="hljs-comment">#grep -Ev &quot;^#|^$&quot; /etc/percona-xtradb-cluster.conf.d/wsrep.cnf </span><br>[mysqld]<br>wsrep_provider=/usr/lib64/galera3/libgalera_smm.so<br>wsrep_cluster_address=gcomm://10.0.0.7,10.0.0.17,10.0.0.27,10.0.0.37 <span class="hljs-comment">#改</span><br>binlog_format=ROW<br>default_storage_engine=InnoDB<br>wsrep_slave_threads= 8<br>wsrep_log_conflicts<br>innodb_autoinc_lock_mode=2<br>wsrep_node_address=10.0.0.37 <span class="hljs-comment">#改</span><br>wsrep_cluster_name=pxc-cluster<br>wsrep_node_name=pxc-cluster-node-4 <span class="hljs-comment">#改</span><br>pxc_strict_mode=ENFORCING<br>wsrep_sst_method=xtrabackup-v2<br>wsrep_sst_auth=<span class="hljs-string">&quot;sstuser:s3cretPass&quot;</span>  <span class="hljs-comment">#改</span><br><br>[root@pxc4 ~]<span class="hljs-comment">#systemctl start mysql</span><br>[root@pxc4 ~]<span class="hljs-comment">#mysql -uroot -p123456</span><br>Server version: 5.7.27-30-57-<span class="hljs-built_in">log</span> Percona XtraDB Cluster (GPL), Release rel30, <br>Revision <br>mysql&gt; SHOW STATUS LIKE <span class="hljs-string">&#x27;wsrep_cluster_size&#x27;</span>;<br>+--------------------+-------+<br>| Variable_name      | Value |<br>+--------------------+-------+<br>| wsrep_cluster_size | 4     |<br>+--------------------+-------+<br><br><span class="hljs-comment">#将其它节点的配置文件加以修改</span><br>[root@pxc1 ~]<span class="hljs-comment">#vim /etc/percona-xtradb-cluster.conf.d/wsrep.cnf</span><br>wsrep_cluster_address=gcomm://10.0.0.7,10.0.0.17,10.0.0.27,10.0.0.37<br>[root@pxc2 ~]<span class="hljs-comment">#vim /etc/percona-xtradb-cluster.conf.d/wsrep.cnf</span><br>[root@pxc3 ~]<span class="hljs-comment">#vim /etc/percona-xtradb-cluster.conf.d/wsrep.cnf</span><br></code></pre></td></tr></table></figure>

<hr>
<h4 id="实战案例：MariaDB-Galera-Cluster"><a href="#实战案例：MariaDB-Galera-Cluster" class="headerlink" title="实战案例：MariaDB Galera Cluster"></a>实战案例：MariaDB Galera Cluster</h4><h5 id="（1）centos8-实现MariaDB-Galera-Cluster"><a href="#（1）centos8-实现MariaDB-Galera-Cluster" class="headerlink" title="（1）centos8 实现MariaDB Galera Cluster"></a>（1）centos8 实现MariaDB Galera Cluster</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#在三个节点上都实现</span><br>[root@centos8 ~]<span class="hljs-comment">#dnf install mariadb-server-galera -y</span><br>[root@centos8 ~]<span class="hljs-comment">#vim /etc/my.cnf.d/galera.cnf</span><br><span class="hljs-comment">#wsrep_cluster_address=&quot;dummy://&quot; 在此行下面加一行</span><br>wsrep_cluster_address=<span class="hljs-string">&quot;gcomm://10.0.0.8,10.0.0.18,10.0.0.28&quot;</span>  <br><br><span class="hljs-comment">#启动第一节点</span><br>[root@centos8 ~]<span class="hljs-comment">#galera_new_cluster</span><br>[root@centos8 ~]<span class="hljs-comment">#systemctl enable mariadb</span><br><br><span class="hljs-comment">#再启动其它节点</span><br>[root@centos8 ~]<span class="hljs-comment">#systemctl enable --now mariadb</span><br>[root@centos8 ~]<span class="hljs-comment">#ss -ntl</span><br>State       Recv-Q Send-Q             Local Address:Port                            Peer Address:Port                            <br>LISTEN      0      128                            *:4567                                       *:*                  <br>LISTEN      0      80                            :::3306                                      :::*   <br><br><span class="hljs-comment">#验证</span><br>[root@centos8 ~]<span class="hljs-comment">#mysql</span><br>MariaDB [(none)]&gt;  show status like <span class="hljs-string">&quot;wsrep_ready&quot;</span>;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| wsrep_ready   | ON    |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.001 sec)<br>MariaDB [(none)]&gt; SHOW STATUS LIKE <span class="hljs-string">&#x27;wsrep_cluster_size&#x27;</span>; <br>+--------------------+-------+<br>| Variable_name      | Value |<br>+--------------------+-------+<br>| wsrep_cluster_size | 3     |<br>+--------------------+-------+<br></code></pre></td></tr></table></figure>

<h5 id="（2）CentOS-7-实现-MariaDB-Galera-Cluster-5-5"><a href="#（2）CentOS-7-实现-MariaDB-Galera-Cluster-5-5" class="headerlink" title="（2）CentOS 7 实现 MariaDB Galera Cluster 5.5"></a>（2）CentOS 7 实现 MariaDB Galera Cluster 5.5</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#参考仓库：https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-5.5.X/yum/centos7-amd64/</span><br>yum install MariaDB-Galera-server<br>vim /etc/my.cnf.d/server.cnf<br>[galera]<br>wsrep_provider = /usr/lib64/galera/libgalera_smm.so<br>wsrep_cluster_address=<span class="hljs-string">&quot;gcomm://10.0.0.7,10.0.0.17,10.0.0.27&quot;</span><br>binlog_format=row<br>default_storage_engine=InnoDB<br>innodb_autoinc_lock_mode=2<br>bind-address=0.0.0.0<br><br><span class="hljs-comment">#下面配置可选项</span><br>wsrep_cluster_name = <span class="hljs-string">&#x27;mycluster&#x27;</span> 默认my_wsrep_cluster<br>wsrep_node_name = <span class="hljs-string">&#x27;node1&#x27;</span><br>wsrep_node_address = <span class="hljs-string">&#x27;10.0.0.7&#x27;</span><br><br><span class="hljs-comment">#首次启动时，需要初始化集群，在其中一个节点上执行命令</span><br>/etc/init.d/mysql start --wsrep-new-cluster<br><br><span class="hljs-comment">#而后正常启动其它节点</span><br>service mysql start<br><br><span class="hljs-comment">#查看集群中相关系统变量和状态变量</span><br>SHOW VARIABLES LIKE <span class="hljs-string">&#x27;wsrep_%&#x27;</span>;<br>SHOW STATUS LIKE <span class="hljs-string">&#x27;wsrep_%&#x27;</span>;<br>SHOW STATUS LIKE <span class="hljs-string">&#x27;wsrep_cluster_size&#x27;</span>;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="3-3-TiDB"><a href="#3-3-TiDB" class="headerlink" title="3.3 TiDB"></a>3.3 TiDB</h3><blockquote>
<p>略</p>
</blockquote>
<h1 id="-5"><a href="#-5" class="headerlink" title=""></a></h1><hr>
<h1 id="七、MySQL压力测试"><a href="#七、MySQL压力测试" class="headerlink" title="七、MySQL压力测试"></a>七、MySQL压力测试</h1><h2 id="1-mysqlslap压力测试工具"><a href="#1-mysqlslap压力测试工具" class="headerlink" title="1 mysqlslap压力测试工具"></a>1 <strong>mysqlslap</strong>压力测试工具</h2><blockquote>
<p><strong>格式</strong></p>
<ul>
<li><code>mysqlslap [options]</code></li>
</ul>
<p><strong>常用参数</strong> <strong>[options]</strong> <strong>说明</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">--auto-generate-sql, -a <span class="hljs-comment">#自动生成测试表和数据，表示用mysqlslap工具自己生成的SQL脚本来测试并发压力</span><br>--auto-generate-sql-load-type=<span class="hljs-built_in">type</span> <span class="hljs-comment">#测试语句的类型。代表要测试的环境是读操作还是写操作还是两者混合的。取值包括：read，key，write，update和mixed(默认)</span><br>--auto-generate-sql-add-auto-increment <span class="hljs-comment">#代表对生成的表自动添加auto_increment列，从5.1.18版本开始支持</span><br>--number-char-cols=N, -x N <span class="hljs-comment">#自动生成的测试表中包含多少个字符类型的列，默认1</span><br>--number-int-cols=N, -y N <span class="hljs-comment">#自动生成的测试表中包含多少个数字类型的列，默认1</span><br>--number-of-queries=N <span class="hljs-comment">#总的测试查询次数(并发客户数×每客户查询次数)</span><br>--query=name,-q <span class="hljs-comment">#使用自定义脚本执行测试，例如可以调用自定义的存储过程或者sql语句来执行测试</span><br>--create-schema <span class="hljs-comment">#代表自定义的测试库名称，测试的schema</span><br>--commint=N <span class="hljs-comment">#多少条DML后提交一次</span><br>--compress, -C <span class="hljs-comment">#如服务器和客户端都支持压缩，则压缩信息</span><br>--concurrency=N, -c N <span class="hljs-comment">#表示并发量，即模拟多少个客户端同时执行select。可指定多个值，以逗号或者--delimiter参数指定值做为分隔符,如：--concurrency=100,200,500</span><br>--engine=engine_name, -e engine_name <span class="hljs-comment">#代表要测试的引擎，可以有多个，用分隔符隔开。例如：--engines=myisam,innodb</span><br>--iterations=N, -i N <span class="hljs-comment">#测试执行的迭代次数，代表要在不同并发环境下，各自运行测试多少次</span><br>--only-print <span class="hljs-comment">#只打印测试语句而不实际执行。</span><br>--detach=N <span class="hljs-comment">#执行N条语句后断开重连</span><br>--debug-info, -T <span class="hljs-comment">#打印内存和CPU的相关信息</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a><strong>使用示例</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#单线程测试</span><br>mysqlslap -a -uroot -p123456<br><br><span class="hljs-comment">#多线程测试。使用--concurrency来模拟并发连接</span><br>mysqlslap -a -c 100 -uroot -p123456<br><span class="hljs-comment">#迭代测试。用于需要多次执行测试得到平均值</span><br>mysqlslap -a -i 10 -uroot -p123456<br>mysqlslap ---auto-generate-sql-add-autoincrement -a<br>mysqlslap -a --auto-generate-sql-load-type=<span class="hljs-built_in">read</span><br>mysqlslap -a --auto-generate-secondary-indexes=3<br>mysqlslap -a --auto-generate-sql-write-number=1000<br>mysqlslap --create-schema world -q <span class="hljs-string">&quot;select count(*) from City&quot;</span><br>mysqlslap -a -e innodb -uroot -p123456<br>mysqlslap -a --number-of-queries=10 -uroot -p123456<br><br><span class="hljs-comment">#测试同时不同的存储引擎的性能进行对比</span><br>mysqlslap -a --concurrency=50,100 --number-of-queries 1000 --iterations=5 --engine=myisam,innodb --debug-info -uroot -p123456<br><br><span class="hljs-comment">#执行一次测试，分别50和100个并发，执行1000次总查询</span><br>mysqlslap -a --concurrency=50,100 --number-of-queries 1000 --debug-info -uroot -p123456<br><span class="hljs-comment">#50和100个并发分别得到一次测试结果(Benchmark)，并发数越多，执行完所有查询的时间越长。为了准确起见，可以多迭代测试几次</span><br>mysqlslap -a --concurrency=50,100 --number-of-queries 1000 --iterations=5 --debug-info -uroot -p123456<br></code></pre></td></tr></table></figure>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/28/%E7%AC%AC%E5%8D%81%E5%91%A8/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第十周</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/28/linux%E8%BF%9B%E9%98%B6%E6%8A%80%E8%83%BD/">
                        <span class="hidden-mobile">linux进阶技能</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://qm.qq.com/cgi-bin/qm/qr?k=A5I1aDMT5p5nmi3zDa8t7gWOHawJhjyi&noverify=0&personal_qrcode_source=4" target="_blank" rel="nofollow noopener"><span>JohnBakcu</span></a> <i class="iconfont icon-love"></i> <a href="https://www.magedu.com"  target="_blank" rel="nofollow noopener"><span>Mgedu</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
