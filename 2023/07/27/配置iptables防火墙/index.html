

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="壹 iptables常见概念  iptables服务端：xuegod63.cn  IP：192.168.1.63 iptables客户端：xuegod64.cn  IP：192.168.1.64 一、iptables概述： netfilter&#x2F;iptables ：IP信息包过滤系统，它实际上由两个组件netfilter 和 iptables 组成。 netfilter&#x2F;iptables 关系：">
<meta property="og:type" content="article">
<meta property="og:title" content="配置iptables防火墙">
<meta property="og:url" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/index.html">
<meta property="og:site_name" content="Mgedu-N80054">
<meta property="og:description" content="壹 iptables常见概念  iptables服务端：xuegod63.cn  IP：192.168.1.63 iptables客户端：xuegod64.cn  IP：192.168.1.64 一、iptables概述： netfilter&#x2F;iptables ：IP信息包过滤系统，它实际上由两个组件netfilter 和 iptables 组成。 netfilter&#x2F;iptables 关系：">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640.gif">
<meta property="og:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640-1690456058081-5.png">
<meta property="og:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640-1690456060607-8.png">
<meta property="og:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640-1690456065324-11.png">
<meta property="og:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640.gif">
<meta property="og:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640-1690456070143-16.png">
<meta property="og:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640-1690456072602-19.png">
<meta property="og:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640.gif">
<meta property="og:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640-1690456087361-24.png">
<meta property="og:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640-1690456100035-27.gif">
<meta property="og:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640-1690456108092-29.png">
<meta property="article:published_time" content="2023-07-27T19:06:36.000Z">
<meta property="article:modified_time" content="2023-07-30T21:21:41.306Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/07/27/%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99/640.gif">
  
  
  <title>配置iptables防火墙 - Mgedu-N80054</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>JohnBackus</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="配置iptables防火墙">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-07-27 19:06" pubdate>
        July 27, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      7.8k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      65 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">配置iptables防火墙</h1>
            
            <div class="markdown-body">
              <p><strong>壹</strong></p>
<p><strong>iptables常见概念</strong></p>
<p><img src="640.gif" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p><strong>iptables服务端：xuegod63.cn  IP：192.168.1.63</strong></p>
<p><strong>iptables客户端：xuegod64.cn  IP：192.168.1.64</strong></p>
<p><strong>一、iptables概述：</strong></p>
<p><strong>netfilter/iptables ：IP信息包过滤系统，它实际上由两个组件netfilter 和 iptables 组成。</strong></p>
<p><strong>netfilter/iptables 关系：</strong>            </p>
<p><strong>netfilter 组件也称为内核空间（kernelspace），是内核的一部分，由一些信息包过滤表组成，这些表包含内核用来控制信息包过滤处理的规则集。</strong></p>
<p><strong>iptables 组件是一种工具，也称为用户空间（userspace），它使插入、修改和除去信息包过滤表中的规则变得容易。</strong></p>
<p><strong>netfilter/iptables 后期简称为：iptables。iptables是基于内核的防火墙，功能非常强大，iptables内置了filter，nat和mangle三张表。所有规则配置后，立即生效，不需要重启服务。</strong></p>
<p><strong>二、三张表介绍：</strong></p>
<p><strong>filter负责过滤数据包，包括的规则链有，input，output和forward；</strong></p>
<p><strong>nat则涉及到网络地址转换，包括的规则链有，prerouting，postrouting和output；</strong></p>
<p><strong>mangle表则主要应用在修改数据包内容上，用来做流量整形的，给数据包打个标识，默认的规则链有：INPUT，OUTPUT、 forward，POSTROUTING，PREROUTING；</strong></p>
<p><strong>三、五个链：</strong></p>
<p><strong>input匹配目标IP是本机的数据包，</strong></p>
<p><strong>output 出口数据包 ， 一般不在此链上做配置</strong></p>
<p><strong>forward匹配流经本机的数据包，</strong></p>
<p><strong>prerouting用来修改目的地址，用来做DNAT 。如：把内网中的80端口映射到路由器外网端口上</strong></p>
<p><strong>postrouting用来修改源地址用来做SNAT。 如：内网通过路由器NAT转换功能实现内网PC机通过一个公网IP地址上网。</strong></p>
<p><strong>总结****：iptables三个表，5个链接，结构如图：</strong></p>
<p><img src="640-1690456058081-5.png" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>Raw [rɔ:]表：用于处理异常，包括的规则链有，prerouting，output；一般使用不到。</p>
<p><strong>例：查看raw表中的内容：</strong></p>
<p><strong>[root@xuegod63 ~]# iptables -t raw -L</strong></p>
<p><strong>Chain PREROUTING (policy ACCEPT)</strong></p>
<p><strong>target   prot opt source        destination</strong>    </p>
<p><strong>Chain OUTPUT (policy ACCEPT)</strong></p>
<p><strong>target   prot opt source        destination</strong>   </p>
<p>表-&gt;链-&gt;规则</p>
<p>Iptables过滤封包流程</p>
<p><img src="640-1690456060607-8.png" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p><strong>–&gt;PREROUTING–&gt;[ROUTE]–&gt;FORWARD–&gt;POSTROUTING–&gt;</strong></p>
<p>   <strong>mangle     |    mangle            ^ mangle</strong></p>
<p>​    <strong>nat       |    filter              | nat</strong></p>
<p>​             <strong>|                 |</strong></p>
<p>​             <strong>|                 |</strong></p>
<p>​             <strong>v                 |</strong></p>
<p>​          <strong>INPUT             OUTPUT</strong></p>
<p>​             <strong>| mangle             ^ mangle</strong></p>
<p>​             <strong>| filter              | nat</strong></p>
<p>​            <strong>v —————-&gt;local————&gt;| filter</strong></p>
<p>**<br>**</p>
<p>**<br>**</p>
<p><strong>总结：</strong> 整体数据包分两类：1、发给防火墙本身的数据包 ；2、需要经过防火墙的数据包</p>
<p>① 当一个数据包进入网卡时，它首先进入PREROUTING链，内核根据数据包目的IP判断是否需要转送出去。 </p>
<p>② 如果数据包就是进入本机的，它就会沿着图向下移动，到达INPUT链。数据包到了INPUT链后，任何进程都会收到它。</p>
<p>本机上运行的程序可以发送数据包，这些数据包会经过OUTPUT链，然后到达POSTROUTING链输出。 </p>
<p>③ 如果数据包是要转发出去的，且内核允许转发，数据包就会如图所示向右移动，经过FORWARD链，然后到达POSTROUTING链输出。</p>
<p>**<br>**</p>
<p><img src="640-1690456065324-11.png" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p><strong>总结：</strong>整体数据包分两类：1、发给防火墙本身的数据包 ；2、需要经过防火墙的数据包</p>
<p>注意：规则的次序非常关键，谁的规则越严格，应该放的越靠前，而检查规则的时候，是按照从上往下的方式进行检查的。</p>
<p>**<br>**</p>
<p><strong>贰</strong></p>
<p><strong>iptables服务器安装及相关配置文件</strong></p>
<p><img src="640.gif" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>Iptables部署</p>
<p>Iptables是逻辑性比较强的服务，所以我们一个一个的实验疏通</p>
<p><strong>一、安装</strong></p>
<p>–关闭firewall：</p>
<p>[root@localhost ~]# systemctl stop firewalld.service       #停止firewall<br>[root@localhost ~]# systemctl disable firewalld.service     #禁止firewall开机启动</p>
<p>–安装安装iptables防火墙</p>
<p>[root@localhost ~]# yum install iptables-services       #安装</p>
<p><strong>二、配置文件位置：</strong></p>
<p>[root@xuegod63 ~]# ls /etc/sysconfig/iptables</p>
<p>/etc/sysconfig/iptables</p>
<p><strong>三、启动服务</strong></p>
<p>[root@xuegod63 ~]# systemctl start iptables.service</p>
<p>[root@xuegod63 ~]# systemctl enable iptables.service</p>
<p><img src="640-1690456070143-16.png" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p><img src="640-1690456072602-19.png" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p><strong>叁</strong></p>
<p><strong>实战：iptables使用方法</strong></p>
<p><img src="640.gif" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>例1：iptables命令使用方法</p>
<p>£ iptables [-t 要操作的表]</p>
<p>​     &lt;操作命令&gt;</p>
<p>​     [要操作的链]</p>
<p>​     [规则号码]</p>
<p>​     [匹配条件]</p>
<p>​     [-j 匹配到以后的动作]</p>
<p>£ 操作命令（-A、-I、-D、-P、-F）</p>
<p>£ 查看命令（-[vnx]L）</p>
<p><strong>-A &lt;链名&gt;  APPEND，追加一条规则（放到最后）</strong></p>
<p>例如：</p>
<p>  iptables -t filter -A INPUT -j DROP   #拒绝所有人访问服务器</p>
<p>  在 filter 表的 INPUT 链里追加一条规则（作为最后一条规则）</p>
<p>匹配所有访问本机 IP 的数据包，匹配到的丢弃</p>
<p><strong>-I &lt;链名&gt; [规则号码]   INSERT，插入一条规则</strong></p>
<p>例如：</p>
<p>  iptables -I INPUT -j DROP</p>
<p>  在 filter 表的 INPUT 链里插入一条规则（插入成第 1 条）</p>
<p>  iptables -I INPUT 3 -j DROP</p>
<p>  在 filter 表的 INPUT 链里插入一条规则（插入成第 3 条）</p>
<p>注意：1、-t filter 可不写，不写则自动默认是 filter 表</p>
<p>​    2、-I 链名 [规则号码]，如果不写规则号码，则默认是 1</p>
<p>​    3、确保规则号码 ≤ （已有规则数 + 1），否则报错</p>
<p><strong>-R num：Replays替换/修改第几条规则</strong></p>
<p>  格式：iptables –t filter -R INPUT 3 ………… 修改filter的INPUT链第三条规则</p>
<p><strong>-D &lt;链名&gt; &lt;规则号码 | 具体规则内容&gt;  DELETE，删除一条规则</strong></p>
<p>例如：</p>
<p>[root@xuegod63 ~]# iptables -L</p>
<p>Chain INPUT (policy ACCEPT)</p>
<p>target   prot opt source        destination    </p>
<p>DROP    all – anywhere       anywhere </p>
<p><strong>iptables -D INPUT 1（按号码匹配）</strong></p>
<p>删除 filter 表 INPUT 链中的第1条规则（不管它的内容是什么）</p>
<p>[root@xuegod63 ~]# iptables -L</p>
<p>Chain INPUT (policy ACCEPT)</p>
<p>target   prot opt source        destination    </p>
<p><strong>iptables -D INPUT -s 192.168.0.1 -j DROP（按内容匹配）</strong></p>
<p>  删除 filter 表 INPUT 链中内容为“-s 192.168.0.1 -j DROP”的规则</p>
<p>  （不管其位置在哪里）</p>
<p>注意：</p>
<p>  1、若规则列表中有多条相同的规则时，按内容匹配只删除序号最小的一条</p>
<p>  2、按号码匹配删除时，确保规则号码 ≤ 已有规则数，否则报错</p>
<p>  3、按内容匹配删除时，确保规则存在，否则报错</p>
<p><strong>-P &lt;链名&gt; &lt;动作&gt;  POLICY，设置某个链的默认规则</strong></p>
<p>例如：</p>
<p>[root@xuegod63 ~]# iptables -L  #查看默认规则是ACCEPT [əkˈsept]</p>
<p>Chain INPUT (policy ACCEPT)</p>
<p>target   prot opt source        destination </p>
<p> <strong>iptables -P INPUT DROP</strong></p>
<p> 设置 filter 表 INPUT 链的默认规则是 DROP</p>
<p>[root@xuegod63 ~]# iptables -L  #查看已经变为DROP</p>
<p>Chain INPUT (policy DROP)</p>
<p>target   prot opt source        destination  </p>
<p>注意：</p>
<p> 当数据包没有被规则列表里的任何规则匹配到时，按此默认规则处理。动作前面不能加 –j，这也是唯一一种匹配动作前面不加 –j 的情况。</p>
<p><strong>-F [链名]    FLUSH，清空规则</strong></p>
<p>例如：</p>
<p>添加规则：</p>
<p>[root@xuegod63 ~]# iptables -t filter -A INPUT -j DROP</p>
<p>[root@xuegod63 ~]# iptables -F INPUT  #清除INPUT链上的规则</p>
<p>[root@xuegod63 ~]# iptables -F  #清除filter表中所有链上的规则</p>
<p>[root@xuegod63 ~]# iptables -t nat -F #清空NAT表中  所有链上的规则</p>
<p>[root@xuegod63 ~]# iptables -t nat -F PREROUTING #清空NAT表中 PREROUTING链上的规则</p>
<p><strong>注意：</strong></p>
<p>  1、-F 仅仅是清空链中规则，并不影响 -P 设置的默认规则。需要手动改：</p>
<p>[root@xuegod63 ~]# iptables -P INPUT ACCEPT</p>
<p>  2、-P 设置了 DROP 后，使用 -F 一定要小心！！！</p>
<p><strong>##在生产环境中，使用-P DROP 这条规则，一定要小心，设置之前最好配置下面两个任务计划，否则容易把自己drop掉，链接不上远程主机。</strong></p>
<p>配置crontab :</p>
<p>*/15 * * * * iptables -P INPUT ACCEPT</p>
<p>*/15 * * * * iptables –F</p>
<p>  3、如果不写链名，默认清空某表里所有链里的所有规则</p>
<p><strong>-Z  将封包计数器归零</strong></p>
<p>iptables -Z INPUT</p>
<p><strong>-L [链名]    LIST，列出规则</strong></p>
<p>  v：显示详细信息，包括每条规则的匹配包数量和匹配字节数</p>
<p>  x：在 v 的基础上，禁止自动单位换算（K、M）</p>
<p>  n：只显示 IP 地址和端口号码，不显示域名和服务名称</p>
<p>   –line-number 可以查看到规则号</p>
<p>例如：</p>
<p>  iptables -L</p>
<p>  粗略列出 filter 表所有链及所有规则</p>
<p>  iptables -t nat -vnL</p>
<p>  用详细方式列出 nat 表所有链的所有规则，只显示 IP 地址和端口号</p>
<p>  iptables -t nat -vxnL PREROUTING</p>
<p>  用详细方式列出 nat 表 PREROUTING 链的所有规则以及详细数字，不反解</p>
<p>互动：  iptables -L  -n  可以执行成功</p>
<p>​      iptables -Ln  是否可以执行成功？</p>
<p>匹配条件</p>
<p>£ 流入、流出接口（-i、-o）</p>
<p>£ 来源、目的地址（-s、-d）</p>
<p>£ 协议类型   （-p）</p>
<p>£ 来源、目的端口（–sport、–dport）</p>
<p><strong>按网络接口匹配</strong></p>
<p>-i &lt;匹配数据进入的网络接口&gt;  #此参数主要应用于nat表，例如目标地址转换</p>
<p>例如：</p>
<p> -i eth0 </p>
<p>  匹配是否从网络接口 eth0 进来</p>
<p>  -i ppp0</p>
<p>  匹配是否从网络接口 ppp0 进来</p>
<p>-o 匹配数据流出的网络接口</p>
<p>例如：</p>
<p>  -o eth0</p>
<p>  -o ppp0</p>
<p><strong>按来源目的地址匹配</strong></p>
<p>-s &lt;匹配来源地址&gt;</p>
<p>  可以是 IP、 网段、域名，也可空（任何地址）</p>
<p>例如：</p>
<p>  -s 192.168.0.1   匹配来自 192.168.0.1 的数据包</p>
<p>  -s 192.168.1.0/24 匹配来自 192.168.1.0/24 网络的数据包</p>
<p>  -s 192.168.0.0/16 匹配来自 192.168.0.0/16 网络的数据包</p>
<p>-d &lt;匹配目的地址&gt;</p>
<p>  可以是 IP、 网段、域名，也可以空</p>
<p>例如：</p>
<p>  -d 202.106.0.20  匹配去往 202.106.0.20 的数据包</p>
<p>  -d 202.106.0.0/16 匹配去往 202.106.0.0/16 网络的数据包</p>
<p>  -d <a target="_blank" rel="noopener" href="http://www.abc.com/">www.abc.com</a>   匹配去往域名 <a target="_blank" rel="noopener" href="http://www.abc.com/">www.abc.com</a> 的数据包</p>
<p><strong>按协议类型匹配</strong></p>
<p>-p &lt;匹配协议类型&gt;</p>
<p>  可以是 TCP、UDP、ICMP 等，也可为空</p>
<p>例如：</p>
<p>  -p tcp</p>
<p>  -p udp</p>
<p>  -p icmp –icmp-type 类型</p>
<p>  ping: type 8   pong: type 0</p>
<p><strong>按来源目的端口匹配</strong></p>
<p>–sport &lt;匹配源端口&gt;</p>
<p>  可以是个别端口，可以是端口范围</p>
<p>例如：</p>
<p>  –sport 1000   匹配源端口是 1000 的数据包</p>
<p>  –sport 1000:3000 匹配源端口是 1000-3000 的数据包（含1000、3000）</p>
<p>  –sport :3000   匹配源端口是 3000 以下的数据包（含 3000）</p>
<p>  –sport 1000:   匹配源端口是 1000 以上的数据包（含 1000）</p>
<p>–dport &lt;匹配目的端口&gt;</p>
<p>  可以是个别端口，可以是端口范围</p>
<p>例如：</p>
<p>  –dport 80    匹配目的端口是 80 的数据包</p>
<p>  –dport 6000:8000 匹配目的端口是 6000-8000 的数据包（含6000、8000）</p>
<p>  –dport :3000   匹配目的端口是 3000 以下的数据包（含 3000）</p>
<p>  –dport 1000:   匹配目的端口是 1000 以上的数据包（含 1000）</p>
<p>注意：–sport 和 –dport 必须配合 -p 参数使用</p>
<p><strong>匹配应用举例</strong></p>
<p>1、端口匹配</p>
<p>-p udp –dport 53</p>
<p>匹配网络中目的端口是 53 的 UDP 协议数据包</p>
<p>2、地址匹配</p>
<p>-s 10.1.0.0/24 -d 172.17.0.0/16</p>
<p>匹配来自 10.1.0.0/24 去往 172.17.0.0/16 的所有数据包</p>
<p>3、端口和地址联合匹配</p>
<p>-s 192.168.0.1 -d <a target="_blank" rel="noopener" href="http://www.abc.com/">www.abc.com</a> -p tcp –dport 80</p>
<p>匹配来自 192.168.0.1，去往 <a target="_blank" rel="noopener" href="http://www.abc.com/">www.abc.com</a> 的 80 端口的 TCP 协议数据包</p>
<p><img src="640-1690456087361-24.png" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p><strong>注意：</strong></p>
<p>1、–sport、–dport 必须联合 -p 使用，必须指明协议类型是什么</p>
<p>2、条件写的越多，匹配越细致，匹配范围越小</p>
<p>4 动作（处理方式）</p>
<p>£ ACCEPT</p>
<p>£ DROP</p>
<p>£ SNAT</p>
<p>£ DNAT</p>
<p>£ MASQUERADE</p>
<p><strong>-j ACCEPT</strong></p>
<p>  通过，允许数据包通过本链而不拦截它</p>
<p>  例如：</p>
<p>  iptables -A INPUT -j ACCEPT</p>
<p>  允许所有访问本机 IP 的数据包通过</p>
<p><strong>-j DROP</strong></p>
<p>  丢弃，阻止数据包通过本链而丢弃它</p>
<p> 例如：</p>
<p>  iptables -A FORWARD -s 192.168.80.39 -j DROP</p>
<p>   阻止来源地址为 192.168.80.39 的数据包通过本机</p>
<p><strong>-j SNAT –to IP[-IP][:端口-端口]（nat 表的 POSTROUTING 链）</strong></p>
<p><strong>源地址转换</strong>，SNAT 支持转换为单 IP，也支持转换到 IP 地址池（一组连续的 IP 地址）</p>
<p>例如：</p>
<p> [root@xuegod63 ~]# iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT –to 1.1.1.1</p>
<p>#将内网 192.168.0.0/24 的原地址修改为 1.1.1.1，用于 NAT</p>
<p>iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT –to 1.1.1.1-1.1.1.10</p>
<p>同上，只不过修改成一个地址池里的 IP</p>
<p><strong>-j DNAT</strong> –to IP[-IP][:端口-端口]（nat 表的 PREROUTING 链）</p>
<p><strong>目的地址转换</strong>，DNAT 支持转换为单 IP，也支持转换到 IP 地址池</p>
<p>  （一组连续的 IP 地址）</p>
<p>例如：</p>
<p>表达方式1：把从 eth0 进来的要访问 TCP/80 的数据包目的地址改为 192.168.0.1.</p>
<p>[root@xuegod63 ~]# iptables -t nat -A PREROUTING -i eth0 -p tcp –dport 80 -j DNAT –to 192.168.0.1</p>
<p>表达方式2：</p>
<p>[root@xuegod63 ~]# iptables -t nat -A PREROUTING -i eth0 -p tcp –dport <strong>81</strong> -j DNAT –to 192.168.0.1:<strong>81</strong></p>
<p>表达方式3：把从 eth0 进来的要访问 TCP/80 的数据包目的地址改为 192.168.0.1-192.169.1.10</p>
<p>[root@xuegod63 ~]# iptables -t nat -A PREROUTING -i eth0 -p tcp –dport 80 -j DNAT –to 192.168.0.1-192.169.0.10</p>
<p><strong>-j MASQUERADE  伪装</strong></p>
<p>动态源地址转换（动态 IP 的情况下使用）</p>
<p>例如：</p>
<p>  [root@xuegod63 ~]# iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE</p>
<p>将源地址是 192.168.0.0/24 的数据包进行地址伪装，转换成eth0上的IP地址。eth0为路由器外网出口IP地址</p>
<p><strong>肆</strong></p>
<p><strong>selinux概述-状态切换</strong> </p>
<p><img src="640-1690456100035-27.gif" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p><strong>附加模块</strong></p>
<p>£ 按包状态匹配  （state）</p>
<p>£ 按来源 MAC 匹配（mac）</p>
<p>£ 按包速率匹配  （limit）</p>
<p>£ 多端口匹配   （multiport）</p>
<p><strong>按包状态匹配  （state）</strong></p>
<p>-m state –state 状态</p>
<p>状态：NEW、RELATED、ESTABLISHED、INVALID</p>
<p>   NEW：有别于 tcp 的 syn  #如果我们发送一个流的初始化包，状态就会在OUTPUT链 里被设置为NEW，当我们收到回应的包时，状态就会在PREROUTING链里被设置为ESTABLISHED。如果第一个包不是本地产生的，那就会在PREROUTING链里被设置为NEW状 态。</p>
<p>   ESTABLISHED：连接态</p>
<p>   RELATED：衍生态，与 conntrack 关联（FTP）</p>
<p>   INVALID：不能被识别属于哪个连接或没有任何状态</p>
<p>例如：</p>
<p>  iptables -A INPUT -m state –state RELATED,ESTABLISHED -j ACCEPT</p>
<p>四个状态：</p>
<p><img src="640-1690456108092-29.png" srcset="/img/loading.gif" lazyload alt="图片"></p>
<p>   这些状态可以一起使用，以便匹配数据包。这可以使我们的防火墙非常强壮和有效。以前，我们经常打 开1024以上的所有端口来放行应答的数据。现在，有了状态机制，就不需再这样了。因为我们可以只开放那些有应答数据的端口，其他的都可以关闭。这样就安全多了。</p>
<p><strong>按来源 MAC 匹配（mac）</strong></p>
<p>-m mac –mac-source MAC</p>
<p>匹配某个 MAC 地址</p>
<p>例如：</p>
<p>  iptables -A FORWARD -m mac –mac-source xx:xx:xx:xx:xx:xx -j DROP</p>
<p>  阻断来自某 MAC 地址的数据包，通过本机</p>
<p>注意：</p>
<p>​    报文经过路由后，数据包中原有的 mac 信息会被替换，所以在路由后的 iptables 中使用 mac 模块是没有意义的</p>
<p><strong>按包速率匹配  （limit）</strong></p>
<p>-m limit –limit 匹配速率 [–burst 缓冲数量]</p>
<p>  用一定速率去匹配数据包</p>
<p>例如：</p>
<p>  iptables -A FORWARD -d 192.168.0.1 -m limit –limit 50/s -j ACCEPT</p>
<p>  iptables -A FORWARD -d 192.168.0.1 -j DROP</p>
<p>注意：</p>
<p> limit 英语上看是限制的意思，但实际上只是按一定速率去匹配而已，50/s表示1秒中转发50个数据包，要想限制的话后面要再跟一条 DROP</p>
<p><strong>多端口匹配   （multiport）</strong></p>
<p>-m multiport &lt;–sports|–dports|–ports&gt; 端口1[,端口2,..,端口n]</p>
<p>一次性匹配多个端口，可以区分源端口，目的端口或不指定端口</p>
<p>例如：</p>
<p>  iptables -A INPUT -p tcp -m multiport –dports 21,22,25,80,110 -j ACCEPT</p>
<p><strong>注意：</strong></p>
<p>  必须与 -p 参数一起使用</p>
<p><strong>保存：service iptables save</strong></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/27/%E7%94%A8ChatGPT%E6%90%AD%E5%BB%BA%E4%BB%A3%E7%A0%81%E7%9F%A5%E8%AF%86%E5%BA%93/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">用ChatGPT搭建代码知识库</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/27/%E9%98%B2%E7%81%AB%E5%A2%99/">
                        <span class="hidden-mobile">防火墙</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://qm.qq.com/cgi-bin/qm/qr?k=A5I1aDMT5p5nmi3zDa8t7gWOHawJhjyi&noverify=0&personal_qrcode_source=4" target="_blank" rel="nofollow noopener"><span>JohnBakcu</span></a> <i class="iconfont icon-love"></i> <a href="https://www.magedu.com"  target="_blank" rel="nofollow noopener"><span>Mgedu</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
